# GUSTAV local environment example (do not commit secrets)

# App environment
GUSTAV_ENV=dev
GUSTAV_TRUST_PROXY=false  # set to true only when running behind a trusted reverse proxy

# Database DSNs
# Security: Do not log in as `gustav_limited` (NOLOGIN by design). Create an env-specific
# login user (e.g., `gustav_app`) that is IN ROLE gustav_limited and use it here.
# Example psql (run once locally):
#   create role gustav_app login password 'CHANGE_ME_DEV' in role gustav_limited;
APP_DB_USER=gustav_app
APP_DB_PASSWORD=CHANGE_ME_DEV
DATABASE_URL=postgresql://${APP_DB_USER}:${APP_DB_PASSWORD}@127.0.0.1:54322/postgres
RLS_TEST_DSN=postgresql://${APP_DB_USER}:${APP_DB_PASSWORD}@127.0.0.1:54322/postgres
# Production/Stage: set TEACHING_DATABASE_URL/LEARNING_DATABASE_URL explicitly.
# Fallback to the dev DSN is disabled when GUSTAV_ENV is prod/stage.

# Sessions (optional DB-backed)
# SESSIONS_BACKEND=db
# SESSION_DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres

# OIDC / Keycloak (dev)
# Prefer KC_BASE_URL; KC_BASE is accepted for backward compatibility.
# IMPORTANT:
# - Inside containers use the internal service URL: http://keycloak:8080
# - For browser-facing links use KC_PUBLIC_BASE_URL (reverse-proxied TLS): https://id.localhost:8100
KC_BASE_URL=http://keycloak:8080
KC_PUBLIC_BASE_URL=https://id.localhost:8100
KC_REALM=gustav
# Admin API client (preferred; grants realm-management roles like view-users, query-users)
KC_ADMIN_REALM=master
KC_ADMIN_CLIENT_ID=gustav-admin-cli
# WARNING: Never commit real secrets; use a dedicated confidential client for admin API access.
# Production/Stage REQUIRE this secret; password grant is disabled in those envs.
KC_ADMIN_CLIENT_SECRET=CHANGE_ME_DEV
# Legacy fallback (discouraged in prod): uncomment only for local dev
# KC_ADMIN_USERNAME=admin
# KC_ADMIN_PASSWORD=admin
# Keycloak database connection (Dev defaults; override in prod/stage)
KC_DB=postgres
KC_DB_URL=jdbc:postgresql://keycloak-db:5432/keycloak
KC_DB_USERNAME=keycloak
KC_DB_PASSWORD=keycloak
KC_DB_URL_PROPERTIES=sslmode=disable  # override with sslmode=require (and friends) in prod
# App base for browser-facing URLs (reverse proxy maps app.localhost:8100 → web)
WEB_BASE=https://app.localhost:8100
REDIRECT_URI=https://app.localhost:8100/auth/callback

# Supabase Storage (self-hosted)
# Replace with values from `supabase start` output.
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_SERVICE_ROLE_KEY=DUMMY_DO_NOT_USE
# SECURITY: Service Role keys are server-only secrets. Never expose to clients
# or bundle into frontends. Use only on the backend for short-lived signed URLs.
# In production, fail-fast if this value is unset or equals the dummy placeholder.
SUPABASE_STORAGE_BUCKET=materials
LEARNING_STORAGE_BUCKET=submissions
# Centralized size limits (bytes)
MATERIALS_MAX_UPLOAD_BYTES=20971520
LEARNING_MAX_UPLOAD_BYTES=10485760
# Dev-only convenience (auto-provision buckets via REST on startup)
# Dev/Test only: allow automatic bucket provisioning when local Supabase resets wipe storage.
# Never enable this flag in prod/stage; migrations are the single source of truth there.
AUTO_CREATE_STORAGE_BUCKETS=false

# Notes:
# - Keep this file as a template. Create a real `.env` with your secrets.
# - The backend loads `.env` automatically in dev/test.

# Local AI (Ollama / DSPy)
# Prod-ready default: use local adapters with real models
AI_BACKEND=local
OLLAMA_BASE_URL=http://ollama:11434
AI_VISION_MODEL=qwen2.5vl:3b
AI_FEEDBACK_MODEL=gpt-oss:latest
AI_TIMEOUT_VISION=30
AI_TIMEOUT_FEEDBACK=15
# Feature toggle: JSONAdapter erzwingt streng typisierte strukturierte Ausgaben.
# Standard ist `true`. Für lokale Modelle, die zwar JSON liefern, aber Felder
# nicht robust befüllen, in Dev/Stage auf `false` setzen, um tolerant zu parsen.
#
# WICHTIG (Compose-Integration): Diese Variable wird in `docker-compose.yml` unter
# `services.learning-worker.environment` via `${LEARNING_DSPY_JSON_ADAPTER:-true}`
# in den Container injiziert. Setze sie hier in der Projekt-`.env` und starte den
# Worker neu (`docker compose up -d --force-recreate learning-worker`).
#
# Verifikation: Worker-Logs zeigen beim Start
#   - `adapter=JSONAdapter` (aktiv) oder `adapter=default` (deaktiviert)
#   Befehl: `docker compose logs -n 50 learning-worker | rg dspy_configured`
LEARNING_DSPY_JSON_ADAPTER=true
