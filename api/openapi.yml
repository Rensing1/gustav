openapi: 3.0.3
info:
  title: GUSTAV API
  version: 0.1.0
  description: >-
    Contract-first API for minimal authentication/session integration with Keycloak.
    Endpoints cover login redirect, callback handling, logout, session info, and a
    convenience redirect for "forgot password". Sessions are represented by an
    httpOnly cookie.

servers:
  - url: /

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: gustav_session
  schemas:
    Role:
      type: string
      enum: [student, teacher, admin]
    Me:
      type: object
      required: [sub, roles, name, expires_at]
      properties:
        sub:
          type: string
          description: Stable subject identifier from the IdP (opaque, non-PII).
        roles:
          type: array
          items:
            $ref: '#/components/schemas/Role'
        name:
          type: string
          description: Display name (prefer Keycloak user attribute `display_name`; fallback per server logic).
        expires_at:
          type: string
          format: date-time
          description: Session expiration timestamp (UTC ISO-8601).
          nullable: true
      example:
        sub: "a1b2c3d4-ef01-2345-6789-abcdef012345"
        roles: ["student"]
        name: "Max Musterschüler"
        expires_at: "2025-10-20T12:34:56Z"
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
        detail:
          type: string
    Course:
      type: object
      required: [id, title, teacher_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
        teacher_id:
          type: string
          description: Teacher subject identifier (OIDC sub)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CourseCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
    CourseUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
    CourseMember:
      type: object
      required: [sub, name, joined_at]
      properties:
        sub:
          type: string
          description: Student subject identifier (OIDC sub)
        name:
          type: string
        joined_at:
          type: string
          format: date-time
    Unit:
      type: object
      required: [id, title, author_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
        author_id:
          type: string
          description: Teacher subject identifier (OIDC sub)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    UnitCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
    UnitUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
    Section:
      type: object
      required: [id, unit_id, title, position, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the learning unit
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    SectionCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
    SectionUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
    SectionReorder:
      type: object
      required: [section_ids]
      properties:
        section_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of section IDs for the given unit
    Material:
      type: object
      required: [id, unit_id, section_id, title, body_md, position, kind, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        section_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the section
        kind:
          type: string
          enum: [markdown, file]
          description: Material content type.
        body_md:
          type: string
          description: Markdown content shown to students once the section is released (only for `kind=markdown`).
          nullable: true
        filename_original:
          type: string
          description: Original filename provided by the teacher (only for `kind=file`).
        storage_key:
          type: string
          description: Storage path used for the uploaded file (only for `kind=file`).
        mime_type:
          type: string
          description: MIME type of the uploaded file (only for `kind=file`).
        size_bytes:
          type: integer
          minimum: 1
          description: Size of the uploaded file in bytes (only for `kind=file`).
        sha256:
          type: string
          description: Hex-encoded SHA-256 checksum of the uploaded file (only for `kind=file`).
        alt_text:
          type: string
          description: Optional alternative text for accessibility (only for `kind=file`).
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    MaterialCreate:
      type: object
      required: [title, body_md]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        body_md:
          type: string
          description: Markdown body authored by the teacher
    MaterialUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        body_md:
          type: string
          description: Markdown body authored by the teacher
          nullable: true
        alt_text:
          type: string
          description: Alternative text for file materials (ignored for markdown)
    MaterialReorder:
      type: object
      required: [material_ids]
      properties:
        material_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of material IDs for the given section
    MaterialUploadIntentRequest:
      type: object
      required: [filename, mime_type, size_bytes]
      properties:
        filename:
          type: string
          description: Original filename supplied by the teacher
        mime_type:
          type: string
          description: MIME type expected for the upload
        size_bytes:
          type: integer
          minimum: 1
          description: Declared file size in bytes
    MaterialUploadIntentResponse:
      type: object
      required: [intent_id, material_id, storage_key, url, headers, accepted_mime_types, max_size_bytes, expires_at]
      properties:
        intent_id:
          type: string
          format: uuid
        material_id:
          type: string
          format: uuid
        storage_key:
          type: string
          description: Storage key that must be used during upload
        url:
          type: string
          format: uri
          description: Pre-signed upload URL
        headers:
          type: object
          additionalProperties:
            type: string
          description: HTTP headers that must be included with the upload request
        accepted_mime_types:
          type: array
          items:
            type: string
          description: MIME types allowed for uploads
        max_size_bytes:
          type: integer
          minimum: 1
          description: Maximum allowed file size in bytes
        expires_at:
          type: string
          format: date-time
          description: ISO timestamp when the upload intent expires
    MaterialFileFinalizeRequest:
      type: object
      required: [intent_id, title, sha256]
      properties:
        intent_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        sha256:
          type: string
          description: Hex-encoded SHA-256 checksum of the uploaded file
          pattern: '^[0-9a-f]{64}$'
        alt_text:
          type: string
          description: Optional alternative text for accessibility
    MaterialDownloadUrlResponse:
      type: object
      required: [url, expires_at]
      properties:
        url:
          type: string
          format: uri
          description: Short-lived download URL
        expires_at:
          type: string
          format: date-time
          description: ISO timestamp when the download URL expires
    CourseModule:
      type: object
      required: [id, course_id, unit_id, position, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        course_id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the course
        context_notes:
          type: string
          maxLength: 2000
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CourseModuleCreate:
      type: object
      required: [unit_id]
      properties:
        unit_id:
          type: string
          format: uuid
        context_notes:
          type: string
          maxLength: 2000
          nullable: true
    CourseModuleReorder:
      type: object
      required: [module_ids]
      properties:
        module_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of course_module IDs for the given course

paths:
  /auth/login:
    get:
      tags: [Auth]
      summary: Redirect to IdP login (Authorization Code Flow with PKCE)
      description: >-
        Redirects to the Keycloak authorization endpoint with PKCE. The server
        generates and manages the opaque `state` (CSRF) and a `nonce` (replay
        protection) for the OIDC flow; clients MUST NOT provide these values.
      operationId: startLogin
      parameters:
        - in: query
          name: redirect
          schema:
            type: string
            maxLength: 256
            pattern: '^/(?!.*//)(?!.*\\.\\.)[A-Za-z0-9._\-/]*$'
          description: >-
            Optional in-app absolute path to navigate to after login. External
            URLs are rejected; invalid values are ignored. Disallows double-slash
            and path traversal segments.
      responses:
        '302':
          description: Redirect to Keycloak authorization endpoint
          headers:
            Location:
              description: Authorization URL at Keycloak
              schema:
                type: string


  /auth/callback:
    get:
      tags: [Auth]
      summary: OAuth2/OIDC callback from Keycloak
      description: Handles the authorization code, sets session cookie, and redirects.
      operationId: authCallback
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Session established, redirect to application page
          headers:
            Set-Cookie:
              description: >-
                httpOnly session cookie `gustav_session`.
                Production: `HttpOnly; Secure; SameSite=strict`.
                Development/Test: `HttpOnly; SameSite=lax`.
                In production, `Max-Age` matches the server session TTL (default 3600 seconds).
              schema:
                type: string
            Location:
              description: In-app destination (e.g., "/" or a course page)
              schema:
                type: string
        '400':
          description: Invalid or expired code/state
          headers:
            Cache-Control:
              description: Security hardening — responses must not be cached
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    get:
      tags: [Auth]
      summary: Logout (App session + IdP end-session)
      description: >-
        Clears the application session cookie and redirects to the Identity Provider's
        end-session endpoint. After IdP logout, the browser returns to the app start page.
      operationId: logoutUnified
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
            maxLength: 256
            pattern: '^/(?!.*//)(?!.*\\.\\.)[A-Za-z0-9._\-/]*$'
            default: "/auth/logout/success"
          description: >-
            App-relative absolute path (e.g., "/courses") to redirect to after IdP logout.
            External URLs are rejected and ignored. Disallows double-slash and path traversal.
            Defaults to "/auth/logout/success". Server enforces the same regex pattern.
      responses:
        '302':
          description: Redirect to IdP end-session endpoint (then back to the app)
          headers:
            Set-Cookie:
              description: >-
                Clears the httpOnly session cookie `gustav_session` (expires it).
                Production: `HttpOnly; Secure; SameSite=strict; Max-Age=0`.
                Development/Test: `HttpOnly; SameSite=lax; Max-Age=0`.
              schema:
                type: string
            Location:
              description: IdP end-session endpoint URL
              schema:
                type: string

  /auth/logout/success:
    get:
      tags: [Auth]
      summary: Logout success page
      description: Shows a confirmation that the user has been logged out and links to /auth/login.
      responses:
        '200':
          description: HTML page confirming logout
          content:
            text/html:
              schema:
                type: string


  /auth/forgot:
    get:
      tags: [Auth]
      summary: Redirect to IdP forgot password page
      description: Redirect to Keycloak password reset page.
      operationId: forgotPassword
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill on the reset page.
      responses:
        '302':
          description: Redirect to Keycloak password reset page
          headers:
            Location:
              schema:
                type: string


  /auth/register:
    get:
      tags: [Auth]
      summary: Redirect to IdP registration
      description: >-
        Redirects to Keycloak with `kc_action=register`. The server generates and
        includes a `nonce` parameter (replay protection) in the authorization request,
        analogous to `/auth/login`.
      operationId: startRegistration
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill in the registration form.
      responses:
        '302':
          description: Redirect to Keycloak registration page
          headers:
            Location:
              schema:
                type: string


  /api/me:
    get:
      tags: [Auth]
      summary: Return current user context
      description: Returns `sub`, `roles`, and display `name` if authenticated.
      operationId: getMe
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User context
          headers:
            Cache-Control:
              description: Security hardening — responses must not be cached
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security hardening — responses must not be cached
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/teaching/courses:
    get:
      tags: [Teaching]
      summary: List courses for the current user
      description: >-
        Teachers see courses where they are the owner (teacher_id == sub).
        Students see courses where they are a member.
      operationId: listCourses
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of courses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Course'
        '401':
          description: Unauthenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Teaching]
      summary: Create a course (teacher only)
      operationId: createCourse
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseCreate'
      responses:
        '201':
          description: Course created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_input (e.g., blank title or exceeds length limits)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_input:
                  summary: Invalid payload (e.g., blank title)
                  value:
                    error: bad_request
                    detail: invalid_input
        '401':
          description: Unauthenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (not a teacher)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/teaching/courses/{course_id}:
    patch:
      tags: [Teaching]
      summary: Update a course (owner only)
      operationId: updateCourse
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseUpdate'
      responses:
        '200':
          description: Updated course
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_field (e.g., blank title)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_field:
                  summary: Invalid field update
                  value:
                    error: bad_request
                    detail: invalid_field
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a course (owner only)
      description: |-
        Deletes a course when owned by the caller. Returns 404 when the course
        does not exist and 403 when the caller is not the owner. Response 204
        contains no content.
      operationId: deleteCourse
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204': { description: Deleted (no content) }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/members:
    get:
      tags: [Teaching]
      summary: List course members (owner only)
      description: |-
        Returns the roster only when the caller owns the course. Responds 404
        when the course does not exist and 403 when the caller is not the
        owner.
      operationId: listCourseMembers
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "RLS: course_memberships select returns rows only for the logged-in student (self-only)"
        - "Owner roster uses SECURITY DEFINER helper that verifies ownership server-side to avoid RLS recursion"
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseMember'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Add member (owner only, idempotent)
      description: |-
        Adds a student to the course. Responds 201 when created and 204 (no
        content) if the membership already exists. Responds 404 when the course
        does not exist and 403 when the caller is not the owner.
      operationId: addCourseMember
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [student_sub]
              properties:
                student_sub:
                  type: string
      responses:
        '201': { description: Added }
        '204': { description: Already a member (no content) }
        '400':
          description: |
            Invalid input. detail codes:
              - student_sub_required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                student_sub_required:
                  summary: student_sub missing or blank
                  value:
                    error: bad_request
                    detail: student_sub_required
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/members/{student_sub}:
    delete:
      tags: [Teaching]
      summary: Remove member (owner only, idempotent)
      description: |-
        Removes a student from the course; idempotent 204 (no content). 404
        when the course does not exist; 403 when the caller is not the owner.
      operationId: removeCourseMember
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: student_sub
          required: true
          schema:
            type: string
      responses:
        '204': { description: Removed or not present (no content) }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units:
    get:
      tags: [Teaching]
      summary: List learning units authored by the current teacher
      description: Returns only units where the caller is the author.
      operationId: listUnits
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of authored learning units
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Unit'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not a teacher), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create a learning unit
      operationId: createUnit
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnitCreate'
      responses:
        '201':
          description: Learning unit created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_title
              - invalid_summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_title:
                  summary: Title missing or exceeds limits
                  value:
                    error: bad_request
                    detail: invalid_title
                invalid_summary:
                  summary: Summary exceeds maximum length
                  value:
                    error: bad_request
                    detail: invalid_summary
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not a teacher), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}:
    patch:
      tags: [Teaching]
      summary: Update a learning unit (author only)
      operationId: updateUnit
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnitUpdate'
      responses:
        '200':
          description: Updated learning unit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - empty_payload
              - invalid_title
              - invalid_summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                empty_payload:
                  summary: No fields supplied
                  value:
                    error: bad_request
                    detail: empty_payload
                invalid_title:
                  summary: Title violates validation
                  value:
                    error: bad_request
                    detail: invalid_title
                invalid_summary:
                  summary: Summary exceeds maximum length
                  value:
                    error: bad_request
                    detail: invalid_summary
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a learning unit (author only)
      description: Removes the unit and cascades linked course modules owned by the author.
      operationId: deleteUnit
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204': { description: Deleted (no content) }
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /api/teaching/units/{unit_id}/sections:
    get:
      tags: [Teaching]
      summary: List sections of a learning unit (author only)
      description: Returns sections sorted by ascending position for the unit's author.
      operationId: listSections
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of sections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Section'
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create a section within a learning unit (author only)
      operationId: createSection
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionCreate'
      responses:
        '201':
          description: Section created at the next position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Section'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}:
    patch:
      tags: [Teaching]
      summary: Update a section (author only)
      operationId: updateSection
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionUpdate'
      responses:
        '200':
          description: Updated section
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Section'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a section (author only)
      description: Removes the section and resequences remaining positions to 1..n.
      operationId: deleteSection
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204': { description: Deleted (no content) }
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_path_params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_path_params:
                  summary: Section id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_path_params
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/reorder:
    post:
      tags: [Teaching]
      summary: Reorder sections of a learning unit (author only)
      description: Atomically updates positions based on the provided section order.
      operationId: reorderSections
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      x-security-notes:
        - "Transactional update with row locks ensures contiguous positions without duplicates."
        - "Check author ownership before validating payload to avoid error-oracle leakage."
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionReorder'
      responses:
        '200':
          description: Sections reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Section'
        '400':
          description: |
            Invalid section list. detail codes:
              - invalid_unit_id
              - section_ids_must_be_array
              - empty_section_ids
              - duplicate_section_ids
              - invalid_section_ids
              - section_mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_section_ids:
                  summary: Section ids contain duplicates
                  value:
                    error: bad_request
                    detail: duplicate_section_ids
                invalid_section_ids:
                  summary: Section ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_section_ids
                section_mismatch:
                  summary: Payload ids do not match current unit sections
                  value:
                    error: bad_request
                    detail: section_mismatch
                empty_section_ids:
                  summary: Submitted section id array is empty
                  value:
                    error: bad_request
                    detail: empty_section_ids
                section_ids_must_be_array:
                  summary: Submitted section_ids is not an array
                  value:
                    error: bad_request
                    detail: section_ids_must_be_array
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials:
    get:
      tags: [Teaching]
      summary: List materials of a section (author only)
      description: Returns materials sorted by ascending position for the section's author.
      operationId: listSectionMaterials
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of materials
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
                invalid_section_id:
                  summary: Section id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_section_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create material within a section (author only)
      operationId: createSectionMaterial
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialCreate'
      responses:
        '201':
          description: Material created at the next position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_title
              - invalid_body_md
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/{material_id}:
    patch:
      tags: [Teaching]
      summary: Update a material (author only)
      operationId: updateSectionMaterial
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialUpdate'
      responses:
        '200':
          description: Updated material
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
              - invalid_title
              - invalid_body_md
              - invalid_alt_text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_title:
                  summary: Title provided but empty or too long
                  value:
                    error: bad_request
                    detail: invalid_title
                empty_payload:
                  summary: No fields were provided in the PATCH body
                  value:
                    error: bad_request
                    detail: empty_payload
                invalid_alt_text:
                  summary: Alt text provided but too long
                  value:
                    error: bad_request
                    detail: invalid_alt_text
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a material (author only)
      description: Removes the material and resequences remaining positions to 1..n.
      operationId: deleteSectionMaterial
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204': { description: Deleted (no content) }
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '502':
          description: Upstream storage deletion failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                storage_delete_failed:
                  summary: Storage deletion failed and manual cleanup is required
                  value:
                    error: bad_gateway
                    detail: storage_delete_failed
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/reorder:
    post:
      tags: [Teaching]
      summary: Reorder materials of a section (author only)
      description: Atomically updates positions based on the provided material order.
      operationId: reorderSectionMaterials
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      x-security-notes:
        - "Transactional update with row locks ensures contiguous positions without duplicates."
        - "Check author ownership before validating payload to avoid error-oracle leakage."
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialReorder'
      responses:
        '200':
          description: Materials reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid material list. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - material_ids_must_be_array
              - empty_material_ids
              - duplicate_material_ids
              - invalid_material_ids
              - material_mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_material_ids:
                  summary: Material ids contain duplicates
                  value:
                    error: bad_request
                    detail: duplicate_material_ids
                invalid_material_ids:
                  summary: Material ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_material_ids
                material_mismatch:
                  summary: Payload ids do not match current section materials
                  value:
                    error: bad_request
                    detail: material_mismatch
                empty_material_ids:
                  summary: Submitted material id array is empty
                  value:
                    error: bad_request
                    detail: empty_material_ids
                material_ids_must_be_array:
                  summary: Submitted material_ids is not an array
                  value:
                    error: bad_request
                    detail: material_ids_must_be_array
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/upload-intents:
    post:
      tags: [Teaching]
      summary: Create upload intent for file material (author only)
      operationId: createSectionMaterialUploadIntent
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialUploadIntentRequest'
      responses:
        '200':
          description: Upload intent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaterialUploadIntentResponse'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_filename
              - mime_not_allowed
              - size_exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_filename:
                  summary: Filename becomes empty after sanitizing
                  value:
                    error: bad_request
                    detail: invalid_filename
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/finalize:
    post:
      tags: [Teaching]
      summary: Finalize upload intent (author only)
      operationId: finalizeSectionMaterialUpload
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialFileFinalizeRequest'
      responses:
        '201':
          description: File material created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '200':
          description: Upload intent already finalized (idempotent)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_intent_id
              - intent_expired
              - checksum_mismatch
              - invalid_title
              - mime_not_allowed
              - invalid_alt_text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                intent_expired:
                  summary: Upload intent is no longer valid
                  value:
                    error: bad_request
                    detail: intent_expired
                mime_not_allowed:
                  summary: Uploaded object has a MIME type outside the whitelist
                  value:
                    error: bad_request
                    detail: mime_not_allowed
                invalid_alt_text:
                  summary: Alt text exceeds the permitted length
                  value:
                    error: bad_request
                    detail: invalid_alt_text
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (intent does not belong to caller), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or intent not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/{material_id}/download-url:
    get:
      tags: [Teaching]
      summary: Generate download URL for file material (author only)
      operationId: getSectionMaterialDownloadUrl
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: disposition
          required: false
          schema:
            type: string
            enum: [inline, attachment]
          description: Desired `Content-Disposition`; defaults to `attachment`.
      responses:
        '200':
          description: Short-lived download URL returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaterialDownloadUrlResponse'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
              - invalid_disposition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_disposition:
                  summary: Disposition is not 'inline' or 'attachment'
                  value:
                    error: bad_request
                    detail: invalid_disposition
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules:
    get:
      tags: [Teaching]
      summary: List course modules (owner only)
      description: Returns modules in ascending position for the course owner.
      operationId: listCourseModules
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "RLS: course_modules policies verify ownership via course_exists_for_owner helper"
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Course modules ordered by position
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseModule'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Add a learning unit to a course (owner only)
      description: Creates a course module at the next position using a unit authored by the caller.
      operationId: createCourseModule
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseModuleCreate'
      responses:
        '201':
          description: Course module created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseModule'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner or not the unit author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course or unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '409': { description: Unit already attached to this course, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules/reorder:
    post:
      tags: [Teaching]
      summary: Reorder course modules (owner only)
      description: Replaces positions atomically based on the provided module order.
      operationId: reorderCourseModules
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "Transactional update ensures no duplicate positions and preserves contiguous order."
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseModuleReorder'
      responses:
        '200':
          description: Modules reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseModule'
        '400':
          description: |
            Invalid module list. detail codes:
              - invalid_course_id
              - duplicate_module_ids
              - invalid_module_ids
              - empty_reorder
              - module_mismatch
              - no_modules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_module_ids:
                  summary: Duplicate ids submitted
                  value:
                    error: bad_request
                    detail: duplicate_module_ids
                module_mismatch:
                  summary: Payload ids do not match current modules
                  value:
                    error: bad_request
                    detail: module_mismatch
                empty_reorder:
                  summary: Submitted array is empty
                  value:
                    error: bad_request
                    detail: empty_reorder
                invalid_module_ids:
                  summary: Submitted ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_module_ids
                no_modules:
                  summary: Course has no modules to reorder
                  value:
                    error: bad_request
                    detail: no_modules
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course or module not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/users/search:
    get:
      tags: [Users]
      summary: Search users by name
      description: Teachers/Admins search for students by display name; returns sub and name.
      operationId: searchUsers
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 2
        - in: query
          name: role
          required: true
          schema:
            $ref: '#/components/schemas/Role'
          description: Filter by role (e.g., student)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: Results
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [sub, name]
                  properties:
                    sub: { type: string }
                    name: { type: string }
        '400':
          description: |
            Invalid query. detail codes:
              - q_too_short
              - invalid_role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                q_too_short:
                  summary: Query shorter than 2 characters
                  value:
                    error: bad_request
                    detail: q_too_short
                invalid_role:
                  summary: Unsupported role filter
                  value:
                    error: bad_request
                    detail: invalid_role
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
