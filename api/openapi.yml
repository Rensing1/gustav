openapi: 3.0.3
info:
  title: GUSTAV API
  version: 0.0.2
  description: >-
    Contract-first API for authentication (Keycloak), Teaching, and Learning.
    Endpoints cover login redirect, callback handling, logout, session info,
    course/unit/section/task/material management for teachers, and student
    views for released content. Sessions are represented by an httpOnly cookie.
  x-changelog:
    - date: "2025-10-28"
      type: breaking
      note: "LearningSectionCore now requires unit_id (update client models)."

servers:
  - url: /

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: gustav_session
  schemas:
    Role:
      type: string
      enum: [student, teacher, admin]
    Me:
      type: object
      required: [sub, roles, name, expires_at]
      properties:
        sub:
          type: string
          description: Stable subject identifier from the IdP (opaque, non-PII).
        roles:
          type: array
          items:
            $ref: '#/components/schemas/Role'
        name:
          type: string
          description: Display name (prefer Keycloak user attribute `display_name`; fallback per server logic).
        expires_at:
          type: string
          format: date-time
          description: Session expiration timestamp (UTC ISO-8601).
          nullable: true
      example:
        sub: "a1b2c3d4-ef01-2345-6789-abcdef012345"
        roles: ["student"]
        name: "Max Musterschüler"
        expires_at: "2025-10-20T12:34:56+00:00"
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
        detail:
          type: string
    Course:
      type: object
      required: [id, title, teacher_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
        teacher_id:
          type: string
          description: Teacher subject identifier (OIDC sub)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CourseCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
    CourseUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        subject:
          type: string
          maxLength: 100
          nullable: true
        grade_level:
          type: string
          maxLength: 32
          nullable: true
        term:
          type: string
          maxLength: 32
          nullable: true
    CourseMember:
      type: object
      required: [sub, name, joined_at]
      properties:
        sub:
          type: string
          description: Student subject identifier (OIDC sub)
        name:
          type: string
        joined_at:
          type: string
          format: date-time
    Unit:
      type: object
      required: [id, title, author_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
        author_id:
          type: string
          description: Teacher subject identifier (OIDC sub)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    UnitCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
    UnitUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        summary:
          type: string
          maxLength: 2000
          nullable: true
    Section:
      type: object
      required: [id, unit_id, title, position, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the learning unit
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    SectionCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
    SectionUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
    SectionReorder:
      type: object
      required: [section_ids]
      properties:
        section_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of section IDs for the given unit
    ModuleSectionVisibility:
      type: object
      required: [course_module_id, section_id, visible, released_by]
      properties:
        course_module_id:
          type: string
          format: uuid
        section_id:
          type: string
          format: uuid
        visible:
          type: boolean
          description: Whether the section is released to students of the course.
        released_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the section was last released (`null` when currently hidden).
        released_by:
          type: string
          description: Subject identifier of the teacher who last changed visibility. Never null.
    ModuleSectionVisibilityUpdate:
      type: object
      required: [visible]
      properties:
        visible:
          type: boolean
          description: Target visibility state for the section within the course module.
    Material:
      type: object
      required: [id, unit_id, section_id, title, body_md, position, kind, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        section_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the section
        kind:
          type: string
          enum: [markdown, file]
          description: Material content type.
        body_md:
          type: string
          description: Markdown content shown to students once the section is released (only for `kind=markdown`).
          nullable: true
        filename_original:
          type: string
          description: Original filename provided by the teacher (only for `kind=file`).
        storage_key:
          type: string
          description: Storage path used for the uploaded file (only for `kind=file`).
        mime_type:
          type: string
          description: MIME type of the uploaded file (only for `kind=file`).
        size_bytes:
          type: integer
          minimum: 1
          description: Size of the uploaded file in bytes (only for `kind=file`).
        sha256:
          type: string
          description: Hex-encoded SHA-256 checksum of the uploaded file (only for `kind=file`).
        alt_text:
          type: string
          description: Optional alternative text for accessibility (only for `kind=file`).
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    MaterialCreate:
      type: object
      required: [title, body_md]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        body_md:
          type: string
          description: Markdown body authored by the teacher
    MaterialUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        body_md:
          type: string
          description: Markdown body authored by the teacher
          nullable: true
        alt_text:
          type: string
          description: Alternative text for file materials (ignored for markdown)
    MaterialReorder:
      type: object
      required: [material_ids]
      properties:
        material_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of material IDs for the given section
    MaterialUploadIntentRequest:
      type: object
      required: [filename, mime_type, size_bytes]
      properties:
        filename:
          type: string
          description: Original filename supplied by the teacher
        mime_type:
          type: string
          description: MIME type expected for the upload
        size_bytes:
          type: integer
          minimum: 1
          description: Declared file size in bytes
    MaterialUploadIntentResponse:
      type: object
      required: [intent_id, material_id, storage_key, url, headers, accepted_mime_types, max_size_bytes, expires_at]
      properties:
        intent_id:
          type: string
          format: uuid
        material_id:
          type: string
          format: uuid
        storage_key:
          type: string
          description: Storage key that must be used during upload
        url:
          type: string
          format: uri
          description: Pre-signed upload URL
        headers:
          type: object
          additionalProperties:
            type: string
          description: HTTP headers that must be included with the upload request
        accepted_mime_types:
          type: array
          items:
            type: string
          description: MIME types allowed for uploads
        max_size_bytes:
          type: integer
          minimum: 1
          description: Maximum allowed file size in bytes
        expires_at:
          type: string
          format: date-time
          description: ISO timestamp when the upload intent expires
    MaterialFileFinalizeRequest:
      type: object
      required: [intent_id, title, sha256]
      properties:
        intent_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        sha256:
          type: string
          description: Hex-encoded SHA-256 checksum of the uploaded file
          pattern: '^[0-9a-f]{64}$'
        alt_text:
          type: string
          description: Optional alternative text for accessibility
    MaterialDownloadUrlResponse:
      type: object
      required: [url, expires_at]
      properties:
        url:
          type: string
          format: uri
          description: Short-lived download URL
        expires_at:
          type: string
          format: date-time
          description: ISO timestamp when the download URL expires
    Task:
      type: object
      required: [id, unit_id, section_id, instruction_md, criteria, position, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        section_id:
          type: string
          format: uuid
        instruction_md:
          type: string
          minLength: 1
          description: Task instruction shown to students (Markdown)
        criteria:
          type: array
          items: { type: string }
          minItems: 0
          maxItems: 10
          description: Optional evaluation criteria; one line per item
        hints_md:
          type: string
          nullable: true
          description: Optional hints or solution scaffolding (Markdown)
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the section
        due_at:
          type: string
          format: date-time
          nullable: true
        max_attempts:
          type: integer
          minimum: 1
          nullable: true
        kind:
          type: string
          readOnly: true
          default: native
          description: >-
            Task type (forward-compat). MVP returns "native". This field is
            read-only and must not be provided by clients.
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    TaskCreate:
      type: object
      required: [instruction_md]
      properties:
        instruction_md:
          type: string
          minLength: 1
          description: Task instruction (Markdown)
        criteria:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 0
          maxItems: 10
          description: Optional evaluation criteria; one line per item
        hints_md:
          type: string
          nullable: true
          description: Optional hints or solution scaffolding (Markdown)
        due_at:
          type: string
          format: date-time
          nullable: true
        max_attempts:
          type: integer
          minimum: 1
          nullable: true
    TaskUpdate:
      type: object
      properties:
        instruction_md:
          type: string
          minLength: 1
        criteria:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 0
          maxItems: 10
        hints_md:
          type: string
          nullable: true
        due_at:
            type: string
            format: date-time
            nullable: true
        max_attempts:
          type: integer
          minimum: 1
          nullable: true
    TaskReorder:
      type: object
      required: [task_ids]
      properties:
        task_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of task IDs for the given section
    CourseModule:
      type: object
      required: [id, course_id, unit_id, position, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        course_id:
          type: string
          format: uuid
        unit_id:
          type: string
          format: uuid
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the course
        context_notes:
          type: string
          maxLength: 2000
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CourseModuleCreate:
      type: object
      required: [unit_id]
      properties:
        unit_id:
          type: string
          format: uuid
        context_notes:
          type: string
          maxLength: 2000
          nullable: true
    CourseModuleReorder:
      type: object
      required: [module_ids]
      properties:
        module_ids:
          type: array
          minItems: 1
          uniqueItems: true
          items:
            type: string
            format: uuid
          description: Desired order (1..n) of course_module IDs for the given course
    LearningSectionCore:
      type: object
      required: [id, title, position, unit_id]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        position:
          type: integer
          minimum: 1
          description: 1-based ordering within the course release
        unit_id:
          type: string
          format: uuid
          description: Identifier of the learning unit this section belongs to (for UI grouping/filtering).
    LearningMaterial:
      type: object
      required: [id, title, kind]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 200
        kind:
          type: string
          enum: [markdown, file]
        body_md:
          type: string
          description: Markdown content (only for materials with kind=markdown)
          nullable: true
        mime_type:
          type: string
          nullable: true
          description: MIME type for file materials (null for markdown)
        size_bytes:
          type: integer
          nullable: true
          minimum: 1
          description: Declared file size (bytes) for file materials
        filename_original:
          type: string
          nullable: true
          description: Original filename supplied by the author (files only)
        storage_key:
          type: string
          nullable: true
          description: Internal storage key used for download routing
        sha256:
          type: string
          nullable: true
          pattern: '^[0-9a-f]{64}$'
          description: Hash provided during upload (files only)
        alt_text:
          type: string
          nullable: true
          description: Alternative text supplied by teachers for accessibility
        position:
          type: integer
          nullable: true
          minimum: 1
          description: Ordering within the section
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
    LearningTask:
      type: object
      required: [id, instruction_md, criteria]
      properties:
        id:
          type: string
          format: uuid
        instruction_md:
          type: string
          minLength: 1
          description: Task instructions displayed to students
        criteria:
          type: array
          items:
            type: string
            minLength: 1
          maxItems: 10
          description: Evaluation criteria shown to the student
        hints_md:
          type: string
          nullable: true
        due_at:
          type: string
          format: date-time
          nullable: true
        max_attempts:
          type: integer
          minimum: 1
          nullable: true
        kind:
          type: string
          nullable: true
          description: Backend task type identifier (e.g., "native")
    LearningSection:
      type: object
      required: [section, materials, tasks]
      properties:
        section:
          $ref: '#/components/schemas/LearningSectionCore'
        materials:
          type: array
          items:
            $ref: '#/components/schemas/LearningMaterial'
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/LearningTask'
    LearningSubmission:
      type: object
      required: [id, attempt_nr, kind, analysis_status, created_at]
      properties:
        id:
          type: string
          format: uuid
        attempt_nr:
          type: integer
          minimum: 1
        kind:
          type: string
          enum: [text, image]
        text_body:
          type: string
          nullable: true
        mime_type:
          type: string
          nullable: true
        size_bytes:
          type: integer
          nullable: true
        storage_key:
          type: string
          nullable: true
        sha256:
          type: string
          nullable: true
          pattern: '^[0-9a-f]{64}$'
        analysis_status:
          type: string
          enum: [pending, completed, error]
        analysis_json:
          type: object
          nullable: true
          description: Synthetic or model-provided analysis payload; null while analysis is pending.
          required: [text, scores]
          additionalProperties: false
          properties:
            text:
              type: string
              description: Text that was analysed (submitted content or OCR output).
            length:
              type: integer
              minimum: 0
              description: Optional character count of the analysed text.
            scores:
              type: array
              description: Per-criterion scoring result shown to learners.
              items:
                type: object
                required: [criterion, score]
                additionalProperties: false
                properties:
                  criterion:
                    type: string
                    description: Display name of the rubric criterion.
                  score:
                    type: integer
                    minimum: 0
                    maximum: 10
                    description: Score between 0 and 10.
                  explanation:
                    type: string
                    nullable: true
                    description: Short explanation helping students understand the score.
          example:
            text: "Antwort 1"
            length: 9
            scores:
              - criterion: "Graph korrekt"
                score: 8
                explanation: "Stubbed analysis."
              - criterion: "Steigung erläutert"
                score: 9
                explanation: "Stubbed analysis."
        feedback:
          type: string
          nullable: true
          description: Human-readable formative feedback for the learner.
        error_code:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    LearningCourse:
      type: object
      required: [id, title]
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
        subject:
          type: string
          nullable: true
        grade_level:
          type: string
          nullable: true
        term:
          type: string
          nullable: true
    UnitPublic:
      type: object
      required: [id, title]
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        summary:
          type: string
          nullable: true

paths:
  /health:
    get:
      tags: [Operations]
      operationId: getHealth
      summary: Health check
      description: Lightweight readiness probe for orchestration and tests.
      security: []
      responses:
        '200':
          description: Service is healthy
          headers:
            Cache-Control:
              description: Security — not cacheable.
              schema:
                type: string
                example: no-store
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: healthy
  /api/learning/courses:
    get:
      tags: [Learning]
      summary: List courses for the current student (alphabetical)
      description: Returns courses where the authenticated student is a member, ordered by title asc with a stable secondary order by id asc.
      operationId: listLearningCourses
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: gustav_limited policies scope results to the authenticated student."
      x-permissions:
        requiredRole: student
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Student's courses ordered by title asc
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LearningCourse'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden — caller is not a student
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/learning/courses/{course_id}/sections:
    get:
      tags: [Learning]
      summary: List released sections for a course (student view)
      description: Returns only sections that were released to the authenticated student within the given course.
      operationId: listLearningSections
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: helper functions expose only sections released to the authenticated student."
      x-permissions:
        requiredRole: student
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: include
          style: form
          explode: false
          schema:
            type: string
            pattern: '^(materials|tasks)(,(materials|tasks))*$'
          description: 'Comma-separated list controlling embedded resources (supported: "materials", "tasks").'
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of sections to return.
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Offset for pagination.
      responses:
        '200':
          description: Released sections visible to the student.
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LearningSection'
        '400':
          description: Invalid input (e.g., malformed UUID or include parameter)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (student not enrolled in the course)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Course not found or sections not released
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/learning/courses/{course_id}/units:
    get:
      tags: [Learning]
      summary: List learning units of a course for the current student
      description: Requires membership in the course; returns units ordered by course module position.
      operationId: listLearningCourseUnits
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: course membership guard filters units per authenticated student."
      x-permissions:
        requiredRole: student
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Units of the course
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [unit, position]
                  properties:
                    unit:
                      $ref: '#/components/schemas/UnitPublic'
                    position:
                      type: integer
                      minimum: 1
        '400':
          description: Invalid UUID
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden — caller is not a student
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Course not found or not visible to the student
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/learning/courses/{course_id}/units/{unit_id}/sections:
    get:
      tags: [Learning]
      summary: List released sections of a unit for the current student
      description: Returns only sections released to the authenticated student within the given course and unit. Responds 200 with an array, which may be empty when no sections are released yet.
      operationId: listLearningUnitSections
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: student scope enforced via helper functions filtering visibility."
      x-permissions:
        requiredRole: student
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: include
          style: form
          explode: false
          schema:
            type: string
            pattern: '^(materials|tasks)(,(materials|tasks))*$'
          description: 'Comma-separated list controlling embedded resources (supported: "materials", "tasks").'
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of sections to return.
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Offset for pagination.
      responses:
        '200':
          description: Released sections of the unit visible to the student (may be empty).
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LearningSection'
        '400':
          description: Invalid input (e.g., malformed UUID or include parameter)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (student not enrolled in the course)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Course or unit not found, or unit does not belong to the course
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/teaching/courses/{course_id}/modules/{module_id}/sections/releases:
    get:
      tags: [Teaching]
      summary: List release states for sections in a course module (owner)
      description: Returns visibility records for sections attached to the specified module. Missing entries imply hidden sections.
      operationId: listModuleSectionReleases
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: course ownership enforced via gustav_limited policies."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: module_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Release state entries for the module (can be empty).
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [course_module_id, section_id, visible]
                  properties:
                    course_module_id:
                      type: string
                      format: uuid
                    section_id:
                      type: string
                      format: uuid
                    visible:
                      type: boolean
                    released_at:
                      type: string
                      nullable: true
                      description: RFC3339 UTC timestamp or null when hidden
                    released_by:
                      type: string
                      description: Teacher id (subject)
        '400':
          description: Invalid identifiers
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (caller is not the course owner)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Course/module not found or not visible to the owner
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/learning/courses/{course_id}/tasks/{task_id}/submissions:
    get:
      tags: [Learning]
      summary: List submissions for the current student (most recent first)
      description: Returns submissions created by the authenticated student for the specified task, newest first.
      operationId: listLearningSubmissions
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: submissions table enforces student ownership via policies."
      x-permissions:
        requiredRole: student
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: task_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of submissions to return (capped at 100).
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Offset to start listing submissions.
      responses:
        '200':
          description: Submissions visible to the student.
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LearningSubmission'
        '400':
          description: Invalid input (e.g., malformed UUID or pagination parameter)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (student not enrolled in the course)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Course or task not found, or not released to the student
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Learning]
      summary: Create a new submission for a task within a course
      description: >-
        Accepts text submissions directly or stores metadata for an already uploaded image.
        Duplicate requests can be avoided using the optional Idempotency-Key header.
        Security: Requests must be same-origin when sent from a browser; cross-site
        requests with a foreign `Origin` are rejected with 403. When `Origin` is
        absent (some browsers), the server falls back to validating the `Referer` origin.
      operationId: createLearningSubmission
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: policies ensure only the owning teacher can read the course."
      x-permissions:
        requiredRole: student
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: task_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
            maxLength: 64
            pattern: '^[A-Za-z0-9_-]{1,64}$'
          description: "Optional idempotency token to de-duplicate retries (ASCII token: letters, digits, underscore, hyphen; case-sensitive)."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  required: [kind, text_body]
                  properties:
                    kind:
                      type: string
                      enum: [text]
                    text_body:
                      type: string
                      minLength: 1
                      maxLength: 10000
                - type: object
                  required: [kind, storage_key, mime_type, size_bytes, sha256]
                  properties:
                    kind:
                      type: string
                      enum: [image]
                    storage_key:
                      type: string
                      minLength: 1
                    mime_type:
                      type: string
                      enum: ['image/jpeg', 'image/png']
                    size_bytes:
                      type: integer
                      minimum: 1
                    sha256:
                      type: string
                      pattern: '^[0-9a-f]{64}$'
      responses:
        '201':
          description: Submission created with synchronous feedback (MVP default).
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningSubmission'
        '400':
          description: Bad request (invalid_input | invalid_image_payload | max_attempts_exceeded | invalid_uuid)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (not enrolled or CSRF same-origin check failed)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not found
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    get:
      tags: [Auth]
      summary: Redirect to IdP login (Authorization Code Flow with PKCE)
      description: >-
        Redirects to the Keycloak authorization endpoint with PKCE. The server
        generates and manages the opaque `state` (CSRF) and a `nonce` (replay
        protection) for the OIDC flow; clients MUST NOT provide these values.
      operationId: startLogin
      parameters:
        - in: query
          name: redirect
          schema:
            type: string
            maxLength: 256
            pattern: '^/(?!.*//)(?!.*\\.\\.)[A-Za-z0-9._\-/]*$'
          description: >-
            Optional in-app absolute path to navigate to after login. External
            URLs are rejected; invalid values are ignored. Disallows double-slash
            and path traversal segments.
      responses:
        '302':
          description: Redirect to Keycloak authorization endpoint
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
            Location:
              description: Authorization URL at Keycloak
              schema:
                type: string
        '400':
          description: Invalid or expired request (e.g., stale state)
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many login attempts (rate limited)
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
            Retry-After:
              description: Seconds until another login attempt is accepted.
              schema:
                type: string
              example: "60"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                rate_limited:
                  summary: Rate limit enforced
                  value:
                    error: rate_limited
                    detail: retry_later


  /auth/callback:
    get:
      tags: [Auth]
      summary: OAuth2/OIDC callback from Keycloak
      description: Handles the authorization code, sets session cookie, and redirects.
      operationId: authCallback
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Session established, redirect to application page
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
            Set-Cookie:
              description: >-
                httpOnly session cookie `gustav_session`.
                Production: `HttpOnly; Secure; SameSite=strict`.
                Development/Test: `HttpOnly; SameSite=lax`.
                In production, `Max-Age` matches the server session TTL (default 3600 seconds).
              schema:
                type: string
            Location:
              description: In-app destination (e.g., "/" or a course page)
              schema:
                type: string
        '400':
          description: Invalid or expired code/state
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    get:
      tags: [Auth]
      summary: Logout (App session + IdP end-session)
      description: >-
        Clears the application session cookie and redirects to the Identity Provider's
        end-session endpoint. After IdP logout, the browser returns to the app start page.
      operationId: logoutUnified
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
            maxLength: 256
            pattern: '^/(?!.*//)(?!.*\\.\\.)[A-Za-z0-9._\-/]*$'
            default: "/auth/logout/success"
          description: >-
            App-relative absolute path (e.g., "/courses") to redirect to after IdP logout.
            External URLs are rejected and ignored. Disallows double-slash and path traversal.
            Defaults to "/auth/logout/success". Server enforces the same regex pattern.
      responses:
        '302':
          description: Redirect to IdP end-session endpoint (then back to the app)
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
            Set-Cookie:
              description: >-
                Clears the httpOnly session cookie `gustav_session` (expires it).
                Production: `HttpOnly; Secure; SameSite=strict; Max-Age=0`.
                Development/Test: `HttpOnly; SameSite=lax; Max-Age=0`.
              schema:
                type: string
            Location:
              description: IdP end-session endpoint URL
              schema:
                type: string

  /auth/logout/success:
    get:
      tags: [Auth]
      summary: Logout success page
      description: Shows a confirmation that the user has been logged out and links to /auth/login.
      responses:
        '200':
          description: HTML page confirming logout
          headers:
            Cache-Control:
              description: Security — responses must not be cached.
              schema:
                type: string
              example: no-store
          content:
            text/html:
              schema:
                type: string


  /auth/forgot:
    get:
      tags: [Auth]
      summary: Redirect to IdP forgot password page
      description: Redirect to Keycloak password reset page.
      operationId: forgotPassword
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill on the reset page.
      responses:
        '302':
          description: Redirect to Keycloak password reset page
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
              example: private, no-store
            Location:
              schema:
                type: string
        '429':
          description: Too many reset attempts from this client (rate limited)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
              example: private, no-store
            Retry-After:
              description: Seconds until another password reset redirect is allowed.
              schema:
                type: string
              example: "60"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                rate_limited:
                  summary: Password reset rate limit hit
                  value:
                    error: rate_limited
                    detail: retry_later


  /auth/register:
    get:
      tags: [Auth]
      summary: Redirect to IdP registration
      description: >-
        Redirects to Keycloak with `kc_action=register`. The server generates and
        includes a `nonce` parameter (replay protection) in the authorization request,
        analogous to `/auth/login`.
      operationId: startRegistration
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill in the registration form.
      responses:
        '302':
          description: Redirect to Keycloak registration page
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
              example: private, no-store
            Location:
              schema:
                type: string


  /api/me:
    get:
      tags: [Auth]
      summary: Return current user context
      description: Returns `sub`, `roles`, and display `name` if authenticated.
      operationId: getMe
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User context
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/teaching/courses:
    get:
      tags: [Teaching]
      summary: List courses for the current user
      description: >-
        Teachers see courses where they are the owner (teacher_id == sub).
        Students see courses where they are a member.
      operationId: listCourses
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of courses
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Course'
        '401':
          description: Unauthenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Teaching]
      summary: Create a course (teacher only)
      operationId: createCourse
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: ownership enforced; only the author can read this resource."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseCreate'
      responses:
        '201':
          description: Course created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_input (e.g., blank title or exceeds length limits)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_input:
                  summary: Invalid payload (e.g., blank title)
                  value:
                    error: bad_request
                    detail: invalid_input
        '401':
          description: Unauthenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (not a teacher)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/teaching/courses/{course_id}:
    get:
      tags: [Teaching]
      summary: Get a course by id (owner only)
      description: |
        Returns the course when the caller owns it. Responds 404 when the
        course does not exist and 403 when the caller is not the owner.
      operationId: getCourse
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Course
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_course_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    patch:
      tags: [Teaching]
      summary: Update a course (owner only)
      operationId: updateCourse
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: author-only policies scope sections to the calling teacher."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseUpdate'
      responses:
        '200':
          description: Updated course
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_field (e.g., blank title)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_field:
                  summary: Invalid field update
                  value:
                    error: bad_request
                    detail: invalid_field
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a course (owner only)
      description: |-
        Deletes a course when owned by the caller. Returns 404 when the course
        does not exist and 403 when the caller is not the owner. Response 204
        contains no content.
      operationId: deleteCourse
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: author-only policies limit task visibility to the owning teacher."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/members:
    get:
      tags: [Teaching]
      summary: List course members (owner only)
      description: |-
        Returns the roster only when the caller owns the course. Responds 404
        when the course does not exist and 403 when the caller is not the
        owner.
      operationId: listCourseMembers
      security:
        - cookieAuth: []
      x-security-notes:
        - "RLS: author-only policies control material visibility."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "RLS: course_memberships select returns rows only for the logged-in student (self-only)"
        - "Owner roster uses SECURITY DEFINER helper that verifies ownership server-side to avoid RLS recursion"
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseMember'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Add member (owner only, idempotent)
      description: |-
        Adds a student to the course. Responds 201 when created and 204 (no
        content) if the membership already exists. Responds 404 when the course
        does not exist and 403 when the caller is not the owner.
      operationId: addCourseMember
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [student_sub]
              properties:
                student_sub:
                  type: string
      responses:
        '201':
          description: Added
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '204':
          description: Already a member (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: |
            Invalid input. detail codes:
              - student_sub_required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                student_sub_required:
                  summary: student_sub missing or blank
                  value:
                    error: bad_request
                    detail: student_sub_required
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/members/{student_sub}:
    delete:
      tags: [Teaching]
      summary: Remove member (owner only, idempotent)
      description: |-
        Removes a student from the course; idempotent 204 (no content). 404
        when the course does not exist; 403 when the caller is not the owner.
      operationId: removeCourseMember
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: student_sub
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Removed or not present (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units:
    get:
      tags: [Teaching]
      summary: List learning units authored by the current teacher
      description: Returns only units where the caller is the author.
      operationId: listUnits
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of authored learning units
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Unit'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not a teacher), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create a learning unit
      operationId: createUnit
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnitCreate'
      responses:
        '201':
          description: Learning unit created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_title
              - invalid_summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_title:
                  summary: Title missing or exceeds limits
                  value:
                    error: bad_request
                    detail: invalid_title
                invalid_summary:
                  summary: Summary exceeds maximum length
                  value:
                    error: bad_request
                    detail: invalid_summary
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not a teacher), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}:
    get:
      tags: [Teaching]
      summary: Get a learning unit by id (author only)
      description: Returns the unit if the authenticated teacher is the author.
      operationId: getUnit
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Learning unit owned by the caller
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    patch:
      tags: [Teaching]
      summary: Update a learning unit (author only)
      operationId: updateUnit
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnitUpdate'
      responses:
        '200':
          description: Updated learning unit
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - empty_payload
              - invalid_title
              - invalid_summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                empty_payload:
                  summary: No fields supplied
                  value:
                    error: bad_request
                    detail: empty_payload
                invalid_title:
                  summary: Title violates validation
                  value:
                    error: bad_request
                    detail: invalid_title
                invalid_summary:
                  summary: Summary exceeds maximum length
                  value:
                    error: bad_request
                    detail: invalid_summary
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a learning unit (author only)
      description: Removes the unit and cascades linked course modules owned by the author.
      operationId: deleteUnit
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /api/teaching/units/{unit_id}/sections:
    get:
      tags: [Teaching]
      summary: List sections of a learning unit (author only)
      description: Returns sections sorted by ascending position for the unit's author.
      operationId: listSections
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of sections
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Section'
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create a section within a learning unit (author only)
      operationId: createSection
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionCreate'
      responses:
        '201':
          description: Section created at the next position
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Section'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}:
    patch:
      tags: [Teaching]
      summary: Update a section (author only)
      operationId: updateSection
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionUpdate'
      responses:
        '200':
          description: Updated section
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Section'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a section (author only)
      description: Removes the section and resequences remaining positions to 1..n.
      operationId: deleteSection
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_path_params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_path_params:
                  summary: Section id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_path_params
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/reorder:
    post:
      tags: [Teaching]
      summary: Reorder sections of a learning unit (author only)
      description: Atomically updates positions based on the provided section order.
      operationId: reorderSections
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
        - "Transactional update with row locks ensures contiguous positions without duplicates."
        - "Check author ownership before validating payload to avoid error-oracle leakage."
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionReorder'
      responses:
        '200':
          description: Sections reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Section'
        '400':
          description: |
            Invalid section list. detail codes:
              - invalid_unit_id
              - section_ids_must_be_array
              - empty_section_ids
              - duplicate_section_ids
              - invalid_section_ids
              - section_mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_section_ids:
                  summary: Section ids contain duplicates
                  value:
                    error: bad_request
                    detail: duplicate_section_ids
                invalid_section_ids:
                  summary: Section ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_section_ids
                section_mismatch:
                  summary: Payload ids do not match current unit sections
                  value:
                    error: bad_request
                    detail: section_mismatch
                empty_section_ids:
                  summary: Submitted section id array is empty
                  value:
                    error: bad_request
                    detail: empty_section_ids
                section_ids_must_be_array:
                  summary: Submitted section_ids is not an array
                  value:
                    error: bad_request
                    detail: section_ids_must_be_array
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/tasks:
    get:
      tags: [Teaching]
      summary: List tasks of a section (author only)
      description: Returns tasks sorted by ascending position for the section's author.
      operationId: listSectionTasks
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of tasks
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value: { error: bad_request, detail: invalid_unit_id }
                invalid_section_id:
                  summary: Section id not a UUID
                  value: { error: bad_request, detail: invalid_section_id }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create a task in a section (author only)
      operationId: createSectionTask
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: |
            Invalid input or path. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_instruction_md
              - invalid_criteria
              - invalid_due_at
              - invalid_max_attempts
              - invalid_hints_md
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                invalid_unit_id: { value: { error: bad_request, detail: invalid_unit_id } }
                invalid_section_id: { value: { error: bad_request, detail: invalid_section_id } }
                invalid_instruction_md: { value: { error: bad_request, detail: invalid_instruction_md } }
                invalid_criteria: { value: { error: bad_request, detail: invalid_criteria } }
                invalid_due_at: { value: { error: bad_request, detail: invalid_due_at } }
                invalid_max_attempts: { value: { error: bad_request, detail: invalid_max_attempts } }
                invalid_hints_md: { value: { error: bad_request, detail: invalid_hints_md } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/tasks/{task_id}:
    patch:
      tags: [Teaching]
      summary: Update a task (author only)
      operationId: updateSectionTask
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: task_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Updated task
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: |
            Invalid input or path. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_task_id
              - empty_payload
              - invalid_instruction_md
              - invalid_criteria
              - invalid_due_at
              - invalid_max_attempts
              - invalid_hints_md
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                invalid_unit_id: { value: { error: bad_request, detail: invalid_unit_id } }
                invalid_section_id: { value: { error: bad_request, detail: invalid_section_id } }
                invalid_task_id: { value: { error: bad_request, detail: invalid_task_id } }
                empty_payload: { value: { error: bad_request, detail: empty_payload } }
                invalid_instruction_md: { value: { error: bad_request, detail: invalid_instruction_md } }
                invalid_criteria: { value: { error: bad_request, detail: invalid_criteria } }
                invalid_due_at: { value: { error: bad_request, detail: invalid_due_at } }
                invalid_max_attempts: { value: { error: bad_request, detail: invalid_max_attempts } }
                invalid_hints_md: { value: { error: bad_request, detail: invalid_hints_md } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Task not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a task (author only)
      operationId: deleteSectionTask
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: task_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_task_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id: { value: { error: bad_request, detail: invalid_unit_id } }
                invalid_section_id: { value: { error: bad_request, detail: invalid_section_id } }
                invalid_task_id: { value: { error: bad_request, detail: invalid_task_id } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Task not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/tasks/reorder:
    post:
      tags: [Teaching]
      summary: Reorder tasks of a section (author only)
      description: Atomically updates positions based on the provided task order.
      operationId: reorderSectionTasks
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskReorder'
      responses:
        '200':
          description: Tasks reordered
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '400':
          description: |
            Invalid path or task list. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - task_ids_must_be_array
              - empty_task_ids
              - duplicate_task_ids
              - invalid_task_ids
              - task_mismatch
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                invalid_unit_id: { value: { error: bad_request, detail: invalid_unit_id } }
                invalid_section_id: { value: { error: bad_request, detail: invalid_section_id } }
                task_ids_must_be_array: { value: { error: bad_request, detail: task_ids_must_be_array } }
                empty_task_ids: { value: { error: bad_request, detail: empty_task_ids } }
                duplicate_task_ids: { value: { error: bad_request, detail: duplicate_task_ids } }
                invalid_task_ids: { value: { error: bad_request, detail: invalid_task_ids } }
                task_mismatch: { value: { error: bad_request, detail: task_mismatch } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials:
    get:
      tags: [Teaching]
      summary: List materials of a section (author only)
      description: Returns materials sorted by ascending position for the section's author.
      operationId: listSectionMaterials
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of materials
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_unit_id:
                  summary: Unit id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_unit_id
                invalid_section_id:
                  summary: Section id not a UUID
                  value:
                    error: bad_request
                    detail: invalid_section_id
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Create material within a section (author only)
      operationId: createSectionMaterial
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialCreate'
      responses:
        '201':
          description: Material created at the next position
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_title
              - invalid_body_md
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/{material_id}:
    patch:
      tags: [Teaching]
      summary: Update a material (author only)
      operationId: updateSectionMaterial
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialUpdate'
      responses:
        '200':
          description: Updated material
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
              - invalid_title
              - invalid_body_md
              - invalid_alt_text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_title:
                  summary: Title provided but empty or too long
                  value:
                    error: bad_request
                    detail: invalid_title
                empty_payload:
                  summary: No fields were provided in the PATCH body
                  value:
                    error: bad_request
                    detail: empty_payload
                invalid_alt_text:
                  summary: Alt text provided but too long
                  value:
                    error: bad_request
                    detail: invalid_alt_text
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      tags: [Teaching]
      summary: Delete a material (author only)
      description: Removes the material and resequences remaining positions to 1..n.
      operationId: deleteSectionMaterial
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted (no content)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: |
            Invalid path. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '502':
          description: Upstream storage deletion failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                storage_delete_failed:
                  summary: Storage deletion failed and manual cleanup is required
                  value:
                    error: bad_gateway
                    detail: storage_delete_failed
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/reorder:
    post:
      tags: [Teaching]
      summary: Reorder materials of a section (author only)
      description: Atomically updates positions based on the provided material order.
      operationId: reorderSectionMaterials
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
        - "Transactional update with row locks ensures contiguous positions without duplicates."
        - "Check author ownership before validating payload to avoid error-oracle leakage."
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialReorder'
      responses:
        '200':
          description: Materials reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid material list. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - material_ids_must_be_array
              - empty_material_ids
              - duplicate_material_ids
              - invalid_material_ids
              - material_mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_material_ids:
                  summary: Material ids contain duplicates
                  value:
                    error: bad_request
                    detail: duplicate_material_ids
                invalid_material_ids:
                  summary: Material ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_material_ids
                material_mismatch:
                  summary: Payload ids do not match current section materials
                  value:
                    error: bad_request
                    detail: material_mismatch
                empty_material_ids:
                  summary: Submitted material id array is empty
                  value:
                    error: bad_request
                    detail: empty_material_ids
                material_ids_must_be_array:
                  summary: Submitted material_ids is not an array
                  value:
                    error: bad_request
                    detail: material_ids_must_be_array
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/upload-intents:
    post:
      tags: [Teaching]
      summary: Create upload intent for file material (author only)
      operationId: createSectionMaterialUploadIntent
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialUploadIntentRequest'
      responses:
        '200':
          description: Upload intent created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaterialUploadIntentResponse'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_filename
              - mime_not_allowed
              - size_exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_filename:
                  summary: Filename becomes empty after sanitizing
                  value:
                    error: bad_request
                    detail: invalid_filename
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit or section not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/finalize:
    post:
      tags: [Teaching]
      summary: Finalize upload intent (author only)
      operationId: finalizeSectionMaterialUpload
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaterialFileFinalizeRequest'
      responses:
        '201':
          description: File material created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '200':
          description: Upload intent already finalized (idempotent)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Material'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_intent_id
              - intent_expired
              - checksum_mismatch
              - invalid_title
              - mime_not_allowed
              - invalid_alt_text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                intent_expired:
                  summary: Upload intent is no longer valid
                  value:
                    error: bad_request
                    detail: intent_expired
                mime_not_allowed:
                  summary: Uploaded object has a MIME type outside the whitelist
                  value:
                    error: bad_request
                    detail: mime_not_allowed
                invalid_alt_text:
                  summary: Alt text exceeds the permitted length
                  value:
                    error: bad_request
                    detail: invalid_alt_text
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (intent does not belong to caller), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Unit, section, or intent not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/units/{unit_id}/sections/{section_id}/materials/{material_id}/download-url:
    get:
      tags: [Teaching]
      summary: Generate download URL for file material (author only)
      operationId: getSectionMaterialDownloadUrl
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        authorOnly: true
      parameters:
        - in: path
          name: unit_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: material_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: disposition
          required: false
          schema:
            type: string
            enum: [inline, attachment]
          description: Desired `Content-Disposition`; defaults to `attachment`.
      responses:
        '200':
          description: Short-lived download URL returned
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaterialDownloadUrlResponse'
        '400':
          description: |
            Invalid input. detail codes:
              - invalid_unit_id
              - invalid_section_id
              - invalid_material_id
              - invalid_disposition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_disposition:
                  summary: Disposition is not 'inline' or 'attachment'
                  value:
                    error: bad_request
                    detail: invalid_disposition
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Material not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '503': { description: Service unavailable (storage not configured), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules:
    get:
      tags: [Teaching]
      summary: List course modules (owner only)
      description: Returns modules in ascending position for the course owner.
      operationId: listCourseModules
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "RLS: course_modules policies verify ownership via course_exists_for_owner helper"
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Course modules ordered by position
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseModule'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    post:
      tags: [Teaching]
      summary: Add a learning unit to a course (owner only)
      description: Creates a course module at the next position using a unit authored by the caller.
      operationId: createCourseModule
      security:
        - cookieAuth: []
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseModuleCreate'
      responses:
        '201':
          description: Course module created
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseModule'
        '400': { description: Invalid input, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner or not the unit author), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course or unit not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '409': { description: Unit already attached to this course, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules/reorder:
    post:
      tags: [Teaching]
      summary: Reorder course modules (owner only)
      description: Replaces positions atomically based on the provided module order.
      operationId: reorderCourseModules
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
        - "Transactional update ensures no duplicate positions and preserves contiguous order."
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseModuleReorder'
      responses:
        '200':
          description: Modules reordered successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseModule'
        '400':
          description: |
            Invalid module list. detail codes:
              - invalid_course_id
              - duplicate_module_ids
              - invalid_module_ids
              - empty_reorder
              - module_mismatch
              - no_modules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate_module_ids:
                  summary: Duplicate ids submitted
                  value:
                    error: bad_request
                    detail: duplicate_module_ids
                module_mismatch:
                  summary: Payload ids do not match current modules
                  value:
                    error: bad_request
                    detail: module_mismatch
                empty_reorder:
                  summary: Submitted array is empty
                  value:
                    error: bad_request
                    detail: empty_reorder
                invalid_module_ids:
                  summary: Submitted ids include a non-UUID value
                  value:
                    error: bad_request
                    detail: invalid_module_ids
                no_modules:
                  summary: Course has no modules to reorder
                  value:
                    error: bad_request
                    detail: no_modules
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Course or module not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules/{module_id}:
    delete:
      tags: [Teaching]
      summary: Remove a unit from a course (owner only)
      description: Deletes a course module and resequences remaining positions contiguously.
      operationId: deleteCourseModule
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
        - "Transactional delete + resequence; RLS enforces ownership via course_modules policies."
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: module_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Module removed
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
        '400':
          description: "Invalid identifiers (detail: invalid_course_id | invalid_module_id)"
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden (not the owner), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Module not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/teaching/courses/{course_id}/modules/{module_id}/sections/{section_id}/visibility:
    patch:
      tags: [Teaching]
      summary: Update section visibility within a course module (owner only)
      description: |
        Sets whether a section is released to students enrolled in the course.
        Security: When called from a browser, requests must be same-origin; a foreign
        `Origin` or `Referer` results in 403 with `detail=csrf_violation`.
      operationId: updateModuleSectionVisibility
      security:
        - cookieAuth: []
      x-permissions:
        requiredRole: teacher
        ownerOnly: true
      x-security-notes:
        - "RLS: module_section_releases table joins course_modules to enforce owner checks."
        - "CSRF: Same-origin required (Origin/Referer must match server origin)."
      parameters:
        - in: path
          name: course_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: module_id
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: section_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModuleSectionVisibilityUpdate'
      responses:
        '200':
          description: Visibility state updated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
              example: private, no-store
            Vary:
              description: Security — responses vary by request Origin for CSRF enforcement.
              schema:
                type: string
              example: Origin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModuleSectionVisibility'
              examples:
                released:
                  summary: Section released to students
                  value:
                    course_module_id: "11111111-1111-1111-1111-111111111111"
                    section_id: "22222222-2222-2222-2222-222222222222"
                    visible: true
                    released_at: "2025-10-22T12:00:00+00:00"
                    released_by: "teacher-123"
                hidden:
                  summary: Section hidden from students
                  value:
                    course_module_id: "11111111-1111-1111-1111-111111111111"
                    section_id: "22222222-2222-2222-2222-222222222222"
                    visible: false
                    released_at: null
                    released_by: "teacher-123"
        '400':
          description: "Invalid identifiers or payload (detail: invalid_course_id | invalid_module_id | invalid_section_id | missing_visible | invalid_visible_type)"
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthenticated
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Forbidden (not the course owner or CSRF violation)
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: |
            Course, module, or section not found within the module.
            detail codes:
              - module_not_found
              - section_not_in_module
          headers:
            Cache-Control:
              description: Security — responses are private and not cacheable by shared caches.
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/search:
    get:
      tags: [Users]
      summary: Search users by name
      description: Teachers/Admins search for students by display name; returns sub and name.
      operationId: searchUsers
      security:
        - cookieAuth: []
      x-permissions:
        requiredRoles: [teacher, admin]
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 2
        - in: query
          name: role
          required: true
          schema:
            $ref: '#/components/schemas/Role'
          description: Filter by role (e.g., student)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: Results
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [sub, name]
                  properties:
                    sub: { type: string }
                    name: { type: string }
        '400':
          description: |
            Invalid query. detail codes:
              - q_too_short
              - invalid_role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                q_too_short:
                  summary: Query shorter than 2 characters
                  value:
                    error: bad_request
                    detail: q_too_short
                invalid_role:
                  summary: Unsupported role filter
                  value:
                    error: bad_request
                    detail: invalid_role
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /api/users/list:
    get:
      tags: [Users]
      summary: List users by role
      description: Teachers/Admins list users by role; returns sub and name for pagination and UI population.
      operationId: listUsers
      security:
        - cookieAuth: []
      x-permissions:
        requiredRoles: [teacher, admin]
      parameters:
        - in: query
          name: role
          required: true
          schema:
            $ref: '#/components/schemas/Role'
          description: Filter by role (e.g., student)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Results
          headers:
            Cache-Control:
              description: Security — responses must not be cached
              schema:
                type: string
                example: private, no-store
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [sub, name]
                  properties:
                    sub: { type: string }
                    name: { type: string }
        '400':
          description: |
            Invalid query. detail codes:
              - invalid_role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthenticated, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
