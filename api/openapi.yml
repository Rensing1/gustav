openapi: 3.0.3
info:
  title: GUSTAV API
  version: 0.1.0
  description: >-
    Contract-first API for minimal authentication/session integration with Keycloak.
    Endpoints cover login redirect, callback handling, logout, session info, and a
    convenience redirect for "forgot password". Sessions are represented by an
    httpOnly cookie.

servers:
  - url: /

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: gustav_session
  schemas:
    Role:
      type: string
      enum: [student, teacher, admin]
    Me:
      type: object
      required: [email, roles]
      properties:
        email:
          type: string
          format: email
        roles:
          type: array
          items:
            $ref: '#/components/schemas/Role'
        email_verified:
          type: boolean
          description: Whether the email address has been verified.
        expires_at:
          type: string
          format: date-time
          description: Session expiration timestamp (optional).
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
        detail:
          type: string

paths:
  /auth/login:
    get:
      tags: [Auth]
      summary: Render login form or redirect to IdP
      description: |
        Returns an HTML login form (feature-flagged in DEV/CI) or redirects to
        the Keycloak authorization endpoint (default in PROD). Both behaviors
        are valid depending on deployment configuration.
      operationId: startLogin
      parameters:
        - in: query
          name: state
          schema:
            type: string
          description: >-
            Optional opaque state token used for CSRF protection and QR-context.
            Created and validated server-side.
        - in: query
          name: redirect
          schema:
            type: string
            pattern: '^/[A-Za-z0-9_\-/]*$'
          description: Optional in-app path to navigate to after login.
      responses:
        '200':
          description: HTML login form with CSRF
          headers:
            Set-Cookie:
              description: CSRF cookie `gustav_csrf` for Double-Submit (DEV/CI)
              schema:
                type: string
          content:
            text/html:
              schema:
                type: string
        '302':
          description: Redirect to Keycloak authorization endpoint
          headers:
            Location:
              description: Authorization URL at Keycloak
              schema:
                type: string
    post:
      tags: [Auth]
      summary: Submit credentials (feature-flagged in DEV/CI)
      description: |
        Accepts form credentials and, when enabled, exchanges them via IdP to
        establish a session. In PROD, this route may be disabled in favor of
        redirect-based login.
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [email, password, csrf_token]
              properties:
                email: { type: string, format: email }
                password: { type: string }
                redirect: { type: string }
                csrf_token: { type: string }
      responses:
        '303':
          description: Login success, session cookie set
          headers:
            Location: { schema: { type: string } }
            Set-Cookie:
              description: httpOnly session cookie `gustav_session`
              schema:
                type: string
        '400': { description: Invalid credentials or policy violation }
        '403': { description: CSRF invalid or route disabled }

  /auth/callback:
    get:
      tags: [Auth]
      summary: OAuth2/OIDC callback from Keycloak
      description: Handles the authorization code, sets session cookie, and redirects.
      operationId: authCallback
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Session established, redirect to application page
          headers:
            Set-Cookie:
              description: >-
                httpOnly session cookie `gustav_session`.
                Production: `HttpOnly; Secure; SameSite=strict`.
                Development/Test: `HttpOnly; SameSite=lax`.
              schema:
                type: string
            Location:
              description: In-app destination (e.g., "/" or a course page)
              schema:
                type: string
        '400':
          description: Invalid or expired code/state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout and clear session cookie
      description: Invalidates the current session and clears the cookie.
      operationId: logout
      security:
        - cookieAuth: []
      responses:
        '204':
          description: Session terminated, cookie cleared
          headers:
            Set-Cookie:
              description: >-
                Expires the httpOnly session cookie `gustav_session`.
                Production: `HttpOnly; Secure; SameSite=strict; Max-Age=0`.
                Development/Test: `HttpOnly; SameSite=lax; Max-Age=0`.
              schema:
                type: string

  /auth/forgot:
    get:
      tags: [Auth]
      summary: Render forgot form or redirect to IdP
      description: HTML form (DEV/CI) or redirect to IdP reset page (PROD).
      operationId: forgotPassword
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill on the reset page.
      responses:
        '200':
          description: HTML forgot form with CSRF
          headers:
            Set-Cookie:
              description: CSRF cookie `gustav_csrf` for Double-Submit (DEV/CI)
              schema:
                type: string
          content:
            text/html:
              schema: { type: string }
        '302':
          description: Redirect to Keycloak password reset page
          headers:
            Location:
              schema:
                type: string
    post:
      tags: [Auth]
      summary: Trigger password reset (feature-flagged in DEV/CI)
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [email, csrf_token]
              properties:
                email: { type: string, format: email }
                csrf_token: { type: string }
      responses:
        '202':
          description: Reset mail triggered (neutral)
          content:
            application/json:
              schema:
                type: object
                required: [message]
                properties:
                  message: { type: string }
        '403': { description: CSRF invalid or route disabled }

  /auth/register:
    get:
      tags: [Auth]
      summary: Render registration form or redirect to IdP
      description: HTML form (DEV/CI) or redirect to IdP registration page (PROD).
      operationId: startRegistration
      parameters:
        - in: query
          name: login_hint
          schema:
            type: string
            format: email
          description: Optional email to prefill in the registration form.
      responses:
        '200':
          description: HTML registration form with CSRF
          headers:
            Set-Cookie:
              description: CSRF cookie `gustav_csrf` for Double-Submit (DEV/CI)
              schema:
                type: string
          content:
            text/html:
              schema:
                type: string
        '302':
          description: Redirect to Keycloak registration page
          headers:
            Location:
              schema:
                type: string
    post:
      tags: [Auth]
      summary: Create user account (feature-flagged in DEV/CI)
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [email, password, csrf_token]
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                display_name: { type: string }
                csrf_token: { type: string }
      responses:
        '303':
          description: Account created; redirect to login (with login_hint)
          headers:
            Location: { schema: { type: string } }
        '400': { description: Validation error or duplicate }
        '403': { description: CSRF invalid or route disabled }
        '500': { description: Role assignment failed }

  /api/me:
    get:
      tags: [Auth]
      summary: Return current user session info
      description: Returns email and roles if authenticated.
      operationId: getMe
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Session info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
