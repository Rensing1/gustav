# Changelog

## Unreleased
- db(teaching): Make `module_section_releases.released_by` NOT NULL with backfill to 'system'.
- feat(api/teaching): Add PATCH /api/teaching/courses/{course_id}/modules/{module_id}/sections/{section_id}/visibility to toggle section releases (owner-only), with explicit 400 detail codes.
- db(teaching): Add `public.module_section_releases` table with RLS (owner-only via course_modules ↔ courses join); upsert semantics for visibility.
- db(teaching): Add CHECK constraint ensuring `released_at` matches `visible` (NOT NULL when true, NULL when false).
- docs(openapi/db): Document ModuleSectionVisibility schemas and endpoint in references; database schema updated accordingly.
- docs(openapi): Add 503 `service_unavailable` to file-materials endpoints (upload-intents, finalize, download-url, delete) when storage is not configured.
- security(api/teaching): Mark download-url responses `Cache-Control: no-store` (short-lived, non-cacheable URLs).
- env(auth): Prefer `KC_BASE_URL` (accept legacy `KC_BASE`); `.env.example` and docs updated.
- feat(storage): Respect `SUPABASE_STORAGE_BUCKET` env for MaterialFileSettings (default `materials`).
- fix(api/openapi): Move 502 storage_delete_failed example from PATCH to DELETE /materials; align with runtime behavior.
- fix(api/teaching): Delete storage first, then DB, to avoid orphaned objects when storage deletion fails (returns 502).
- db(materials): Strengthen SHA-256 CHECK (regex ^[0-9a-f]{64}$) via migration; improves data integrity.
- fix(teaching): Finalize accepts parameterized Content-Type from storage HEAD (e.g., "application/pdf; charset=UTF-8").
- docs(openapi): Add regex pattern for `sha256` (^[0-9a-f]{64}$) in `MaterialFileFinalizeRequest`.
- tests(teaching): Add test ensuring finalize accepts Content-Type with parameters.
- fix(teaching): In-memory course repo now mirrors DB validation (reject blank titles) to keep fallback in contract.
- security(api/users): User search responses send Cache-Control: no-store to prevent caching of roster data.
- chore(git): Explicitly ignore backend web __pycache__ directories (root-owned artifacts from previous builds).
- fix(api/teaching): Route-level sha256 validation returns 400 checksum_mismatch (avoid FastAPI 422); relaxed Pydantic length to defer to server checks.
- tests(teaching): Add tests for invalid sha256 pattern and content-length mismatch (deletes object + 400 checksum_mismatch).
- fix(api/teaching): Validate download `disposition` at route-level (400 invalid_disposition) and normalize before calling service.
- docs(openapi): Add 400 example for `invalid_disposition` in download-url endpoint.
- fix(api/teaching): PATCH materials treats provided empty title as `invalid_title` (was `empty_payload`).
- consistency(api/teaching): GET materials returns explicit JSONResponse (200) for uniform response shape.
- docs(openapi): Add `empty_payload` example to materials PATCH 400 section.
- consistency(api/teaching): Align error detail strings — use `invalid_module_ids` (plural) and map no-sections case to `section_mismatch` in DB repo.
- security(api/teaching): Move author/owner guards before payload validation in Unit/Section PATCH to avoid error‑oracle leakage (403/404 precede 400 empty_payload).
- fix(teaching): Implement sections CRUD/reorder in in‑memory repo to avoid 500s in dev/tests without Postgres; add smoke test.
- fix(api/teaching): Return explicit JSONResponse (200) from sections/modules reorder for consistent API shape.
- security(api/teaching): Check course ownership before deep payload validation in modules reorder to reduce error‑oracle leakage (403/404 precede 400 list errors).
- security(api/teaching): Mirror early authorship guard for sections reorder to reduce error‑oracle leakage.
- docs(openapi): Add 400 examples for modules reorder (empty_reorder, invalid_module_ids, no_modules) and sections reorder (section_mismatch).
  Also add sections: empty_section_ids, section_ids_must_be_array examples.
- fix(api/openapi): Correct DELETE /api/teaching/units/{unit_id} path placement (remove stray delete under sections/reorder); units PATCH uses authorOnly permissions.
- fix(api/teaching): Validate course_id UUID in POST /api/teaching/courses/{course_id}/modules/reorder (400 bad_request on invalid path param).
- fix(api/teaching): Allow PATCH /materials to update `alt_text`, returning `invalid_alt_text` on violations; keeps markdown/body guards intact.
- security(teaching): Sanitize storage-key path segments (author/unit/section/material) before presign/finalize to avoid path traversal on S3-compatible backends; in-memory repo gained full file-material workflow.
- docs(openapi/db): Document new error details (`invalid_filename`, `mime_not_allowed`, `invalid_alt_text`) and storage-key sanitizing; contract examples extended.
 - feat(storage): Add SupabaseStorageAdapter with unit tests, service/route fallbacks, and optional app wiring via env vars (no API changes).
 - docs(ops): Add storage and gateway reference with CLI steps and .env template; plan doc for storage integration; architecture updated with Storage section.
- tests(teaching): Extend file-material contract tests for invalid filenames, uppercase MIME normalization, size limit, expired intents, alt-text updates and in-memory fallback coverage.
- fix(db/sections): Serialize concurrent section creation by locking parent unit; add one-shot retry on unique violation; regression tests added.
- fix(db/sections): Ensure unique-violation retry fetches the inserted row before the cursor closes; regression test guards against cursor-already-closed errors.
- security(teaching): Enforce limited-role DSN (gustav_limited) for TeachingRepo to guarantee RLS coverage; add override flag `ALLOW_SERVICE_DSN_FOR_TESTING` for dev only.
- fix(teaching): Correct HTTP semantics — 204 responses without body; align 404 vs 403 for members and delete endpoints with contract.
- feat(db): Add SECURITY DEFINER helpers `public.course_exists_for_owner` and `public.course_exists` via Supabase migration to disambiguate 404 (not found) from 403 (forbidden) safely.
- perf(teaching): Avoid blocking event loop during name resolution by offloading sync directory requests to a thread; foundation for future async/batch lookup.
- tests: Add DSN enforcement tests and optional existence-helper tests; strengthen assertions for 204 no-content responses.
- fix(api/teaching): PATCH /api/teaching/courses/{id} returns explicit JSONResponse (200) for consistent response shape.
- security(ops): /health responses include `Cache-Control: no-store` to prevent caching of diagnostics.
- test(auth): Add smoke test for `/auth/logout/success` (200 + back-to-login link).
- chore(auth): Remove deprecated `_cookie_opts` wrapper in auth routes; use shared `auth_utils.cookie_opts`.

## 2025-10-20
- Teaching (Unterrichten) — Kursmanagement (MVP)
  - OpenAPI erweitert: `Course`, `CourseCreate`, `CourseUpdate`, `CourseMember`
  - Endpunkte: Kurse (create/list/update/delete), Mitglieder (add/list/remove), Users‑Suche
  - Migration: `courses`, `course_memberships`, `pgcrypto`, `updated_at`‑Trigger, RLS
  - DB‑Repo (psycopg3) implementiert; Router standardmäßig DB bzw. Fallback In‑Memory in Tests
  - Tests: API‑Coverage und optionaler Repo‑Test (skip bei fehlender DB)
