# Changelog

## Unreleased
### Security
 - security(teaching): Bind `remove_course_membership` authorization to session (`app.current_sub`).
   Requires `p_owner` to equal the session subject and to own the course; prevents owner spoofing.
   Adds regression test.
- security(identity): Disable HTTP redirects for Keycloak admin POST/GET calls (prevent token leakage via 3xx).
- security(teaching): Owner-scoped GETs for module sections/releases set `Vary: Origin` across 200/4xx.
- security(api/teaching): PATCH /api/teaching/.../sections/{section_id}/visibility now strictly requires
  Origin/Referer and same-origin. Missing or foreign headers → 403 `detail=csrf_violation`. SSR helper forwards
  an Origin header to remain compatible.
- mask(import): DSN is no longer logged or persisted in migration reports; prevents credential leakage.
- csrf(submissions): In production, POST /submissions always requires Origin/Referer (strict same-origin), independent of STRICT_CSRF_SUBMISSIONS.

### API
- api(operations): Clarify LearningWorker health checks schema; remove unused `metrics_scope` value from `LearningWorkerHealthCheck` enum.
- api(operations): Add `GET /internal/health/learning-worker` returning private, no-store health diagnostics (200 healthy / 503 degraded). Requires teacher or operator role.
- api(teaching/members): Apply sensible default paging limits and improve search/roster endpoints; SSR adjusted accordingly.
- api(teaching/live): Align detail/unit endpoints and SSR rendering with stricter semantics and improved payloads.
- api(learning): Align submission handlers with contract (request/response shape and headers) for student submissions UI.
- openapi: Update Learning and Operations endpoints in `api/openapi.yml` (schemas and paths).
- api(teaching): GET /api/teaching/courses/{course_id}/modules/{module_id}/sections responds with `Vary: Origin` and
  clamps `position` to a minimum of 1 (schema compliance).
- api(teaching): GET /api/teaching/courses/{course_id}/modules/{module_id}/sections/releases documents `Vary: Origin`.
- api(teaching/live): Neue Delta‑Route `GET /api/teaching/courses/{course_id}/units/{unit_id}/submissions/delta` für Polling‑basierte Live‑Aktualisierung auf Einheitenebene. Antwort `200 { cells: [...] }` oder `204` bei keinen Änderungen. `changed_at` ist UTC/ISO mit Mikrosekunden.
- api(teaching/live): `GET /…/submissions/summary` akzeptiert `include_students=false`, um nur die Aufgabenliste zu laden (UI‑Optimierung beim Start).
- docs(teaching/live): Referenzdokumentation unter `docs/references/teaching_live.md` hinzugefügt (Cursor‑Semantik mit EPS‑Fenster, Client‑Polling‑Empfehlung).
- openapi(learning): Document 404 for POST /api/learning/courses/{course_id}/tasks/{task_id}/upload-intents (task not found/not released).

### Database
- db(learning-worker): Introduce async job queue with leasing/status checks and retry semantics (Supabase migrations).
- db(learning-worker): Add dedicated worker role and health‑probe columns.
- db(learning): Enforce submissions idempotency (unique constraint) to avoid duplicate processing.

### Tooling & Dev
- dev(ops): Add worker modules and operations route, wire up in `docker-compose.yml` and `Makefile`.
- dev(sql): Update `scripts/dev/create_login_user.sql` for local bootstrap.

### Docs
- docs(plan): Add security plan for membership removal + health probe hardening.
- docs(learning): Update references for Learning and AI modules; add planning note for course member search fix.

### Tests
- tests(learning-worker): Add health endpoint coverage, job execution flow, and security role checks.
- tests(teaching/members): Add default limit, candidates limit, roster limit, remove‑persistence, and global search tests.
- tests(teaching/live): Update/extend live detail and unit SSR/API tests.
- tests(learning): Add API contract alignment tests and student submissions UI coverage; add idempotency header cases and storage verification.
- tests(migration): Adjust legacy submissions migration test after tooling updates.
- tests(teaching): Header tests ensure `Vary: Origin` for 200/400/403/404 on module sections and releases listings.
- tests(teaching/live): Delta‑Tests prüfen 401/403/404/400 sowie den Happy‑Path „200 dann 204“ mit Cursor‑Fortschreibung.
- add(learning): Idempotency-Key header regex negative/positive tests.
- add(learning): Production CSRF strictness test for /submissions.
- security(api/learning): Upload-Intents verlangen nun zwingend `Origin`/`Referer` (strict same-origin). Fehlende Header führen zu 403 `detail=csrf_violation`.
- security(api/learning): Submissions unterstützen optional strikte CSRF-Policy: `STRICT_CSRF_SUBMISSIONS=true` verlangt `Origin`/`Referer` (ohne Header → 403 `csrf_violation`). Dev-Default bleibt tolerant.
 - security(api/learning): Optionale Integritätsprüfung bei Abgaben (Größe + sha256) gegen `STORAGE_VERIFY_ROOT`; erzwingbar via `REQUIRE_STORAGE_VERIFY=true`.
 - openapi(learning): 400-Fehler für Abgaben dokumentieren zusätzlich `invalid_file_payload`; Upload-Intents 400/401/403 enthalten Cache/Vary-Header.
- security(api/learning): Upload‑Intent prüft Kurs‑Mitgliedschaft und Task‑Sichtbarkeit (403/404) und setzt `detail=csrf_violation` bei CSRF.
- openapi(learning): 403 Forbidden für Upload‑Intent dokumentiert.
- consistency(learning): Feedback‑Text für PDF‑Abgaben („PDF submission received.“).
 - security(web/ssr): Enforce same-origin on student submit route; respond 403 with private, no-store and Vary: Origin.
 - security(api/learning): Add Vary: Origin to Learning responses; shorten upload-intent TTL to 10 minutes.
 - repo(migration): Remove committed legacy DB dump; add .gitignore rules for dumps under docs/migration/.
 - tests(learning): Add 401/403 cases for upload-intents; add SSR CSRF guard test for submit route.
- ui(learning): Ersetzt Radiogruppe (Text/Bild/Datei) durch Choice Cards mit zwei Optionen „Text“ und „Upload“; Upload akzeptiert JPG/PNG/PDF (bis 10 MB). Kein Preview, klarer Erfolgshinweis.
- web(learning): PRG nach Abgabe enthält `open_attempt_id`; Unit‑Seite und History‑Fragment öffnen deterministisch genau diesen Versuch (Fallback: neuester).
- tests(learning/ui): UI‑Tests auf Choice Cards und `mode=upload` angepasst; neuer Test prüft `open_attempt_id` in der PRG‑Weiterleitung.
- api(learning): Support PDF submissions (`kind=file`) with strict validation (MIME `application/pdf`, size ≤ 10 MiB, sha256, storage_key). Add POST `/api/learning/courses/{course_id}/tasks/{task_id}/upload-intents` (same‑origin) to presign client uploads (dev stub).
- openapi(learning): Extend `LearningSubmission.kind` with `file`; document PDF constraints. Add `StudentUploadIntent{Request,Response}` schemas and the `POST /upload-intents` path.
- ui(learning): SSR Task‑Formular mit Umschalter (Text/Bild/PDF). Neues `learning_upload.js` für Toggle, Upload‑Intent, PUT‑Upload und Ausfüllen der Hidden‑Felder. PRG zurück mit Erfolgshinweis; keine Bild‑/PDF‑Vorschau.
- ui(learning): Aufgaben‑Historie lazy‑load via HTMX‑Platzhalter pro Task; beim PRG wird die Historie serverseitig vorab geladen und der neueste Eintrag geöffnet. Korrigierte Attributreihenfolge im `<details>`‑Tag (`open` vor `class`).
- repo(learning): Fallback‑Analyse für Legacy‑Submissions ohne `analysis_json`: nutzt `text_body` (Text) bzw. Platzhalter („OCR…“/„PDF…“) für Bild/PDF, damit die Historie stets sinnvollen Text anzeigt.
- db(migration): `learning_submissions.kind` um `file` erweitert; Größen‑Constraint `size_bytes` ≤ 10 MiB ergänzt.
- api(teaching): Mitglieder‑Endpoint akzeptiert neben `student_sub` nun auch Legacy‑Schlüssel `sub` (Kompatibilität) — Ownership/RLS unverändert.
- tests(learning): Upload‑Intent‑Verhalten (image/PDF), PDF‑Submission (happy/whitelist), UI‑Tests für Lazy‑Loader und Fallback‑Text in Historie.
- tests(auth): Stubs für `main` via `monkeypatch` in `sys.modules`, um Leaks zwischen Tests zu vermeiden.
- security(ops): Add startup guard to prevent dummy/unset SUPABASE_SERVICE_ROLE_KEY and `sslmode=disable` in production.
 - security(ops): Enforce HTTPS for `KC_BASE_URL`/`KC_PUBLIC_BASE_URL` in prod/stage (startup guard aborts on http).
 - docs(openapi): Document `/health` endpoint (no auth, no-store cache header).
- security(auth): Add `Cache-Control: no-store` to /auth/login, /auth/callback (302/400), /auth/logout, and /auth/logout/success.
- docs(env): `.env.example` uses `DUMMY_DO_NOT_USE` for service role key; README clarifies `KC_BASE_URL` vs legacy `KC_BASE`.
- ops(docker): Add container `HEALTHCHECK` hitting `/health`.
 - BREAKING(api/openapi): LearningSectionCore now requires `unit_id`. Update clients accordingly; older clients must ignore unknown fields or update schema.
 - security(openapi): Unify Cache-Control header descriptions to "Security — responses are private and not cacheable by shared caches." across Learning/Teaching endpoints.
 - security(api/learning): POST submissions validates `Idempotency-Key` as ASCII token (`[A-Za-z0-9_-]{1,64}`); rejects invalid/too-long tokens with 400.
 - consistency(web/ssr): Align SSR pagination clamp defaults to API (limit default 50, max 100).
- security(api/teaching): Enforce same-origin (CSRF) for PATCH visibility endpoint; all responses include `Cache-Control: private, no-store`.
 - security(api/teaching): Enforce same-origin (CSRF) for DELETE course/module/member; 201/204 responses include `Cache-Control: private, no-store`.
- fix(api/teaching): Module section releases endpoint returns private, no-store cache headers for 400/403/404.
- fix(ui/markdown): Headings rendered on student cards are emitted as block-level tags without wrapping `<p>` containers.
 - fix(api/openapi): Add 401/403/404 to GET /api/learning/courses/{course_id}/units/{unit_id}/sections; remove misplaced response blocks; align Cache-Control wording.
 - tests(contract): Add OpenAPI contract test for unit sections responses.
 - tests(learning): Add 403 (not enrolled) and 400 invalid include tests for unit sections.
 - security(db): Harden `get_released_sections_for_student_by_unit` search_path to `pg_catalog, public` (defense-in-depth).
- security(db): Learning helpers run as SECURITY INVOKER with hardened search_path; rely on
  `gustav_limited` RLS instead of SECURITY DEFINER ownership changes. Added student-facing
  SELECT policies on units/modules/sections/materials/tasks/releases to expose only released data.
 - security(db): Revoke PUBLIC EXECUTE on learning helper functions; grant EXECUTE only to `gustav_limited` (idempotent migration).
- security(container): Run web image as non-root user `app` (UID 10001).
- docs(env): Clarify Supabase Service Role key is server-only and must never be exposed to clients.
 - docs/openapi: Align /api/learning/courses pagination defaults (limit default 50, max 100) with other Learning endpoints.
 - docs(openapi): Declare `include` query as CSV (`style: form`, `explode: false`) for Learning sections endpoints.
 - api(teaching): Mark module section releases listing as owner-only via `x-permissions.ownerOnly=true`.
- security(db): `public.get_course_units_for_student` now stays SECURITY INVOKER; relies on RLS
  while keeping EXECUTE grant for `gustav_limited`.
- fix(db/repo): Remove duplicate `set_config('app.current_sub')` call in units listing query.
 - tests(learning): Add Cache-Control success header checks for courses and units (private, no-store).
 - tests(learning): Add pagination clamping test (limit>50, offset<0) and empty list case for student courses.
 - docs(openapi): Document stable secondary ordering for /api/learning/courses (title asc, id asc).
- api(learning): Document 403 Forbidden for student-only endpoints `/api/learning/courses` and `/api/learning/courses/{course_id}/units`.
- security(cache): Learning API responses use `Cache-Control: private, no-store` and contract examples updated accordingly.
 - docs(openapi): Align Learning Submissions Cache-Control examples to `private, no-store` (GET/POST 200/201/4xx).
 - tests(learning): Assert `Cache-Control: private, no-store` on 201 Create Submission; ensure 404 units carry private cache header and generic error.
- tests(learning): Add assertions for Cache-Control on 401/403 and 403 for non-student units access.
- docs(openapi): Add `additionalProperties: false` to `LearningCourse` and `UnitPublic` schemas to constrain payloads.
 - docs(openapi): Remove 429 rate-limit responses for `/auth/login` and `/auth/forgot` to match implementation.
- ux(learning/ui): Align page title to “Meine Kurse” for student course list.
- fix(openapi): Document Cache-Control on GET /api/teaching/courses (200) and remove duplicate example entry in course GET header.
- security(cache): POST /api/teaching/courses returns 201 with Cache-Control: private, no-store (align API and contract).
- security(cache): Add Cache-Control: private, no-store to 201/200 responses on POST/PATCH for teaching units; harden proxies/browsers.
- docs(openapi): Add `example: private, no-store` to Cache-Control headers for courses, units, sections, users endpoints.
- fix(web/units): Unit detail page maps 403 (not author) and 404 (missing) distinctly, mirroring API semantics.
- consistency(PRG): Use 303 See Other after POST on `/units` and `/courses`.
- feat(web/sections): Add SSR section detail page with slim UI (lists only) and clear create actions. Lists now link to per‑entry detail pages (materials/tasks). PRG flows, CSRF enforced, Cache‑Control private, no-store.
- feat(web/materials): Dedicated create page for materials with two flows — Markdown text and 2‑phase file upload (intent → finalize). File materials show a “Download anzeigen” link (short‑lived URL) on the detail page.
- feat(web/tasks): Dedicated create page for tasks with 0–10 analysis criteria and optional hints. Add due_at (RFC3339) and max_attempts to create/update UI; delegated to API for validation.
- feat(web/entry-detail): Per‑entry SSR detail pages for materials and tasks including Edit (PATCH via API) and Delete (DELETE via API), PRG redirects.
- ux(web): Section cards and list items now have explicit links to detail pages; section cards include a prominent “Material & Aufgaben” action.
- tests(web): Add coverage for SSR section detail (lists, reorder, CSRF), per‑entry detail pages (edit/delete), create pages (materials/tasks), and upload intent UI. Stabilize reorder tests to accept anchor‑wrapped titles.
- docs(plan): Update 2025‑10‑26 plan with status (SSR section detail, per‑entry, upload UI) and next steps.
- security(cache): Add Cache-Control: private, no-store to Teaching units list and sections list (200 responses); prevent caching of teacher-scoped data.
- docs(openapi): Document Cache-Control header for GET /api/teaching/units and GET /api/teaching/units/{unit_id}/sections.
- api(teaching): GET /api/teaching/courses/{course_id} validates UUID; returns 400 detail=invalid_course_id. Documented Cache-Control on 200.
- api(teaching): GET /api/teaching/units/{unit_id} documented Cache-Control on 200.
- api(users): /api/users/search, /api/users/list responses set Cache-Control: private, no-store; OpenAPI x-permissions require teacher/admin.
- fix(web/units): SSR edit form and sections UI now display API validation errors; reorder surfaces backend failures to the user.
- fix(auth): Remove duplicate /auth/callback route in auth-only test app to avoid ambiguous routing.
- security(csp): Harden CSP in prod (drop 'unsafe-inline' for scripts/styles); keep inline allowed in dev for DX.
- security(cache): Add Cache-Control: private, no-store to Teaching JSON endpoints (courses list, course get, members list).
- tests(security): New tests assert private/no-store on courses list and ensure prod CSP omits 'unsafe-inline'.
- fix(web/sections): Escape SectionCreateForm hx-post/action and add POST fallback to close XSS gap and keep non-HTMX submits working.
- fix(web/units): Always render #unit-list-section wrapper and POST-enabled create form so the first HTMX swap succeeds on empty lists.
- tests(web): Add regression coverage for sections/unit forms (escaping, HTMX targets) to guard the fixes.
- feat(users): Add GET /api/users/list for role‑scoped user listing (Keycloak Admin API). Used by Members UI to auto‑populate candidates.
- feat(teaching/api): Add GET /api/teaching/courses/{id} (owner‑only) for direct lookups (Edit/Mitglieder SSR prefill; avoids list scans).
- feat(teaching/api): Add GET /api/teaching/units/{id} (author‑only) for direct lookups (SSR Umbenennen‑Formular).
- feat(web/units): Add SSR routes GET/POST /units/{id}/edit with CSRF; prefill via API GET.
- feat(web/sections): SSR reorder now calls API reorder for DB-backed units (UUID ids) while keeping UI dummy store in sync; tests added.
- ux(web/sections): Drag & drop works on entire item (not only handle); clicks on buttons/links are ignored while dragging.
- feat(web/members): Auto‑load candidates (students not yet members) under the search input; search now filters candidates server‑side.
- fix(web/members): Removing a member immediately updates the current members list; inline error banner on API failure.
- docs(teaching): Reference updated for Users list endpoint and SSR member management behavior.
- devops(keycloak): Set defaultRoles=["student"] in realm import; docker‑compose passes KC_ADMIN_USERNAME/PASSWORD (defaults admin/admin) for directory access.
- security(web): Global security headers middleware now covered by tests; HSTS only in `prod`.
- security(auth): Dynamic `redirect_uri` derives host:port from ASGI request when not trusting proxy; tests for `/auth/register` added.
- security(ssr): Do not mint CSRF tokens when no session cookie present (defensive guard for `/courses` and `/units`).
- consistency(ssr): Removed redundant XFO/XCTO meta tags from `/units` SSR HTML; rely on middleware headers.
- Security: Set Referrer-Policy to strict-origin-when-cross-origin to support Origin/Referer CSRF fallback while protecting cross-site leakage.
- Auth: Dynamic redirect_uri now used only when request host matches WEB_BASE (or configured redirect_uri host); otherwise falls back to static redirect_uri. Prevents IdP errors and open redirect vectors.
- Learning API: Add GET /api/learning/courses/{course_id}/tasks/{task_id}/submissions listing endpoint; returns newest-first history for the current student.
- Contract: analysis_json schema tightened (required keys, examples) and feedback field renamed to feedback.
- Validation: Enforce text_body maxLength 10k; harmonize 400 invalid_input for blank/oversized; sanitize image storage_key via strict regex and MIME whitelist.
- UI/SSR: Add security headers middleware; /courses form uses synchronizer CSRF tokens; navigation updated per role.
- fix(api/learning): Blank text submissions now return 400 detail=invalid_input (contract-aligned); add tests. Enforce `text_body` maxLength=10000 (contract updated).
- security(csrf): When not trusting proxy, CSRF origin check no longer reads Host header; derives origin strictly from ASGI URL.
- consistency(api/learning): Use ALLOWED_IMAGE_MIME constant; delegate sections pagination clamping to use case only.
- fix(learning): Map `created_at` correctly in submission DTO (row[12]); align list_submissions route to reuse pagination clamp helpers.
- fix(learning): Correct materials created_at mapping; add pagination clamp tests and section 404 cache header assert.
- security(learning): SECURITY DEFINER Funktionen gehärtet (`search_path = pg_catalog, public`), vollqualifizierte `public.*`-Objekte.
- security(csrf): Same‑Origin vertraut `X‑Forwarded-*` nur mit `GUSTAV_TRUST_PROXY=true`.
- security(csrf): Fallback auf `Referer` bei fehlendem `Origin`; Tests ergänzt. Berücksichtigt `X‑Forwarded‑Port` beim Proxy‑Trust.
- fix(api/learning): Include `storage_key` in submission responses (image) and add tests; CSRF origin resolver now supports `X-Forwarded-Port` when proxy trust is enabled.
- consistency(api/learning): storage_key‑Regex zentralisiert; doppelte Pagination‑Clamps in Route entfernt (Use Case clamped).
- feat(api/learning): Add GET /api/learning/courses/{course_id}/tasks/{task_id}/submissions with student-scoped history and cache headers.
- feat(api/learning): Submissions now return structured `analysis_json` (text, length, scores[]) and `feedback`; synchronous stubs fill data for text/image attempts.
- docs(learning): Reference updates for history endpoint, analysis_json structure, and `.env.example` guidance.
- env: `.env.example` documents `GUSTAV_TRUST_PROXY=true` for reverse-proxy deployments.
- devops: `docker-compose.yml` setzt `GUSTAV_TRUST_PROXY=true` für den `web`‑Dienst (Betrieb hinter Caddy).
- docs: DSN‑Auflösung (Learning‑Repo) ergänzt; Terminologie‑Hinweis `student_sub` (API) ≙ `student_id` (DB) dokumentiert.
- security(db/learning): Add CHECK constraints for `learning_submissions` (idempotency_key ≤ 64; kind‑specific field requirements).
 - fix(api/middleware): 401 `Cache-Control` aligned with contracts — Learning: `private, max-age=0`; other APIs remain `no-store`.
- build(test): Remove import hack in `routes/learning.py`; tests now add repo root to `sys.path`.
- tests(learning): Assert 401 cache headers; add non‑member submission test coverage.
- fix(api/learning): Enforce `Idempotency-Key` maxLength=64 with 400 `invalid_input` and `Cache-Control: private, no-store`.
- fix(api/learning): Guarantee `section.position` is an integer ≥ 1 in responses (fallback to 1 when NULL).
- fix(db/learning): Handle idempotent insert races by catching unique violations and returning the existing row.
- security(db/learning): Restrict default limited DSN to non-prod; prod requires explicit DSN env var.
- docs(openapi): Add `Cache-Control` headers to 400/401/403/404 for Learning sections/submissions endpoints.
- build(docker): Include `backend/teaching` in production image to satisfy imports.
 - fix(api/learning): Enforce image MIME whitelist (image/jpeg, image/png) and sanitize storage_key via regex; new contract tests.
 - consistency(api/learning): 400 invalid path params now use detail=invalid_uuid; 400 responses include Cache-Control: private, no-store.
 - tests(learning): Add tests for MIME whitelist, storage_key pattern, and invalid_uuid detail + cache header.
- security(db/learning): Harden `get_released_tasks_for_student` via new migration so unreleased sections leak no tasks; contract test added.
- fix(api/openapi): Align Learning contract with implemented endpoints (remove upload-intents, document storage metadata for image submissions).
- fix(api/learning): Validate image `sha256` format pre-insert to surface 400 `invalid_image_payload` instead of database check violations.
- fix(api/openapi): Align `/api/me` example `expires_at` to `+00:00` offset to match runtime serialization.
- chore(openapi): Set spec version to `0.0.2` to match app version in backend/web/main.py.
- docs(api): Document `Cache-Control: no-store` on `GET /api/users/search` and `GET /api/teaching/.../materials/{id}/download-url` (privacy‑sensitive responses).
- feat(api/teaching): Add Tasks endpoints (list/create/update/delete/reorder) with read-only `kind="native"` responses.
- db(teaching): Introduce `public.unit_tasks` (RLS, deferrable ordering, ownership triggers) via new Supabase migration.
- feat(teaching): Wire TasksService + FastAPI adapter, ensuring Clean Architecture separation and in-memory fallback parity.
- tests(teaching): Add OpenAPI contract tests, API integration tests, and TasksService unit tests covering validation edge cases.
- docs(teaching): Plan & architecture docs updated to note Tasks MVP and `kind` forward-compatibility preparations.
- fix(teaching): Ensure partial PATCH updates honour repo defaults and document `invalid_hints_md` error detail.
- db(teaching): Make `module_section_releases.released_by` NOT NULL with backfill to 'system'.
- feat(api/teaching): Add PATCH /api/teaching/courses/{course_id}/modules/{module_id}/sections/{section_id}/visibility to toggle section releases (owner-only), with explicit 400 detail codes.
- db(teaching): Add `public.module_section_releases` table with RLS (owner-only via course_modules ↔ courses join); upsert semantics for visibility.
- db(teaching): Add CHECK constraint ensuring `released_at` matches `visible` (NOT NULL when true, NULL when false).
- docs(openapi/db): Document ModuleSectionVisibility schemas and endpoint in references; database schema updated accordingly.
- docs(openapi): Add 503 `service_unavailable` to file-materials endpoints (upload-intents, finalize, download-url, delete) when storage is not configured.
- security(api/teaching): Mark download-url responses `Cache-Control: no-store` (short-lived, non-cacheable URLs).
- env(auth): Prefer `KC_BASE_URL` (accept legacy `KC_BASE`); `.env.example` and docs updated.
- feat(storage): Respect `SUPABASE_STORAGE_BUCKET` env for MaterialFileSettings (default `materials`).
- fix(api/openapi): Move 502 storage_delete_failed example from PATCH to DELETE /materials; align with runtime behavior.
- fix(api/teaching): Delete storage first, then DB, to avoid orphaned objects when storage deletion fails (returns 502).
- db(materials): Strengthen SHA-256 CHECK (regex ^[0-9a-f]{64}$) via migration; improves data integrity.
- fix(teaching): Finalize accepts parameterized Content-Type from storage HEAD (e.g., "application/pdf; charset=UTF-8").
- docs(openapi): Add regex pattern for `sha256` (^[0-9a-f]{64}$) in `MaterialFileFinalizeRequest`.
- tests(teaching): Add test ensuring finalize accepts Content-Type with parameters.
- fix(teaching): In-memory course repo now mirrors DB validation (reject blank titles) to keep fallback in contract.
- security(api/users): User search responses send Cache-Control: no-store to prevent caching of roster data.
- chore(git): Explicitly ignore backend web __pycache__ directories (root-owned artifacts from previous builds).
- fix(api/teaching): Route-level sha256 validation returns 400 checksum_mismatch (avoid FastAPI 422); relaxed Pydantic length to defer to server checks.
- tests(teaching): Add tests for invalid sha256 pattern and content-length mismatch (deletes object + 400 checksum_mismatch).
- fix(api/teaching): Validate download `disposition` at route-level (400 invalid_disposition) and normalize before calling service.
- docs(openapi): Add 400 example for `invalid_disposition` in download-url endpoint.
- fix(api/teaching): PATCH materials treats provided empty title as `invalid_title` (was `empty_payload`).
- consistency(api/teaching): GET materials returns explicit JSONResponse (200) for uniform response shape.
- docs(openapi): Add `empty_payload` example to materials PATCH 400 section.
- consistency(api/teaching): Align error detail strings — use `invalid_module_ids` (plural) and map no-sections case to `section_mismatch` in DB repo.
- security(api/teaching): Move author/owner guards before payload validation in Unit/Section PATCH to avoid error‑oracle leakage (403/404 precede 400 empty_payload).
- fix(teaching): Implement sections CRUD/reorder in in‑memory repo to avoid 500s in dev/tests without Postgres; add smoke test.
- fix(api/teaching): Return explicit JSONResponse (200) from sections/modules reorder for consistent API shape.
- security(api/teaching): Check course ownership before deep payload validation in modules reorder to reduce error‑oracle leakage (403/404 precede 400 list errors).
- security(api/teaching): Mirror early authorship guard for sections reorder to reduce error‑oracle leakage.
- docs(openapi): Add 400 examples for modules reorder (empty_reorder, invalid_module_ids, no_modules) and sections reorder (section_mismatch).
  Also add sections: empty_section_ids, section_ids_must_be_array examples.
- fix(api/openapi): Correct DELETE /api/teaching/units/{unit_id} path placement (remove stray delete under sections/reorder); units PATCH uses authorOnly permissions.
- fix(api/teaching): Validate course_id UUID in POST /api/teaching/courses/{course_id}/modules/reorder (400 bad_request on invalid path param).
- fix(api/teaching): Allow PATCH /materials to update `alt_text`, returning `invalid_alt_text` on violations; keeps markdown/body guards intact.
- security(teaching): Sanitize storage-key path segments (author/unit/section/material) before presign/finalize to avoid path traversal on S3-compatible backends; in-memory repo gained full file-material workflow.
- docs(openapi/db): Document new error details (`invalid_filename`, `mime_not_allowed`, `invalid_alt_text`) and storage-key sanitizing; contract examples extended.
 - feat(storage): Add SupabaseStorageAdapter with unit tests, service/route fallbacks, and optional app wiring via env vars (no API changes).
 - docs(ops): Add storage and gateway reference with CLI steps and .env template; plan doc for storage integration; architecture updated with Storage section.
- tests(teaching): Extend file-material contract tests for invalid filenames, uppercase MIME normalization, size limit, expired intents, alt-text updates and in-memory fallback coverage.
- fix(db/sections): Serialize concurrent section creation by locking parent unit; add one-shot retry on unique violation; regression tests added.
- fix(db/sections): Ensure unique-violation retry fetches the inserted row before the cursor closes; regression test guards against cursor-already-closed errors.
- security(teaching): Enforce limited-role DSN (gustav_limited) for TeachingRepo to guarantee RLS coverage; add override flag `ALLOW_SERVICE_DSN_FOR_TESTING` for dev only.
- fix(teaching): Correct HTTP semantics — 204 responses without body; align 404 vs 403 for members and delete endpoints with contract.
- feat(db): Add SECURITY DEFINER helpers `public.course_exists_for_owner` and `public.course_exists` via Supabase migration to disambiguate 404 (not found) from 403 (forbidden) safely.
- perf(teaching): Avoid blocking event loop during name resolution by offloading sync directory requests to a thread; foundation for future async/batch lookup.
- tests: Add DSN enforcement tests and optional existence-helper tests; strengthen assertions for 204 no-content responses.
- fix(api/teaching): PATCH /api/teaching/courses/{id} returns explicit JSONResponse (200) for consistent response shape.
- security(ops): /health responses include `Cache-Control: no-store` to prevent caching of diagnostics.
- test(auth): Add smoke test for `/auth/logout/success` (200 + back-to-login link).
- chore(auth): Remove deprecated `_cookie_opts` wrapper in auth routes; use shared `auth_utils.cookie_opts`.
 - fix(api/openapi): Document 400 invalid path params for Tasks endpoints (invalid_unit_id, invalid_section_id, invalid_task_id).
 - consistency(api/openapi): `criteria.items` now `minLength: 1` in TaskCreate/TaskUpdate.
 - fix(api/teaching): DELETE /tasks returns 204 without body (HTTP semantics).
 - feat(teaching): Accept `due_at` with trailing 'Z' (UTC) in TasksService.
 - tests(teaching): Add invalid-UUID path tests and Zulu due_at acceptance.

- feat(teaching/ui): Abschnittsfreigaben (Owner) — SSR‑UI mit Schalter „Freigegeben“, Zeitstempel „Freigegeben am …“, und kurzer Erfolgsmeldung nach Toggle.
- feat(teaching/api): `PATCH /api/teaching/courses/{course_id}/modules/{module_id}/sections/{section_id}/visibility` speichert sofort (UPSERT) mit `released_by`/`released_at` (RLS‑gesichert).
- feat(learning/api+ui): `GET /api/learning/courses/{course_id}/units/{unit_id}/sections` (private, no‑store). Schüler‑Unit‑Seite rendert freigegebene Abschnitte ohne Titel, getrennt durch `<hr>`.

## 2025-10-20
- Teaching (Unterrichten) — Kursmanagement (MVP)
  - OpenAPI erweitert: `Course`, `CourseCreate`, `CourseUpdate`, `CourseMember`
  - Endpunkte: Kurse (create/list/update/delete), Mitglieder (add/list/remove), Users‑Suche
  - Migration: `courses`, `course_memberships`, `pgcrypto`, `updated_at`‑Trigger, RLS
  - DB‑Repo (psycopg3) implementiert; Router standardmäßig DB bzw. Fallback In‑Memory in Tests
  - Tests: API‑Coverage und optionaler Repo‑Test (skip bei fehlender DB)
- 2025-11-02 — Security hardening for Teaching Live detail
  - Enforce strict task∈unit∈course checks in latest submission detail endpoint (owner-only)
  - Remove unsafe DB fallback; rely on SECURITY DEFINER helper only
  - Update helper signature to include unit_id and validate relation in SQL
  - OpenAPI: add date-time format for TeachingModuleSection.released_at; set additionalProperties: false; 204 headers
  - Makefile: silence legacy import commands to avoid logging secrets
