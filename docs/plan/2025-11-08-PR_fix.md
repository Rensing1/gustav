# PR-Review Nacharbeiten (Security & Learning-UX)

Datum: 2025-11-08  
Autor: Codex (Teacher/Developer)  
Status: In Bearbeitung – Teilmaßnahmen umgesetzt, Rest folgt

## Hintergrund & Ziel
Im letzten Code-Review (Stand `HEAD=123a6d2`) wurden mehrere Must-Fix/Should-Fix-Punkte identifiziert, die vor dem Merge adressiert werden müssen. Dieses Dokument sammelt die Analyse und skizziert den Plan zur Behebung, damit alle Beteiligten denselben Kontext teilen und TDD-Schritte ableiten können.

## Befunde aus dem Review
1. **[SEC] Worker-Container nutzt Service-Role (postgres:postgres)**  
   - Impact: Hebelt RLS/Least-Privilege aus; Remote Code Execution im Worker würde vollständige DB-Kontrolle gewinnen.  
   - Quelle: `docker-compose.yml` (learning-worker env `LEARNING_DATABASE_URL=postgres://postgres:postgres@…`).

2. **[BUG] Status `analysis_status='extracted'` stoppt Auto-Refresh/History**  
   - Impact: Schüler sehen keine Fortschrittsaktualisierung mehr, sobald PDFs nach der Extraktion hängen.  
   - Quelle: `backend/web/main.py` (Polling nur für `pending`), neue Repo-/Worker-States liefern jedoch `extracted`.

3. **[BUG] Supabase-PUT liefert keine `sha256` mehr**  
   - Impact: `POST /submissions` schlägt deterministisch fehl (`sha256=""`) → Integrity-Check blockiert Uploads, selbst wenn JS aktiv ist.  
   - Quelle: `backend/web/static/js/gustav.js` – nach erfolgreichem PUT wird nur auf JSON geparst; Supabase antwortet leer, daher keine Checksumme.

4. **[BUG] Datei-Upload nur noch via JavaScript möglich**  
   - Impact: Browser ohne JS (Barrierefreiheit, Prüfungsgeräte, Privacy-Setups) können keine JPG/PDF mehr einreichen.  
   - Ursache: Hidden-Felder `storage_key/sha256` werden ausschließlich durch `gustav.js::prepareLearningUpload` befüllt; serverseitiger Fallback fehlt.

5. **[SEC] Globale Variable `LAST_ISSUED_ID_TOKEN` als Logout-Fallback**  
   - Impact: Letztes beliebiges id_token bleibt im Speicher und kann bei fehlendem Cookie als `id_token_hint` verwendet werden → potentielles Cross-Logout und unnötige Token-Aufbewahrung.

## Plan nach Prinzipien (KISS, Security-First, Contract/TDD)

### 1. Worker-DSN auf Least-Privilege zurückstellen
- **User Story**: Als Betreiber möchte ich, dass der Worker nur mit der vorgesehenen, RLS-beschränkten Rolle arbeitet, damit ein Exploit keine vollständige DB-Kontrolle erhält.
- **Schritte**:
  1. Compose/Docs: Default `LEARNING_DATABASE_URL` wieder auf App-/Worker-Rolle setzen; Service-Role nur über explizites Override dokumentieren.
  2. Ergänzende Tests/Checks (z. B. `test_learning_worker_security.py`) stellen sicher, dass RLS weiter greift.
- **Risiken**: Worker benötigt ggf. SECURITY DEFINER Funktionen – sicherstellen, dass diese weiterhin reichen.
- **Status**: ✅ Implementiert (Compose + neue `_resolve_worker_dsn`-Logik + pytest).

### 2. `extracted` als „in Bearbeitung“ behandeln
- **User Story**: Als Schüler sehe ich live, dass meine PDF-Abgabe noch verarbeitet wird, bis Feedback auftaucht.
- **Schritte**:
  1. Alle UI-Stellen, die derzeit `status == "pending"` prüfen (History, HX-Placeholder, Banner), auf `status in {"pending", "extracted"}` erweitern.
  2. Tests erweitern (`test_learning_ui_auto_refresh.py`, `test_learning_ui_student_submissions.py`), um den neuen Status abzudecken.
- **Status**: ✅ UI + Tests aktualisiert.

### 3. sha256-Ermittlung client-/serverseitig absichern
- **User Story**: Als Schüler möchte ich, dass mein Upload unabhängig vom Storage-Backend eine gültige Prüfsumme erhält, damit das Backend Integrität prüfen kann.
- **Schritte**:
  1. Im Frontend die SHA-256 des `File` via `crypto.subtle.digest` berechnen und Hidden-Feld setzen, falls PUT keine JSON-Antwort liefert.
  2. Serverseitig (Upload-Stub & Proxy) weiterhin Hash/Size zurückgeben, damit Tests mit dem Stub bestehen.
  3. Regressionstest (`test_learning_ui_htmx_submit.py`, neuer JS-less Test) stellt sicher, dass `sha256` nie leer ist.
- **Status**: ✅ Web/SSR fallback + JS-Digest + Test ergänzt.

### 4. JS-freien Upload-Fallback wiederherstellen
- **User Story**: Als Schüler ohne JS-Unterstützung kann ich weiterhin Dateien hochladen und abschicken.
- **Schritte**:
  1. Backend akzeptiert weiterhin klassische Multipart-POSTs und löst intern Upload-Stubs/Supabase-Aufrufe aus (z. B. serverseitiger PUT nach Intent).
  2. Graceful Degradation im Template (Hinweis, dass ohne JS serverseitiger Pfad genutzt wird).
  3. Pytests für No-JS-Fluss (z. B. `test_learning_upload_stub_route` / neuer Integrationstest).
- **Status**: ✅ Implementiert.
  - SSR-Route `learning_submit_task` erkennt fehlende `storage_key`/`sha256`-Felder und nutzt nun `_server_side_prepare_submission_upload`, um Intent + Upload komplett serverseitig durchzuführen (inkl. Same-Origin-Headern und SHA-Fallback).
  - Neuer Test `test_ui_submit_upload_png_without_js_uses_server_fallback` deckt den Non-JS-Flow ab; für testbare Umgebungen ohne Postgres kommt ein lokaler Stub-Repo + Upload-Stub zum Einsatz.
  - Relevante Tests:  
    - `.venv/bin/pytest backend/tests/test_learning_ui_student_submissions.py -k js_uses_server_fallback`  
    - `.venv/bin/pytest backend/tests/test_learning_ui_htmx_submit.py`

### 5. Logout-Token-Fallback entfernen
- **User Story**: Als Betreiber möchte ich keine fremden Tokens im Speicher behalten; Logout soll nur mit dem zum Request gehörenden Token arbeiten.
- **Schritte**:
  1. `LAST_ISSUED_ID_TOKEN` entfernen; Logout verwendet ausschließlich Session-gebundene Tokens oder fällt auf `client_id` zurück.
  2. Tests für `/auth/logout` anpassen (z. B. `test_security_logout_flows`) und dokumentieren, dass `id_token_hint` optional ist.
- **Status**: ✅ Implementiert.
  - Globale Variable `LAST_ISSUED_ID_TOKEN` entfernt; `/auth/callback` speichert keine Tokens mehr außerhalb der Session.
  - `/auth/logout` nutzt jetzt nur noch `id_token_hint`, wenn der aktuelle Request/Session eines bereitstellt, und fällt sonst strikt auf `client_id` zurück.
  - Neue Tests (`test_logout_without_session_only_sends_client_id`, `test_logout_session_without_id_token_falls_back_to_client_id`) stellen sicher, dass keine historischen Tokens recycelt werden.

## Tests & Nachweise (TDD-Reminder)
- Sicherheits-/Infra-Änderungen: Compose Smoke-Test + ggf. `pytest -k learning_worker_security`.
- UI/Polling: Erweiterte HTMX-/history-Tests (`anyio`) decken `extracted` ab.
- Upload-Fallback: Neuer Testpfad ohne JS (multipart POST) → 202 + gespeicherte Submission.
- Auth: Logout-Test stellt sicher, dass kein globaler Token verwendet wird.

Aktuell bestanden:  
- `.venv/bin/pytest backend/tests/test_learning_worker_security.py -k dsn`  
- `.venv/bin/pytest backend/tests/test_learning_ui_auto_refresh.py backend/tests/test_learning_ui_htmx_submit.py`  
- `.venv/bin/pytest backend/tests/test_learning_ui_student_submissions.py -k js_uses_server_fallback`  
- `.venv/bin/pytest backend/tests/test_auth_hardening.py -k logout`  
- `.venv/bin/pytest backend/tests/test_auth_contract.py -k logout`  
- `RUN_OLLAMA_E2E=1 AI_FEEDBACK_MODEL="llama3.2:1b" OLLAMA_BASE_URL=http://localhost:11434 .venv/bin/pytest backend/tests/ai/test_ollama_integration.py -q -rs`  
- `RUN_OLLAMA_E2E=1 RUN_OLLAMA_VISION_E2E=1 AI_VISION_MODEL="qwen2.5vl:3b" OLLAMA_BASE_URL=http://localhost:11434 .venv/bin/pytest backend/tests/ai/test_ollama_vision_integration.py -q -rs`  
- `RUN_SUPABASE_E2E=1 SUPABASE_URL=http://127.0.0.1:54321 SUPABASE_SERVICE_ROLE_KEY=<local_secret> SUPABASE_ANON_KEY=<local_publishable> .venv/bin/pytest backend/tests/test_supabase_storage_e2e.py -q -rs`  
- `RUN_E2E=1 .venv/bin/pytest backend/tests_e2e/test_identity_login_register_logout_e2e.py -q -rs`  
- `RUN_E2E=1 .venv/bin/pytest backend/tests_e2e/test_identity_register_validation_e2e.py -q -rs`

## Nächste Schritte
1. Gesamtsuite / relevante Rauchtests laufen lassen, um Nebeneffekte auszuschließen.
2. Review der offenen PR-Kommentare und ggf. Rest-Must-Fixes adressieren.
