# PR-Review Nacharbeiten (Contract & Storage Follow-up)

Datum: 2025-11-08  
Autor: Codex (Teacher/Developer)  
Status: In Arbeit – Umsetzung geplant (Contract-Fixes), DX/Docker-Nacharbeiten folgen

## Hintergrund & Ziel
Im jüngsten Code-Review (`HEAD=ee034c3`) wurden zusätzliche Blocker identifiziert, die vor einem Merge adressiert werden müssen. Dieses Dokument sammelt die Analyse, formuliert User Stories und skizziert die Umsetzungsschritte gemäß unseren Prinzipien (Contract-First, TDD, KISS). Fokus liegt auf API-Vertragstreue, Sicherheit der Dev-Infra und Robustheit der Upload-Pipeline.

## Befunde aus dem Review
1. **[API] `analysis_json` verletzt den Vertrag für Submissions**  
   - Repo schreibt `analysis_json={"page_keys": [...]}` (ohne `schema`), während der OpenAPI-Vertrag ausschließlich `criteria.v1/v2` erlaubt.  
   - Impact: Client-Validatoren schlagen fehl; Lernende sehen inkonsistente Daten.

2. **[API] Neue Telemetrie-Felder werden nicht serialisiert**  
   - Vertrag garantiert `vision_attempts`, `vision_last_error`, `feedback_last_attempt_at`, `feedback_last_error`.  
   - DB-Abfragen liefern die Spalten, aber `_row_to_submission` entfernt sie → Frontend/SDKs bekommen unvollständige Antworten.

3. **[API] Upload-Proxy-Endpunkt fehlt im Vertrag**  
   - Bei `ENABLE_STORAGE_UPLOAD_PROXY=true` liefert `/upload-intents` eine URL auf `/api/learning/internal/upload-proxy`, obwohl dieser nicht im OpenAPI/BDD beschrieben ist.  
   - Impact: Kein getesteter Contract, Frontend-Dokumentation lückenhaft.

4. **[BUG] Proxy-Route blockiert Event Loop synchron**  
   - `internal_upload_proxy` ruft `requests.put` in einer `async`-Route auf → ganze Uvicorn-Worker werden während des Uploads blockiert.  
   - Impact: DoS-Potenzial bei großen Dateien; widerspricht KISS/Robustheit.

5. **[SEC] Ollama-Container exponiert Port 11434 öffentlich**  
   - Compose mappt `11434:11434` ohne Bind-Adresse/Firewall.  
   - Impact: Lokale LLM-Ausgabe inklusive PII ist im LAN erreichbar → DSGVO-Risiko.

6. **[DX/CONSISTENCY] Build/Docs-Feinschliff (Junior-Analyse)**  
   - Dockerfile enthält doppelte `pip install`-Schicht; `ollama` Version nicht gepinnt.  
   - `.env.example` sollte klaren Prod-Hinweis zu `AI_BACKEND=stub` enthalten.  
   - Whitespace-Leak in `.gitignore`.  
   - Migration „no raise on mismatch (jsonb)“ braucht Regressions-Test für idempotente Re-Updates.

## Plan (User Stories, Schritte, TDD)

### 1. Vertragstreues `analysis_json`
- **User Story**: Als Lernender möchte ich, dass jede Submission das dokumentierte `analysis_json`-Schema liefert, damit UI/SDKs zuverlässig rendern können.  
- **Entscheidung**: Option B (minimal): `analysis_json` bleibt bis Feedback `null`; `page_keys` werden nicht im Public Contract exponiert (nur intern persistiert).  
- **BDD**:  
  1. *Given* eine Lehrkraft markiert eine Submission als `extracted`, *When* die Submission über die API abgerufen wird, *Then* `analysis_json` ist `null` und enthält keine `page_keys`.  
  2. *Given* dieselbe Submission nach erfolgtem Feedback, *When* sie erneut geladen wird, *Then* `analysis_json` entspricht exakt dem dokumentierten Schema (`criteria.v1` oder `criteria.v2`).  
  3. *Given* ein nicht authentifizierter Nutzer, *When* er die Submission anfragt, *Then* antwortet die API mit `401` und ohne `analysis_json`-Information.  
- **OpenAPI-Entwurf**:  
  ```yaml
  Submission:
    type: object
    properties:
      analysis_json:
        nullable: true
        description: |
          `null` bis die Lehrkraft Feedback erteilt; anschließend eines der `criteria.*`
          Schemas. `page_keys` bleiben intern und sind kein Teil des öffentlichen Vertrags.
        oneOf:
          - type: 'null'
          - $ref: '#/components/schemas/CriteriaV1'
          - $ref: '#/components/schemas/CriteriaV2'
  ```
- **Migration-Entwurf**: Neue Spalte `internal_metadata jsonb default '{}'::jsonb` in `learning_submissions` (RLS-konform, nicht über API exponiert). `page_keys` werden dort persistiert und bleiben intern.  
- **Schritte**:  
  1. Repo/Serializer: Entfernen des Schreibens von `page_keys` in `analysis_json`; stattdessen Speicherung unter `internal_metadata` (jsonb).  
  2. OpenAPI/BDD: Klarstellen, dass bei `extracted` das Feld `analysis_json=null` ist.  
  3. Pytest: `test_learning_repo_mark_extracted` + Contract-Tests erwarten `analysis_json is None` im `extracted`-Status.  
- **Done-Definition**: `.venv/bin/pytest backend/tests/test_learning_api_contract.py -k analysis_json` grün; Contract-Linter bestätigt Schema.

### 2. Telemetrie-Felder liefern
- **User Story**: Als Produkt-Team brauche ich `vision_attempts` & Fehlerzeiten, um Lernenden sinnvolle Statusmeldungen anzuzeigen.  
- **Entscheidung**: Option A (öffentlich belassen): Alle vier Felder bleiben im Public Contract und werden ausgeliefert (mit Sanitization, wo relevant).  
- **Schritte**:  
  1. SQL-Selects + Serializer vollständig machen (`vision_attempts`, `vision_last_error`, `feedback_last_attempt_at`, `feedback_last_error`).  
  2. Sanitization sicherstellen (Trunkierung/keine PII); Tests für Vorhandensein/Nicht-Leak.  
  3. Contract-/UI-Tests abgleichen.  
- **Done**: JSON-Response enthält alle Felder, Snapshot-Tests aktualisiert.

### 3. Upload-Proxy dokumentieren & testen
- **User Story**: Als Frontend-Entwickler möchte ich einen dokumentierten Endpunkt für den Same-Origin-Proxy, damit ich Fehlfälle und CSRF-Anforderungen korrekt implementiere.  
- **Entscheidung**: Keine Änderung am derzeitigen Verhalten; insbesondere kein Rate‑Limiting hinzufügen.  
- **Schritte**:  
  1. Dokumentation/Contract nur präzisieren, wo nötig; kein zusätzliches Rate‑Limiting oder Flow‑Change.  
  2. Tests wie vorhanden beibehalten.  

### 4. Async-kompatible Proxy-Weiterleitung
- **User Story**: Als Betreiber möchte ich, dass Upload-Proxys keine Event-Loop-Blocker sind, damit parallele Lernende nicht hängen.  
- **Entscheidung**: Option B (reduzierte Telemetrie öffentlich): Nur `vision_attempts` und `feedback_last_attempt_at` werden prominent genutzt; Fehlertexte bleiben im Teacher‑Kontext.  
- Hinweis: Diese Entscheidung bezieht sich auf Telemetrie-Öffnung; die technische Umstellung auf async bleibt empfohlen, ist aber hier nicht Teil der Änderung.  

### 5. Ollama-Port absichern
- **User Story**: Als Datenschutzbeauftragter will ich, dass lokale KI-Dienste nicht unbeabsichtigt nach außen exponiert werden.  
- **Schritte**:  
  1. `docker-compose.yml`: Port-Bindung auf `127.0.0.1:11434` beschränken oder Port vollständig entfernen (nur interner Zugriff).  
  2. Dokumentation (`docs/references/compose_env.md`) aktualisieren – Hinweis auf SSH-Tunnel falls Remote-Zugriff nötig.  
  3. Optionaler Healthcheck via Make-Target `make test-ollama` anpassen (nutzt localhost).  
- **Entscheidung**: Nichts tun (keine Änderung an aktueller Compose‑Portbindung).  
- **Hinweis**: Sicherheitsbewertung bleibt bestehen; Wiedervorlage bei Prod‑Rollout.  

### 6. DX/Consistency-Nacharbeiten (aus Junior-Analyse)
- **User Story**: Als Dev möchte ich deterministische Builds, saubere Beispiel-ENV und minimale Diffs, um Onboarding und CI stabil zu halten.  
- **Schritte**:  
  1. Dockerfile: Doppelte `pip install`-Schicht konsolidieren; `ollama`-Client optional pinnen (abhängig von CI‑Stabilität).  
  2. `.env.example`: Deutlicher Prod-Hinweis bei `AI_BACKEND=stub`.  
  3. `.gitignore`: überflüssige Whitespace-Zeile entfernen.  
  4. Tests: Neuer Case für „update_completed(jsonb) ist idempotent“ ergänzt (SQL + pytest).  
- **Done**: CI-Build zeigt reduzierte Layer; Linter/whitespace sauber; neuer Test schützt Idempotenz.

## Tests & Verifikation
- Contract: `.venv/bin/pytest backend/tests/test_learning_api_contract.py -k submissions`  
- Proxy: `.venv/bin/pytest backend/tests/test_learning_internal_proxy_prod_parity.py backend/tests/test_learning_upload_proxy_fallback.py`  
- Telemetrie/UI: `.venv/bin/pytest backend/tests/test_learning_ui_student_submissions.py -k vision_attempts`  
- Repo: `.venv/bin/pytest backend/tests/test_learning_repo_mark_extracted.py backend/tests/test_learning_pdf_preprocessing_usecase.py`  
- Compose/Security: `docker compose ps` → kein offener 0.0.0.0:11434, manueller Curl-Test.
 - Docker/DX: Image-Build reproduzierbar, keine doppelte Layer-Installation; `.env.example`-Lint ok.  
 - SQL/Idempotenz: Neuer Test „completed→completed (jsonb)“ grün.

## Offene Fragen
1. —  
2. —  
3. —  

*(Bitte Antworten/Änderungen hier ergänzen, bevor die Umsetzung startet.)*

---

## Anhang: Punkte aus Junior-Analyse (integriert)
- [SEC] Pin für `ollama`-Client im Docker-Image; doppelte Install-Schicht entfernen (siehe Plan 6).  
- [DOC] Neue ENV-Variablen in `docs/references/*` dokumentieren.  
- [TEST] Idempotenz-Test für JSONB-Completed-Updates (siehe Plan 6).  
- [NICE] Multi-stage Build und `set -euo pipefail` für Makefile prüfen (kein Blocker).
