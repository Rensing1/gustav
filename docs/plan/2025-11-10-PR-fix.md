# PR-Review Fixplan (Security & API Konsistenz)

Datum: 2025-11-10  
Autor: Codex (Teacher/Developer)  
Status: Geplant – kleine sicherheitsrelevante Korrekturen vor Merge

## Hintergrund & Ziel
Dieser Plan konserviert die PR-Review-Ergebnisse vom 2025-11-10. Fokus sind zwei sicherheitskritische Punkte (HTTPS-Zwang im Upload‑Proxy, AI‑Stub in Prod verhindern) sowie kleinere Konsistenz-/Test-Nacharbeiten. Vorgehen gemäß unseren Prinzipien: Contract‑First, TDD, KISS, Clean Architecture.

## Kurzfazit
Großer, sinnvoller Ausbau (Learning‑Uploads, Storage‑Wiring, Vision/AI). Security und Vertrag sind überwiegend solide (CSRF, RLS, Cache‑Control). Zwei Lücken bleiben: fehlender HTTPS‑Zwang im Upload‑Proxy und fehlender Produktions‑Guard gegen AI‑Stub. Diese schließen wir zuerst.

## MUST‑FIX
- [SEC] Erzwinge HTTPS im Upload‑Proxy  
  Evidenz: `backend/web/routes/learning.py:1166-1182@HEAD`  
  Impact: SSRF/Down‑Grade  
  Fix: `urlparse(url).scheme in {"https"}` erzwingen; `http` nur für `localhost/127.0.0.1` erlauben; sonst 400 `invalid_url`.
- [SEC] Verbiete AI‑Stub in Produktion  
  Evidenz: `.env.example:73-82@HEAD`, `backend/learning/config.py:65-72@HEAD`  
  Impact: Scheinfeedback/Analytics verfälscht  
  Fix: Startup‑Guard (Web/Worker): `GUSTAV_ENV∈{prod,stage}` und `AI_BACKEND=stub` → abort mit klarer Meldung.
- [CONSISTENCY] Vision‑Adapter muss den konfigurierten Bucket respektieren  
  Evidenz: `backend/learning/adapters/local_vision.py:134@HEAD` (auch 337, 404) nutzt hartkodiert `submissions`  
  Impact: Beim Umbenennen von `LEARNING_STORAGE_BUCKET` finden Vision/Derived-Page-Downloads keine Objekte mehr; OCR bleibt leer.  
  Fix: Bucket aus `get_submissions_bucket()`/`LEARNING_STORAGE_BUCKET` ermitteln, führende `submissions/`-Segment entfernen und die echte Supabase-URL verwenden.
- [CONSISTENCY] API-Antwort muss `feedback_md` liefern  
  Evidenz: `backend/learning/repo_db.py:1015@HEAD` liefert `feedback`, Contract `api/openapi.yml:953@HEAD` erwartet `feedback_md`  
  Impact: Clients, die dem Vertrag folgen, erkennen keine Rückmeldungen mehr; Validierung schlägt fehl.  
  Fix: Serialisierung so anpassen, dass `feedback_md` statt `feedback` gesetzt wird (oder OpenAPI/Konsument aktualisieren).
- [BUG] PDF-Preprocessing darf nicht an RLS/Telemetry vorbeischreiben  
  Evidenz: `backend/learning/usecases/pdf_preprocessing.py:141-157@HEAD` führt ein direktes `update public.learning_submissions …` aus, während `supabase/migrations/20251108185952_learning_worker_failed_clear_analysis_json.sql` die Security-Definer-Funktion `learning_worker_update_failed` bereitstellt.  
  Impact: `vision_attempts`, Sanitizing und Auditing laufen ins Leere; zudem braucht der Use Case unnötig starke DB-Rechte.  
  Fix: Fehlerpfade über `learning_worker_update_failed` (oder Repo-Wrapper) ausführen, damit Telemetrie/Policy erhalten bleiben.

## SHOULD‑FIX
- [CONSISTENCY] Angleiche AI‑Model‑Defaults zwischen `.env.example` (llama3.*) und `backend/learning/config.py` (qwen2.5*).  
  Fix: Einheitliche Defaults + Doku‑Hinweis in `docs/references/learning_ai.md`.
- [TEST] Ergänze Test für HTTPS‑Zwang im Proxy (`http` → 400 `invalid_url`).
- [CONSISTENCY] Markiere `AUTO_CREATE_STORAGE_BUCKETS` explizit als dev‑only in README/Runbook; Log‑Hinweis beim Aufruf.
- [DOC] Learning-Referenz dokumentiert nicht den aktualisierten Vertrag (z. B. `analysis_status=extracted`, Telemetrie-Felder, Upload-Proxy).  
  Fix: `docs/references/learning.md` und API-Referenzen synchronisieren (Feldnamen, Fehlerschemata, neue Endpunkte).
- [DEVEXP] docker-compose nutzt standardmäßig `ollama/ollama:rocm` → schlägt auf Intel/CPU-only fehl.  
  Fix: CPU-kompatibles Default-Image (z. B. `ollama/ollama:latest`) wählen und ROCm als optionalen Override dokumentieren.

## NICE‑TO‑HAVE
- Rate‑Limit für `internal/upload-stub` und `internal/upload-proxy` (simple token‑bucket pro Session/IP).  
- Striktere Host/Port‑Prüfung im Proxy (Explizite Port‑Whitelist der Supabase‑URL).

## Aktueller Stand
- Vollsuite (`.venv/bin/pytest -q -rs`) grün: `742 passed, 9 skipped` in ~3 Minuten. Skips entsprechen erwarteten Guards (Ollama/Supabase/Keycloak-E2E).
- Vision/Worker-Probleme gelöst:
  - `backend/tests/utils/storage_fixtures.py` erzeugt jetzt robuste 160×220-PNGs via Pillow (inkl. Dummy-Texturen).
  - `_ensure_pdf_stitched_png` liest `internal_metadata.page_keys`, akzeptiert verschiedene Bucket/Root-Layouts und durchsucht bei Bedarf rekursiv `**/derived/<submission_id>`.
  - Worker lädt `internal_metadata` samt `page_keys`, sodass vorberechnete Seiten sofort genutzt werden.
- Queue-Tests sind robuster: `test_worker_passes_task_context_to_feedback_adapter` wartet nun explizit, bis der eigene Job abgearbeitet ist, sodass liegengebliebene Supabase-/Dev-Jobs keine Flakes mehr auslösen.
- DSPy-Structured-Pipeline, HTTPS-Proxy, AI-Stub-Guard und `feedback_md`-Serialisierung bleiben grün; es gibt keine weiteren offenen Review-Blocker.

### Probleme
Aktuell keine offenen Testfehler oder Blocker. Die neuen Logs (`learning.vision.pdf_ensure_stitched`) liefern genügend Kontext, falls zukünftig wieder Vision-Retries auftreten.

### Nächste Schritte
1. Beobachten, ob die rekursive Fallback-Suche in `_ensure_pdf_stitched_png` bei großen lokalen Upload-Verzeichnissen messbare Laufzeit erzeugt. Falls ja, Limit/Breaker ergänzen.
2. Bei weiteren Worker-/Storage-Änderungen konsequent `ensure_pdf_derivatives` verwenden, damit Tests realistische Artefakte behalten.

## Ausführung/Verifikation
- Gesamt-Testlauf: `.venv/bin/pytest -q -rs` → 742 pass / 9 skip.
- Zielgerichtete Suites:
  - `backend/tests/test_learning_vision_pdf_images_param.py`
  - `backend/tests/test_learning_worker_pdf_extracted_flow.py`
  - `backend/tests/test_learning_worker_jobs.py::test_worker_marks_feedback_failure_records_job_error`
  → alles grün nach den Anpassungen.
- E2E-Make-Targets: `make test-ollama` (ollama connectivity) sowie `RUN_SUPABASE_E2E=1 .venv/bin/pytest backend/tests/test_supabase_storage_e2e.py -q -rs` → beide aktuell grün (siehe heutige Laufprotokolle).

## Tests (Given‑When‑Then, TDD)
- Given prod env; When POST `/submissions` ohne Origin/Referer; Then 403 `csrf_violation`.
- Given proxy enabled; When upstream PUT wirft Exception; Then 502 `bad_gateway`.
- Given proxy enabled; When upstream non‑2xx; Then 502 `bad_gateway`.
- Given OpenAPI; When spec geladen; Then `/api/learning/internal/upload-proxy` dokumentiert.
- Given proxy; When `url=http://foreign.example/...`; Then 400 `invalid_url`.
- Given prod env; When `AI_BACKEND=stub`; Then Startup abort.

## Contract‑First
- Keine neuen API-Änderungen notwendig; alle Updates fanden in Adaptern/Tests statt.

## Umsetzungsschritte (Red‑Green‑Refactor)
1. Tests rot:
   - Worker-/Vision-Regressionen über `test_learning_vision_pdf_images_param` und `test_learning_worker_pdf_extracted_flow`.
2. Grün:
   - Fixture-Update (`write_dummy_png`, `ensure_pdf_derivatives`) + `_ensure_pdf_stitched_png`-Fallbacks.
3. Refactor:
   - Logging/Warnungen ergänzt, Plan dokumentiert (dieses Dokument).

## Akzeptanzkriterien
- `.venv/bin/pytest -q -rs` ohne Fehler → ✅.
- Worker- und Vision-Tests verwenden realistische Artefakte und erreichen `analysis_status='completed'`.
- Dokumentation des Vorgehens in `docs/plan/2025-11-10-PR-fix.md` aktualisiert → ✅.

## Risiken & Rückfallplan
- Falsche Host/Scheme‑Erkennung hinter Proxies → Mit `GUSTAV_TRUST_PROXY=true` testen; falls nötig, Host‑Extraktion zentralisieren.  
- Abbruch in Prod wegen `AI_BACKEND`‑Guard → Rollback per ENV‑Fix; Guard kann temporär per Feature‑Flag abgeschwächt werden (nur in Notfällen, nicht empfohlen).
