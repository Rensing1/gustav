# PR-Review Fixplan (Security, API-Konsistenz, Robustheit)

Datum: 2025-11-11  
Autor: Codex (Teacher/Developer)  
Status: Geplant – Must-Fix vor Merge, Rest zeitnah

## Hintergrund & Ziel
Dieses Dokument fasst das heutige Code-Review zusammen und leitet konkrete TDD-Schritte ab. Fokus entlang unserer Prinzipien: KISS, Security‑First (DSGVO/Auth), FOSS/Lernbarkeit, API Contract‑First, Clean Architecture. Änderungen sind minimal-invasiv und vertragstreu.

## Kurzfazit
Solider Ausbau (Upload‑Intents, Same‑Origin‑Proxy, Worker‑Health). Security‑Header, RLS und CSRF weitgehend sauber. Risiken: kleiner Contract‑Drift und Timeout‑Lücke. Rate‑Limiting ist bewusst out‑of‑scope. Wir schließen 4 Must‑Fixs, ergänzen konsistente Tests/Doku.

## Befunde (Top‑Priorität)
1) [API] Upload‑Intent liefert unerwartetes Feld `method`  
   Evidenz: `backend/web/routes/learning.py:1050@HEAD`  
   Impact: Contract‑Drift gegenüber `StudentUploadIntentResponse`; Clients/Tests können brechen.  
   Entscheidung: Feld entfernen (bevorzugt) statt Vertrag zu ändern.

2) [SEC] Rate‑Limit (bewusst nicht umgesetzt)  
   Entscheidung: Produktentscheidung — kein Rate‑Limiting im MVP; dokumentiert als Nicht‑Ziel.

3) [SEC] `_is_same_origin` erlaubt fehlende Origin/Referer (Default allow)  
   Evidenz: `backend/web/routes/security.py:18,97@HEAD`  
   Impact: Fußangel; neue POSTs könnten versehentlich CSRF‑anfällig sein.  
   Fix: Default auf False oder Helper eindeutig umbenennen + bei mutierenden Endpunkten strikt `_require_strict_same_origin` verwenden.

4) [SEC] Upload‑Proxy validiert nur Host, nicht Pfad  
   Evidenz: `backend/web/routes/learning.py:1197-1205@HEAD`  
   Impact: SSRF zu Nicht‑Storage‑Pfaden des gleichen Hosts.  
   Fix: Pfad‑Whitelist (z. B. `/storage/v1/object/upload/…`) erzwingen.

5) [BUG] Kein Timeout bei `requests.head` (Supabase‑Fallback)  
   Evidenz: `backend/teaching/storage_supabase.py:174@HEAD`  
   Impact: Hänger/Thread‑Blockade bei Netzproblemen.  
   Fix: `timeout=5` setzen; Fehlerpfad robust behandeln.

6) [BUG] Upload‑Proxy lehnt host.docker.internal fälschlich ab  
   Evidenz: `backend/web/routes/learning.py:1190-1198@HEAD` prüft `scheme == "http"` und erlaubt nur localhost/127/::1.  
   Impact: Standard-Setup (`SUPABASE_URL=http://host.docker.internal:54321`) kann keine Dateien mehr hochladen, weil der Proxy bereits vor dem Upload mit 400 `invalid_url` antwortet. Das blockiert Dev/Test-Installationen komplett.  
   Fix: HTTP-Whitelist um `host.docker.internal` und Compose-Service-Namen erweitern oder den Spezialfall entfernen und sich auf den bestehenden Gleichheits-Check zwischen Zielhost und `SUPABASE_URL` verlassen. Ergänzende Regressionstests für den Proxy einplanen.

7) [SEC] Vision-Adapter prüft Hash bei Supabase-Fallback nicht  
   Evidenz: `backend/learning/adapters/local_vision.py:401-444@HEAD` verifiziert `sha256` nur für lokale Dateien; beim HTTP-Download wird der Hash nie geprüft, obwohl `job_payload["sha256"]` vorliegt.  
   Impact: Manipulierte oder verspätet hochgeladene Dateien können unbemerkt verarbeitet werden, sobald der Worker auf die Remote-Bytes zurückfällt – Integritätsschutz entfällt genau dann, wenn er am wichtigsten ist.  
   Fix: Nach jedem Remote-Download denselben Size/Hash-Abgleich wie beim lokalen Pfad durchführen und bei Abweichung `VisionPermanentError("hash_mismatch")` zurückgeben. Tests für beide Pfade ergänzen (lokal vs. remote).

## Weitere Punkte (Should/Nice)
- [CONSISTENCY] 404 bei Rollenfehler (Intent) vs. 403 anderswo  
  Evidenz: `backend/web/routes/learning.py:877-878@HEAD`  
  Fix: Vereinheitlichen auf 403 oder OpenAPI‑Hinweis ergänzen, dass 404 auch bei fehlender Rolle auftreten kann (Absicht: Nicht‑Leaken).
- [SEC] Upload‑Proxy: Content‑Type‑Whitelist (image/*, application/pdf)  
  Evidenz: `backend/web/routes/learning.py:1205@HEAD`  
  Fix: Header prüfen, sonst 400 `mime_not_allowed`.
- [CONSISTENCY] Einheitliche Cache/Vary‑Header in sämtlichen Fehlerpfaden  
  Fix: zentralen Helper konsequent verwenden.
- [NICE] X‑Request‑Id Header ergänzen und im Fehlerlog mitschreiben.

## Ergänzungen aus Review (Codex)
- [API] 201 vs. 202 Inkonsistenz bei Submissions  
  Evidenz: `api/openapi.yml:1976-1987@HEAD` listet 201; Code antwortet stets 202  
  (`backend/web/routes/learning.py:773@HEAD`).  
  Fix: Entweder 201 aus Vertrag entfernen (empfohlen) oder echten Sync‑Fast‑Path implementieren und gezielt 201 senden.

- [CONSISTENCY] Signed‑URL Host‑Rewrite Doku vs. Verhalten  
  Evidenz: Docstring spricht von „appears local ODER Toggle“; Implementierung
  rewritet nur bei Toggle. `backend/teaching/storage_supabase.py:251-277@HEAD`.  
  Fix: Entweder Local‑Host‑Erkennung wirklich implementieren oder Docstring an das
  Toggle‑only‑Verhalten anpassen (bevorzugt Doku angleichen für KISS).

- [SEC] Streaming‑Verifikation folgt Redirects  
  Evidenz: `backend/storage/verification.py:41@HEAD` `follow_redirects=True`.  
  Fix: Redirects deaktivieren oder streng limitieren; Host/Schema gegen `SUPABASE_URL`
  validieren, um SSRF/Umleitungen zu dämpfen.

- [ROBUSTNESS] Potenzielles N+1 bei Sections‑Listing  
  Evidenz: `backend/learning/repo_db.py` ruft Materialien/Aufgaben je Section separat ab.  
  Fix: Batch‑Fetch oder DB‑Helper, der aggregiert zurückliefert; behutsam, solange kein Hot‑Path.

- [SEC] Dev Upload‑Stub: Content‑Type explizit whitelisten  
  Evidenz: `backend/web/routes/learning.py:1091-1140@HEAD` prüft keine Header‑MIME.  
  Fix: `Content-Type` gegen `ALLOWED_IMAGE_MIME ∪ ALLOWED_FILE_MIME` validieren; sonst 400.

- [CONSISTENCY] Einheitliche Cache‑Header über alle Fehlerpfade  
  Evidenz: einzelne Pfade setzen zusätzlich Diag‑Header, aber Cache‑Header prüfen.  
  Fix: konsequent `_cache_headers_error()` überall verwenden.

## Zusätzlicher TDD‑Plan (ergänzend)
- Given OpenAPI lists 201; When calling create submission; Then actual status ∈ {202} oder Vertrag angepasst.  
  Tests: `backend/tests/test_learning_api_contract.py::test_submission_status_contract`

- Given verification download; When redirect occurs; Then request nicht gefolgt oder strikt limitiert.  
  Tests: `backend/tests/test_storage_verification_streaming.py::test_redirects_disallowed`

- Given many sections; When listing; Then höchstens N DB‑Roundtrips (smoke metric).  
  Tests: `backend/tests/test_learning_api_contract.py::test_sections_listing_no_n_plus_one` (Marker/budgetiert)

- Given dev upload‑stub with bad Content‑Type; When PUT; Then 400 `mime_not_allowed`.  
  Tests: `backend/tests/test_learning_upload_proxy_fallback.py::test_upload_stub_rejects_bad_mime`

## Contract‑First Änderungen
- Keine Schema‑Erweiterung geplant. Upload‑Intent‑Feld `method` wird entfernt, damit `StudentUploadIntentResponse` unverändert gültig bleibt.
- 201 (sync) wird aus `createLearningSubmission` entfernt; Endpoint ist verlässlich asynchron (202). Beschreibung entsprechend anpassen.
- Ergänzende Spezifikationshinweise (deskriptiv, keine Breaking Changes): präzisere CSRF‑Notes.

## Beschlossene Optionen (Stand)
- Submissions: rein asynchron → 202; 201 aus OpenAPI streichen (kein Sync‑Fast‑Path).
- Signed‑URL Host‑Rewrite: „Toggle‑only“ dokumentieren; keine Heuristik einbauen.
- Verification‑Download: Redirects deaktivieren (3xx = Fehler) – Whitelist ggf. später.
- Dev Upload‑Stub: Content‑Type gegen `ALLOWED_IMAGE_MIME ∪ ALLOWED_FILE_MIME` whitelisten.
- Fehlerpfade: Cache/Vary‑Header zentral vereinheitlichen.
- Sections N+1: beobachten, in Backlog für batchende Helper.

## TDD‑Plan (Given‑When‑Then)
- Given POST upload‑intent ohne Origin/Referer; When call; Then 403 `csrf_violation`.  
  Tests: `backend/tests/test_learning_api_contract.py::test_upload_intent_requires_same_origin`
- Given teacher session; When POST upload‑intent; Then 403 forbidden (oder dokumentiertes 404).  
  Tests: `backend/tests/test_learning_api_contract.py::test_upload_intent_forbidden_role`
- Given upload‑intent response; When parsing; Then keine unbekannten Felder (insb. kein `method`).  
  Tests: `backend/tests/test_openapi_learning_upload_proxy_contract.py::test_upload_intent_shape_matches_schema`
- Given proxy url host≠SUPABASE_URL; When PUT; Then 400 `invalid_url_host`.  
  Tests: `backend/tests/test_openapi_learning_upload_proxy_contract.py::test_proxy_rejects_wrong_host`
- Given proxy url gleicher Host aber falscher Pfad; When PUT; Then 400 `invalid_url`.  
  Tests: `backend/tests/test_openapi_learning_upload_proxy_contract.py::test_proxy_rejects_wrong_path`
- Given requests.head Fallback; When Remote stallt; Then Rückgabe innerhalb Timeout (keine Hänger).  
  Tests: `backend/tests/test_teaching_materials_files_api.py::test_head_timeout_protects`
- Given proxy Content‑Type nicht erlaubt; When PUT; Then 400 `mime_not_allowed`.  
  Tests: `backend/tests/test_openapi_learning_upload_proxy_contract.py::test_proxy_rejects_bad_mime`

## Umsetzungsschritte (Red‑Green‑Refactor)
1. Tests rot herstellen/anpassen (API‑Form, CSRF, Host/Pfad, Redirect‑Policy, MIME, ggf. 403/404‑Erwartung harmonisieren).  
2. Minimaler Code:
   - Entferne `method` aus Upload‑Intent‑Antwort (Learning‑Router).
   - Entferne 201 aus OpenAPI (Submissions) und beschreibe asynchrones Verhalten (202).
   - (entfällt) Rate‑Limit Middleware/Decorator für `/auth/login`, `upload‑intents`, `internal/upload‑proxy`.
   - `_is_same_origin`: Default‑Allow klar dokumentieren; mutierende Routen prüfen, dass sie strikt sind.
   - Upload‑Proxy: Pfad‑Whitelist und Content‑Type‑Whitelist validieren; konsistente Error‑Bodies/Headers.
   - Verification‑Download: Redirects deaktivieren; Host nicht wechseln lassen; Fehlerpfad eindeutig.
   - `requests.head(..., timeout=5)` setzen (Supabase‑Fallback);
   - Fehlerpfade: Cache/Vary‑Header vereinheitlichen.
3. Refactor & Doku: OpenAPI‑Notes (CSRF), `docs/references/*` anpassen; Docstring zum Host‑Rewrite auf „Toggle‑only“.

## Akzeptanzkriterien
- Alle o. g. Tests grün: `.venv/bin/pytest -q`.  
- Keine unerwarteten Felder in Upload‑Intent‑Response; Proxy lehnt falschen Host/Pfad/MIME ab; Verification folgt keinen Redirects; `requests.head` blockiert nicht.  
- Konsistente 403/404‑Semantik dokumentiert/getestet.

## Risiken & Rückfallplan
- (entfällt) Rate‑Limit könnte falsche Positives in CI erzeugen.
- Striktere Proxy‑Prüfung könnte spezielle Supabase‑Pfade blocken → erlaubte Pfade eng am tatsächlichen Presign‑Output testen.

## Nächste Schritte
- Vertrag/Doku anpassen (201→202, CSRF‑Hinweise, Host‑Rewrite‑Docstring).  
- Tests anpassen/hinzufügen (Proxy‑Path/MIME/Redirects, Upload‑Intent‑Shape).  
- Minimal‑Änderungen umsetzen (Whitelist/Redirect‑Policy/Timeout/Cache‑Header).  
- Vollständiger Testlauf + Security‑Pass (Cookies, CSRF, RLS) verifizieren.

## Smoke‑Tests (lokal)
- Learning‑Test‑Suite grün (Upload‑Intents/Proxy/Verification). Auszug:
  - test_learning_internal_proxy_prod_parity.py: 5 passed
  - test_learning_internal_proxy_security.py: 4 passed
  - test_learning_upload_intent_response_shape.py: 1 passed
  - test_supabase_storage_head_timeout.py: 1 passed

## E2E‑Tests (Ollama, Vision, Supabase)
- Voraussetzungen: `supabase status` OK, `docker compose up -d ollama` (Modelle vorhanden), `.env` geladen.
- Ergebnisse:
  - backend/tests/ai/test_ollama_integration.py: 1 passed (AI_FEEDBACK_MODEL=llama3.1, OLLAMA_BASE_URL=http://localhost:11434)
  - backend/tests/ai/test_ollama_vision_integration.py: 1 passed (AI_VISION_MODEL=qwen2.5vl:3b)
  - backend/tests/test_supabase_storage_e2e.py: 3 passed (RUN_SUPABASE_E2E=1, SUPABASE_URL/KEY aus .env)

## Backlog
- Batchende DB‑Helper für Sections‑Listing (Materialien/Aufgaben) zur N+1‑Vermeidung; erst aktivieren, wenn Profiling Bedarf zeigt.

---

# Compact Review (PR 2025‑11‑11)

## Kurzfazit
Guter Fortschritt bei Upload‑Sicherheit. Hauptnutzen: konsistenter Vertrag und SSRF‑Härte. Rate‑Limit: bewusst nicht Teil des MVP. Empfehlung: mergen nach kurzen Nachtests.

## MUST-FIX
- [API] Entferne Feld `method` aus Upload‑Intent — Evidenz: backend/web/routes/learning.py:1043@4599e66 — Impact: Contract‑Drift bricht Clients — Fix: Sende nur dokumentierte Felder.
- [SEC] Proxy erzwingt Storage‑Pfad — Evidenz: backend/web/routes/learning.py:1203@4599e66 — Impact: SSRF‑Risiko bei freien Pfaden — Fix: Erlaube nur `/storage/v1/object/…`.
- [SEC] MIME‑Whitelist im Proxy — Evidenz: backend/web/routes/learning.py:1213@4599e66 — Impact: unerw. Typen via Same‑Origin — Fix: `image/*`, `application/pdf`, `application/octet-stream`.
- [BUG] HEAD‑Fallback ohne Timeout — Evidenz: backend/teaching/storage_supabase.py:175@4599e66 — Impact: Hänger bei Netzproblemen — Fix: `requests.head(..., timeout=5)`.
- [BUG] host.docker.internal blockiert — Evidenz: backend/web/routes/learning.py:1199@4599e66 — Impact: Dev/CI‑Uploads schlagen fehl — Fix: als lokaler Host whitelisten.

## SHOULD-FIX
- [CONSISTENCY] Dokumentiere `mime_not_allowed` beim Proxy — Evidenz: api/openapi.yml:4908@4599e66 — Impact: Vertrag unvollständig — Fix: 400‑Details ergänzt.

## NICE-TO-HAVE
(entfällt)

## Tests
- Given student+visible task, When POST upload‑intent, Then kein `method` Feld (backend/tests/test_learning_upload_intent_response_shape.py::test_upload_intent_response_does_not_include_method)
- Given SUPABASE_URL, When proxy URL mit fremdem Host, Then 400 invalid_url_host (backend/tests/test_learning_internal_proxy_security.py::test_proxy_rejects_wrong_host)
- Given SUPABASE_URL, When proxy URL mit falschem Pfad, Then 400 invalid_url (backend/tests/test_learning_internal_proxy_security.py::test_proxy_rejects_invalid_path)
- Given text/plain, When proxy PUT, Then 400 mime_not_allowed (backend/tests/test_learning_internal_proxy_security.py::test_proxy_rejects_disallowed_mime)
- Given fallback, When head_object, Then requests.head mit timeout (backend/tests/test_supabase_storage_head_timeout.py::test_head_fallback_sets_timeout)

## Refactor-Budget
S · Blast radius: learning routes, supabase adapter, OpenAPI.

## Freigabe
✅ Änderungen sind klein, vertragstreu und sicherheitsrelevant. Rate‑Limiting ist ausdrücklich nicht vorgesehen. Merge empfohlen nach kurzem Smoke‑Test im Compose‑Setup.
