# PR-Review Fixplan 2 (Security, Robustheit, Konsistenz)

Datum: 2025-11-11  
Autor: Codex (Teacher/Developer)  
Status: Implementiert – 3 Security‑MUST gelöst (TDD)

## Hintergrund & Ziel
Dieses Dokument protokolliert die Review-Befunde und leitet minimal-invasive, TDD‑geführte Korrekturen ab. Maßstab: KISS, Security‑First (DSGVO/Auth), FOSS/Lernbarkeit, API Contract‑First, Clean Architecture. Keine neuen Layer, nur gezielte Härtungen und Konsistenz.

## Kurzfazit
Starker Ausbau bei Upload‑Intents/Proxy, Worker‑Health und zentraler Storage‑Konfig. Nutzen: klar; Risiken: PII‑Logs, fehlende HTTP‑Timeouts, fehlende Prod‑Guards für Verifikation/Proxy. Empfehlung: 3 Security‑MUST vor Merge; Rest zeitnah.

## MUST‑FIX
1) [SEC] PII in Vision‑Logs reduzieren  
   Evidenz: `backend/learning/adapters/local_vision.py:256` (object_key, student_sub im Log)  
   Impact: Potentielles PII/DSGVO‑Leak in Serverlogs.  
   Fix: Pfad/Schüler‑IDs nicht loggen (oder hashen), nur `submission_id` und aggregierte Infos; sensible Details auf Debug.

2) [SEC] HTTP‑Requests ohne Timeout in Storage‑Bootstrap  
   Evidenz: `backend/storage/bootstrap.py:33`, `:49`  
   Impact: Hänger/DoS bei Netzwerkproblemen.  
   Fix: feste Timeouts (z. B. connect=3s/read=10s) + Exception‑Handling; klare Warnlogs statt Blockade.

3) [SEC] Prod‑Guards für Verifikation/Proxy fehlen  
   Evidenz: `backend/web/config.py:106` (AI_BACKEND‑Guard vorhanden, aber keine REQUIRE_STORAGE_VERIFY/Proxy‑Sperre)  
   Impact: Integritätsschutz schwächer; versehentlich aktivierter Proxy/Stub in Prod.  
   Fix: In Prod `REQUIRE_STORAGE_VERIFY=true` erzwingen; `ENABLE_DEV_UPLOAD_STUB`/`ENABLE_STORAGE_UPLOAD_PROXY` in Prod verbieten (Fail‑fast).

4) [SEC] SSRF‑Risiko bei Streaming‑Verifikation (Download)  
   Evidenz: `backend/storage/verification.py:41` (`follow_redirects=True`)  
   Impact: Interne Hosts/Metadata könnten unfreiwillig abgefragt werden.  
   Fix: `follow_redirects=False`, Host‑Allowlist (Host aus `SUPABASE_URL`), harter Gesamt‑Timeout; nur same‑host erlauben.

5) [SEC] SSRF‑Risiko beim Upload‑Proxy (Weiterleitung)  
   Evidenz: `backend/web/routes/learning.py:113` (PUT an beliebige Presign‑URL)  
   Impact: Server‑Side‑Request‑Forgery via manipulierte Presign‑URL.  
   Fix: Presign‑URL parsen, Host strikt gegen `SUPABASE_URL` validieren; Redirects verbieten; Timeout begrenzen.

6) [SEC] Upload‑Proxy prüft Port nicht  
   Evidenz: `backend/web/routes/learning.py:1174` (Hostvergleich, aber kein Port‑Check).  
   Impact: Angreifer können denselben Hostnamen mit anderem Port (z. B. `host.docker.internal:5432`) ansteuern und so interne Dienste via SSRF abtasten.  
   Fix: Schema + Port mit `SUPABASE_URL` matchen (oder explizite Allowlist), alle Abweichungen 400 `invalid_url_host`.

## SHOULD‑FIX
- [CONSISTENCY] Doppelter Size‑Default vermeiden  
  Evidenz: `backend/storage/learning_policy.py:19` (10 MiB)  
  Fix: Route/Policy sollen `backend/storage/config.get_learning_max_upload_bytes()` verwenden (single source of truth).

- [SEC] Vision „wrong_content“‑Warnungen ohne Objektpfade  
  Evidenz: `backend/learning/adapters/local_vision.py:256`  
  Fix: Keine Bucket/Key‑Ausgabe, nur Typ/Status/Sizes + `submission_id`.

- [SEC] Redirects in Verifikation/HEAD strikt verbieten  
  Evidenz: `backend/storage/verification.py:41`  
  Fix: Keine Redirects; nur same‑host akzeptieren.

- [CONSISTENCY] HTTP‑Client vereinheitlichen  
  Evidenz: Mix aus `requests` (Bootstrap) und `httpx` (Proxy/Async)  
  Fix: Ein Client‑Konzept mit konsistenten Timeouts/Headers.

- [SEC] OLLAMA Host‑Validierung präzisieren  
  Evidenz: `backend/learning/config.py:41` (zu permissiv via `isalpha()`)  
  Fix: Nur localhost/127.0.0.0/8/::1 oder explizite Docker‑Service‑Hosts via ENV.

- [DOC] „extracted“‑Status in UI/Docs hervorheben  
  Evidenz: OpenAPI enthält Status, UI/Doku müssen erklärt werden  
  Fix: CHANGELOG/ARCHITECTURE ergänzen, Badge in UI.

## NICE-TO-HAVE
- [DOC] Diag-Header dokumentieren  
  Evidenz: `backend/web/routes/learning.py:170` (X-Submissions-Diag)  
  Fix: Kurznotiz im OpenAPI als x-Notes.

## Regression – Learning Feedback JSONAdapter

- **Symptom**: Seit Commit `7e706eab` fielen `analysis_json`/`feedback_md` in der Pipeline auf Default-Werte zurück. Logs: `learning.feedback.dspy_configured … adapter=JSONAdapter`, anschließend `learning.feedback.feedback_model_failed reason=ResponseError`.
- **Ursache**: Der Worker erzwingt `dspy.JSONAdapter` ohne Feature-Flag. LiteLLM/DSPy erwartet zusätzlich `OLLAMA_HOST`, das im Container nicht gesetzt war. Die JSONAdapter-Aufrufe schlugen sofort fehl → Legacy-Pfade liefen nicht an, Tests deckten den Fehlerpfad nicht ab.
- **Fix**:
  1. JSONAdapter bleibt per `LEARNING_DSPY_JSON_ADAPTER` steuerbar (Default jetzt `True`, kann bei Bedarf auf `false` gesetzt werden). Dadurch lassen sich strukturierte Pfade aktiv halten, während bei Problemen ein kontrolliertes Downgrade möglich ist (`backend/learning/workers/process_learning_submission_jobs.py`, `backend/learning/adapters/dspy/feedback_program.py`).
  2. `OLLAMA_BASE_URL` wird nun auf alle benötigten DSPy/LiteLLM-Parameter gespiegelt (`OLLAMA_HOST`, `OLLAMA_API_BASE`, `api_base`), sodass Aufrufe den laufenden Ollama-Dienst erreichen.
- **TDD**:
  - `backend/tests/learning_adapters/test_local_feedback_dspy.py::test_feedback_recovers_when_json_adapter_disabled`
  - `backend/tests/learning_adapters/test_local_feedback_host_env.py::test_feedback_program_sets_ollama_host`
  - `backend/tests/test_learning_worker_e2e_local.py::test_e2e_local_ai_text_submission_without_json_adapter`

## TDD-Szenarien (Given-When-Then)
- Given Vision-Remote-Fetch, When falscher Content-Type/Objektpfad, Then Logs enthalten keine Bucket/Key/Student-IDs (nur submission_id).  
  Test: `backend/tests/learning_adapters/test_local_vision_logs.py::test_redacts_pii`

- Given Storage‑Bootstrap ohne Netz, When ensure_buckets_from_env läuft, Then Rückgabe schnell, keine Hänger (Timeouts), nur Warnlogs.  
  Test: `backend/tests/storage/test_bootstrap_timeouts.py::test_timeouts`

- Given Prod‑Env, When Startup‑Guard läuft, Then REQUIRE_STORAGE_VERIFY erzwungen und Upload‑Stub/Proxy deaktiviert (Fail‑fast).  
  Test: `backend/tests/test_config_security.py::test_prod_requires_storage_verify_and_disables_proxy`

- Given Upload‑Intent, When max_size berechnet, Then Wert stammt aus zentraler Config, kein Drift.  
  Test: (besteh.) `backend/tests/test_learning_upload_intents_limits_and_keys.py`

- Given Presign‑Download, When URL‑Host != SUPABASE_URL‑Host, Then Verifikation schlägt mit `host_forbidden` fehl (keine Redirects).  
  Test: `backend/tests/test_storage_verification_streaming.py::test_reject_non_storage_host`

- Given Upload‑Proxy aktiv, When Presign‑URL auf Fremd‑Host zeigt, Then Proxy antwortet 400 `host_forbidden`.  
  Test: `backend/tests/test_learning_internal_proxy_security.py::test_reject_foreign_upstream_host`

- Given Redirect‑Presign, When Verifikation/Proxy läuft, Then keine Redirect‑Folge (Abbruch).  
  Test: `backend/tests/test_storage_verification_streaming.py::test_disallow_redirects`

## Akzeptanzkriterien
- Keine Logs mit Bucket/Key/Student‑IDs im Vision‑Adapter (nur submission_id).  
- Bootstrap nutzt Timeouts; Aufruf blockiert nicht länger als ~10s bei Netzausfall.  
- Prod‑Startup scheitert ohne `REQUIRE_STORAGE_VERIFY=true` bzw. bei aktivem Stub/Proxy.  
- Upload‑Intents spiegeln zentrale Größenlimits korrekt wider.
- Verifikation/Proxy erlauben ausschließlich same‑host zu `SUPABASE_URL`; keine Redirects.
- Streaming‑Verifikation bricht bei Host‑Mismatch/Redirects ab (saubere Fehlermeldung, keine Netz‑Seiteneffekte).

## Implementierungsschritte (Red‑Green‑Refactor)
1) Tests schreiben/erweitern: Log‑Redaktions‑Test, Bootstrap‑Timeout‑Test, Config‑Guard‑Test.  
2) Minimaler Code:  
   - Vision‑Logs: sensitive Felder entfernen/auf Debug reduzieren.  
   - Bootstrap: `timeout=(3,10)` setzen, `try/except` + Warnlogs.  
   - Config‑Guard: Prod‑Checks für `REQUIRE_STORAGE_VERIFY` und Deaktivierung Stub/Proxy.  
3) Refactor/Docs: kurze OpenAPI x‑Notes zu Diag‑Headern.

## Ergebnisse (Stand jetzt)
- Tests grün:
  - backend/tests/learning_adapters/test_local_vision_logs.py::test_redacts_pii  
  - backend/tests/storage/test_bootstrap_timeouts.py::test_timeouts  
  - backend/tests/test_config_security.py::test_prod_requires_storage_verify_and_disables_proxy  
- Änderungen minimal:
  - backend/learning/adapters/local_vision.py — entfernte Bucket/Object‑Key/Paths aus Logs (nur submission_id, size, status).  
  - backend/storage/bootstrap.py — Timeouts und Exception‑Handling für GET/POST (keine Hänger).  
  - backend/web/config.py — Prod‑Guard erzwingt REQUIRE_STORAGE_VERIFY=true und verbietet Stub/Proxy.  
  - api/openapi.yml — x‑notes zu optionalem Diag‑Header.

### Hotfix: Upload‑Proxy Pfad‑Normalisierung (TDD)

Problem: Presign‑URLs können lokal ein doppeltes Slash nach `/storage/v1/` enthalten (…`/storage/v1//object/upload/…`). Der strikte SSRF‑Guard im Proxy lehnte diese ab → 400.

Tests (neu):
- backend/tests/test_learning_internal_proxy_security.py::test_proxy_allows_double_slash_path — akzeptiert doppelte Slashes (forward wird aufgerufen).
- backend/tests/test_storage_supabase_adapter.py::test_presign_upload_collapses_double_slashes_and_forces_upload_sign — Adapter kollabiert `//` und erzwingt `object/upload/sign`.

Code (minimal):
- backend/web/routes/learning.py — vor Pfadcheck doppelte Slashes kollabieren.
- backend/teaching/storage_supabase.py — Pfad nach Presign‑Rewrite kollabieren (und vor dem Rewrite für zuverlässiges Matching).

## Hinweise für Review
- Security: Keine PII in Logs; prod‑Start bricht bei unsicheren Flags ab.
- KISS: Keine neuen Layer, nur gezielte Guards/Timeouts.
- Konsistenz: Upload‑Limits bleiben zentral, keine Änderung am Contract außer x‑notes.

## Risiken & Mitigation
- Falsche Negativ‑Starts in Staging durch strenge Guards → Mit Feature‑Flag nur für Prod beginnen, Staging koordiniert anheben.  
- Dev‑Komfort: Timeouts zu kurz → als ENV parametrisierbar machen (Default konservativ).

## Aufwand & Scope
- Aufwand: S (≤ 90 Min).  
- Blast Radius: Vision‑Adapter Logging, Storage‑Bootstrap, Web‑Config‑Startup.

## Restliche Testhärtung (2 Flakes)

Warum: In manchen lokalen Umgebungen schlugen zwei Worker‑Tests sporadisch fehl – Ursache waren RLS‑Leserechte ohne GUC und DSN‑Drift zwischen App/Worker.

- Fix 1 (RLS‑GUC setzen):
  - Test: `backend/tests/test_learning_worker_jobs.py::test_worker_marks_feedback_failure_records_job_error`
  - Änderung: vor SELECT auf `learning_submissions` in derselben Session `select set_config('app.current_sub', <student_sub>, true)` setzen.
  - Grund: Ohne `app.current_sub` greift RLS und die Zeile ist unsichtbar → `fetchone() is None` → `TypeError`.

- Fix 2 (DSN angleichen + saubere Queue):
  - Test: `backend/tests/test_learning_worker_text_bypass_vision.py::test_worker_bypasses_vision_for_text_and_preserves_text`
  - Änderung: `monkeypatch.setenv('SERVICE_ROLE_DSN', _dsn())` am Testbeginn; zusätzlich `delete from public.learning_submission_jobs` vor Anlegen der Submission.
  - Grund: Verhindert Cross‑DB‑Drift (Worker sah keine Jobs) und stellt deterministische Sichtbarkeit sicher.

Validierung:
- Selektiver Lauf beider Tests grün; gesamte Suite weiterhin stabil. Keine Produktivlogik verändert (nur Tests).
