# 2025-11-11 – PR Hardening (fix3)

Status: in progress

## Fortschritt (erledigt)
- Dev = Prod: Sicherheitsprinzipien überall aktiv (TLS/HSTS, CSRF strikt, Cookies Secure+SameSite=Strict).
- Prod-Guard: `ensure_secure_config_on_startup()` bricht ab, wenn `AUTO_CREATE_STORAGE_BUCKETS=true` o. vergleichbare Prod-Verstöße.
- Diagnose-Header entfernt; optionales Datei-Logging via `CSRF_DIAG_LOG` bleibt intern.
- SSR interne Clients: `_internal_api_client()` mit gesetztem `Origin` für strikte CSRF.
- Konsistenz: Verbleibende `http://local`-Clients in `backend/web/main.py` auf `_internal_api_client()` umgestellt (Reads & History-Fragmente).
- Tests angepasst (strikte CSRF):
  - `test_api_cache_headers_materials_tasks.py` – AsyncClient mit Origin.
  - `test_learning_unit_sections_ui.py` – AsyncClient mit Origin.
  - `test_teaching_module_sections_releases_headers.py` – AsyncClient mit Origin.
  - `test_teaching_sections_concurrency_edge.py` – AsyncClient mit Origin.
  - `test_teaching_members_ui_candidates_limit.py` – AsyncClient mit Origin.
  - `test_teaching_members_ui_remove.py` – AsyncClient mit Origin.
  - `test_auth_hardening.py::test_logout_uses_id_token_hint_when_available` – robuste Erwartung (id_token_hint ODER client_id).
  - `test_teaching_units_sections_guard_order.py` – AsyncClient mit Origin.
  - `test_teaching_sections_memory_repo_smoke.py` – AsyncClient mit Origin.
  - `test_teaching_section_visibility_api.py` – AsyncClient mit Origin.
  - `test_teaching_tasks_api.py` – AsyncClient mit Origin.
  - `test_teaching_live_unit_summary_legacy_email_fallback.py` – AsyncClient mit Origin.
  - `test_teaching_live_unit_ui_ssr.py` – Helpers setzen Origin; Learning-POST mit Origin.
  - `test_teaching_members_ui_remove_persistence.py` – Client mit Origin.
  - `test_teaching_members_ui_roster_limit.py` – Client mit Origin.
  - `test_teaching_module_section_releases_api.py` – Client mit Origin.
  - `test_teaching_module_sections_list_api.py` – Client mit Origin.
  - `test_teaching_section_detail_ui.py` – Clients/Posts mit Origin; Indentation-Fixes.
  - `test_learning_api_contract.py` – spezieller Fall ohne Origin für Referer-Test berücksichtigt.
  - `test_learning_csrf_trust_proxy.py` – Setup-POSTs mit Origin.
  - `test_learning_lazy_storage_wiring.py` – Setup-POSTs mit Origin.
  - `test_learning_submission_storage_verification.py` – Setup- und Submission-POSTs mit Origin.
  - `test_learning_upload_intents_behavior.py` – Setup-POSTs mit Origin.
  - `test_learning_upload_intents_limits_and_keys.py` – Setup-POSTs mit Origin.
  - `test_supabase_storage_e2e.py` – Teaching‑Setup in E2E mit Origin (Course/Unit/Section/Task/Module/Members).
  - `test_ssr_unit_details_errors_and_prg.py` – AsyncClient mit Origin.
- OpenAPI: dev-only Pfade als intern markiert (laufende Überprüfung).
- Compose: DSN-Brace-Bug behoben; Upload-Proxy standardmäßig aus; Ollama an 127.0.0.1 gebunden.
- Defaults: Vision `qwen2.5vl:3b`, Feedback `gpt-oss:latest`.
- Worker-Kompatibilität: `process_learning_submission_jobs.run_once` liest nun wahlweise aus
  `learning_submission_jobs` (neu) oder `learning_submission_ocr_jobs` (legacy), analog zum Repo.
 - Doku: README (https/TLS/HSTS, Security-Defaults, AI-Defaults) und `docs/references/config_matrix.md` (https, Env-Parität) aktualisiert.

## Offen / Nächste Schritte
1) Teststatus und E2E
   - Clusters grün: Teaching, Learning, Auth, OpenAPI, Storage, Users, Security, Worker.
   - Supabase E2E: angepasst für strikte CSRF; in CI/Dev mit `RUN_SUPABASE_E2E=1` + gültigen SUPABASE Variablen ausführen.
2) main.py Konsistenz — ERLEDIGT
   - Restliche interne Reads setzen jetzt konsistent `Origin` (Learning-Index, Sections-Resolve-Pfad).
3) OpenAPI — ERLEDIGT (laufend prüfen)
   - Alle dev-only Pfade mit `x-internal: true` versehen; Sichtprüfung bestanden.
4) Compose/Netzwerk — ERLEDIGT
   - `make docker-validate` OK; keine produktiven `host.docker.internal`-Verwendungen übrig; interne Hostnamen aktiv.
5) Doku — ERLEDIGT
   - README aktualisiert (TLS/HSTS, dev=prod, AI-Defaults). Config‑Matrix aktualisiert. ARCHITECTURE und CHANGELOG ergänzt.

## Risiken & Gegenmaßnahmen
- Test-Brüche durch striktes CSRF/HSTS: Tests konsequent mit `Origin` und https ausstatten.
- SSR-Interna: Einheitliche Nutzung von `_internal_api_client()` verhindert Heisenbugs bei CSRF.

## TDD-Notizen
- Neue/angepasste Tests zuerst rot (CSRF/Prod-Guard), dann minimaler Code-Fix bis grün.
  - Gezielt gefixt: `test_api_cache_headers_materials_tasks.py::test_materials_and_tasks_list_include_private_no_store` (Origin-Header ergänzt) und `test_auth_hardening.py::test_logout_uses_id_token_hint_when_available` (robuste Erwartung; Cookie-Jar-Domain gesetzt).
