# PR Review – Fix Plan (2025-11-12)

## Kurzfazit
Starker Schritt Richtung Security‑by‑default und zentraler Konfiguration. Wichtigste Lücke: API‑Dokumentations‑Mismatch bei Logout‑Cookie‑Flags. Zusätzlich zwei Härtungen: SSRF‑Schutz in Storage‑Verifikation und CI‑Abdeckung für development. Empfehlung: 1× API‑Fix priorisieren, Härtungen nachziehen.

## MUST-FIX
- [API] Cookie‑Policy widerspricht Code (SameSite=strict auch in Dev) — Evidenz: api/openapi.yml:2191-2194@24f513c — “Development/Test: SameSite=lax” — Impact: Falscher Vertrag, Compliance-/Client‑Fehlverhalten — Fix: OpenAPI auf SameSite=strict (Dev/Prod) angleichen (Set‑Cookie unter /auth/logout).

- [API] Gating von feedback_md nur bei completed — Evidenz: backend/learning/repo_db.py:1015@24f513c — Impact: Vertragsverletzung/Leaken teilweiser Daten — Fix: feedback_md nur setzen, wenn analysis_status == "completed".

## SHOULD-FIX
- [SEC] Verifikations‑Download härten — Evidenz: backend/storage/verification.py:41-45@24f513c (follow_redirects=True) — Impact: SSRF‑Risiko — Fix: Redirects deaktivieren und Zielhost gegen SUPABASE_URL whitelisten.
- [SEC] Bucket‑Bootstrap in Prod hart deaktivieren — Evidenz: backend/storage/bootstrap.py:173-177@24f513c — Impact: SRK‑Fehlkonfiguration — Fix: Bei GUSTAV_ENV ∈ {prod,stage} sofort no‑op.
- [CONSISTENCY] Policy‑Limit zentral beziehen — Evidenz: backend/storage/learning_policy.py:19@24f513c — Impact: Drift zu zentralem Config‑Wert — Fix: max_size_bytes via get_learning_max_upload_bytes().
- [CONSISTENCY] Verifikationslimit dynamisch — Evidenz: backend/storage/verification.py:19-23@24f513c — Impact: Oversize je nach Env — Fix: _SAFE_MAX_BYTES an get_learning_max_upload_bytes() koppeln.
- [CONSISTENCY] Duplizierte Port‑Schnittstelle — Evidenz: backend/learning/usecases/pdf_preprocessing.py:34-37@24f513c — Impact: Divergenz — Fix: backend.storage.ports.BinaryWriteStorage importieren.
- [CONSISTENCY] Bucket‑Quelle zentral — Evidenz: backend/storage/learning_policy.py:49-52@24f513c — Impact: Drift zum zentralen Getter — Fix: get_submissions_bucket() nutzen.
- [CONSISTENCY] Doppelte Importzeile entfernen — Evidenz: backend/teaching/services/materials.py:15@24f513c — Impact: Rauschen/Wartbarkeit — Fix: redundanten Import löschen.
- [CONSISTENCY] CI für development aktivieren — Evidenz: .github/workflows/compose-validate.yml:6@24f513c — Impact: Compose‑Fehler unentdeckt — Fix: branches um development ergänzen.

- [SEC] Rate‑Limit für Upload‑Stub — Evidenz: backend/web/routes/learning.py:1113@24f513c — Impact: Dev/CI‑DoS/Diskfüllung — Fix: einfacher Token‑Bucket pro Session/IP, 429 bei Überschreitung.
- [SEC] Rate‑Limit für Upload‑Proxy — Evidenz: backend/web/routes/learning.py:1175@24f513c — Impact: Missbrauch/Lastspitzen — Fix: gleiches Token‑Bucket anwenden.
- [SEC] MIME‑Allowlist im Upload‑Stub erzwingen — Evidenz: backend/web/routes/learning.py:1155@24f513c — Impact: Beliebige Binär‑Writes — Fix: Content‑Type gegen ALLOWED_IMAGE_MIME|ALLOWED_FILE_MIME prüfen, sonst 400 mime_not_allowed.
- [CONSISTENCY] 403‑Beschreibungen vereinheitlichen — Evidenz: api/openapi.yml:4840@24f513c — Impact: Klarere Doku/Clients — Fix: „Forbidden (csrf_violation)“ einheitlich dokumentieren.

## NICE-TO-HAVE
- Vereinheitliche Header-Doku (Vary: Origin) bei Learning-Write-Endpunkten — Impact: Klarheit — Fix: OpenAPI-Header ergänzen.
- Kurzkommentar in verification.py, warum HEAD/ETag nur sha256/content_sha256 vertraut — Impact: Lernbarkeit — Fix: 1–2 erklärende Sätze.
- README-Hinweis: Lokales HTTPS via Reverse‑Proxy für Secure‑Cookie notwendig (passt zu WEB_BASE/KC_PUBLIC_BASE_URL).

- Upload‑Stub: 401/403/404 Error‑Schema explizit dokumentieren — Impact: robustere Clients — Fix: OpenAPI‑Responses mit Error‑Schema ergänzen.

## Tests
- Given dev env, When /auth/callback, Then Set-Cookie enthält Secure+SameSite=strict (backend/tests/test_auth_cookie_policies.py::test_callback_sets_host_only_cookie_dev).
- Given LEARNING_MAX_UPLOAD_BYTES=3MiB, When upload-intent, Then max_size_bytes=3MiB und Bucket aus Config (backend/tests/test_learning_upload_intents_limits_and_keys.py::test_learning_upload_intent_uses_config_limit_and_key_shape; api/openapi.yml: UploadIntent).
- Given REQUIRE_STORAGE_VERIFY=true und falscher Hash, When submit, Then 400 invalid_file_payload (backend/tests/test_learning_submission_storage_verification.py::test_submission_verification_rejects_sha_mismatch).
- Given prod env, When AUTO_CREATE_STORAGE_BUCKETS=true, Then ensure_buckets_from_env no-op (add: backend/tests/storage/test_bootstrap_timeouts.py oder neuer Test).
- Given require_remote & externe Redirect‑URL, When verify download, Then kein Fetch/Fail (download_error) — backend/tests/storage/test_verification_ssrf_guard.py::test_rejects_external_redirect.

- Given status=extracted, When list_submissions, Then feedback_md is null, analysis_json is null bis completed (backend/tests/test_learning_api_contract.py::test_feedback_md_gated_to_completed).
- Given ENABLE_DEV_UPLOAD_STUB=true, When >N PUTs in Δt, Then 429 (backend/tests/test_learning_upload_stub_route.py::test_rate_limit_stub).
- Given internal upload-proxy, When >N PUTs in Δt, Then 429 (backend/tests/test_learning_internal_proxy_prod_parity.py::test_rate_limit_proxy).
- Given stub PUT text/plain, When storing, Then 400 mime_not_allowed (backend/tests/test_learning_upload_stub_route.py::test_stub_rejects_invalid_mime).

## Refactor-Budget
S (≤ 90 Min) · Blast radius: Web Auth (OpenAPI), Storage Verification/Policy, Learning Routes, RepoDB, CI Workflow.

## Freigabe
❌ Wegen API‑Must‑Fix (Cookie‑Policy). Nach Korrektur der OpenAPI (SameSite=strict) und den kleinen Härtungen (SSRF/CI/Consistency) ist der PR freigabereif.

---

## Status-Update (applied 2025-11-12)
- DONE: OpenAPI Cookie-Doku angleichen (Dev=Prod: `Secure; SameSite=strict`) — api/openapi.yml:2138-2139,2193-2194.
- DONE: Verifikationslimit dynamisch über `get_learning_max_upload_bytes()` — backend/storage/verification.py.
- DONE: `feedback_md` nur bei `analysis_status == "completed"` exposen — backend/learning/repo_db.py.
- TESTS: Suite teilweise ausgeführt; keine Regressionshinweise in geänderten Pfaden (lokale Laufzeit begrenzt).
