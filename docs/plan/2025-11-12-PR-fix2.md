# PR Review – 2025-11-12 – PR-fix2

## Kurzfazit
Gute Richtung: HTTPS-by-default, Storage-/AI-ENV klarer, Compose-Check in CI. Risiken: Falsches KC_BASE_URL im .env.example bricht OIDC (lokal=prod), CI triggert nicht für development, ein Makefile-URL‑Bug. Empfehlung: Fixen, dann mergen.
Zusätzlich kritisch: PII‑Logs im Worker und ungültiger OpenAPI‑Null‑Typ; beide blockieren.

## MUST-FIX
- [SEC] Entferne PII aus Worker‑Logs — Evidenz: backend/learning/workers/process_learning_submission_jobs.py:281@e582ca8 „exc“ geloggt — Impact: PII im Log (DSGVO) — Fix: Normierte Fehlercodes/Trunkierung, nicht `str(exc)` loggen.
- [SEC] Whitelist für Verify‑Download‑Host erzwingen — Evidenz: backend/storage/verification.py:46@e582ca8 `client.stream('GET', url)` — Impact: SSRF/Redirect‑Missbrauch — Fix: Host gegen `SUPABASE_URL` prüfen, keine Fremd‑Hosts/Redirects zulassen.
- [SEC] Erzwinge internen Keycloak-Host in KC_BASE_URL — Evidenz: .env.example:25@e582ca8 “KC_BASE_URL=http://id.localhost:8100” — Impact: OIDC-Discovery/Tokenflow scheitert im Containernetz — Fix: `KC_BASE_URL=http://keycloak:8080`.
- [API] Korrigiere OAS 3.0 Null‑Schema — Evidenz: api/openapi.yml:950@e582ca8 `type: 'null'` — Impact: Ungültiger 3.0‑Vertrag, Tooling bricht — Fix: `nullable: true` beibehalten, `type: 'null'` entfernen.
- [TEST] CI triggert nicht für development — Evidenz: .github/workflows/compose-validate.yml:6@e582ca8 “branches: [ main, master ]” — Impact: Compose-Fehler bleiben unentdeckt — Fix: branches um `development` erweitern.
- [BUG] Makefile nutzt HTTP auf TLS‑Port — Evidenz: Makefile:103@e582ca8 “KC_BASE_URL ?= http://127.0.0.1:8100” — Impact: Import schlägt fehl (Caddy nur TLS) — Fix: `https://127.0.0.1:8100`.
- [BUG] Doppelter Import — Evidenz: backend/teaching/services/materials.py:15@e582ca8 — Impact: Lint/Lesbarkeit — Fix: Duplikat‑Import entfernen.

## SHOULD-FIX
- [SEC] Pinne GitHub Actions per Commit‑SHA — Evidenz: .github/workflows/compose-validate.yml:12-14@e582ca8 — Impact: Supply‑Chain‑Risiko — Fix: `actions/checkout@<sha>`, `docker/setup-buildx-action@<sha>`.
- [CONSISTENCY] Dokumentiere lokales TLS‑Trust (Caddy internal CA) — Evidenz: README.md:9@e582ca8 — Impact: Onboarding-Reibung — Fix: Abschnitt “Zertifikat vertrauen” ergänzen.
- [CONSISTENCY] .env.example Kommentar zu KC_BASE_URL — Evidenz: .env.example:23-27@e582ca8 — Impact: Fehlkonfiguration naheliegend — Fix: Hinweis “im Container stets http://keycloak:8080”.
- [API] Größenlimits im Vertrag widerspiegeln — Evidenz: api/openapi.yml:426@e582ca8 `size_bytes` — Impact: Konsistenz (20 MiB Teaching/10 MiB Learning) — Fix: `maximum` ergänzen und Limits zentral referenzieren.
- [API] Vereinheitliche CSRF/503‑Fehlerdetails — Evidenz: api/openapi.yml:4756@e582ca8 „csrf_violation“, 4774@e582ca8 503‑Details — Impact: Client‑Mapping konsistent halten — Fix: Einheitliche `detail`‑Werte und Doku.
- [CONSISTENCY] Header‑Casing dokumentieren — Evidenz: api/openapi.yml:447@e582ca8 `headers` — Impact: Client‑Erwartung — Fix: Lowercase‑Schlüssel in Beschreibung festhalten.

## NICE-TO-HAVE
- GH Workflow nur bei relevanten Änderungen ausführen — Evidenz: .github/workflows/compose-validate.yml:3-7@e582ca8 — Fix: `paths:` auf Dockerfile/compose/Makefile beschränken.
- Threat‑Model‑Hinweis beim Upload‑Proxy (SSRF‑Scope, Host‑Binding) — Evidenz: api/openapi.yml:4841@e582ca8 — Fix: Kurznotiz unter `x-security-notes` ergänzen.

## Tests
- Given env mit KC_BASE_URL=http://keycloak:8080; When Web startet; Then OIDC Discovery 200 und Tokenflow OK (backend/tests_e2e/test_identity_login_register_logout_e2e.py::test_oidc_discovery_ok).
- Given PR auf development; When compose-validate läuft; Then `make docker-validate` gibt “OK” zurück (.github/workflows/compose-validate.yml::docker-validate).
- Given Makefile Import-Defaults; When KC_BASE_URL=https://127.0.0.1:8100; Then Admin-/health-Check 200 (scripts/tests/test_import_legacy_connection.py::test_keycloak_admin_reachable).
- Given OAS 3.0.3; When Spec validiert; Then kein `type: 'null'` (backend/tests/test_openapi_contract.py::test_no_null_type_in_oneOf).
- Given VisionPermanentError; When Worker loggt; Then keine PII im Log (backend/tests/test_learning_worker_privacy_logs.py::test_logs_no_pii).
- Given ENABLE_DEV_UPLOAD_STUB=false; When PUT /internal/upload-stub; Then 404 (backend/tests/test_learning_upload_stub_route.py::test_feature_flag_404).
- Given presigned URL Redirect; When Verify‑Stream lädt; Then Host bleibt SUPABASE_URL (backend/tests/test_storage_verification_streaming.py::test_no_untrusted_redirects).
- Given alle Umgebungen; When Login/Logout; Then Cookie Secure/Strict (backend/tests/test_auth_cookie_policies.py::test_secure_strict_all_envs).
- Given Teacher; When POST Teaching Upload‑Intent mit size_bytes>20MiB; Then 400 size_exceeded (api/openapi.yml:416ff; backend/tests/test_teaching_material_upload_intent.py::test_rejects_oversize).

## Refactor-Budget
S · Blast radius: infra/env + CI + learning worker + storage verification

## Freigabe
❌ Wegen [SEC] PII‑Logs und [API] ungültigem OAS‑Null‑Schema sowie [SEC] KC_BASE_URL/CI‑Abdeckung. Erst diese Fixes, dann Merge unkritisch.
