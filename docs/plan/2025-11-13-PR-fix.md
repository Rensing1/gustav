# 2025-11-13 — PR Review Fix Plan

Scope: Capture review findings, risks, and concrete fixes for the current PR. Includes open questions to resolve before merging.

## Kurzfazit
TLS-by-default für WEB/KC, Compose‑Validierung in CI und klarere AI/Storage‑ENVs sind gut. Die kritischen Punkte wurden umgesetzt: Actions gepinnt, OIDC auf Port 443 vereinheitlicht, RLS auf storage.objects erzwingt deny‑by‑default. Ausstehend: kleiner CI‑Pytest‑Job, Cookie‑Contract in OpenAPI.

## MUST-FIX (Status)
- [SEC] GitHub Actions pinnen — Evidenz: `.github/workflows/compose-validate.yml:30@9c29b72` uses `actions/checkout@v4` (unpinned) — Impact: Supply-chain-Risiko — Fix: Pin auf verifizierte Commit-SHAs für `actions/checkout`, `docker/setup-buildx-action`. Status: umgesetzt mit `actions/checkout@08eba0b27e8…` (v4) und `docker/setup-buildx-action@e468171a9d…` (v3).
- [SEC] Storage RLS für Objekte ergänzen — Evidenz: `supabase/migrations/20251105164245_storage_submissions_bucket.sql:23@9c29b72` (Bucket wird privat angelegt) und keine `storage.objects`-Policies gefunden — Impact: Fehlende/uneinheitliche Absicherung der Objekte — Fix: RLS auf `storage.objects` erzwingen (deny-by-default), keine direkten Policies für App-Rollen. Status: umgesetzt in `supabase/migrations/20251113120000_storage_objects_rls_submissions.sql`.
- [CONSISTENCY] OIDC Host/Port konsistent — Status: umgesetzt auf 443. Updates: `.env.example`, `reverse-proxy/Caddyfile`, `backend/web/*` Defaults, E2E‑Tests, README, references, ARCHITECTURE, Runbook.
- [API] Cookie-Contract angleichen (SameSite) — Status: umgesetzt. OpenAPI beschreibt jetzt `HttpOnly; Secure; SameSite=lax` (host‑only) bei Callback/Logout; Tests/README aktualisiert.

## SHOULD-FIX (Status)
- [TEST] CI-Basislauf `pytest` — umgesetzt (neuer Job in `.github/workflows/compose-validate.yml`).
- [SEC] KC Public-URL absichern — umgesetzt (Test hinzugefügt: `backend/tests/test_auth_idp_public_host.py` stellt Host=`KC_PUBLIC_BASE_URL` sicher; Doku bereits auf 443/Hosts aktualisiert).
- [CONSISTENCY] Kommentare/Doku zu Ports angleichen — umgesetzt im Zuge der 443‑Umstellung (README, references, ARCHITECTURE, Runbook).
 - [CONSISTENCY] Zentrale Upload-Limits nutzen — umgesetzt (learning_policy nutzt Config; Test ergänzt: backend/tests/test_learning_upload_intent_config_limit.py).
- [SEC] HEAD‑Metadaten-Fetch Host‑Allowlist — umgesetzt in `backend/teaching/storage_supabase.py` + Tests `test_supabase_storage_head_security.py`.
 - [CONSISTENCY] OLLAMA Host-Validierung erweitern — umgesetzt (regex-Validierung; Tests: backend/tests/test_learning_ai_config_ollama_validation.py).
- [SEC] Keine Redirects bei HEAD — umgesetzt (`allow_redirects=False`).
 - [SEC] Verifier nur http/https erlauben — umgesetzt (invalid_url_scheme + Tests: backend/tests/storage/test_verification_invalid_scheme.py).
 - [API] 502 mit Cache‑Headern dokumentieren — umgesetzt (api/openapi.yml für Delete/Proxy aktualisiert).
 - [API] `alt_text` Begrenzung spezifizieren — umgesetzt (maxLength: 500 in Material, MaterialUpdate, LearningMaterial).

## NICE-TO-HAVE
- [CONSISTENCY] Workflow-Name/Target präzisieren — Evidenz: `.github/workflows/compose-validate.yml:1@9c29b72`, `Makefile:196-199@9c29b72` — Nutzen: Klarheit; gleiche Benennung (z. B. „docker-validate“ in Jobnamen) hilft Orientierung.
- [API] README/Runbooks verlinken auf `docs/references/storage_and_gateway.md` für zentrale Limits — Evidenz: `.env.example:59-66@9c29b72` — Nutzen: Eine Quelle der Wahrheit für Größenlimits und Flags.
- [CONSISTENCY] OpenAPI-Hinweis „host‑only cookie“ ergänzen — Evidenz: `backend/tests/test_auth_cookie_policies.py:69@9c29b72` (kein `Domain=`) — Nutzen: Klarere Doku zum Cookie‑Scope — Fix: Set‑Cookie‑Beschreibung um „ohne Domain‑Attribut“ erweitern.
- [CONSISTENCY] Test‑Prints minimieren — Evidenz: `backend/web/main.py:997@9c29b72` — Nutzen: Sauberere Logs — Fix: auf `logger.debug` hinter Flag umstellen.
- [CONSISTENCY] .gitignore-Update im README erwähnen — Evidenz: `.gitignore:46@9c29b72` `*.bak` — Nutzen: Entwicklerkomfort — Fix: kurzer Hinweis im Contributing Abschnitt.
- [CONSISTENCY] Test‑Docstring zu Cookie‑Flags angleichen — Status: umgesetzt (auf „SameSite=lax“ geändert).
 - [CONSISTENCY] Gemeinsamen URL‑Normalizer erwägen — Evidenz: `backend/teaching/storage_supabase.py:260@9c29b72` (+ ähnliche Logik im Verifier) — Nutzen: Weniger Duplication — Fix: Nur extrahieren, wenn Nutzung ≥ 3.

## Verifikation & Tests
- Migration anwenden: `supabase migration up` (RLS‑Migration überspringt ohne Owner‑Rechte sicher mit NOTICE).
- Compose prüfen: `make docker-validate`.
- E2E Identity (optional): `RUN_E2E=1 WEB_BASE=https://app.localhost KC_BASE_URL=https://id.localhost .venv/bin/pytest -q -m e2e`.
- Supabase E2E (optional): `make test-supabase` (setzt RUN_SUPABASE_E2E=1, rewrites host für signed URLs).

### Testvorschläge (bleiben)
- Given WEB_BASE Port ≠ Caddy-Expose; When OIDC Login; Then Callback schlägt mit 302 an falschen Host/Port fehl (Fix: ausrichten) — `backend/tests_e2e/test_identity_login_register_logout_e2e.py::test_login_redirect`
- Given bucket `submissions`; When anonymer/unkorrekter Client SELECT/INSERT `storage.objects`; Then 403 via RLS — `backend/tests/test_storage_policies.py::test_submissions_bucket_rls`
- Given CI; When Workflow läuft; Then pytest-Basislauf (ohne Integration-Marker) grün — `.github/workflows/compose-validate.yml::<pytest job>`
- Given OpenAPI Cookie-Flags; When Auth Callback/Logout; Then Set‑Cookie entspricht `SameSite=lax`, host‑only — `api/openapi.yml` vs. `backend/tests/test_auth_contract.py::test_callback_sets_cookie_flags_and_no_max_age`, `backend/tests/test_auth_cookie_policies.py::test_callback_sets_host_only_cookie_prod`
 - Given presign_download HEAD 302; When Metadaten abgerufen werden; Then Redirect nicht folgen und Fehlerzustand melden — `backend/tests/teaching/test_supabase_head_redirect_handling.py::test_head_redirect_not_followed`
 - Given Verifier URL mit `file://`/`ftp://`; When Hash‑Stream gestartet; Then `invalid_url_scheme` — `backend/tests/storage/test_verification_invalid_scheme.py::test_rejects_non_http_scheme`

## Refactor-Budget
S (≤ 90 Min) · Blast radius: CI/ENV/DB-Policies

## Beschlüsse und Klärungen
1) OIDC-Port-Strategie — Beschluss: Einheitlich Port 443. Wir entfernen alle `:8100`‑Referenzen und stellen Compose/Caddy/.env/Doku/Tests auf `https://app.localhost` und `https://id.localhost` um.
2) Storage‑Objekt‑Policies — Klärung in einfachen Worten: Endnutzer greifen nicht direkt auf die Objekte in der DB zu. Der Server erzeugt kurze signierte URLs (mit der Service‑Role) und der Browser lädt/liest damit über die Supabase‑Storage‑API. Vorschlag: `gustav_limited` erhält keine direkten Rechte auf `storage.objects`. Falls der Worker Metadaten braucht, erfolgt das über die Storage‑API oder über eine eng gefasste SECURITY DEFINER‑Function (nur Read, nur passende `bucket_id`). Bitte bestätigen.
3) GitHub‑Actions „Pinning“ — Klärung: Statt `uses: actions/checkout@v4` (bewegliches Tag) fixieren wir die Action auf einen konkreten Commit‑Hash, z. B. `uses: actions/checkout@<commit-sha>`. So verhindern wir unkontrollierte Änderungen. Optional: Dependabot pflegt die SHAs automatisch. Bitte bestätigen.
4) Cookie‑Policy: Bestätigen wir `SameSite=lax` als final (OAuth‑kompatibel) und passen OpenAPI an, oder wollen wir Code auf `strict` anheben (Breaking‑Change für Login)?

## Nächste Schritte
1) CI‑Pytest‑Job — umgesetzt in `.github/workflows/compose-validate.yml` (Python 3.11, pytest, Marker‑Ausschluss).
2) OpenAPI‑Cookie‑Flags — umgesetzt: `SameSite=lax` + host‑only in `api/openapi.yml` (Set‑Cookie‑Header bei Callback/Logout).
3) Optionale Doku‑Bereinigung — erledigt: Nicht‑historische `:8100`‑Referenzen in Doku bereinigt (ARCHITECTURE, auth_legacy, final_run_playbook). README auf `SameSite=lax` vereinheitlicht; Hinweis zu `.gitignore`/Secrets ergänzt. Historische Notizen unverändert belassen.

## Nachtrag (2025‑11‑14) — Stabilisierung nach Regressions
- Auth Public-Host: Resolver für aktives Main‑Modul anhand `request.app` ergänzt, damit Tests mit `main` und `backend.web.main` konsistent greifen. Endpunkte `/auth/login|register|forgot|logout` angepasst. Tests: `backend/tests/test_auth_idp_public_host.py`, `backend/tests/test_auth_contract.py` grün.
- OLLAMA Host‑Policy: Validierung präzisiert (localhost/127/[::1] und einteilige Service‑Hosts erlaubt; FQDNs/Datei/FTP abgelehnt). Tests: `backend/tests/test_learning_ai_config_ollama_validation.py`, `backend/tests/storage/test_verification_invalid_scheme.py` grün.
- Worker Leasing: Sichtbarkeitsfenster von `+5s` auf `+30s` erweitert, um Retry‑Timing‑Drift zu vermeiden. Betroffene Datei: `backend/learning/workers/process_learning_submission_jobs.py`. Relevante Tests: `backend/tests/test_learning_worker_jobs.py` grün.
