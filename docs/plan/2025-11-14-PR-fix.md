# PR Review – Fix Plan (2025-11-14)

## Kurzfazit
Die Änderungen stärken Auth-Defaults, Storage-Sicherheit und AI-Konfiguration deutlich. Offene Punkte betreffen vor allem Robustheit (ENV-Fehler, Vision-Storage-Fetch), API-Vertragsschärfe bei internen Upload-Endpunkten und die Komplexität der Supabase-/Vision-Adapter. Empfehlung: gezielte Härtungen und kleinere Refactorings, kein Blocker.

## MUST-FIX
- [SEC] Upload-Proxy liest kompletten Body in den Arbeitsspeicher, bevor Limits greifen — Evidenz: backend/web/routes/learning.py:1236-1245@7368c5a. Gefahr: Ein einzelner PUT pumpt >LEARNING_MAX_UPLOAD_BYTES Daten in RAM und blockiert den Worker. Maßnahme: Streaming-Read (request.stream/receive) mit hartem Byte-Counter; bei Überschreiten sofort 400 (size_exceeded) zurückgeben.

- [SEC] Upload-Proxy validiert nur den Host, nicht Port/Scheme — Evidenz: backend/web/routes/learning.py:1198-1224@7368c5a. Folge: Studenten können SSRF gegen beliebige Ports derselben Domain oder localhost fahren. Maßnahme: Netloc exakt mit SUPABASE_URL (inkl. Port & Scheme) matchen, http nur für explizite lokale Hosts erlauben, ansonsten 400 invalid_url_host/invalid_url.

## SHOULD-FIX
- [SEC] Vision-Supabase-Fetch mit Host-/Scheme-Validierung und Größenlimit härten — Evidenz: backend/learning/adapters/local_vision.py:420-507@7368c5a — Impact: Sicherheit (SSRF-/Env-/DoS-Risiko bei SUPABASE_URL) — Fix: URL via `urlparse` prüfen, Host gegen SUPABASE_URL/SUPABASE_PUBLIC_URL whitelisten und Downloads per Streaming + `get_learning_max_upload_bytes()` begrenzen, analog `backend/storage/verification._stream_hash_from_url`.

- [SEC] Fehlermeldungen im PDF-Preprocessing vor DB-Write scrubben — Evidenz: backend/learning/usecases/pdf_preprocessing.py:91-99,141-149@7368c5a — Impact: Datenschutz; rohe Renderer-/Persistenz-Fehler können Pfade/PII enthalten — Fix: Message über einen Helfer nach dem Muster von `_sanitize_error_message` kürzen/anonymisieren, bevor `learning_worker_update_failed` aufgerufen wird.

- [API] internal_upload_stub-Error-Responses präzisieren — Evidenz: api/openapi.yml:4831-4884@7368c5a; backend/web/routes/learning.py:1113-1172@7368c5a — Impact: API-Vertrag/Clients — Fix: 401/403/404 mit Error-Schema + Cache-Header dokumentieren; Beschreibungstexte an realen Payload (`{"error": "...", "detail": "..."}`) und CSRF-/Feature-Flag-Fälle angleichen.

- [BUG] Negative *_MAX_UPLOAD_BYTES robuster behandeln — Evidenz: backend/storage/config.py:57-75@7368c5a — Impact: Robustheit (Fehlkonfiguration kann still alle Uploads sperren) — Fix: Bei `value <= 0` klar auf Default zurückfallen (statt 0), optional Warnlog bei offensichtlich falschen Werten.

- [API] Upload-Limits und OpenAPI-Maximum synchronisieren — Evidenz: api/openapi.yml:424-432@7368c5a; backend/storage/config.py:68-75@7368c5a; backend/teaching/services/materials.py:88-99@7368c5a — Impact: Konsistenz; effektive Limits dürfen den im Vertrag dokumentierten `maximum`-Wert nicht überschreiten — Fix: Limits per `min(env_limit, spec_max)` kappen oder Spec/Docs bewusst anheben und Tests (Materials/Learning-Upload-Intent) nachziehen.

- [CONSISTENCY] SupabaseStorageAdapter-URL-Rewrites entflechten — Evidenz: backend/teaching/storage_supabase.py:63-200@7368c5a — Impact: Wartbarkeit/Komplexität — Fix: Host-/Pfad-Normalisierung in kleine, getestete Helper extrahieren (z.B. „normalize_signed_url_host“, „ensure_storage_v1_upload_path“), Verhalten mit vorhandenen Tests (test_storage_public_url_rewrite, test_supabase_storage_* ) absichern.

- [CONSISTENCY] local_vision-Adapter in kleinere Bausteine schneiden — Evidenz: backend/learning/adapters/local_vision.py:1-520@7368c5a — Impact: Verständlichkeit, gezielte Tests — Fix: Hilfsfunktionen/kleine Klassen für (a) lokale/remote Storage-Reads, (b) PDF→PNG-Derivate, (c) Ollama-Aufruf inkl. Fehler-Mapping; öffentliche Schnittstelle (`extract`) unverändert lassen.

- [CONSISTENCY] Zentrale Limits konsequent im Learning-Policy verwenden — Evidenz: backend/storage/learning_policy.py:19-28@7368c5a; backend/web/routes/learning.py:75-76@7368c5a — Impact: Drift-Risiko — Fix: sicherstellen, dass Upload-Limits und Policy-Objekt (`LearningUploadPolicy.max_size_bytes`) überall auf `get_learning_max_upload_bytes()` basieren (OpenAPI `maximum` bereits auf 20971520/LEARNING_MAX_UPLOAD_BYTES ausgerichtet).

- [CONSISTENCY] Upload-Proxy muss Presign-Header 1:1 weiterreichen — Evidenz: backend/web/routes/learning.py:1044-1071 & 1246-1263@7368c5a. Impact: Presign-spezifische Header (z.B. `x-upsert`, Auth) gehen verloren → Proxy verhält sich anders als Direkt-Upload. Fix: Intent-Response speichert Original-Header, Route liest sie (z.B. via Base64/JSON im Query) und übergibt sie an `_async_forward_upload`.

## NICE-TO-HAVE
- [TEST] JSONAdapter-Feature-Flag im Worker explizit testen — Evidenz: backend/learning/workers/process_learning_submission_jobs.py:134-186@7368c5a — Impact: Testbarkeit — Fix: zwei Tests ergänzen (`LEARNING_DSPY_JSON_ADAPTER=true/false`), die Konfiguration/Log-Ausgabe und Fallback auf Default-Adapter prüfen.

- [DOC] OLLAMA_BASE_URL-Policy in Referenzdocs verankern — Evidenz: backend/learning/config.py:49-60@7368c5a; .env.example:55-75@7368c5a — Impact: Dokumentation — Fix: Abschnitt „AI/Ollama-Konfiguration“ in `docs/references/storage_and_gateway.md` oder eigenem AI-Referenzdokument ergänzen (erlaubte Hosts: localhost/127.0.0.1/Service-Namen, Verbot externer Hosts).

- [CONSISTENCY] BinaryWriteStorage-Port vereinheitlichen — Evidenz: backend/storage/ports.py:11-25@7368c5a; backend/learning/usecases/pdf_preprocessing.py:34-38@7368c5a — Impact: Wartbarkeit; doppelte Port-Definitionen können divergieren — Fix: Gemeinsamen Port aus `backend.storage.ports` verwenden oder den lokalen Typ explizit als dokumentierten Subset-Port markieren.

## BDD-Szenarien (Auszug)

1. **Vision-Supabase-Fetch (SSRF-Härtung)**
   - Given SUPABASE_URL=https://storage.gustav.local und local_vision, When extract() mit Remote-Fetch-URL auf fremder Domain, Then kein HTTP-Request wird abgesetzt und eine VisionTransientError/„untrusted_host“-Variante wird gemeldet.
   - Given SUPABASE_URL=https://storage.gustav.local und gültigem Object-URL-Host, When extract() auf JPEG/PDF, Then genau diese Host-Kombi wird genutzt, Bytes werden begrenzt geladen und in Base64 eingebettet.

2. **internal_upload_stub / upload_proxy Sicherheit**
   - Given ENABLE_DEV_UPLOAD_STUB=true, When PUT /api/learning/internal/upload-stub ohne Session-Cookie, Then 401 mit `{error: "unauthorized", detail: ...}` laut Komponenten-Response, inkl. `Cache-Control: private, no-store` und `Vary: Origin`.
   - Given ENABLE_DEV_UPLOAD_STUB=false, When PUT /api/learning/internal/upload-stub, Then 404 mit Error-Schema und gleicher Header-Policy wie andere Fehlerfälle.
   - Given ENABLE_STORAGE_UPLOAD_PROXY=true und Presign-URL auf falschem Port, When PUT /api/learning/internal/upload-proxy, Then 400 (invalid_url_host) bevor Proxy-Verbindung aufgebaut wird.
   - Given valider Presign-Host, When PUT /api/learning/internal/upload-proxy mit >MAX_SIZE Streaming-Daten, Then Server bricht den Stream sofort ab und antwortet 400 size_exceeded ohne den Body vollständig zu puffern.

3. **Zentrale Upload-Limits**
   - Given LEARNING_MAX_UPLOAD_BYTES=3MiB, When Lern-Upload-Intent erstellt und Upload-Proxy/Stub verwendet wird, Then `max_size_bytes` und alle serverseitigen Checks (internal upload-proxy/stub, Learning-Submission-Finalisierung) respektieren exakt 3MiB.
   - Given MATERIALS_MAX_UPLOAD_BYTES=4MiB, When Lehr-Material-Upload-Intent erstellt wird, Then `MaterialUploadIntentResponse.max_size_bytes` == 4MiB und HEAD-Prüfungen orientieren sich daran.

## Tests
- Given OpenAPI geladen, When Pfad /api/learning/internal/upload-proxy inspiziert, Then security, query param `url`, binary body und Responses 200/400/401/403/404/502 sind dokumentiert (backend/tests/test_openapi_learning_upload_proxy_contract.py::test_openapi_upload_proxy_*; api/openapi.yml:4885-4964).
- Given ENABLE_DEV_UPLOAD_STUB=true, When PUT /api/learning/internal/upload-stub, Then 200 + {sha256,size_bytes} und Datei liegt unter STORAGE_VERIFY_ROOT/storage_key (backend/tests/test_learning_upload_stub_route.py::test_internal_upload_stub_writes_file_and_returns_sha).
- Given zentrale Limits-Konfiguration, When *_MAX_UPLOAD_BYTES per ENV gesetzt, Then Getter liefern erwartete Werte (backend/tests/test_storage_config_limits.py::test_limits_defaults/test_limits_env_overrides).
- Given Upload-Proxy Security-Konfiguration, When Host/Path/MIME invalid, Then 400 (invalid_url_host|invalid_url|mime_not_allowed) und `_async_forward_upload` wird nicht aufgerufen (backend/tests/test_learning_internal_proxy_security.py::test_proxy_rejects_*).
- Ergänzen: Streaming-Test `test_upload_proxy_streaming_limit_enforced` — bei 1 byte > Limit muss Route früh abbrechen, Speicherverbrauch konstant bleiben.
- Ergänzen: Test `test_upload_proxy_rejects_port_mismatch` — SUPABASE_URL Host identisch, Port verschieden → 400 invalid_url_host.

## Refactor-Budget
S (≤ 90 Min) · Blast radius: Learning-Vision/Feedback-Adapter, Storage-Config/-Adapter, Learning-Upload-Strecke, OpenAPI-Vertrag.

## Freigabe-Empfehlung
Aktueller Stand ist freigabefähig mit Hinweis: Die identifizierten Punkte sind vorrangig Härtungen und Wartbarkeitsverbesserungen ohne erkennbaren Datenverlustpfad. Empfohlen wird, mindestens die Vision-Supabase-Härtung und die OpenAPI-Klarstellungen in einem Folge-PR zeitnah umzusetzen.
