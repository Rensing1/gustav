# PR Review – Fix Plan 2 (2025-11-14)

## Kontext
- PR erweitert Env-/Storage-/AI-Config sowie UI-Komponenten massiv, ohne OpenAPI- oder Schema-Updates.
- Ziel: Review-Findings strukturiert dokumentieren, um Folgetasks (Contract, Tests, Security) planbar zu machen.

## Kurzfazit
Aktuelle Änderungen wirken überladen (Env, Storage, UI, AI) und verletzen Contract-First/TDD-Grundsatz. Höchstes Risiko entsteht durch fehlende OpenAPI-/Schema-Aktualisierungen und fehlende Tests für kritische Lern-Uploads. Empfehlung: Blocker gezielt schließen, bevor Merge freigegeben wird.

## MUST-FIX
- [API] **OpenAPI & Migration nachziehen** — Neue Storage-Limits/Buckets tauchen nur in `.env`/Compose auf. Ohne `api/openapi.yml`- und Supabase-Migration-Update entsteht Prod-Drift bei Upload-Endpunkten.
- [TEST] **Neue Funktionalität testen** — Keine zusätzlichen Pytests trotz umfangreicher UI/Backend-Änderungen; Verhalten von Upload-Limits, AI-Konfig und Routing bleibt unbewiesen.
- [CONSISTENCY] **Learning-Bucket-Env rückwärtskompatibel halten** — `backend/storage/config.get_submissions_bucket` liest nur noch `LEARNING_STORAGE_BUCKET`, während bestehende Deployments sowie zahlreiche Tests weiterhin `LEARNING_SUBMISSIONS_BUCKET` setzen. Ergebnis: Lern-Uploads landen im Default-`submissions`-Bucket, Worker liest aber den alten Pfad. Lösung: Fallback auf den Legacy-Namen (oder Migrationshinweis + Guard), plus Test, dass beide Variablen unterstützt werden.
- [SEC] **Upload-Proxy erlaubt rewritete Hosts nicht** — Der Supabase-Adapter rewritet signierte URLs auf `SUPABASE_PUBLIC_URL`, der Proxy prüft jedoch nur gegen `SUPABASE_URL` und lehnt damit jede Anfrage mit 400 `invalid_url_host` ab. Fix: Host-Whitelist um `SUPABASE_PUBLIC_URL` erweitern bzw. Rewrites für Proxy-Ziele unterdrücken; Regressionstest ergänzen.

## SHOULD-FIX
- [CONSISTENCY] **Compose-Defaults sichern** — `docker-compose.yml` referenziert neue ENV-Variablen ohne Fallback; Compose bricht ohne `.env` ab.
- [ROBUSTNESS] **UI-A11y sicherstellen** — Neue Navigations-/Layout-Blöcke im Template fehlen ARIA-/Keyboard-Support, was A11y-Risiko birgt.
- [SEC] **Adapter-Fehlertexte sanitizen** — Telemetrie-Felder (`vision_last_error`/`feedback_last_error`) werden zwar gekürzt, aber Regex deckt Secrets/PII nur teilweise ab; Regex & Tests nachziehen.
- [API] **Alt-Text-Regeln vereinheitlichen** — Upload-Flow für `alt_text` validiert Länge nicht wie Update-Flow; beide Pfade sollen `maxLength 500` und Trim-Logik aus dem Contract konsistent anwenden.
- [API] **SubmissionTelemetry-Vertrag präzisieren** — Neues Schema (`SubmissionTelemetry` + `LearningSubmission`) beschreibt Telemetrie; Tests und API-Doku müssen Verhalten (Nullability, Defaults, Sanitization) abbilden.
- [SEC] **SSRF-Schutz der Storage-Verifikation testen** — `_stream_hash_from_url` nutzt Host-Allowlist/Redirect-Block; Unit-Tests für erlaubte/unerlaubte Hosts und Redirects ergänzen.

## NICE-TO-HAVE
- [DOC] `.env.example`-Kommentare kürzen oder in Referenz verschieben, damit Onboarding schneller gelingt.
- [ROBUSTNESS] **Storage-Verifikation modularisieren** — `verify_storage_object_integrity` in kleinere Helfer für HEAD/Download/Local-Check aufteilen, um Tests und Lesbarkeit zu verbessern (kein neues öffentliches Layer).
- [TEST] **Telemetrie-Sanitization explizit testen** — Beispiel-Errorstrings mit Tokens/URLs/Pfaden durch `_sanitize_error_message` schicken und sicherstellen, dass nur gekürzte, sekretfreie Texte in die API gelangen.
- [CONSISTENCY] **Dev-Cookie-Doku aktualisieren** — Kommentare/Docs an neue Policy angleichen: `gustav_session` ist auch in dev `Secure` + `SameSite=lax`, host-only ohne Domain-Attribut.

## Teststrategie
- Contract-Tests: Sicherstellen, dass `/api/learning/internal/upload-proxy` und verwandte Pfade in `api/openapi.yml` Limits, Fehlercodes, Header korrekt führen.
- Backend-Pytests: Upload-Limits (Materials/Learning), AI-Adapter-Flag (`LEARNING_DSPY_JSON_ADAPTER`) und UI-Routing (htmx) über funktionale Tests absichern.
- Optional: Accessibility-Sniffs (Pa11y/axe) für neue Templates.
- Telemetrie-Tests: `LearningSubmission`/`SubmissionTelemetry`-Antworten gegen OpenAPI prüfen (Feld-Set, Nullability, `maxLength`, Sanitization).
- Security-Tests: SSRF-Schutz und Redirect-Handling von `_stream_hash_from_url`/Storage-Verifikation mit gezielten Unit-Tests abdecken.
- Auth-Tests: Logout-/Cookie-Policies (Secure, SameSite, host-only, `id_token_hint`-Fallback) stabil mit httpx/ASGI-Tests absichern.

## Nächste Schritte
1. API-Vertrag und Supabase-Migration erstellen (`supabase migration new`), dann `supabase migration up` laufen lassen.
2. Fehlende Pytests (Upload-Limits, AI-Config, Routing) schreiben und isoliert validieren.
3. Compose-/Env-Dokumentation und UI-A11y-Anmerkungen aktualisieren.
4. Error-Sanitization und Telemetrie-Kontrakt in Repo/Tests nachziehen.
5. Alt-Text-Validierung im Teaching-Flow vereinheitlichen und dokumentieren.
6. Storage-Verifikationspfad (Host-Allowlist, Redirects, Download-Hash) mit Unit-Tests absichern.
7. Alle Änderung mit `.venv/bin/pytest -q` validieren.
