# Plan: Review-Analyse PR fix3 (2025-11-14)

## Kontext & Rahmenbedingungen
- Rolle laut `AGENTS.md`: Lehrender Entwickler, der Code-Qualität didaktisch erklärt und Reviews dokumentiert.
- Review-Anfrage (Benutzer, 2025-11-14): Strenges PR-Review entlang der Achsen Komplexität, Wartbarkeit, Robustheit, Sicherheit, Dokumentation und Konsistenz, Formatvorgaben für Findings, Evidenz `file:line@SHA`.
- Repository-Status: `development...origin/development`, keine lokalen Änderungen; Netzwerk-Zugriff auf GitHub blockiert (Fetch scheiterte wegen DNS, dokumentiert zur Nachvollziehbarkeit).
- Diff-Basis: `BASE=084340a7`, `HEAD=628dbd2`, SHA kurz `628dbd2`.
- Relevante Richtlinien: API-Contract-First (Änderungen zuerst in `api/openapi.yml`), Migration-only Schemaänderungen, Security-first (keine Dummy-Defaults in Prod), Tests verpflichtend (pytest), Clean Architecture und RLS-Schutz.

## Vorgehen
1. Repository-Zustand & Diff-Basis bestimmen (`git status -sb`, Merge-Base).
2. Vollständigen Diff zwischen `BASE...HEAD` ziehen (Sandbox-bedingt lokal, Ergebnis 33k Zeilen → Fokus auf veränderte Dateien per `git diff --name-only`).
3. Code entlang geforderter Achsen evaluiert, Findings gesammelt, Must/Should/Nice kategorisiert, Evidenzen mit SHA referenziert.
4. Review-Ergebnis (separat an Benutzer geliefert) in dieser Datei mit Kontext, Belegen und empfohlenen Maßnahmen dokumentiert.

## Diff-Überblick (Schwerpunkte)
- `.env.example`: Große Ergänzungen (Keycloak-Basen, neue Supabase-Buckets, AI/DSPr-Konfig, Limits, Auto-Bucket-Flag).
- Backend-Konfig (`backend/learning/config.py`, `backend/storage/config.py`, `backend/storage/bootstrap.py`): Zentralisierung von Bucket-Namen/Limits, Flags für JSONAdapter, neue Defaults.
- Identity/OIDC (`backend/identity_access/oidc.py`): Anpassungen für Public Base/Redirects; potenzielle HTTPS-Regressionen.
- Learning-Adapters & Tests: DSPy/Local/Ollama Programme, Parser-Anpassungen, massiver Test-Suite-Zuwachs (~70 Dateien).
- Docs & Infra: README, LICENCE, Makefile, Dockerfile; GitHub-Automation (Dependabot), neue Upload-/Storage-/Worker-Konfiguration.

## Findings & Referenzen
### Must-Fix (priorisiert)

0. **Robustheit: Worker-DML versteht Legacy-Queues nicht**  
   - Evidenz: `backend/learning/workers/process_learning_submission_jobs.py:520-667@628dbd2`. `_resolve_queue_table` erkennt zwar `learning_submission_ocr_jobs`, doch `_nack_retry`, `_mark_job_failed` und `_delete_job` sind weiterhin hart auf `learning_submission_jobs` verdrahtet.  
   - Risiko: Sobald Deployments noch auf der alten Queue-Tabelle laufen, lassen sich geleaste Jobs weder requeue’n noch löschen → Worker bleibt auf „leased“ hängen, Analyse-Backlog wächst.  
   - Status Legacy-Table: `make import-legacy-all` (siehe `scripts/import_legacy_backup.py`) schreibt ausschließlich in `public.learning_submissions`; die Queue-Tabelle wird nirgends mehr verwendet. Wir können `learning_submission_ocr_jobs` daher via Migration endgültig entfernen.  
   - Maßnahme (Plan): (a) Migration hinzufügen, die alte Tabelle droppt oder in die neue migriert; (b) Code-Pfade vereinfachen, indem `_resolve_queue_table` entfällt und sämtliche DML nur noch `learning_submission_jobs` adressieren.

1. **Security: Local-Vision-Adapter zu komplex und schwer auditierbar**  
   - Evidenz: `backend/learning/adapters/local_vision.py:1-1732@628dbd2`. ~1700 Zeilen Adapter-Code inkl. HTTP-Download, Supabase-URL-Bau, Pfad-Logik und Ollama-Aufrufen.  
   - Risiko (Komplexität & Sicherheit): Große, monolithische Adapter-Klasse → schwer testbar, Angriffsoberfläche für SSRF/Host-Misskonfiguration, hohe Einstiegshürde für Lernende.  
   - Maßnahme (Plan):  
     - Kurzfristig: Externe Zugriffe (HTTP/Supabase-Download, Storage-Host-Checks) in kleine, reine Helfer-Funktionen oder Ports auslagern (`backend.storage`), Adapter auf Orchestrierung reduzieren.  
     - Mittelfristig: Dead Code/überflüssige Pfade und künstliche Leerzeilen entfernen, Fokus auf die vom Test-Contract benötigten Pfade (JPEG/PNG/PDF, VisionResult-Erstellung, Fehler-Mapping).
     - Detailplan & BDD: `docs/plan/2025-11-16-vision-adapter-rest.md`.

2. **Security: Supabase-Download via Service-Role besser härten**  
   - Evidenz: `backend/learning/adapters/local_vision.py:60-110@628dbd2` (`_download_supabase_object`).  
   - Risiko: Host-/Port-Validierung und Größenlimitierung nur teilweise umgesetzt; Redirects/HTTP-Fehler werden grob zusammengefasst, Logging kaum differenziert.  
   - Maßnahme (Plan):  
     - Host-Check inkl. Port (Host+Port-Paar), keine impliziten Defaults.  
     - Gründe (`redirect`, `size_exceeded`, `http_error`) klar loggen; Pfade an `backend.storage.verification._stream_hash_from_url` angleichen, um die Security-Story zu vereinheitlichen.

3. **Security/API: Storage-Verification-Konfiguration klarer trennen**  
   - Evidenz: `backend/storage/verification.py:105-220@628dbd2`.  
   - Risiko: Flag `require_remote` steuert sowohl HEAD- als auch Download-Pfade; Rückgabecodes wie `"skipped"`, `"hash_unavailable"` und `"download_exception"` sind für Aufrufer schwer zu interpretieren.  
   - Maßnahme (Plan):  
     - Flags für „Verifikation erforderlich“ vs. „Remote-Download erlaubt“ trennen und im Docstring matrixartig dokumentieren (dev vs. prod).  
     - Aufrufer (Learning-Router) sollen Statuscodes/Gründe explizit loggen (z.B. `reason=size_mismatch|hash_mismatch|download_failed`).

4. **Security/Config: AI-Konfiguration – Default und Produktion sauberer fassen**  
   - Evidenz: `.env.example:61-83@628dbd2`, `backend/learning/config.py:60-90@628dbd2`.  
   - Risiko: `.env.example` suggeriert „prod-ready default: local“, Code nutzt `backend="stub"` als Default. In prod/stage verhindert `AI_BACKEND=stub` zwar Start, aber in neuen Umgebungen kann Misskonfiguration zu unerwarteten Stub-Läufen führen.  
   - Maßnahme (Plan):  
     - In Docs eindeutig dokumentieren: `AI_BACKEND=local` ist der Standard für prod/stage, `stub` nur für Tests.  
     - Optional: In dev/test Fail-fast, wenn `.env` `local` setzt, aber `OLLAMA_BASE_URL`/Modelle ungültig sind (klarere Fehlermeldungen für Lernende).

5. **Security/API: OIDC/Public-Base weiterhin auf HTTPS und bekannte Hosts prüfen**  
   - Evidenz: `backend/identity_access/oidc.py:33-40@628dbd2`. Docstring-Beispiele aktualisiert auf `https://app.localhost` / `https://id.localhost`.  
   - Risiko: Falls an anderer Stelle Validierung gelockert wurde, könnten Mixed-Content oder unsichere Redirects entstehen (Cookies, STS).  
   - Maßnahme (Plan):  
     - Sicherstellen, dass zentrale Validierung (`test_auth_idp_public_host`, `test_auth_default_app_base`) weiterhin `https://` und die erwarteten lokalen Hosts durchsetzt, ansonsten Validierungslogik wieder einziehen und Tests anpassen.

6. **Security/Robustheit: Worker-DSN mit Least-Privilege strenger testen**  
   - Evidenz: `backend/learning/workers/process_learning_submission_jobs.py:528-592@628dbd2` (`_resolve_worker_dsn`).  
   - Risiko: RuntimeError bei `postgres`/`service_role` ist korrekt, aber nicht durch Tests abgesichert; Gefahr späterer Regression (z.B. unbewusstes Zulassen von Superusern).  
   - Maßnahme (Plan):  
     - Unit-Tests für `_resolve_worker_dsn` ergänzen: erlaubte vs. verbotene Benutzer, Verhalten mit/ohne `ALLOW_SERVICE_DSN_FOR_TESTING`/`RUN_*`-Flags.

### Should-Fix

0. **Konsistenz: Verwaistes Artefakt `tmp_unit.html` entfernen**  
   - Evidenz: `tmp_unit.html:1@628dbd2`. Datei liegt in der Repo-Wurzel, ist weder dokumentiert noch referenziert und enthält UI-Snapshot-Daten.  
   - Maßnahme (Plan): Artefakt löschen oder — falls als Dokumentation gewünscht — nach `docs/` verschieben und im README verlinken. Zusätzlich Git-Hooks/CI-Regeln prüfen, damit temporäre Exporte nicht eingecheckt werden.

1. **Robustheit/Fehlerbilder: PDF-Preprocessing – differenzierte Fehlercodes & Sanitizer nutzen**  
   - Evidenz: `backend/learning/usecases/pdf_preprocessing.py:60-152@628dbd2`, `backend/tests/test_learning_pdf_preprocessing_usecase.py@628dbd2`.  
   - Verbesserungen:  
     - Oversize-Handling (`input_too_large`) bereits vorhanden; Fehlerpfade mappen `PdfRenderError` auf `input_corrupt`, generic auf `input_unsupported`.  
     - `_mark_failed` nutzt `_sanitize_error_message` aus `repo_db`, Security-Definer-Funktion wird aufgerufen.  
   - Maßnahme (Plan):  
     - Zusätzlich zu `context.size_bytes` auch `len(pdf_bytes)` gegen das zentrale Limit prüfen und bei Überschreitung ebenfalls `input_too_large` setzen (Schutz bei inkonsistenten Metadaten).  
     - Prüfen, ob weitere spezifische Fehlercodes (z.B. „verschlüsselte PDFs“) sinnvoll sind; falls ja, DDD-Konzept ergänzen und Tests erweitern.
   - Umsetzung (2025-11-15):  
     - Neuer Test `test_pdf_preprocessing_rejects_oversized_body_even_when_metadata_small` in `backend/tests/test_learning_pdf_preprocessing_usecase.py`: Seed mit `size_bytes` innerhalb des Limits, tatsächliche `pdf_bytes` größer als `size_limit_bytes`. Erwartung: Status `failed`, `error_code="input_too_large"`, Renderer wird nicht aufgerufen.  
     - `PreprocessPdfSubmissionUseCase.execute` erweitert: Zusätzlich zum bestehenden Guard auf `context.size_bytes > self._size_limit` wird jetzt auch `len(pdf_bytes) > self._size_limit` frühzeitig geprüft. Bei Überschreitung wird `_mark_failed(..., code="input_too_large", message="payload size exceeds configured limit")` aufgerufen, bevor die Vision-Pipeline importiert oder verwendet wird.  
     - Die Oversize-Logik ist damit sowohl für Metadaten-Fehler (deklarierte Größe) als auch für tatsächlich zu große Payloads abgesichert; keine Änderungen am OpenAPI-Vertrag nötig, da der Fehlercode bereits etabliert war.

2. **Konsistenz: Zentrale Bucket-Konfiguration überall erzwingen**  
   - Evidenz: `backend/storage/config.py:17-64@628dbd2`, `backend/storage/learning_policy.py:21-55@628dbd2`, `backend/learning/adapters/local_vision.py:27-36@628dbd2`.  
   - Risiko: Einige ältere Stellen greifen evtl. noch direkt auf `LEARNING_STORAGE_BUCKET`/`SUPABASE_STORAGE_BUCKET` zu.  
   - Maßnahme (Plan):  
     - Systematischer Suchlauf nach direkten Env-Zugriffen; diese über `get_materials_bucket`/`get_submissions_bucket` umbiegen, Tests (`test_learning_bucket_uses_central_config`) ggf. ausbauen.

2a. **Robustheit: Vision-Adapter braucht Host/Model-Defaults**  
    - Evidenz: `backend/learning/adapters/local_vision.py:119-123@628dbd2`. `self._base_url = os.getenv("OLLAMA_BASE_URL")` kann `None` liefern, obwohl `load_ai_config` einen Default vorsieht.  
    - Risiko: In lokalen Umgebungen ohne gesetztes OLLAMA-ENV schlägt der Adapter schon beim Client-Konstruktor fehl.  
    - Maßnahme (Plan): Default analog zum Feedback-Adapter setzen (`... or "http://ollama:11434"`), Tests für fehlende ENV ergänzen.
    - Umsetzung (2025-11-15):  
      - Neuer Test `test_local_vision_uses_default_base_url_when_env_missing` in `backend/tests/learning_adapters/test_local_vision.py`: löscht `OLLAMA_BASE_URL`, lädt den Adapter neu und erwartet, dass `adapter._base_url == "http://ollama:11434"` gesetzt ist.  
      - Adapter-Init in `_LocalVisionAdapter.__init__` angepasst: `self._base_url` wird nun aus einem getrimmten `OLLAMA_BASE_URL` gelesen und fällt bei leerem/fehlendem Wert auf `"http://ollama:11434"` zurück, analog zum Feedback-Adapter.  
      - Verifikation: `.venv/bin/pytest backend/tests/learning_adapters/test_local_vision.py -k "default_base_url" -q` grün; übrige Vision-Tests bleiben unverändert.

3. **Dokumentation: AI-/DSPy-Flags klarer beschreiben**  
   - Evidenz: `backend/learning/config.py:60-90@628dbd2`, `.env.example:61-83@628dbd2`, `backend/tests/learning_adapters/test_local_feedback_dspy.py@628dbd2`.  
   - Risiko: Lernende/Ops müssen aus Code und Tests rekonstruieren, wann DSPy/JSONAdapter aktiv ist.  
   - Maßnahme (Plan):  
     - README bzw. passende Datei unter `docs/references/*` um eine Tabelle zu AI-Env-Variablen (Backend, Modelle, Timeouts, Host-Validierung, JSONAdapter-Toggle) ergänzen.
   - Umsetzung (2025-11-15):  
     - `docs/references/learning_ai.md` um Abschnitt „9.1 Environment variables (overview)“ ergänzt: Tabelle mit zentralen AI‑Flags (`AI_BACKEND`, `LEARNING_VISION_ADAPTER`, `LEARNING_FEEDBACK_ADAPTER`, `AI_VISION_MODEL`, `AI_FEEDBACK_MODEL`, `AI_TIMEOUT_*`, `OLLAMA_BASE_URL`, `LEARNING_DSPY_JSON_ADAPTER`, `FEATURE_OCR_ENABLED`, Worker‑Retry‑Flags, Supabase‑Hosts) inklusive Default, Scope und Kurzbeschreibung.  
     - Host‑Validierung aus `load_ai_config()` dokumentiert: `OLLAMA_BASE_URL` muss auf localhost/Loopback oder einen einfachen Compose‑Service‑Host ohne Punkt zeigen; Prod/Stage lehnen `AI_BACKEND=stub` ab.  
     - DSPy/JSONAdapter‑Semantik präzisiert: `LEARNING_DSPY_JSON_ADAPTER=true` aktiviert `dspy.JSONAdapter` für strikt strukturierte Kriterien‑Outputs, `false` schaltet auf einen toleranteren Pfad ohne Adapter um. Hinweise zur praktischen Nutzung (lokales Downgrade bei schwachen Modellen) ergänzt; bestehende Runbooks bleiben konsistent.

4. **Tests: Vision-PDF-Remote-Render stabilisieren (HTTP mocken)**  
   - Evidenz: `backend/tests/learning_adapters/test_local_vision_pdf_remote_render*.py@628dbd2`.  
   - Risiko: CI-Flakiness und versteckte Abhängigkeit von realen HTTP-Umgebungen.  
   - Maßnahme (Plan):  
     - HTTP-Client (`httpx`) wie in `backend/tests/test_learning_bucket_uses_central_config.py` via Fake-Client ersetzen; nur URLs und Bytes-Ströme testen, nicht echte Netzwerklayer.
   - Umsetzung (bereits im PR, 2025-11-15 verifiziert):  
     - Tests `backend/tests/learning_adapters/test_local_vision_pdf_remote_render.py` und `..._error.py` patchen `sys.modules['httpx']` vor dem Import des Adapters und ersetzen den Client durch Fake-Implementierungen, die deterministische PDF-Bytes via Streaming zurückliefern (bzw. Fehler auslösen).  
     - `backend/tests/test_learning_bucket_uses_central_config.py::test_local_vision_adapter_uses_configured_bucket` nutzt ebenfalls einen Fake-`httpx`-Client und prüft nur die konstruierte URL (inkl. Bucket-Namen), nicht den Netzwerklayer.  
     - Fokussierter Testlauf (`.venv/bin/pytest backend/tests/learning_adapters/test_local_vision_pdf_remote_render*.py backend/tests/test_learning_bucket_uses_central_config.py -q`) ist grün; es bestehen keine realen HTTP-Abhängigkeiten mehr, die Tests sind deterministisch.

5. **Konsistenz/Dokumentation: LearningSubmission & Telemetrie mit Vertrag synchronisieren**  
   - Evidenz: `api/openapi.yml:884-1040@628dbd2`, `docs/references/learning.md:114-123@628dbd2`.  
   - Risiko: Referenz-Doku erwähnt nur `pending|completed|error` und `feedback`, der Vertrag/Datenbank führen `extracted|failed`, `feedback_md` und `SubmissionTelemetry`-Felder (`vision_attempts`, `vision_last_error`, `feedback_last_attempt_at`, `feedback_last_error`).  
   - Maßnahme (Plan):  
     - Abschnitt „LearningSubmission (API)“ in `docs/references/learning.md` auf den aktuellen Vertrag (Status-Werte, `feedback_md`, Telemetrie-Felder) anpassen und auf das Telemetrie-Kapitel in `docs/references/learning_ai.md` verweisen.
   - Umsetzung (2025-11-15):  
     - Endpoint-Beschreibung für `GET /api/learning/courses/{course_id}/tasks/{task_id}/submissions` angepasst: `analysis_status` jetzt `pending|extracted|completed|failed` mit kurzer Semantik je Status; `error_code`-Menge mit den Vertragwerten synchronisiert (`vision_*`, `feedback_*`, `input_*`).  
     - Schema-Abschnitt erweitert: Telemetriespalten (`vision_attempts`, `vision_last_error`, `vision_last_attempt_at`, `feedback_last_attempt_at`, `feedback_last_error`) explizit dokumentiert; `analysis_status`-Check auf `pending|extracted|completed|failed` korrigiert; Hinweis auf serverseitige Sanitization und Verweis auf `docs/references/learning_ai.md` ergänzt.  
     - Unterabschnitt „LearningSubmission (API)“ aktualisiert: Status-Enum, Fehlercodes, Telemetrie-Felder und ihre Bedeutung beschrieben; `analysis_json`-Hinweis auf `criteria.v1`/`criteria.v2` und Null-Verhalten für `pending`/`extracted` ergänzt.

6. **Robustheit/API: Upload-Intents an Kurs-/Task-Sichtbarkeit koppeln**  
   - Evidenz: `backend/web/routes/learning.py:1320-1415@628dbd2`, `api/openapi.yml:4680-4860@628dbd2`.  
   - Risiko: Authentifizierte Schüler können aktuell Upload-Intents für beliebige `course_id`/`task_id` anfragen; Storage-Nutzung ist dann unnötig hoch, bevor RLS bei der finalen Submission greift.  
   - Maßnahme (Plan):  
     - Vor dem Presign eine Sichtbarkeitsprüfung über den Repo-Layer einziehen (z.B. `get_task_metadata_for_student` oder äquivalenter Use Case) und bei Nicht-Sichtbarkeit 404 liefern (konform zur bestehenden Learning-Fehlersemantik).
   - Umsetzung (bereits im PR, 2025-11-15 verifiziert):  
     - `create_upload_intent` ruft vor dem Presign `ListSubmissionsUseCase(_get_repo()).execute(...)` auf. Der zugrunde liegende Repo-Call (`DBLearningRepo.list_submissions`) prüft Mitgliedschaft (`course_memberships`) und Sichtbarkeit via `get_task_metadata_for_student`.  
     - Fehlerabbildung: `PermissionError` → 404 (student ist kein Kursmitglied), `LookupError` → 404 (Task/Section nicht sichtbar). Die API-Verträge in `api/openapi.yml` dokumentieren dies explizit (`404: Course or task not found, or not released to the student`).  
     - Tests: `backend/tests/test_learning_upload_intents_behavior.py::test_upload_intent_requires_membership` und `::test_upload_intent_task_not_visible_returns_404` validieren diese Semantik end-to-end. Damit ist die Sichtbarkeitskopplung für Upload-Intents konsistent zu den Submission-Endpunkten umgesetzt.

7. **Tests/Robustheit: CSRF-/Env-/Proxy-Helper direkt testen**  
   - Evidenz: `backend/web/routes/learning.py:94-156@628dbd2`, `backend/tests/test_learning_submissions_*csrf*.py@628dbd2`.  
   - Risiko: `_current_environment`, die Diagnoselogik in `_require_student` und der Header-Encoder/Decoder (`_encode_proxy_headers`/`_decode_proxy_headers`) sind nur indirekt über End-to-End-Tests abgesichert.  
   - Maßnahme (Plan):  
     - Kleine Unit-Tests ergänzen, die (a) Env-Auflösung mit/ohne `GUSTAV_ENV` und `SETTINGS.environment` prüfen und (b) Roundtrip und Fehlerfälle der Header-Kodierung (kaputte Tokens, non-dict-Input) gezielt verifizieren.
   - Umsetzung (2025-11-15):  
     - Neues Testmodul `backend/tests/test_learning_routes_helpers.py` ergänzt.  
     - Tests für `_encode_proxy_headers` / `_decode_proxy_headers`: Roundtrip für gültige Header, Filterung von `None`/leeren Keys, Akzeptanz von Sequenzen (`[("X-A","1"), ...]`), robustes Verhalten bei ungültigen Mappings (z.B. `42`) sowie invaliden/nicht-dict JSON-Tokens.  
     - Tests für `_current_environment()`: Präferenz von `main.SETTINGS.environment` gegenüber `GUSTAV_ENV`, Fallback auf `main` wenn `backend.web.main` nicht importierbar ist, sowie finaler Fallback auf `GUSTAV_ENV`, wenn beide Module fehlen (via gepatchtem `importlib.import_module`).  
     - Alle neuen Tests laufen grün (`.venv/bin/pytest backend/tests/test_learning_routes_helpers.py -q`); Code der Helper konnte unverändert bleiben, das bestehende Verhalten ist jetzt explizit vertraglich abgesichert.

8. **Konsistenz/Lesbarkeit: `mime_type`-Parameter im Storage-Verifier klären**  
   - Evidenz: `backend/storage/verification.py:130-170@628dbd2`, `backend/web/routes/learning.py:1160-1185@628dbd2`.  
   - Risiko: Signatur von `verify_storage_object_integrity` führt `mime_type`, nutzt ihn aber (noch) nicht; Leser erwarten hier MIME-basierte Checks, was zu Verwirrung führen kann.  
   - Maßnahme (Plan):  
     - Entweder einen einfachen MIME-Check ergänzen (z.B. nur erlaubte Typen) oder den Parameter aus Signatur und Aufrufer entfernen; Entscheidung in der Doku des Helpers festhalten.
   - Umsetzung (bereits im PR, 2025-11-15 verifiziert):  
     - `verify_storage_object_integrity` erzwingt bereits die zentrale Upload-MIME-Whitelist über `_allowed_upload_mime()`; bei nicht erlaubten Typen wird `ValueError` geworfen.  
     - Test `backend/tests/test_storage_verification_helper.py::test_mime_whitelist_enforced` deckt dieses Verhalten explizit ab und schützt vor Regressionen.  
     - Aufrufer `_verify_storage_object` in `backend/web/routes/learning.py` übergibt `mime_type` direkt aus der Submission-Validierung (`ALLOWED_IMAGE_MIME`/`ALLOWED_FILE_MIME`), sodass Verifier und Web-Layer dieselbe Policy teilen. Eine Entfernung des Parameters wäre daher nicht mehr konsistent; der Plan-Punkt ist als erledigt markiert.

### Nice-to-Have

1. **Komplexität: Local-Vision-Adapter modulweise aufsplitten**  
   - Evidenz: `backend/learning/adapters/local_vision.py:1-1732@628dbd2`.  
   - Maßnahme:  
     - MIME-Routing, Supabase-Download und Ollama-Aufruf in dedizierte Helfer/Ports mit klaren Docstrings auslagern (z.B. `backend.learning.adapters.vision_io`, `backend.storage.vision_fetch`), so dass das eigentliche Adapter-Objekt für Lernende gut nachvollziehbar bleibt.

2. **Dokumentation: Storage-Bootstrap als explizit „dev-only“ kennzeichnen**  
   - Evidenz: `backend/storage/bootstrap.py:120-165@628dbd2`.  
   - Maßnahme:  
     - In `docs/ARCHITECTURE.md` Abschnitt „Storage Bootstrap“ ergänzen: `AUTO_CREATE_STORAGE_BUCKETS=true` nur lokal/CI, niemals prod/stage; RLS/Policies bleiben ausschließlich migrationsgetrieben. Detailplan: `docs/plan/2025-11-16-storage-bootstrap-docs.md`.

3. **Dokumentation/Lesbarkeit: Umfangreiche `.env.example`-Kommentare entschlacken**  
   - Evidenz: `.env.example:22-90@628dbd2`.  
   - Maßnahme:  
     - Lange Inline-Kommentare durch Verweise auf passende Doku-Dateien (`docs/storage-bucket-unification.md`, AI-Konfig-Referenz) ersetzen, um die `.env.example` als knappe Checkliste nutzbar zu halten. Detailplan: `docs/plan/2025-11-16-env-docs.md`.

4. **Konsistenz/OpenAPI: 401/403-Responses zentral wiederverwenden**  
   - Evidenz: `api/openapi.yml:13-40@628dbd2`.  
   - Maßnahme:  
     - Schrittweise Pfad-Definitionen auf die neuen Komponenten `components.responses.Unauthorized401` / `Forbidden403` umstellen, um die Wiederholung von identischen 401/403-Blöcken zu vermeiden und zukünftige Änderungen an einem Ort zu bündeln.
   - Umsetzung (2025-11-16, dieser Assistent):  
     - Alle generischen 401-Responses (`description: Unauthenticated` mit `Error`-Schema) und die rein generischen 403-Responses (`description: Forbidden` ohne Zusatzkontext) wurden auf `$ref: '#/components/responses/Unauthorized401'` bzw. `$ref: '#/components/responses/Forbidden403'` umgestellt.  
     - Endpunkte mit spezialisierten 403-Beschreibungen („not the author“, „intent does not belong to caller“, CSRF-Detailcodes) behalten ihre konkreten Beschreibungen, um die Semantik im Vertrag sichtbar zu halten.  
     - Funktionales Verhalten und Error-Schema bleiben unverändert; die Änderung reduziert nur Wiederholung im Vertrag und bündelt generische 401/403-Texte zentral.

## Tests & Reproduzierbarkeit
- Pytest-Suite stark erweitert; Kern-Tests zur Validierung der Flags verfügbar (`backend/tests/test_learning_config.py`, `backend/tests/test_learning_ai_config_ollama_validation.py`, `backend/tests/test_learning_bucket_uses_central_config.py`).  
- Wichtige Befehle: `.venv/bin/pytest -q`, `docker compose up -d --build`, `supabase migration up`.  
- Netzwerkzugriff eingeschränkt → externe Fetches nicht reproduzierbar; alle Befunde aus lokalem Diff.  
- Empfehlung: Beim Fix `pytest -k` selektiv laufen lassen (auth, storage, vision) + `supabase status` prüfen.

## Nächste Schritte (Empfehlung an Felix)
1. Security-Fixes implementieren (Fail-Fast Service-Role, HTTPS Enforcement) inklusive Tests.  
2. API/Schema an neue Buckets & Limits anpassen, Migration entwerfen und dokumentieren (`docs/storage-bucket-unification.md` aktualisieren).  
3. Remote-Tests mocken, PDF-Preprocessing-Fehler behandeln.  
4. Dokumentation (README, Config-Docstrings) synchronisieren, unnötige DSPy-Signatures entfernen oder testen.  
5. Erneutes Review einholen; Approval erst nach bestandenen Tests und aktualisiertem Contract.

## Fortschritt 2025-11-15
- Must-Fix 0 (Legacy-Queue) umgesetzt:
  - Migration `20251115084133_drop_learning_submission_ocr_jobs.sql` erzeugt und angewendet (`supabase migration up`), droppt die alte Tabelle inkl. Index.
  - Worker `process_learning_submission_jobs` und Repository `learning/repo_db.py` lesen/schreiben jetzt ausschließlich `learning_submission_jobs`; `_resolve_queue_table` schlägt fehl, wenn Migration fehlt.
  - Neuer Test `backend/tests/test_learning_worker_queue_legacy.py` überprüft sowohl die Supabase-Migrationen (Drop-Snippet vorhanden) als auch das Worker-Verhalten (Legacy-only → RuntimeError). API-Contract-Test (`test_learning_api_contract.py::test_create_text_submission_returns_pending_and_enqueues_job`) akzeptiert nur noch die neue Tabelle.
  - Dokumentation aktualisiert (`docs/references/learning_ai.md`, `docs/CHANGELOG.md`), neues Planfile `docs/plan/2025-11-15-drop-ocr-queue.md` beschreibt Story/BDD.
- Must-Fix 1/2 (Vision-Adapter): `_download_supabase_object` prüft jetzt Host+Port-Kombinationen aus `SUPABASE_URL`/`SUPABASE_PUBLIC_URL`, erlaubt HTTP nur für `.local`/Loopback-Hosts, unterscheidet Redirect/HTTP-Fehlercodes und hat begleitende Tests (`test_local_vision_remote_fetch.py`). Dokumentation + Changelog um die Sicherheitsgeschichte ergänzt; Planfile `2025-11-15-local-vision-hardening.md` beschreibt die Story.
- Must-Fix 3 (Storage-Verification): `verify_storage_object_integrity` validiert zulässige MIME-Typen, unterscheidet `match_head` und `match_download`, meldet Redirect/Host-Fehler und nutzt neue Tests (`test_storage_verification_helper.py`, `test_storage_verification_streaming.py`). Dokumentation (`docs/references/learning_ai.md`, `docs/CHANGELOG.md`) aktualisiert, Planfile `2025-11-15-storage-verification.md` ergänzt.
- Nächste offene Punkte: Weitere Aufspaltung/Tests für den Local-Vision-Adapter (Rest Must-Fix 1/2) sowie die im Nice-to-Have-Bereich gelisteten Dokumentations-/OpenAPI-Aufgaben.

## Fortschritt 2025-11-16
- Must-Fix 1 Rest (Vision-Adapter PDF-Helfer):
  - Neues Detailplan-File `docs/plan/2025-11-16-vision-adapter-rest.md` fasst BDD, Tests und Risiken zusammen.
  - Tests `backend/tests/learning_adapters/test_local_vision_pdf_cached_paths.py` decken Cache-Hits (`stitched.png`), Page-Key-Stitching und Redirect-Fehler (→ `VisionTransientError("remote_fetch_failed")`) ab. Ergänzend prüfen `test_local_vision_remote_fetch.py`, `test_local_vision_streaming.py` und das neue Modul `test_local_vision_model_helper.py`, dass Remote-Image-Fetches `action=fetch_remote_image` loggen, size/hash-Mismatches via `_resolve_submission_image_bytes` als permanent fehlschlagen und `_call_model` Bilder/Timeouts korrekt behandelt.
  - Adapter-Refactor: `_ensure_pdf_stitched_png` nutzt `_log_storage_event` für strukturierte Logs (`action=cached_stitched|stitch_from_page_keys|stitch_from_page_dir|fetch_remote_pdf|remote_fetch_failed`), der JPEG/PNG-Pfad verwendet `_resolve_submission_image_bytes` / `_load_local_storage_bytes`, und `_call_model` bündelt Ollama-Aufruf inkl. Markdown-Unwrap. Supabase-Redirects/HTTP-Fehler werden konsequent als transient (`remote_fetch_failed`) gekennzeichnet und bleiben PII-frei in den Logs.
  - Dokumentation erweitert (`docs/references/learning_ai.md`, `docs/CHANGELOG.md`), damit Operator:innen die neuen Logpfade kennen und Testabdeckung nachvollziehen können.
- Storage-Bootstrap (Nice-to-Have 2):
  - Planfile `docs/plan/2025-11-16-storage-bootstrap-docs.md` beschreibt Scope/Risiken.
  - `docs/ARCHITECTURE.md` enthält jetzt einen Abschnitt „Storage-Bootstrap (nur Dev/CI)“, der klarstellt, dass `AUTO_CREATE_STORAGE_BUCKETS=true` ausschließlich lokal/CI genutzt wird und Prod/Staging weiterhin Migrationen/Manuelle Provisionierung verwenden. Changelog-Eintrag dokumentiert die Ergänzung.
- `.env.example` (Nice-to-Have 3):
  - Planfile `docs/plan/2025-11-16-env-docs.md` angelegt.
  - `.env.example` verweist nun kompakt auf die relevanten Referenzen (Config-Matrix, Identity, Storage, Learning-AI), statt seitenlange Inline-Kommentare zu enthalten. Die Konfigurationshinweise wurden in die Doku ausgelagert; das Template bleibt dadurch übersichtlicher.

## Fortschritt 2025-11-17
- Vollständiger `pytest`-Durchlauf deckte zwei Regressionen auf (`backend/tests/test_learning_routes_helpers.py::test_current_environment_prefers_settings_over_env`, `backend/tests/test_learning_vision_pdf_stitched_fallback.py::test_pdf_without_stitched_or_original_raises_transient`).
- Neues Planfile `docs/plan/2025-11-17-test-regressions.md` dokumentiert Kontext, BDD-Szenarien sowie Umsetzungsschritte zur Behebung.
- Regressionen behoben:
  - `_current_environment` prüft zuerst bereits geladene Module und respektiert `SETTINGS.override_environment` auch bei späteren Import-Fehlern. Neuer Test `test_current_environment_prefers_loaded_module_when_imports_fail` + bestehende Suite grün.
  - Vision-Adapter klassifiziert fehlende PDF-Daten wieder als `pdf_images_unavailable`, auch wenn Supabase-Hosts untrusted sind. Ergänzende Tests in `backend/tests/test_learning_vision_pdf_stitched_fallback.py` decken das Logging + Error-Mapping ab.

_Letzte Aktualisierung: 2025-11-16, Codex Review-Agent._
