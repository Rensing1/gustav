# PR Review – Fix Plan (2025-11-15)

## Kontext & Scope
- Review bezieht sich auf HEAD `7398edb` (Branch: development, diff vs. origin/master).
- Schwerpunkt: neue Storage-/Upload-Härtungen, OpenAPI Defaults (`security` auf Root-Ebene), Learning-Worker/Adapters.
- Relevante Artefakte: `api/openapi.yml`, `backend/storage/verification.py`, `backend/web/routes/learning.py`, Makefile-Erweiterungen.

## Kurzfazit
Solide Fortschritte bei Storage-Dokumentation und Proxy-Härtung. Zwei Blocker bleiben offen: (1) OpenAPI markiert `/auth/logout` & `/auth/logout/success` fälschlich als Cookie-gebundene Endpunkte und bricht damit Contract + Gateway-Policies. (2) Die neue Integritätsprüfung meldet erkannte Mismatchs als „skipped“, sobald `REQUIRE_STORAGE_VERIFY=false`, wodurch manipulierte Uploads ungeprüft akzeptiert werden. Beide Punkte müssen adressiert werden, bevor der PR sicher merged werden kann.

## MUST-FIX
1. **[API] Logout-Vertrag korrigieren**  
   - **Evidenz**: `api/openapi.yml:2120-2249@7398edb` – Root-`security` gilt global, die Login-/Register-Pfade setzen `security: []`, Logout/Sucess aber nicht.  
   - **Impact**: Gateway/Clients interpretieren `/auth/logout` als „Session nötig“. Browser ohne gültiges Cookie oder externe Logout-Flows erhalten 401 → Single-Sign-Out kaputt.  
   - **Plan**: Für `/auth/logout` und `/auth/logout/success` explizit `security: []` setzen (analog Login/Register), Tests `test_auth_logout_redirect` etc. verifizieren weiterhin öffentlichen Zugriff.

2. **[SEC] Integritätsprüfung darf erkannte Fehler nicht ignorieren**  
   - **Evidenz**: `backend/storage/verification.py:169-237@7398edb`. Sobald `require_remote=False`, werden `size_mismatch`/`hash_mismatch` nach lokalen Checks zu `(True, "skipped")`.  
   - **Impact**: Jede Umgebung mit `REQUIRE_STORAGE_VERIFY=false` akzeptiert absichtlich manipulierte Uploads (z.B. falsche SHA), obwohl die Diskrepanz entdeckt wurde. Das betrifft Dev/Test und potenziell produktionsnahe Staging-Deployments.  
   - **Plan**: Sobald eine Diskrepanz festgestellt wird, immer `(False, <reason>)` zurückgeben, unabhängig vom `require_*`-Flag. Nur „nicht geprüft“ (fehlender Zugriff) darf `skipped` melden. Ergänzend Regressionstest in `backend/tests/test_learning_submission_storage_verification.py`.

3. **[BUG] Vision-PDFs funktionieren ohne lokalen Storage nicht**  
   - **Evidenz**: `backend/learning/adapters/local_vision.py:368-783@7398edb` – `_ensure_pdf_stitched_png` liefert `None`, wenn `STORAGE_VERIFY_ROOT` fehlt, und `extract()` beendet PDFs mit `VisionTransientError("pdf_images_unavailable")`, obwohl bereits Remote-Fetches (`image_list_b64`) vorbereitet werden.  
   - **Impact**: Standard-Setup (Supabase-only, kein lokaler Persistenzpfad) kann keine PDF-Abgaben analysieren; Worker retried ewig und liefert nie Feedback. Damit ist das Feature regressionsgefährdet.  
   - **Plan**: Erlaube dem Adapter, die vorhandenen PDF-Page-Bilder aus `image_list_b64` oder der Supabase-Quelle zu verwenden (z.B. `_ensure_pdf_stitched_png` mit Remote-Fallback oder direkter Stitch, wenn Root fehlt). Regressionstest in `backend/tests/learning_adapters/test_local_vision_remote_fetch.py`, der PDF-Flow ohne `STORAGE_VERIFY_ROOT` abdeckt.

4. **[CONSISTENCY] `AUTO_CREATE_STORAGE_BUCKETS`-Flag wird nirgends genutzt**  
   - **Evidenz**: `backend/storage/bootstrap.py:13-22@7398edb` beschreibt den Helper, aber `backend/web/storage_wiring.py` oder andere Startup-Pfade rufen `ensure_buckets_from_env()` nicht auf. README verspricht Auto-Provisioning.  
   - **Impact**: Entwickler aktivieren das Flag, erwarten Bucket-Bootstrap und erhalten weiter 404/403 beim Hochladen. Die Doku ist damit faktisch falsch, Onboarding bleibt holprig.  
   - **Plan**: Im Storage-Wiring nach erfolgreichem Supabase-Adapter (`wire_supabase_adapter_if_configured`) `ensure_buckets_from_env()` integrieren (einmalig mit Logging). Ergänze Unit-Test (`backend/tests/test_app_storage_wiring.py` oder neues Storage-Bootstrap-Szenario), der sicherstellt, dass bei gesetztem Flag `_list_buckets`/`_create_bucket` aufgerufen werden.

## SHOULD-FIX (zur Nachverfolgung)
- **Docstring-Konsistenz für Local Vision Adapter** (`backend/learning/adapters/local_vision.py:328ff`). Kommentar behauptet „no storage access“, obwohl Datei Supabase-Downloads, PDF-Stitching & Persistenz enthält. Empfehlung: Docstring anpassen oder Datei modularisieren (Storage-Fetch, PDF-Derive, Model-Call).

- **Vision/Storage-Remote-Fetch weiter schärfen** (`backend/learning/adapters/local_vision.py`, `backend/storage/verification.py`). Fehler wie `untrusted_host` sollten nicht als transienter Wiederholfehler behandelt werden; stattdessen klar zwischen permanenten Konfigurationsproblemen und temporären Netzwerkfehlern unterscheiden und Host-Whitelist-Logik möglichst zentral halten.

- **AI-Config-Drift vermeiden** (`backend/learning/config.py`, `backend/learning/adapters/local_feedback.py`). Der Local-Feedback-Adapter liest aktuell eigene ENV-Variablen (Model, Base-URL, Timeout) statt das zentrale `AIConfig` zu verwenden. Ziel: Adapter über `load_ai_config()` konfigurieren und `AI_TIMEOUT_*` tatsächlich an den Ollama-Client weitergeben.

- **Storage-Key- und Upload-Limits konsistent halten** (`backend/storage/keys.py`, `backend/teaching/services/materials.py`, `backend/storage/learning_policy.py`). Es existieren zwei unterschiedliche Segment-/Filename-Sanitizer und ein statisch berechnetes `MAX_UPLOAD_BYTES`. Plan: Sanitizer an einer Stelle bündeln und Upload-Limits über die zentralen Getter dynamisch (bzw. klar dokumentiert „per Neustart“) beziehen.

- **Telemetrie- & OpenAPI-Kosmetik** (`backend/learning/repo_db.py`, `api/openapi.yml`). Die neue Submission-Telemetrie nutzt einen lokalen Sanitizer; perspektivisch in ein gemeinsames Utility auslagern. Zusätzlich verbleibende Inline-401/403-Responses Schritt für Schritt auf die neuen `components.responses`-Aliase umstellen, damit der Vertrag für Auth-Fehler überall einheitlich ist.

- **BinaryWriteStorage-Port nur einmal definieren** (`backend/storage/ports.py`, `backend/learning/usecases/pdf_preprocessing.py`). Der Storage-Port ist doppelt definiert; Ziel: Das Protokoll aus `backend.storage.ports` im Use Case wiederverwenden, um Interface-Drift zu vermeiden.

- **DSPy-/Ollama-Env-Helfer zentralisieren** (`backend/learning/workers/process_learning_submission_jobs.py`, `backend/learning/adapters/dspy/feedback_program.py`). Feature-Flags (`LEARNING_DSPY_JSON_ADAPTER`) und `OLLAMA_*`-Hosts werden aktuell an zwei Stellen gepflegt. Plan: Gemeinsame Helper-Funktionen in ein kleines Config-/Util-Modul ziehen.

- **SUPABASE_URL auf HTTPS in Prod prüfen** (`backend/web/config.py`). Bisher werden nur Keycloak-URLs strikt auf HTTPS geprüft. Plan: In `ensure_secure_config_on_startup()` auch `SUPABASE_URL` analog `_must_be_https(...)` validieren (bzw. klar dokumentierte Ausnahme für rein interne Netze).

## Tests & Nachweise
- **OpenAPI Kontrakt**: `backend/tests/test_openapi_learning_upload_proxy_contract.py` bleibt grün; ergänze `test_openapi_logout_paths_are_public`, das `security: []` auf Logout-Pfaden verifiziert.  
- **Storage-Verifikation**: `backend/tests/test_learning_submission_storage_verification.py` um Fall erweitern („skipped“ darf bei Hash-Mismatch nicht passieren). Zusätzlich Unit-Test für `_stream_hash_from_url` bleibt optional.

- **Upload-Proxy-Prod-Parity**: `backend/tests/test_learning_internal_proxy_prod_parity.py` so anpassen, dass die ersten beiden Tests tatsächlich einen `PUT /api/learning/internal/upload-proxy` ausführen und 502 (`proxy_failed` / `upstream_error`) asserten, statt nur `_async_forward_upload` zu patchen. Damit werden die Fehlerpfade real geprüft.

## Nächste Schritte
1. OpenAPI-Update durchführen + Tests (`pytest -q backend/tests/test_openapi_*`).
2. `verify_storage_object_integrity` anpassen, Tests erweitern.  
3. Vision-PDF-Fallback korrigieren und Remote-Flow testen.
4. Storage-Wiring + Bootstrap-Flag verknüpfen, Test ergänzen.  
5. Falls gewünscht, Docstring/Struktur des Local-Vision-Adapters angleichen.
6. Review erneut laufen lassen; sobald Must-Fix erledigt, Merge freigeben.

## Umsetzung 2025-11-15
- Logout-Vertrag korrigiert: `/auth/logout` + `/auth/logout/success` setzen jetzt `security: []`, damit Gateway/Clients öffentliche Logouts zulassen. Red-Test ergänzt (`test_openapi_logout_paths_are_public` in `backend/tests/test_openapi_learning_upload_proxy_contract.py`), danach Vertrag angepasst (`api/openapi.yml`). Tests: `.venv/bin/pytest -q backend/tests/test_openapi_learning_upload_proxy_contract.py`.
- Storage-Integritätsprüfung härtet Mismatches: Neues Szenario `test_submission_verification_detects_mismatch_even_when_optional` beweist, dass falsche Hashes auch bei `REQUIRE_STORAGE_VERIFY=false` abgelehnt werden. `verify_storage_object_integrity` markiert Size/Hash-Mismatches nun sofort als `(False, reason)` (inkl. Remote-HEAD) statt "skipped". Tests: `.venv/bin/pytest -q backend/tests/test_learning_submission_storage_verification.py`.
