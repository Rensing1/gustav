# Plan / Analyse: PR – FilePreview, Material-Upload-Flow & lokale Supabase-Hosts

Stand: 2025-11-17  
Kontext: Review eines PRs, der
- den Datei-Upload-Flow für Lehrkräfte an das bestehende Schüler-Pattern angleicht,
- einen wiederverwendbaren `FilePreview`-Viewer für Datei-Materialien einführt,
- Inline-Previews auf Lehrer- und Schülerseiten aktiviert,
- die Erkennung „lokaler“ Supabase-Hosts für den Learning-Vision-Adapter erweitert,
- die Keycloak-Konfiguration für ein produktionsnähes Setup anpasst.

Ziel dieses Dokuments:
- Änderungen entlang der Projektachsen einordnen (Komplexität, Wartbarkeit, Robustheit, Sicherheit, Dokumentation, Konsistenz).
- Konkrete Must-/Should-Fix-Punkte festhalten, die vor dem Merge erledigt werden sollten.
- Tests & nächste Schritte so dokumentieren, dass spätere Arbeiten auf diesem PR aufbauen können.

---

## 1. Überblick über die Änderungen

### 1.1 UI & Komponenten

- Neuer `FilePreview`-Component in `backend/web/components/file_preview.py`
  - Unterstützt `image/*` (Inline-`<img>`), `application/pdf` (Inline-`<iframe>`) und sonstige MIME-Typen via Fallback-Download-Link.
  - Wrapper-Klassen (`file-preview`, `file-preview--pdf|--image|--download`) plus Accessibility-Hooks (`data-file-preview="true"`, `role="button"`, `tabindex="0"`).
- Integration von `FilePreview` in:
  - Lehrer-Materialdetailseite (`_render_material_detail_page_html` in `backend/web/main.py`).
  - Schüler-Unit-Seite (`_render_learning_unit_sections_page_html` in `backend/web/main.py`), indem pro Datei-Material eine Inline-Preview innerhalb `MaterialCard` aufgebaut wird.
- Neues SSR-Layout für `/units/{unit_id}/sections/{section_id}/materials/new`:
  - Radio-Umschaltung Text | Datei.
  - Zwei getrennte Formulare (`material-form--text` und `material-form--file`), nur eines sichtbar.
  - Datei-Formular enthält File-Input und Hidden-Felder (Intent-ID, SHA-256), die per JS gefüllt werden.

### 1.2 JavaScript / Upload-Flow

- Erweiterung `backend/web/static/js/gustav.js`:
  - `validateFile(file, allowedMime, maxBytes)`: gemeinsame Validierung von MIME-Whitelist und Maximalgröße.
  - `requestIntentAndUpload(intentUrl, file, payload)`: generischer Helper für Intent → PUT-Upload → SHA-256-Ermittlung.
  - `initMaterialCreateForms()` + `prepareMaterialUpload()`: Lehrkraft-Material-Upload nutzt jetzt denselben Intent-Ansatz wie Schüler-Submissions, gesteuert über `data-*`-Attribute auf dem SSR-Formular.
  - `initFilePreviewZoom()`: Delegated Event-Handler, der per Klick/Enter/Space die Klasse `file-preview--zoomed` auf Wrappers toggelt (Zoom-Effekt in CSS).
  - Anpassung `prepareLearningUpload()` (Schüler): Nutzung des generischen `requestIntentAndUpload`, klare Trennung Client-Checks vs. serverseitige Autorität.

### 1.3 Backend-Logik / Security-relevante Teile

- `backend/learning/adapters/local_vision.py`
  - `_is_local_host(host: str) -> bool` deutlich ausgebaut:
    - Normalisierung (Trim/Lowercase, Leerstring-Guard).
    - Explizite Allowlist (`127.0.0.1`, `localhost`, `::1`, `host.docker.internal`) + `.local`-Suffix.
    - NEU: „KISS-Regel“ – Hostnamen ohne Punkt (z. B. `supabase_kong-gustav-alpha2`) werden pauschal als „lokal“ angesehen.
    - DNS-Resolution über `socket.getaddrinfo` mit Prüfung, dass ALLE IPs in privaten/Loopback-Ranges liegen.
  - Ziel: Learning-Worker soll HTTP nur zu lokalen/Supabase-Storage-Hosts nutzen, Service-Role-Key darf nicht nach außen „leaken“.
- Tests für lokale HTTP-Hosts:
  - `test_download_accepts_docker_internal_http_host` in `backend/tests/learning_adapters/test_local_vision_remote_fetch.py` simuliert Docker-internen Host mit privater IP (`172.18.0.10`) und prüft, dass der Download gelingt (`reason == "ok"`).

### 1.4 Infrastruktur / Keycloak / Env

- `.env.example`:
  - Ergänzung `KC_HOSTNAME_URL` und `KC_HOSTNAME_ADMIN_URL` mit Standardwert `https://id.localhost`.
- `docker-compose.yml`:
  - Keycloak-Start von `start-dev` auf `start --optimized --import-realm` umgestellt.
  - `KC_HOSTNAME_URL`/`KC_HOSTNAME_ADMIN_URL` aus Env-Variablen mit Fallback-Werten (`https://id.localhost`) gespeist.
- `keycloak/Dockerfile`:
  - `kc.sh build --db=postgres`, damit das optimierte Keycloak-Image konsistent Postgres nutzt (kein H2-Fallback).

### 1.5 Tests & Pläne

- Neue/erweiterte Tests:
  - `backend/tests/test_teaching_materials_new_ui.py`: SSR-Markup und End-to-End-Flow (Intent → Finalize) für Lehrer-Materialien.
  - `backend/tests/test_teaching_entry_detail_ui.py`: Inline-Preview für PDF- und Bild-Material (Lehrkraft).
  - `backend/tests/test_learning_unit_sections_ui_cards_markdown.py`: Datei-Previews auf Schüler-Unit-Seite.
  - `backend/tests/migration/test_legacy_migration_cli.py`: Cleanup von `staging.materials_json` (Tabelle + Typ) vor Tests.
- Plan-Dokumente:
  - `docs/plan/2025-11-17_material_file_inline_preview.md`: Konzeption FilePreview + Zoom.
  - `docs/plan/2025-11-17_materials_upload_unification.md`: Konzeption gemeinsamer Upload-Flow Lehrer/Schüler.

---

## 2. Bewertung entlang der Projektachsen

### 2.1 Komplexität

- Positiv:
  - FilePreview-Komponente ist klein, fokussiert und kapselt das MIME-basierte Rendering an genau einer Stelle.
  - Upload-Logik wird über einen gemeinsamen Helper (`requestIntentAndUpload`) entdoppelt – bessere Wartbarkeit bei überschaubarer Mehrkomplexität.
- Kritischer Punkt:
  - `_is_local_host` ist deutlich komplexer geworden (DNS-Resolution, IP-Parsing, Sonderfall dotloser Hostnamen). Funktional sinnvoll, aber die „KISS-Regel“ („Host ohne Punkt → lokal“) erhöht die kognitive Komplexität und birgt Sicherheitsrisiken (siehe 3.4 Sicherheit).

### 2.2 Wartbarkeit

- Positiv:
  - Tests sind gut benannt und beschreiben Verhalten in BDD-Nähe.
  - FilePreview-Dokumentation (Docstring) erklärt Zweck, Verhalten und Security-Aspekte kompakt.
  - Upload-Flow-Plan-Dokumente sind sauber strukturiert und decken Happy Path + Fehlerpfade ab.
- Verbesserbar:
  - FakeStorageAdapter ist mehrfach sehr ähnlich implementiert; für längere Sicht wäre eine gemeinsame Test-Hilfsklasse (_z. B. unter `backend/tests/helpers/storage.py`_) klarer.
  - A11y-Aspekt: Plan nennt explizit `aria-label` für die Previews, Code setzt bisher nur `role`/`tabindex` – das erschwert das Nachvollziehen für Screenreader-Nutzer.

### 2.3 Robustheit

- Positiv:
  - UI-Tests für neue Seiten/Flows reduzieren die Gefahr von Regressionen (Material-Create-Page, Material-Detail, Schüler-Unit).
  - DNS-Fehler beim Local-Host-Check („fail closed“) führen zu sicherem Verhalten (kein HTTP-Download).
  - Migrationstest bereinigt `staging.*`-Artefakte, was Tests idempotent hält.
- Offene Punkte:
  - `_is_local_host` hat derzeit nur einen positiven DNS-Test (Docker-Host mit privater IP), aber keine Tests für die Fälle:
    - gemischte DNS-Antworten (private + öffentliche IP),
    - ausschließlich öffentliche IPs.
  - FilePreview-Fallback (`file-preview--download`): aufgrund des globalen Zoom-Handlers wird jeder Klick auf den Wrapper abgefangen; wenn ein `<a>`-Link im Wrapper liegt, kann der Download ungewollt blockiert werden (Robustheits- und UX-Thema).
  - JS-Fehlercodes `mime_not_allowed` / `size_exceeded` aus `validateFile` werden im Lehrkraft-Upload aktuell nur als generisches „Upload fehlgeschlagen. Bitte erneut versuchen.“ kommuniziert; die im Upload-Plan vorgesehenen spezifischen Hinweise (z. B. „Format nicht erlaubt“, „Datei zu groß“) fehlen noch.

### 2.4 Sicherheit (DSGVO/Auth)

- Positiv:
  - FilePreview nutzt ausschließlich kurzlebige, autorisierte Download-URLs aus dem Teaching-Storage-Adapter, keine Roh-Bucket-Keys.
  - Cache-Control bleibt serverseitig unverändert (die Viewer hängen „nur“ an die bestehenden URLs; SSR-Seiten sind weiterhin `private, no-store`).
  - `materials_finalize` unterscheidet sauber zwischen HTMX (Partial) und klassischem POST (Redirect bzw. minimaler Fehlertext), CSRF-Validierung bleibt bestehen.
- Kritische Stellen:
  - `_is_local_host` akzeptiert alle Hostnamen ohne Punkt pauschal als „lokal“. Das ist im Docker-Compose-Szenario praktisch, aber sicherheitsseitig fragil:
    - Angenommen, in einer Umgebung wird `supabase_kong_gustav-alpha2` (oder ein ähnlicher Name) per DNS auf eine öffentliche Adresse aufgelöst, würde `_is_local_host` dennoch True zurückgeben, ohne das DNS-Ergebnis zu prüfen.
    - Service-Role-Credentials könnten dann via HTTP an einen externen Host gesendet werden (RLS-Gedanke wird unterlaufen).
  - Zoom-JS fängt Klicks/Keydowns auf allen `.file-preview`-Wrappern ab, inklusive der Fallback-Variante mit `<a>`-Download. Dadurch kann z. B. in „unsicheren“ MIME-Fällen der beabsichtigte Download nicht mehr intuitiv ausgelöst werden. Das ist kein klassischer Security-Bug, aber kann dazu führen, dass Nutzer Workarounds nutzen (z. B. „Link kopieren“) und sich versehentlich unsichere Muster angewöhnen.

### 2.5 Dokumentation

- Positiv:
  - Zwei ausführliche Plan-Dokumente beschreiben User Story, BDD-Szenarien, Tests und Implementierungsideen sehr klar.
  - FilePreview-Komponente hat einen guten, didaktischen Docstring (Warum/Behavior/Security).
  - Kommentar im Migrationstest erklärt, warum `staging.materials_json` + Typ vorab gedroppt werden (Idempotenz).
- Verbesserungspotenzial:
  - `_is_local_host`-Docstring beschreibt das Verhalten korrekt, aber der „dotloser Host“-Shortcut sollte explizit mit Sicherheitsimplikationen erwähnt werden, falls er beibehalten wird – oder besser entfernt werden (siehe Must-Fix).
  - Dokumentation zu Upload-Settings: Es wäre hilfreich, kurz zu dokumentieren, wie JS und `MaterialFileSettings` zusammenspielen, um MIME/Größe-Constraints zu spiegeln (z. B. Referenz-Absatz in einem passenden `docs/references/*`-Dokument).

### 2.6 Konsistenz (OpenAPI / Schema / UI)

- Positiv:
  - FilePreview nutzt bestehende API-Verträge (`download-url`, Material-Detail/Listen-Endpunkte), keine neuen Routen nötig.
  - Lehrer-Upload-Flow verwendet dieselben Intent-/Finalize-Endpunkte wie in den Plan-Dokumenten beschrieben.
  - Schüler- und Lehreransichten verwenden nun denselben visuellen Preview-Baustein (CSS/JS-Klassen).
- Kleinere Inkonsistenzen:
  - A11y-Plan vs. Umsetzung (`aria-label`).
  - Client-seitige MIME- und Größen-Constraints im Learning-Upload sind aktuell als JS-Konstanten eingebaut, während für Lehrkräfte die Limits aus `MaterialFileSettings` stammen. Langfristig sollte beides an eine gemeinsame Quelle gekoppelt sein, um Divergenzen zu vermeiden.

---

## 3. Konkrete Befunde & empfohlene Fixes

### 3.1 Must-Fix

1. **[SEC] `_is_local_host`: dotlose Hostnamen pauschal als lokal**
   - Befund: `if "." not in host: return True` in `backend/learning/adapters/local_vision.py` akzeptiert jeden Host ohne Punkt, ohne DNS-/IP-Prüfung.
   - Risiko:
     - Service-Role-Credentials können bei fehlkonfiguriertem DNS oder ungewollten Host-Einträgen zu externen IPs geschickt werden.
     - Verletzung des „fail closed“-Prinzips: aktuell wird bei DNS-Fehlern defensiv geschlossen, aber bei dotlosen Hosts immer geöffnet.
   - Empfehlung:
     - Entferne den Shortcut für dotlose Hostnamen.
     - Behandle auch dotlose Hosts über die bestehende IP/DNS-Logik:
       - Wenn `ipaddress.ip_address` greift → nur private/loopback.
       - Sonst `getaddrinfo` und nur dann True, wenn alle Adressen private/loopback sind.
     - Ergänze Tests:
       - Dotloser Host mit öffentlicher IP → `_is_local_host` muss False liefern.

2. **[BUG] FilePreview-Fallback blockiert Download über Zoom-Handler**
   - Befund:
     - Fallback-Renderer (`file-preview--download`) erzeugt `<div class="file-preview file-preview--download" …><a …>Download</a></div>`.
     - `initFilePreviewZoom()` registriert einen globalen Click-Handler auf dem Wrapper und ruft `event.preventDefault()`, bevor `classList.toggle()` ausgeführt wird.
     - Ergebnis: Klick auf den Download-Link löst per Default keinen Navigations-Request mehr aus.
   - Risiko:
     - Nutzer können Dateien mit nicht unterstützten MIME-Typen u. U. nicht mehr komfortabel herunterladen.
     - UX-Bruch und potenzielle Umgehungsversuche (Rechtsklick, Link kopieren).
   - Empfehlung:
     - Zoom-Handler nur auslösen, wenn kein `<a>`-Element als direktes Target des Klicks fungiert (bzw. keine `href`-Navigation stattfinden soll).
       - Beispiel: Im Click-Handler prüfen: wenn `event.target.closest("a[href]")` existiert → nicht `preventDefault()` aufrufen.
     - Alternativ:
       - Zoom nur für `file-preview--pdf`/`file-preview--image` aktivieren, nicht für `file-preview--download`.

### 3.2 Should-Fix

1. **[TEST] Upload-Flow für Lehrkräfte nur indirekt getestet**
   - Befund:
     - Es existieren gute SSR- und API-Tests für `/materials/new` und `materials/finalize`.
     - Der JS-Teil (Intent + PUT + Hidden-Felder füllen) wird aber nur implizit geprüft (über HTML-Markup und API-Tests), nicht direkt.
   - Empfehlung:
     - Falls realistisch: Minimaler JS-Test (z. B. mit DOM-Testframework) für `prepareMaterialUpload` (Happy Path + Fehlerpfad).
     - Alternativ: zusätzlicher Integrationstest, der den End-to-End-Flow im Browser-nahem Kontext abbildet (wenn später UI-Tests eingeführt werden).

2. **[TEST] DNS-Negativpfade für `_is_local_host`**
   - Befund:
     - Es existiert ein positiver Test für Docker-internen Host.
     - Gemischte oder rein öffentliche DNS-Antworten sind nicht getestet.
   - Empfehlung:
     - Ergänze Tests in `test_local_vision_remote_fetch.py`, die:
       - `getaddrinfo` auf gemischte Antworten (z. B. private + 8.8.8.8) patchen → erwartetes Ergebnis: False.
       - `getaddrinfo` nur öffentliche IPs liefert → False.

3. **[CONSISTENCY/A11y] `aria-label` für FilePreview-Wrapper ergänzen**
   - Befund:
     - Plan-Dokument beschreibt `aria-label` („Vorschau vergrößern/verkleinern“), Code setzt nur `role="button"` + `tabindex="0"`.
   - Empfehlung:
     - In `FilePreview.render()` dem Wrapper ein sinnvolles `aria-label` mitgeben, z. B.:
       - Für Bilder: „Dateivorschau Bild vergrößern/verkleinern“.
       - Für PDFs: „PDF-Vorschau vergrößern/verkleinern“.

4. **[CONSISTENCY] Konfiguration für MIME/Größen-Limits vereinheitlichen**
   - Befund:
     - Lehrkraft-Upload nutzt Settings aus `MaterialFileSettings` (via `data-allowed-mime` / `data-max-bytes`).
     - Schüler-Upload nutzt hart kodierte Arrays/Größenlimits (`['image/png', 'image/jpeg', 'application/pdf']`, `10 MB`).
   - Empfehlung:
     - Langfristig: Limits als serverseitige Settings bereitstellen (z. B. über einen kleinen API-/Meta-Endpunkt oder eingebettete `data-*`-Attribute in der Lern-Form), sodass beide Seiten dieselbe Quelle nutzen.

5. **[UX] Fehlerkommunikation im Lehrkraft-Datei-Upload schärfen**
   - Befund:
     - `validateFile` unterscheidet zwar zwischen `mime_not_allowed` und `size_exceeded`, im UI wird aber immer nur eine generische Fehlermeldung („Upload fehlgeschlagen …“) gezeigt.
   - Empfehlung:
     - Fehler in `prepareMaterialUpload` differenziert behandeln und Nutzer:innen explizit auf Format-/Größenprobleme hinweisen (analog zu den BDD-Szenarien im Upload-Plan).

### 3.3 Nice-to-have

1. **[WARTBARKEIT] FakeStorageAdapter testweit wiederverwenden**
   - Mehrere nahezu identische FakeStorageAdapter-Klassen könnten zu einer gemeinsamen Test-Hilfsklasse konsolidiert werden.

2. **[UX] Download-Fallback-Beschriftung angleichen**
   - Statt generischem „Download“ eine konsistente Beschriftung verwenden, z. B. „Datei herunterladen“, passend zur bisherigen UI-Sprache.

---

## 4. Teststrategie & Regression

### 4.1 Relevante Tests (Auszug)

- Lehrer-Material-Create-UI:
  - `backend/tests/test_teaching_materials_new_ui.py::test_materials_new_shows_toggle_and_data_attrs`
  - `backend/tests/test_teaching_materials_new_ui.py::test_materials_finalize_redirects_and_creates_file_material`
- Lehrer-Material-Detail-UI:
  - `backend/tests/test_teaching_entry_detail_ui.py::test_material_file_detail_shows_inline_pdf_preview`
  - `backend/tests/test_teaching_entry_detail_ui.py::test_material_file_detail_shows_inline_image_preview`
- Lehrer-Abschnitt-Detail-UI (HTMX-Materialliste):
  - `backend/tests/test_teaching_section_detail_ui.py::test_file_finalize_ui_creates_material_and_updates_list`
  - `backend/tests/test_teaching_section_detail_ui.py::test_material_tabs_are_rendered_for_text_and_file`
- Schüler-Unit-Seite (Inline-Previews):
  - `backend/tests/test_learning_unit_sections_ui_cards_markdown.py::test_student_unit_page_renders_file_material_previews_pdf_and_image`
- Learning-Adapter / lokale HTTP-Hosts:
  - `backend/tests/learning_adapters/test_local_vision_remote_fetch.py::test_download_accepts_docker_internal_http_host`
- Migration:
  - `backend/tests/migration/test_legacy_migration_cli.py::_prepare_tables` (implizit genutzt in den Tests).

### 4.2 Empfohlene Testläufe nach Fixes

Nach Umsetzung der Must-/Should-Fixes:

- Fokuslauf für UI/Upload/FilePreview:
  - `.venv/bin/pytest -q backend/tests/test_teaching_materials_new_ui.py backend/tests/test_teaching_entry_detail_ui.py backend/tests/test_learning_unit_sections_ui_cards_markdown.py`
- Fokuslauf für lokale-Host-Logik:
  - `.venv/bin/pytest -q backend/tests/learning_adapters/test_local_vision_remote_fetch.py`
- Wenn Migrationstests betroffen sind:
  - `.venv/bin/pytest -q backend/tests/migration/test_legacy_migration_cli.py`

---

## 5. Nächste Schritte / ToDos aus dieser Analyse

1. `_is_local_host` härten:
   - Shortcut für dotlose Hosts entfernen.
   - Zusätzliche DNS-Negativtests implementieren.
2. FilePreview-Zoom/Fallback entkoppeln:
   - Zoom-Handler so anpassen, dass Download-Links nicht blockiert werden.
   - Optional Zoom nur für `file-preview--pdf`/`file-preview--image` erlauben.
3. A11y vervollständigen:
   - `aria-label` im FilePreview-Wrapper ergänzen (Plan-Deckung).
4. Konfiguration vereinheitlichen:
   - Perspektivisch MIME/Größenlimits zentralisieren (Upload für Lehrkräfte und Schüler).
5. Test-Hilfen aufräumen:
   - FakeStorageAdapter in gemeinsamen Helper verschieben.

6. Fehlerfeedback für Lehrkraft-Datei-Upload verbessern:
   - Client-seitige Fehler (`mime_not_allowed` / `size_exceeded`) klar und getrennt kommunizieren, statt eines generischen „Upload fehlgeschlagen“-Hinweises.

Dieses Dokument kann für den eigentlichen „Fix-PR“ als Referenz dienen, um die notwendigen Änderungen zielgerichtet und regressionsarm umzusetzen.
