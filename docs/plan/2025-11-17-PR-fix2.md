# Plan / Review-Notiz: PR ‚Äì FilePreview, Material-Upload-Flow & lokale Supabase-Hosts (Fix 2)

Stand: 2025-11-17  
Kontext: Zweite, fokussierte Review-Runde f√ºr denselben PR wie in `2025-11-17-PR-fix.md`.  
Ziel: Die konkrete Code-Review-Analyse (MUST/SHOULD/NICE) und die relevanten Sicherheits-/Konsistenz-Aspekte kompakt festhalten.

---

## 1. Kurz√ºberblick PR (Kontext aus Fix 1)

- UI & Komponenten
  - Neuer `FilePreview`-Component (`backend/web/components/file_preview.py`) f√ºr inline Previews:
    - `image/*` ‚Üí `<img>`-Preview (`file-preview file-preview--image`),
    - `application/pdf` ‚Üí `<iframe>`-Viewer (`file-preview file-preview--pdf`),
    - sonstige MIME-Typen ‚Üí Fallback-Download-Link (`file-preview file-preview--download`).
  - Integration in:
    - Lehrer-Detailseite f√ºr Materialien (`_render_material_detail_page_html`),
    - Sch√ºler-Unit-Seite (`learning_unit_sections` ‚Üí `MaterialCard` mit `preview_html`).
- SSR & Upload-Flow (Teaching)
  - `/units/{unit_id}/sections/{section_id}/materials/new`:
    - Umschaltung ‚Äûüìù Text | ‚¨ÜÔ∏è Datei‚Äú per Radio-Choice-Cards.
    - Zwei Formulare: `material-form--text` und `material-form--file` (Upload-Intent ‚Üí Finalize, via JS).
  - `materials_finalize`-UI-Route:
    - Leitet bei klassischem POST (ohne `HX-Request`) per 303 zur√ºck zur Abschnittsseite,
    - liefert bei HTMX-Requests den aktualisierten Materiallisten-Partial (mit optionaler Fehlermeldung).
- Frontend-JS (`backend/web/static/js/gustav.js`)
  - Gemeinsamer Helper `requestIntentAndUpload` (Intent ‚Üí PUT ‚Üí SHA-256).
  - `validateFile` f√ºr MIME/Gr√∂√üen-Checks.
  - `initMaterialCreateForms` + `prepareMaterialUpload` f√ºr Lehrer-Upload.
  - `initFilePreviewZoom` f√ºr Zoom-Toggle auf `.file-preview`-Wrappers (Click/Enter/Space).
  - Anpassungen in `prepareLearningUpload` (Sch√ºler) zur Nutzung des neuen Helpers.
- Storage/Vision-Sicherheit
  - `_is_local_host` in `backend/learning/adapters/local_vision.py`:
    - Normalisierung (`strip().lower()`),
    - explizite Allowlist: `127.0.0.1`, `localhost`, `::1`, `host.docker.internal`,
    - `.local`-Suffix z√§hlt als lokal,
    - sonst: DNS-Resolve via `socket.getaddrinfo` ‚Üí Host nur dann ‚Äûlokal‚Äú, wenn **alle** IPs in privaten/Loopback-Ranges liegen; gemischte oder rein √∂ffentliche Antworten ‚Üí `False` (fail closed).
- Tests & Docs
  - Neue/erweiterte UI-Tests f√ºr:
    - Materials-Create-Page (Toggle/Text+Datei, Intent-Attrs),
    - Material-Detail (Inline-Preview PDF/Bild),
    - Sch√ºler-Unit-Seite (FilePreviews),
    - Migrationstest bereinigt `staging.materials_json` (Tabelle + Typ) vor Lauf.
  - Referenz-Dokumente:
    - `docs/references/storage_and_gateway.md`: beschreibt neue `_is_local_host`-Logik.
    - `docs/references/teaching.md`: beschreibt FilePreview-Verhalten und Zoom-Hooks.

---

## 2. Review-Zusammenfassung entlang der Achsen

**Komplexit√§t**
- FilePreview ist klein, fokussiert und KISS; MIME-Logik ist an einer Stelle geb√ºndelt.
- Upload-Flow-Logik wurde sinnvoll in einen JS-Helper (`requestIntentAndUpload`) extrahiert (Duplication reduziert, kein neuer Layer).
- `_is_local_host` ist bewusst komplexer (DNS, IP-Parsing), bleibt aber klar strukturiert und ‚Äûfail closed‚Äú.

**Wartbarkeit**
- Tests sind sprechend benannt und nahe an BDD-Szenarien (Happy Path + Edge Cases).
- Plan-Dokumente (`‚Ä¶material_file_inline_preview`, `‚Ä¶materials_upload_unification`) erkl√§ren den Ansatz sauber.
- Leichte Duplizierung von `FakeStorageAdapter` in mehreren Tests; langfristig w√§re eine gemeinsame Helper-Klasse besser.

**Robustheit**
- UI-Tests decken neue Pfade ab (Material-Create, Detail, Sch√ºler-Unit) und reduzieren Regressionen.
- `_is_local_host` behandelt DNS-Fehler und leere Antworten konservativ (kein HTTP-Fetch nach au√üen).
- Non-HTMX-Fehlerpfad von `materials_finalize` ist implementiert, aber noch nicht separat getestet.

**Sicherheit**
- FilePreview verwendet ausschlie√ülich kurzlebige, autorisierte Download-URLs (kein Rendern von Bucket-Keys).
- SSR-Seiten bleiben `Cache-Control: private, no-store`, Download-URLs behalten ihre No-Store-Header.
- `materials_finalize` respektiert Rollen (nur Lehrkr√§fte), CSRF-Token, und trennt HTMX-Partial von klassischem Redirect.
- `_is_local_host` reduziert SSRF-Risiko durch ‚Äûall private or loopback only‚Äú-Regel f√ºr DNS-Antworten.

**Dokumentation**
- Referenz-Dokus (`storage_and_gateway`, `teaching`) wurden an die neuen Komponenten/Flows angepasst.
- FilePreview besitzt einen klaren Docstring (Warum, Verhalten, Security) und wird in der Teaching-Referenz erl√§utert.

**Konsistenz**
- Verhalten von FilePreview (MIME ‚Üí Viewer) und die Beschreibungen in `docs/references/teaching.md` passen zusammen.
- Storage-Sicherheitsbeschreibung in `docs/references/storage_and_gateway.md` ist konsistent zur `_is_local_host`-Implementierung.
- Kleinere Inkonsistenzen: duplizierte `FakeStorageAdapter`-Implementierungen, sowie leichte Divergenz zwischen Plantext und jetzt implementierter `_is_local_host`-Variante.

---

## 3. Konkrete Review-Findings (MUST/SHOULD/NICE)

### 3.1 MUST-FIX

Aktuell keine; der PR ist aus Security- und API-Sicht mergebar.

### 3.2 SHOULD-FIX (zeitnah nachziehen)

1. **Plan/Code-Konsistenz f√ºr `_is_local_host`**
   - Beobachtung: In `2025-11-17-PR-fix.md` wird noch von einer Heuristik ‚Äûdotloser Hostname = lokal‚Äú gesprochen.  
   - Implementierung: `_is_local_host` nutzt inzwischen DNS-Resolution und akzeptiert Docker-Hosts nur, wenn alle IPs privat/Loopback sind.  
   - Ma√ünahme: Plantext in `2025-11-17-PR-fix.md` anpassen (DNS-only-private-Regel und Tests f√ºr gemischte/√∂ffentliche Antworten erw√§hnen), damit Sicherheitsdoku und Code wieder deckungsgleich sind.

2. **Duplizierte `FakeStorageAdapter`-Stubs in Tests**
   - Beobachtung: Sehr √§hnliche Stubs existieren in mehreren Testdateien (z.B. `test_teaching_materials_new_ui`, `test_learning_unit_sections_ui_cards_markdown`, `test_teaching_entry_detail_ui`).  
   - Impact: Erschwert sp√§tere Anpassungen (z.B. neue Header, andere TTLs) und erh√∂ht kognitive Last in Reviews.  
   - Ma√ünahme: Gemeinsame Helper-Klasse unter `backend/tests/helpers/storage.py` o.√§. einf√ºhren und in den betroffenen Tests verwenden.

3. **Fehlerpfad ohne HTMX in `materials_finalize` explizit testen**
   - Beobachtung: Die Route gibt bei klassischem POST ohne `HX-Request` entweder einen 400-Fehler mit knappem Text oder einen 303-Redirect zur√ºck.  
   - Impact: Logik ist sicherheitsrelevant (CSRF, PRG) und wichtig f√ºr Nicht-HTMX-Clients, aktuell aber nicht separat getestet.  
   - Ma√ünahme: Pytest erg√§nzen, der mit einem fehlerhaften `intent_id` ohne `HX-Request` einen 400-Response mit minimalem Fehlertxt erwartet; bei Erfolg sollte ein 303-Redirect zur Abschnitts-Detailseite gepr√ºft werden.

4. **`.local`-Hosts in `_is_local_host` strenger behandeln**
   - Beobachtung: `.local`-Suffixe werden aktuell direkt als ‚Äûlokal‚Äú eingestuft, ohne DNS-Pr√ºfung.  
   - Impact: In Fehlkonfigurationen k√∂nnten entfernte `.local`-Hosts f√§lschlich als vertrauensw√ºrdig gelten.  
   - Ma√ünahme: `.local`-Hosts wie andere Namen via `socket.getaddrinfo` aufl√∂sen und nur akzeptieren, wenn **alle** IPs privat/Loopback sind; gemischte/√∂ffentliche Antworten ‚Üí `False`.

5. **FilePreview-Download-Fallback um `noreferrer` erg√§nzen**
   - Beobachtung: Der Download-Fallback-Link verwendet `rel="noopener"`, aber nicht explizit `noreferrer`.  
   - Impact: Referer k√∂nnte beim Aufruf der Storage-URL mitgesendet werden (je nach Browser-Konfiguration).  
   - Ma√ünahme: `rel="noopener noreferrer"` im Fallback-Link setzen, um Referer-Leaks zus√§tzlich abzusichern.

### 3.3 NICE-TO-HAVE (geringer Aufwand)

1. **A11y-Feinschliff beim Fallback-Download-Viewer**
   - Beobachtung: Der Wrapper f√ºr `file-preview--download` tr√§gt `role="button"`/`tabindex="0"`, enth√§lt aber einen echten `<a>`-Link.  
   - Impact: F√ºr Screenreader sind verschachtelte interaktive Elemente semantisch uneindeutig.  
   - Ma√ünahme: F√ºr die Download-Variante `role/tabindex` am Wrapper weglassen, so dass nur der Link fokussierbar ist; Zoom-Handler kann optional auf PDFs/Images beschr√§nkt werden.

2. **MIME-Whitelist zwischen Teaching/Learning vereinheitlichen**
   - Beobachtung: `validateFile` und `prepareMaterialUpload` lesen erlaubte MIME-Typen per `data-allowed-mime`, w√§hrend der Lernenden-Upload eine fest kodierte Liste nutzt.  
   - Impact: Bei zuk√ºnftigen MIME-√Ñnderungen besteht Risiko, dass Lehrkraft- und Sch√ºler-Flow auseinanderlaufen.  
   - Ma√ünahme: MIME-Liste aus einer gemeinsamen Quelle speisen (z.B. durch serverseitig gerendertes `data-allowed-mime` auch f√ºr Learning-Forms oder eine zentrale JS-Konstante).

3. **No-JS-Hinweis f√ºr Datei-Upload explizit machen**
   - Beobachtung: Die Datei-Variante ist technisch nur mit JS sinnvoll nutzbar; ohne JS fehlt ein expliziter Hinweis.  
   - Impact: Lehrkr√§fte k√∂nnten ‚Äûdefekten‚Äú Datei-Upload vermuten, ohne zu wissen, dass JavaScript n√∂tig ist; der Text-Flow bleibt zwar nutzbar, das ist aber nicht sichtbar kommuniziert.  
   - Ma√ünahme: Kleinen statischen oder `<noscript>`-Hinweis erg√§nzen (‚ÄûDatei-Upload ben√∂tigt JavaScript; Text-Materialien funktionieren immer.‚Äú).

4. **ARIA-Zustand f√ºr Zoom-Toggle erg√§nzen**
   - Beobachtung: `initFilePreviewZoom` toggelt nur die CSS-Klasse `file-preview--zoomed`, ohne einen expliziten ARIA-State zu setzen.  
   - Impact: Screenreader-Nutzer sehen keinen Zustandswechsel (vergr√∂√üert/kompakt), obwohl der Wrapper wie ein Button wirkt.  
   - Ma√ünahme: Beim Toggle zus√§tzlich ein Attribut wie `aria-pressed="true/false"` oder `aria-expanded="true/false"` auf dem Wrapper pflegen.

5. **Alt-Text-Fallback von FilePreview gezielt testen**
   - Beobachtung: F√ºr Bild-Previews f√§llt `alt` auf `title` zur√ºck, wenn kein expliziter Alt-Text gesetzt ist; dies ist bisher nur implizit durch UI-Tests abgedeckt.  
   - Impact: √Ñnderungen am Fallback k√∂nnten unbeabsichtigt die Barrierefreiheit verschlechtern.  
   - Ma√ünahme: Zus√§tzlichen Unit-Test in `test_file_preview_component.py` erg√§nzen, der den Alt-Text-Fallback (`alt` ‚Üí `title`) verifiziert.

---

## 4. Tests & Referenzen (f√ºr sp√§tere Arbeiten)

Wichtige Tests, die den beschriebenen Zustand absichern:

- Lokale Supabase-Hosts & Vision-Adapter  
  - `backend/tests/learning_adapters/test_local_vision_remote_fetch.py::test_download_accepts_docker_internal_http_host`  
  - plus Negativf√§lle `test_is_local_host_rejects_public_dns_only` und `test_is_local_host_rejects_mixed_private_and_public_dns`.

- FilePreview-Komponente & Inline-Previews  
  - `backend/tests/test_file_preview_component.py::test_file_preview_pdf_includes_zoom_and_accessibility_attrs`  
  - `backend/tests/test_file_preview_component.py::test_file_preview_download_fallback_wraps_link_with_zoom_hooks`  
  - `backend/tests/test_teaching_entry_detail_ui.py::test_material_file_detail_shows_inline_pdf_preview`  
  - `backend/tests/test_teaching_entry_detail_ui.py::test_material_file_detail_shows_inline_image_preview`  
  - `backend/tests/test_learning_unit_sections_ui_cards_markdown.py::test_student_unit_page_renders_file_material_previews_pdf_and_image`

- Lehrkraft-Material-Upload-Flow (Intent ‚Üí Finalize)  
  - `backend/tests/test_teaching_materials_new_ui.py::test_materials_new_shows_toggle_and_data_attrs`  
  - `backend/tests/test_teaching_materials_new_ui.py::test_materials_finalize_redirects_and_creates_file_material`

- Migrationen / Staging-Cleanup  
  - `backend/tests/migration/test_legacy_migration_cli.py::_prepare_tables` (Drop/Truncate von `staging.materials_json` und zugeh√∂rigem Typ).

Referenz-Dokus:
- `docs/references/storage_and_gateway.md` ‚Äì Abschnitt ‚ÄûSecurity‚Äú / `_is_local_host`.  
- `docs/references/teaching.md` ‚Äì Abschnitt ‚ÄûDatei‚ÄëMaterialien & FilePreview‚Äú.
- Plan-Dokumente:  
  - `docs/plan/2025-11-17_material_file_inline_preview.md`  
  - `docs/plan/2025-11-17_materials_upload_unification.md`  
  - `docs/plan/2025-11-17-PR-fix.md` (Erst-Analyse dieses PRs).

---

## 5. N√§chste Schritte (empfohlene Reihenfolge)

1. Plan-Dokument `2025-11-17-PR-fix.md` an die endg√ºltige `_is_local_host`-Implementierung anpassen (DNS-only-private-Regel, Mixed-DNS-Tests).  
2. Gemeinsamen `FakeStorageAdapter`-Testhelper erstellen und in UI-Tests f√ºr Materialien/Units verwenden.  
3. Zus√§tzlichen Pytest f√ºr den Non-HTMX-Fehlerpfad von `materials_finalize` schreiben (400 bei Fehler, 303 bei Erfolg).  
4. Optional: A11y-Feinschliff im Download-Fallback von FilePreview und Harmonisierung der MIME-Whitelists im JS.  
5. Kurz pr√ºfen, ob weitere Stellen FilePreview wiederverwenden k√∂nnen (z.B. sp√§tere Sch√ºler-Materialdetailseiten oder Dashboard-Kacheln), ohne neue API/Schema-√Ñnderungen.
