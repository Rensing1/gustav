# Plan: 2025-11-18 – PR-Fix (Auth & FilePreview Review)

Why
- Review and document the latest PR that touches authentication (Keycloak SMTP, registration domain whitelist, forgot-password flow), Keycloak realm/email themes and inline file previews for teaching/learning materials.
- Capture risks and follow-ups along the core axes for GUSTAV: KISS/Complexity, Maintainability, Robustness/Tests, Security/DSGVO, Documentation and Contract-Consistency (OpenAPI + DB).

Context / Scope
- Auth & Keycloak
  - `.env.example`: SMTP/Keycloak sender configuration + `ALLOWED_REGISTRATION_DOMAINS`.
  - `docker-compose.yml`: Wiring of `KC_SMTP_*` → `KC_SPI_EMAIL_SENDER_DEFAULT_*`.
  - `keycloak/realm-gustav.json`: Realm flags (`verifyEmail`, `resetPasswordAllowed`, `emailTheme`, `smtpServer`).
  - Keycloak email theme: `keycloak/themes/gustav/email/*`.
  - Auth routes: `backend/web/routes/auth.py` (`/auth/login`, `/auth/forgot`, `/auth/register`) and `/auth/callback` in `backend/web/main.py`.
  - OpenAPI contract: `api/openapi.yml` (`/auth/forgot`, `/auth/register`).
  - Docs: `docs/references/user_management.md`.
  - Tests:
    - `backend/tests/test_auth_forgot_flow.py`
    - `backend/tests/test_auth_register_domain_whitelist.py`
    - `backend/tests/test_auth_email_verification.py`
    - `backend/tests/test_keycloak_realm_config.py`
    - `backend/tests/test_keycloak_theme_files.py`
- Storage / Vision hardening
  - `backend/learning/adapters/local_vision.py`
  - `backend/tests/learning_adapters/test_local_vision_remote_fetch.py`
  - `docs/references/storage_and_gateway.md`
- Teaching/Learning UI: file materials & previews
  - Component: `backend/web/components/file_preview.py` (+ export in `backend/web/components/__init__.py`).
  - Styles/JS: `backend/web/static/css/gustav.css`, `backend/web/static/js/gustav.js`.
  - SSR UI:
    - `backend/web/main.py`:
      - Student view: `learning_unit_sections` uses `FilePreview` + presigned download URLs for file materials.
      - Teacher view: `_render_material_detail_page_html` + `/units/{u}/sections/{s}/materials/{m}` now show inline previews.
      - Material list fetch: `_fetch_materials_for_section` returns richer objects (kind, mime_type, storage_key, alt_text).
      - `/units/{u}/sections/{s}/materials/new` + `materials_finalize` for text/file materials.
  - Tests:
    - `backend/tests/test_learning_unit_sections_ui_cards_markdown.py` (file material previews for students).
    - `backend/tests/test_file_preview_component.py` (component markup).
    - `backend/tests/test_teaching_entry_detail_ui.py` (inline previews on material detail).
    - `backend/tests/test_teaching_section_detail_ui.py` (materials new page expectations).
    - `backend/tests/test_teaching_materials_new_ui.py` (toggle + upload-intent/file finalize).
- Migration test hygiene
  - `backend/tests/migration/test_legacy_migration_cli.py` (cleanup of `staging.materials_json` artefacts).

Review Axes (for this PR)
- Complexity (KISS)
  - Helpers `_parse_allowed_registration_domains` and `_is_allowed_registration_email` are small and focused. Domain whitelist logic remains a thin layer around the existing OIDC flow.
  - FilePreview isolates HTML/ARIA/zoom-hook markup; `learning_unit_sections` and `_render_material_detail_page_html` remain readable despite added branches.
  - JS helpers (`validateFile`, `requestIntentAndUpload`, `initMaterialCreateForms`, `initFilePreviewZoom`) centralise upload logic instead of copying code across flows.
- Maintainability
  - Tests added for each new behavior (Domain whitelist, forgot flow, email verification semantics, file previews, Keycloak SMTP/theme).
  - Docs updated to match main flows (`user_management.md`, `storage_and_gateway.md`, `teaching.md`).
  - Naming and structure are consistent with existing repo conventions (Auth routes under `routes/auth.py`, components under `backend/web/components`).
- Robustness / Tests
  - `/auth/register`: BDD scenarios abgedeckt (allowed domain, mixed case/whitespace, missing login_hint, disallowed domain, invalid email format).
  - `/auth/forgot`: Tests sichern Redirect-URL, `Cache-Control: private, no-store` und `login_hint`-Weitergabe.
  - `/auth/callback`: New tests ensure that GUSTAV does not block unverified/missing `email_verified` claims.
  - Vision adapter: `_is_local_host` now resolves Docker hostnames via DNS and fails closed when any public IP is present; tests cover private-only, public-only, mixed answers.
  - File materials:
    - Component contract is tested for PDF and fallback variants (`test_file_preview_component.py`).
    - Student and teacher SSR pages are tested for inline previews, correct classes/ARIA attributes and presence of presigned download URLs.
    - `materials_finalize` distinguishes between HTMX and classic form posts (204/200 partial vs. 303 redirect with fallback error handling).
- Security / DSGVO
  - Auth:
    - `/auth/login`, `/auth/register`, `/auth/forgot` use `Cache-Control: private, no-store`; `/auth/register` and `/auth/login` additionally use `Vary: HX-Request`.
    - `/auth/register`: optional environment-driven domain whitelist; invalid/disallowed domains yield 400 JSON (`Error`-schema-konform), no redirect to Keycloak → improves abuse protection and reduces accidental private registrations.
    - `/auth/callback`: all error paths return 400 JSON with private/no-store; `email_verified` is not used to block logins, so Keycloak remains the single source of truth.
  - Keycloak / SMTP:
    - Realm export explicitly defines `emailTheme="gustav"` and SMTP `from`/`fromDisplayName`, reducing post-import misconfigurations.
    - `resetPasswordAllowed=false` keeps self-service reset via email disabled on the realm; password reset is expected to be done via admin actions.
    - Docker compose maps `KC_SMTP_*` → `KC_SPI_EMAIL_SENDER_DEFAULT_*` ensuring local = prod semantics.
  - Storage / Vision:
    - `_is_local_host` classifies hosts as local only if:
      - Host is in `_LOCAL_HTTP_HOSTS` or has `.local` suffix, or
      - All DNS results are loopback/private; mixed/public results cause `untrusted_host`.
    - `_download_supabase_object` refuses HTTP to non-local hosts, and enforces host:port allow-list from `SUPABASE_URL`/`SUPABASE_PUBLIC_URL`.
  - File previews:
    - Use presigned download URLs (inline disposition) from the teaching storage adapter (`MaterialFileSettings`), never raw bucket keys.
    - SSR responses keep `Cache-Control: private, no-store`; signed URLs keep their own no-store semantics from the API.
- Documentation & Consistency
  - OpenAPI:
    - `/auth/forgot` description now clearly states that Keycloak sends password reset emails and handles rate limiting.
    - `/auth/register` documents the optional 400 response when `ALLOWED_REGISTRATION_DOMAINS` is configured and the login_hint domain is rejected.
  - References:
    - `docs/references/user_management.md` now explains:
      - Domain whitelist behavior (`ALLOWED_REGISTRATION_DOMAINS`) and its relationship to Keycloak policies.
      - Email verification responsibilities (Keycloak vs. GUSTAV).
      - Password-reset flow: disabled self-service in the realm, admin-driven resets, `/auth/forgot` as a technical helper.
    - `docs/references/storage_and_gateway.md` documents the improved `_is_local_host` and DNS-based local-host classification (all IPs must be private/loopback).
    - `docs/references/teaching.md` documents:
      - FilePreview behavior (PDF/image/fallback).
      - Security model for file materials (signed URLs, private buckets).
      - Accessibility and the JS zoom behavior.

Key Findings from the Review
- Positiv:
  - Domain whitelist for `/auth/register` is minimal, well-tested and keeps Keycloak as the central auth provider.
  - SMTP and email theme wiring for Keycloak are end-to-end covered (env → compose → realm → templates → tests).
  - Vision adapter hardening is conservative and documented; SSRF surface is reduced while still supporting Docker-local hosts.
  - FilePreview component and JS helpers reduce duplication and improve UX (inline previews, zoom) without exposing raw storage paths.
  - Test coverage is broad: Auth flows, realm config, Keycloak theme, file materials (component + UI), vision SSRF guards and migration cleanup idempotency.
- Zu prüfen/vereinheitlichen:
  - `verifyEmail` semantics: Docstring in `test_realm_requires_email_verification_and_email_theme` spricht von „verifyEmail=true“, während das Realm-Flag und Testasserts auf `verifyEmail=false` bestehen (GUSTAV vertraut auf Keycloak, erzwingt aber selbst nichts).
  - `/auth/forgot` nutzt nur `Cache-Control` ohne `Vary: HX-Request`; könnte aus Konsistenzgründen an `/auth/login` und `/auth/register` angeglichen werden, falls HTMX später verwendet wird.
  - Fehlermeldung bei Domain-Whitelist ist aktuell fest auf „IServ-Adresse (@gymalf.de)“ zugeschnitten; bei mehreren Schulen/Domains wäre eine konfigurierbare oder neutralere Formulierung sinnvoll.
  - Repo enthält reale SMTP-/From-Daten (gymalf.de, konkrete Absenderadresse); für ein generisches FOSS-Setup sollten wir klar dokumentieren, dass dies ein schul-spezifisches Profil ist oder auf neutrale Platzhalter wechseln.
  - Learning-Upload-Flow im JS verwendet ein hartkodiertes 10-MiB-Limit; Server-/OpenAPI-Limits sollten langfristig aus Konfiguration/Dataset injiziert werden, um Divergenzen zu vermeiden.

Risiken & Prioritäten (basierend auf Review)
- Must-Fix
  - Domain-Whitelist-Fehlermeldung mit fest verdrahtetem „@gymalf.de“:
    - Risiko: Andere Schulen müssen den Code textuell anpassen; FOSS-Reuse leidet.
    - Maßnahme: Fehlermeldung dynamisch aus `ALLOWED_REGISTRATION_DOMAINS` ableiten (oder neutral formulieren) und OpenAPI/Tests entsprechend anpassen.
- Should-Fix
  - JS-Upload-Limits:
    - Risiko: Unterschiede zwischen Client-Checks und Server-Validierung, falls Limits im Vertrag geändert werden.
    - Maßnahme: Limits aus Backend (z. B. via Data-Attribut oder API) ableiten; Hardcodierung entfernen.
  - FilePreview-Zoom-Interaktion:
    - Risiko: Nur statische Markup-Tests; Zoom-Toggle (Click/Keyboard) könnte unbemerkt brechen.
    - Maßnahme: Kleinen Browser-/Integrationstest ergänzen, der `file-preview--zoomed`-Toggle und Nicht-Interferenz mit echten Links prüft.
- Nice-to-Have
  - FOSS-Konfiguration:
    - Risiko: Gymalf-spezifische SMTP-/Support-Adressen verwirren andere Deployments.
    - Maßnahme: Neutrale Platzhalter (`support@school.example`, `noreply@school.example`) in `.env.example`, Realm-Config und Keycloak-Templates verwenden und Gymalf-Profil nur als Beispiel in der Dokumentation führen. Im Plan/Docs klar markieren, dass diese Platzhalter vor Produktivnahme angepasst werden MÜSSEN.

Next Steps / Follow-ups
- Getroffene Entscheidungen (mit Felix abgestimmt):
  - `verifyEmail`:
    - Aktueller Übergangszustand: Der Realm läuft mit `verifyEmail=false`, da E-Mail-/SMTP-Versand noch nicht zuverlässig funktioniert. GUSTAV verlässt sich nicht zusätzlich auf das `email_verified`-Claim, sondern auf die IdP-/Schulkonfiguration.
    - Zielbild: Sobald der E-Mail-Versand stabil ist, soll die Referenzkonfiguration `verifyEmail=true` empfehlen. Dies wird in `docs/references/user_management.md` als „Empfohlener Betriebsmodus“ beschrieben, während der aktuelle Zustand als bewusst gewählte Übergangslösung dokumentiert bleibt.
  - Domain-Whitelist-Fehlermeldung:
    - Die Fehlermeldung für `/auth/register` soll keine hart kodierte „@gymalf.de“-Adresse enthalten, sondern generisch formuliert werden („Registrierung ist nur mit einer Schul-E-Mail-Adresse erlaubt.“) und optional die erlaubten Domains dynamisch aus `ALLOWED_REGISTRATION_DOMAINS` anzeigen.
    - Tests (z. B. `backend/tests/test_auth_register_domain_whitelist.py`) und OpenAPI-Beschreibung werden so angepasst, dass sie diese dynamische, konfigurationsbasierte Darstellung widerspiegeln.
  - SMTP-/Support-Referenz:
    - In allen generischen Artefakten (z. B. `.env.example`, `keycloak/realm-gustav.json`, Keycloak-E-Mail-Templates) werden nur neutrale Platzhalter (`support@school.example`, `noreply@school.example`) verwendet.
    - Gymnasium Alf erscheint nur als konkretes Beispielprofil in der Dokumentation (z. B. Abschnitt „Beispielkonfiguration: Gymnasium Alf“). In einer Deployment-Checkliste wird explizit festgehalten, dass Operatoren diese Platzhalter vor Produktivbetrieb durch reale Schuladressen ersetzen müssen.
- Technische Empfehlungen (nachgelagert, kein Blocker):
  - `/auth/forgot`: Optional `Vary: HX-Request` ergänzen und HTMX-Verhalten dokumentieren.
  - FilePreview:
    - Zusätzlichen Unit-Test für `image/*`-Variante ergänzen (Markup/ARIA analog PDF).
    - Separaten Interaktionstest (Browser/Playwright o. Ä.) für Zoom-Toggle (Click/Enter/Space) ergänzen.
  - JS: Fehlermeldungscodes der Upload-Helfer kurz dokumentieren (Mapping Code → User-Facing Message), damit spätere Internationalisierung einfacher ist.
