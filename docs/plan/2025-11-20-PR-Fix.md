# Plan: Review & Fix-Empfehlungen zum aktuellen PR (2025-11-20)

Dieses Dokument hält die Code-Review-Auswertung zum aktuellen Stand (Commit `9c76a44`) fest.
Es dient als Referenz für nachgelagerte Fixes und zur Abstimmung über Prioritäten.

## 1. Kurzfazit

Die Änderungen stärken Auth-Flows (SMTP, Registrierung, Domain-Whitelist), härten den Storage-Zugriff ab und verbessern LLM-Pipeline sowie Material-UI deutlich. Komplexität bleibt insgesamt im Rahmen, wächst aber spürbar in `backend/web/main.py` und `backend/web/static/js/gustav.js`. Ein neuer DSPy-Fallback-Bug muss vor Merge behoben werden; A11y- und Test-Nachschärfungen bleiben überschaubar.

## 2. MUST-FIX

- [BUG] DSPy-Fallback wird durch Ollama überschrieben —  
  Evidenz: `backend/learning/adapters/local_feedback.py:123-134@9c76a44` —  
  Impact: Doppelte LM-Aufrufe trotz DSPy-Determinismus, höheres Fehlerrisiko —  
  Fix: DSPy-Fallback-Ergebnis direkt zurückgeben, Ollama-Pfad in diesem Status nicht erneut aufrufen.  
  **Status:** Erledigt in `local_feedback.py` + Test `test_feedback_dspy_fallback_does_not_call_ollama`.

## 3. SHOULD-FIX

- [TEST] DNS-Pfade von `_is_local_host` explizit testen —  
  Evidenz: `backend/learning/adapters/local_vision.py:38-80@9c76a44` —  
  Impact: Mischfälle mit privaten/öffentlichen A-Records bleiben ungetestet —  
  Fix: `socket.getaddrinfo` per pytest-Mocks für lokal/mixed/Fehlerfälle abdecken.  
  **Status:** Erledigt (Positive + .local vs. gemischte DNS-Fälle in `test_local_vision_remote_fetch.py`).

- [API] Fehlermeldung für Domain-Whitelist zentralisieren —  
  Evidenz: `backend/web/routes/auth.py:263-311@9c76a44` —  
  Impact: Deutsch-only Text, kein zentrales i18n/Reuse —  
  Fix: Fehlertext über gemeinsames Error-Schema oder Übersetzungs-Layer konfigurieren.  
  **Status:** Erledigt via `_registration_domain_error_payload`.

- [CONSISTENCY] A11y-Status für FilePreview-Zoom ergänzen —  
  Evidenz: `backend/web/components/file_preview.py:40-90@9c76a44` —  
  Impact: Screenreader sehen nur „Button“, keinen Zustand —  
  Fix: `aria-pressed`/`aria-expanded` synchron zum `file-preview--zoomed`-Status halten.  
  **Status:** Erledigt (Wrapper-Attrs + JS-Toggle, Tests aktualisiert).

- [TEST] Worker-DSPy-Pfad fehlt als Integrationstest —  
  Evidenz: `backend/tests/learning_adapters/test_learning_worker_dspy_only_placeholder.py:1-14@9c76a44` —  
  Impact: Persistenz von `criteria.v2`/`feedback_md` im Worker ungeprüft —  
  Fix: Worker-Test mit DSPy-Mock und DB-Assertion ergänzen.  
  **Status:** Erledigt (Test hinzugefügt, läuft bei verfügbarer DB; lokalen Skip beachten).

- [TEST] Raw-Mode-Regression ungeschützt —  
  Evidenz: `backend/tests/learning_adapters/test_ollama_raw_mode.py@9c76a44` (entfernt) —  
  Impact: Risiko, dass Ollama-Template wieder greift —  
  Fix: Raw-Mode-Test reaktivieren oder gleichwertigen DSPy-Security-Test hinzufügen.  
  **Status:** Erledigt (neuer Test `test_local_feedback_fallback_uses_raw_mode`).

## 4. NICE-TO-HAVE

- [API] Verhalten bei Passwort-Reset-Rate-Limits dokumentieren —  
  Evidenz: `api/openapi.yml:2252-2274@9c76a44` —  
  Impact: Entferntes `rate_limited`-Example macht IdP-Ratelimiting intransparent —  
  Fix: Satz im Description-Text oder Runbook zum IdP-Limit ergänzen.

- [TEST] Grenzfälle für `ALLOWED_REGISTRATION_DOMAINS` abdecken —  
  Evidenz: `backend/web/routes/auth.py:32-74@9c76a44` —  
  Impact: Whitespace/Leer-Strings werden wie „keine Restriktion“ behandelt —  
  Fix: pytest-Parameterfälle für "", Whitespace und Domains ergänzen.

- [CONSISTENCY] Prompt-Doku und Signatures synchron halten —  
  Evidenz: `backend/learning/adapters/dspy/signatures.py:19-75@9c76a44` —  
  Impact: Abweichungen zwischen Signatures und LLM-Prompts-Referenz verwirren —  
  Fix: Änderungen in Code/Docs gemeinsam nachziehen.

## 5. Tests (Empfehlungen)

- Given `ALLOWED_REGISTRATION_DOMAINS` gesetzt und fremde `login_hint`-Domain;  
  When `GET /auth/register?login_hint=…`;  
  Then 400 mit JSON `{error:"invalid_email_domain"}` laut Vertrag.  
  (`api/openapi.yml:/auth/register`, `backend/tests/test_auth_register_domain_whitelist.py::<ergänzen/prüfen>`)

- Given Hostname mit gemischten DNS-Antworten;  
  When `_is_local_host(host)`;  
  Then `False` (fail-closed, keine Remote-Fetches).  
  (`backend/tests/learning_adapters/test_local_vision_remote_fetch.py::<mixed_address_case>`)

- Given Host nur private oder `.local`;  
  When `_is_local_host(host)`;  
  Then `True` (erlaubt lokalen HTTP-Traffic).  
  (`backend/tests/learning_adapters/test_local_vision_remote_fetch.py::test_is_local_host_accepts_private_dns_only`)

- Given DSPy-Fallback (analysis_feedback_fallback) aus `analyze_feedback`;  
  When `local_feedback.analyze` ausgeführt wird;  
  Then kein zweiter Ollama-Aufruf und das DSPy-Fallback wird zurückgegeben.  
  (`backend/tests/learning_adapters/test_local_feedback_dspy.py::test_feedback_dspy_fallback_does_not_call_ollama`)

- Given Learning-Worker mit DSPy-Mock;  
  When Job verarbeitet wird;  
  Then `learning_submissions.analysis_json.schema='criteria.v2'` und `feedback_md` gesetzt.  
  (`backend/tests/learning_adapters/test_learning_worker_dspy_only_placeholder.py::<neu hinzufügen>`)

- Given Ollama-Client;  
  When Feedback-Fallback läuft;  
  Then Raw-Mode/Template-Umgehung bleibt aktiv (Regressionstest).  
  (`backend/tests/learning_adapters/test_ollama_raw_mode.py::test_local_feedback_fallback_uses_raw_mode`)

- Given Schülertext+Kriterien;  
  When `analyze_feedback` über DSPy läuft;  
  Then `criteria.v2`-JSON und Feedback-Prosa entsprechen LLM-Prompts-Referenz.  
  (`docs/references/LLM-Prompts.md`, `backend/tests/learning_adapters/test_feedback_program_dspy_structured.py::test_pipeline_happy_path`)

## 6. Refactor-Budget & Freigabe

- Refactor-Budget: **S**  
  - Blast radius: Auth (`/auth*`), Upload-UI (`backend/web/main.py`, `backend/web/static/js/gustav.js`), DSPy-Feedback (`backend/learning/adapters/dspy/*`).

- Freigabe: **⚠️**  
  Merge erst nach Behebung des DSPy-Fallback-Bugs; danach A11y-/Test-Nachschärfungen zeitnah nachziehen. Sicherheit/Lernbarkeit bleiben verbessert, wenn der Bug gefixt ist.
