# Plan: Review & Fix-Empfehlungen zum aktuellen PR (2025-11-20, Runde 2)

Dieses Dokument fasst die zweite Code-Review-Runde zum Stand (Commit `3fb22e4`) zusammen und priorisiert die nächsten Fixes.

## 1. Kurzfazit

DSPy-Pfad wirkt aufgeräumter, Doku und A11y wurden verbessert. Zwei Fallback-Stellen sind jedoch fragil: Im Ollama-Pfad greift kein Timeout, und der DSPy-Legacy-Fallback liefert nur Stub-Feedback. Empfehlung: kleine Nachschärfungen vor dem Merge.

## 2. MUST-FIX

- Keine neuen Must-Fix-Funde in dieser Runde.

## 3. SHOULD-FIX

- [BUG] Ollama-Aufruf ohne Timeout — Evidenz: `backend/learning/adapters/local_feedback.py:33-42,217-239@3fb22e4` — Impact: Worker kann bei langsamem LM hängen; `AI_TIMEOUT_FEEDBACK` bleibt wirkungslos — Fix: Timeout in `client.generate` oder per `client.session` setzen.
- [CONSISTENCY] Legacy-Fallback liefert nur Stubs — Evidenz: `backend/learning/adapters/dspy/feedback_program.py:328-548@3fb22e4` — Impact: Bei DSPy-Ausfällen entsteht generisches Feedback ohne echten LM-Versuch; Kontext/Hints gehen verloren — Fix: Fallback wieder an realen LM-Hook binden oder Fehler bis Adapter eskalieren.

## 4. NICE-TO-HAVE

- [TEST] Timeout- und Fallback-Pfade absichern — Evidenz: `backend/tests/learning_adapters/test_local_feedback.py@3fb22e4` — Impact: Keine Regressionstests für Timeout-Weitergabe und Legacy-Fallback — Fix: Pytest-Mocks für `ollama` mit Delay/Exception; prüfen, dass Timeout greift und LM-Fallback genutzt wird.

## 5. Tests (Empfehlungen)

- Given ollama-Client blockiert; When `analyze()` läuft; Then Timeout aus `AI_TIMEOUT_FEEDBACK` wird angewandt und als `FeedbackTransientError` gemappt. (`backend/tests/learning_adapters/test_local_feedback.py::<neu>`)
- Given DSPy-Signatur wirft Exception; When `analyze_feedback()` fällt zurück; Then LM-Fallback statt Stub wird aufgerufen. (`backend/tests/learning_adapters/test_feedback_program_dspy.py::<neu>`)

## 6. Refactor-Budget & Freigabe

- Refactor-Budget: **S**
  - Blast radius: Learning-Adapter (DSPy + Ollama).

- Freigabe: **⚠️**
  Merge erst nach Timeout-Fix im Ollama-Pfad und einem robusteren DSPy-Legacy-Fallback; Tests anschließend ergänzen.
