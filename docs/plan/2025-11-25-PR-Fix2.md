# Plan: PR-Fixes Runde 2 (2025-11-25)

## Kontext
- Branch: `development`, Stand HEAD `1a60e65`.
- Fokus: Nach-Review-Dokumentation für Backup-Cron und Learning-Worker (Parallelisierung).
- Ziel dieses Plans: Alle festgestellten Risiken und offenen Punkte bündeln, bevor konkrete Fixes umgesetzt werden.

## Wichtigste Befunde (Kurz)
- **SEC**: `Dockerfile.backup` trägt DB-DSNs inkl. Passwörtern ins Cron-Kommando/ps-Liste → Credential-Leak.
- **BUG**: Worker committed Lease vor Verarbeitung; lange Jobs > `LEASE_SECONDS` können doppelt geleast werden → Doppelverarbeitung/Mehrfachfeedback.
- **BUG**: `pg_dump`-Timeout greift nicht sicher, da Reading-Loop blockieren kann → Cron hängt fest.
- **TEST**: Kein Test für hängenden/fehlgeschlagenen `pg_dump` (Timeout/Fail-Manifest) → Regression bleibt unentdeckt.
- **CONSISTENCY**: Compose setzt superuser-`BACKUP_DATABASE_URL` im Repo → verletzt Least-Privilege, Secrets im Klartext.
- **SEC**: `manifest.json` enthält aktuell den rohen Fehlermeldungstext (`error`); interne Host-/DB-Namen sollen dort nicht landen → Fehlertext muss stärker minimiert werden.
- **CONSISTENCY**: Modul-Docstring von `process_learning_submission_jobs` beschreibt weiterhin „einen Job“ und erwähnt weder Parallelität (Batch per `WORKER_CONCURRENCY`) noch OCR-Caching → Doku hinkt leicht hinterher.
- **WARTBARKEIT**: Worker-Tests duplizieren viel Setup-SQL für Kurse/Units/Submissions → langfristig sollten gemeinsame Helper/Factories die Lesbarkeit erhöhen (Nice-to-have).

## Details & Konsequenzen
- Backup-Security: DSN/Passwörter gehören in `PGPASSWORD`/pgpass, nicht in Cron-Env oder Prozessargumente; Manifest darf keine Secrets loggen.
- Worker-Lease: Aktuell `leased`→commit, danach Threads arbeiten; wenn Vision/Feedback länger als Lease läuft, kann `_lease_jobs` den Job erneut ziehen. Crash ent-least zwar, aber lange Laufzeit bleibt riskant.
- Timeout-Verhalten: Streaming zu gzip ist OK, aber ohne hartes Subprozess-Timeout kann `pg_dump` hängen (z. B. Netzwerk/Lock); Retention/weitere Backups blockieren.
- Tests: Fehlerpfade (Timeout, fehlender Storage, pg_dump-Fail) sollen `manifest.status="failed"` erzwingen; Concurrency-Lease-Test existiert, aber kein Heartbeat/Lease-Extend-Test.

## Annahmen / offene Fragen
- Lease-Strategie: Soll Verarbeitung und Lease in derselben Connection/Tx bleiben oder Heartbeat/Lease-Extend implementieren?
- Ops-Vorgaben: Akzeptabler pg_dump-Timeout? (Plan: Default 300s, konfigurierbar).
- Backup-DSN-Quelle: Bevorzugte Reihenfolge wie Runbook (`SESSION_DATABASE_URL` → `BACKUP_DATABASE_URL` → `DATABASE_URL`) beibehalten?

## Nächste Schritte (geplant)
1) Backup:
   - Cron-Command entkoppeln von Secrets; DSN/Passwort per env/pgpass.
   - Subprozess-Timeout robust machen (`communicate(timeout=...)`, Kill on timeout).
   - Testfall für hängenden/fehlenden pg_dump + Manifest `failed`.
   - Compose/Docs auf Least-Privilege-DSN umstellen.
   - Fehlertexte im Manifest auf nicht-sensitive Kurzform (Fehlercode/kurze Message) reduzieren; Detaildiagnostik bleibt in Logs.
2) Worker:
   - Lease hält bis Commit oder Heartbeat einbauen; sicherstellen, dass Jobs nicht doppelt laufen.
   - Test ergänzen für Lease-Überlauf/Heartbeat (sofern Implementierung gewählt).
3) Dokumentation:
   - Runbook/Plan nach Fixes synchronisieren; Hinweise zu `WORKER_CONCURRENCY`-Cap und Backup-Env-Reihenfolge.
   - Modul-Docstring + kurze Inline-Kommentare im Worker an neue Parallelisierungs-/OCR-Reuse-Logik anpassen (Ziel: Lernbarkeit für Schüler sicherstellen).
