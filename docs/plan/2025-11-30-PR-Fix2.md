# Plan: 2025-11-30 – PR-Fix2 (Keycloak Realm & Login-Theme Review)

## Why
- Capture the strict but constructive code review for the Keycloak Realm & Login-Theme PR from 2025-11-30 along the core GUSTAV axes: Complexity, Maintainability, Robustness/Tests, Security/DSGVO, Documentation and Contract-Consistency.
- Make the MUST/SHOULD/NICE findings and test expectations traceable next to earlier plans like `docs/plan/2025-11-30-PR-fix.md`.

## Kurzfazit
Die Änderungen stärken das Keycloak-Theme (Remember-me-Checkbox, dedizierte Update-Passwort-Templates) und bringen sinnvolle Regressionstests für Realm-Export und i18n. Gleichzeitig senken sie durch deaktivierte E-Mail-Verifikation bei offener Registrierung die Sicherheitslinie und bergen ein potenzielles Funktionsrisiko im Passwort-Update-Flow. Nach kleineren Test-/Dok-Korrekturen ist der Code gut wartbar und konsistent, aber die Sicherheits- und Login-Aspekte sollten vor dem Merge geklärt und gehärtet werden.

## Findings

### MUST-FIX
- [SEC] E-Mail-Verifikation bei Self-Service-Registrierung deaktiviert — Evidenz: `keycloak/realm-gustav.json:10-18@9c99e92` — Impact: Unverifizierte Konten möglich, Identitätsmissbrauch/DSGVO-Risiko. — Fix: Setze `verifyEmail=true` oder aktiviere `VERIFY_EMAIL` requiredAction und passe Tests an.
- [BUG] Update-Password-Felder weichen von Keycloak-Required-Action ab — Evidenz: `keycloak/themes/gustav/login/update-password.ftl:30-37@9c99e92` — Impact: Passwort-Änderung scheitert, Reset-Flow bricht ab. — Fix: Verwende `name=\"password-new\"` und `name=\"password-confirm\"` (wie im Standard), ergänze passende Tests.
- [CONSISTENCY] Prod-Redirect für gustav-lernplattform.de fehlt — Evidenz: `keycloak/realm-gustav.json:96-104@9c99e92` — Impact: Realm-Import in Prod führt zu „Invalid redirect URI“. — Fix: Ergänze `https://gustav-lernplattform.de/*` in `redirectUris`.

### SHOULD-FIX
- [SEC] Remember-me-Policy dokumentieren — Evidenz: `keycloak/realm-gustav.json:14-15@9c99e92` — Impact: Längere Sitzungen auf Shared-Devices möglich, unklarer Schul-Policy-Fit. — Fix: Dokumentiere Session-Laufzeiten/Sicherheitsvorkehrungen und verlinke im Sicherheitskonzept.
- [TEST] Update-password-Template fachlich testen — Evidenz: `backend/tests/test_keycloak_theme_files.py:112-129@9c99e92` — Impact: Feldnamen/-attribute können unbemerkt driften. — Fix: Prüfe IDs, Namen, `autocomplete` und `required` für beide Passwortfelder explizit.
- [CONSISTENCY] Testname/Dok zu `verifyEmail` anpassen — Evidenz: `backend/tests/test_keycloak_realm_config.py:47-55@9c99e92` — Impact: Test behauptet „requires email verification“, prüft aber `verifyEmail=false`. — Fix: Benenne Test/Docstring um oder drehe Assertion wieder auf `true`.
- [CONSISTENCY] Inline-Kommentare vollständig auf Englisch halten — Evidenz: `backend/tests/test_keycloak_realm_config.py:60-63@9c99e92` — Impact: Mischsprache erschwert FOSS-Beiträge und widerspricht Stilguide. — Fix: Übersetze deutsche Kommentare in klare, kurze englische Sätze.
- [CONSISTENCY] Alias-Kommentar zu Update-Templates schärfen — Evidenz: `backend/tests/test_keycloak_theme_files.py:42-49@9c99e92` — Impact: Kommentar suggeriert „either-or“, Code verlangt beide Dateien. — Fix: Erläutere explizit, dass beide Templates bewusst vorhanden sein sollen.

### NICE-TO-HAVE
- [TEST] Kurz E2E-Keycloak-Flows gegen lokale Instanz fahren — Evidenz: `keycloak/themes/gustav/login/login.ftl:1-59@9c99e92` — Impact: Theme-/Realm-Änderungen werden nur statisch geprüft. — Fix: Einmal Login, Reset, Update-Passwort, Remember-me manuell durchklicken.
- [CONSISTENCY] Realm-Export-Pfad zentral definieren — Evidenz: `backend/tests/test_keycloak_realm_config.py:14-18@9c99e92` — Impact: Magic-String dreifach, höheres Drift-Risiko. — Fix: `REALM_EXPORT_PATH`-Konstante einführen und überall verwenden.
- [CONSISTENCY] Plan-Notiz zu webOrigins angleichen — Evidenz: `docs/plan/2025-11-30-PR-fix.md:17@9c99e92` vs. aktueller Export — Impact: Nacharbeiten könnten fälschlich auf Wildcard zurückdrehen. — Fix: Dokumentiere, dass `webOrigins` bereits auf explizite Origins eingeschränkt ist.

## Tests (aus dem Review)
- Given `realm-gustav.json` export exists; When loading config; Then `verifyEmail`, `resetPasswordAllowed` und `emailTheme` entsprechen den Erwartungen. (`backend/tests/test_keycloak_realm_config.py::test_realm_requires_email_verification_and_email_theme`)
- Given `realm-gustav.json`; When reading config; Then `rememberMe`-Flag muss `true` sein. (`backend/tests/test_keycloak_realm_config.py::test_realm_enables_remember_me`)
- Given gustav login theme dir; When checking templates; Then login/register/reset/update-password-Templates existieren im Root oder `templates/`. (`backend/tests/test_keycloak_theme_files.py::test_theme_templates_present`)
- Given `login.ftl`; When parsing; Then Remember-me-Checkbox ist bedingt, heißt `rememberMe` und ist nicht vorselektiert. (`backend/tests/test_keycloak_theme_files.py::test_login_has_conditional_remember_me_checkbox`)
- Given update-password-Templates; When parsing; Then enthalten sie `kc`-Layout-Klassen für konsistentes Styling. (`backend/tests/test_keycloak_theme_files.py::test_update_password_templates_use_login_css_hooks`)
- Given update-password-Templates; When parsing; Then Feldnamen sind `password-new`/`password-confirm` mit `autocomplete=\"new-password\"`. (neuer Test in `backend/tests/test_keycloak_theme_files.py`)

## Refactor-Budget & Freigabe
- Refactor-Budget: S — Blast radius: Keycloak Realm & Login-Theme.
- Freigabe: ❌ — Wegen deaktivierter E-Mail-Verifikation bei offener Registrierung und potenziell falscher Feldnamen im Update-Passwort-Formular ist das Login-/Passwort-Ökosystem sicherheitskritisch bzw. funktional riskant. Bitte zuerst beheben.
