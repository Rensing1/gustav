# Plan: 2025-11-30 – PR-Fix (Keycloak Realm & Login-Theme – Reset & Remember-me)

Why
- Capture the code-review for the Keycloak/Realm + Login-Theme PR from 2025-11-30 along the core GUSTAV axes: Complexity, Maintainability, Robustness/Tests, Security/DSGVO, Documentation and Contract-Consistency.
- Make follow-up work explicit (especially Security must-fix) so that future changes around authentication, sessions and Keycloak theming stay aligned with the reference docs in `docs/references/user_management.md` and the Keycloak tickets.

Context / Scope
- Git / Diff
  - BASE: `06086d137586bef43f8269a3cfa06f8f66536ecc` (origin/master vs origin/development merge-base).
  - HEAD: `fa19ec2b711c1d2e4b7bc8eac92f38bf15f90bbf` (this PR).
  - Focus of this plan: only files changed in this diff.
- Keycloak Realm export
  - `keycloak/realm-gustav.json`
    - `resetPasswordAllowed` changed from `false` → `true` so that the self-service password reset link is available in Keycloak.
    - `rememberMe` added as `true` so that the remember-me checkbox can be rendered in the login theme when enabled.
    - `emailTheme` is kept as `"gustav"` and SMTP block uses neutral placeholders (`noreply@school.example`, `smtp.school.example`).
    - `webOrigins` remains configured as `["*"]` for the client `gustav-web` (Security risk, see findings).
- Login theme templates
  - `keycloak/themes/gustav/login/login.ftl`
    - Adds a conditional remember-me checkbox:
      - Guarded by `realm.rememberMe`.
      - `<input id="rememberMe" name="rememberMe" type="checkbox">` and `<label for="rememberMe">${msg("rememberMe")}</label>`.
    - Keeps the existing compact layout (email + password + forgot/reset + register links).
  - `keycloak/themes/gustav/login/update-password.ftl`
    - New template for the Update Password required action.
    - Copies the overall layout and CSS hooks from the login page (`kc-card`, `kc-title`, `kc-form`, `kc-label`, `kc-input`, `kc-submit`, `kc-message`).
    - Renders:
      - Title `${msg("updatePasswordTitle")!msg("doResetPassword")}`.
      - Two password fields (`password` and `password-confirm`) with `autocomplete="new-password"`.
      - Submit button `${msg("doSubmit")}`.
      - A simple link back to the login page `${url.loginUrl}`.
  - `keycloak/themes/gustav/login/login-update-password.ftl`
    - Alias template for Keycloak’s default `login-update-password.ftl` name.
    - Uses the same structure and content as `update-password.ftl` so that both file names are accepted (see tests).
- Login theme messages
  - `keycloak/themes/gustav/login/messages/messages_de.properties`
    - Adds `rememberMe=Angemeldet bleiben`.
  - `keycloak/themes/gustav/login/messages/messages_en.properties`
    - Adds `rememberMe=Keep me signed in`.
- Backend tests
  - `backend/tests/test_keycloak_realm_config.py`
    - Adapts/reset semantics:
      - `resetPasswordAllowed` is now expected to be `True` (self-service reset allowed at IdP level).
    - Adds `test_realm_enables_remember_me`:
      - Asserts `rememberMe` is `True` in `realm-gustav.json`.
  - `backend/tests/test_keycloak_theme_files.py`
    - Extends `test_theme_templates_present`:
      - Requires presence of `update-password.ftl` and `login-update-password.ftl` at theme root or `templates/` subdir.
    - Extends message bundle tests:
      - `rememberMe=` key must exist in German and English bundles.
    - Adds `test_login_has_conditional_remember_me_checkbox`:
      - Asserts presence of `realm.rememberMe` condition, `name="rememberMe"` and `type="checkbox"` in `login.ftl`.
- Documentation / Tickets
  - `docs/plan/2025-11-30-keycloak-login-theme-reset-and-remember-me.md`
    - Describes the original TDD plan for:
      - Theming the password reset/update page.
      - Surfacing `rememberMe` in the login theme.
    - States that no new API endpoints or DB schema changes are required (IdP-only).
  - `docs/references/user_management.md`
    - Documents the semantics of Keycloak’s Remember-me feature vs. GUSTAV app sessions.
    - Clarifies that:
      - The GUSTAV login page shows a remember-me checkbox when the feature is enabled in the realm.
      - The checkbox is not pre-checked by default (safer shared-device default).
      - Remember-me extends only the IdP session, not the app cookie `gustav_session`.
  - `docs/tickets/keycloak-password-reset-page-not-themed.md`
    - Tracks that the password reset page after the email link should use the `gustav` login theme.
  - `docs/tickets/keycloak-remember-me-login-theme.md`
    - Tracks that the remember-me feature should be visible and usable in the simplified GUSTAV login theme.
  - `docs/tickets/learning-criteria-zero-scores-2025-11-28.md`
    - Unrelated to this PR’s code diff, but included in the same commit series as reference for learning feedback issues.

Review Axes (for this PR)
- Complexity (KISS)
  - The remember-me integration in `login.ftl` is minimal: one conditional block guarded by `realm.rememberMe` with standard Keycloak names and a simple label.
  - The reset/update-password templates reuse the existing login layout and CSS hooks; no additional theme layers or partials are introduced.
  - Realm changes are limited to enabling reset/remember-me; no extra custom logic or client configuration beyond placeholders.
- Maintainability
  - Tests cover the new realm flags (`resetPasswordAllowed`, `rememberMe`) and the presence/structure of the remember-me checkbox and update-password templates.
  - The dual template approach (`update-password.ftl` + `login-update-password.ftl`) matches upstream Keycloak naming and keeps directory flexibility (root vs. `templates/`).
  - Message bundle keys are explicit; login and reset pages remain readable for students and maintainers.
- Robustness / Tests
  - Realm tests:
    - `test_realm_requires_email_verification_and_email_theme` now asserts `resetPasswordAllowed=True`.
    - `test_realm_enables_remember_me` asserts `rememberMe=True` in the realm export.
  - Theme tests:
    - `test_theme_templates_present` ensures that both update-password template names exist in the theme.
    - `test_theme_messages_de_present_and_has_keys` and `test_messages_en_present_and_has_email_label` require `rememberMe=` in de/en message bundles.
    - `test_login_has_conditional_remember_me_checkbox` verifies:
      - `realm.rememberMe` appears in `login.ftl`.
      - `name="rememberMe"` and `type="checkbox"` are present.
  - Gaps:
    - There is no explicit test that asserts the remember-me checkbox is not pre-checked by default.
    - There is no dedicated test that the update-password templates actually include all CSS hooks used by the login page (only existence is checked).
- Security / DSGVO
  - Positive aspects:
    - Password reset and remember-me remain purely IdP-level concerns; GUSTAV does not handle raw passwords.
    - The realm export uses neutral SMTP placeholders (`school.example`) instead of real school addresses, which supports FOSS reuse.
    - Remember-me semantics are clearly documented as extending only the IdP session, not the app session cookie.
  - Risk:
    - `webOrigins` is still set to `["*"]` for the `gustav-web` client in `realm-gustav.json`.
      - This broad origin configuration increases the potential attack surface for CORS / misuse if copied into other deployments.
      - For a FOSS reference config we should prefer explicit allowed origins.
- Documentation
  - The user management reference now clearly explains:
    - The difference between IdP-session remember-me and app-session TTL.
    - Why the remember-me checkbox should not be pre-checked (shared-device safety).
  - The plan document for the Keycloak login theme (reset + remember-me) describes:
    - No API/schema changes.
    - Test-first approach on theme files and message bundles.
  - Small drift:
    - The plan still uses wording that suggests a pure “RED phase”, while tests and implementation already exist.
- Contract / Consistency
  - API contract:
    - No changes to `api/openapi.yml`; all behavior is contained within Keycloak and the login/email themes.
    - `/auth/login`, `/auth/forgot`, `/auth/register` behavior is unchanged from an API perspective.
  - DB / Supabase:
    - No new migrations or schema changes; remember-me affects only IdP session lifetimes.
  - Consistency considerations:
    - `test_realm_requires_email_verification_and_email_theme` docstring mentions `verifyEmail=true` as desirable behavior, while the assertion enforces `verifyEmail=false` for the current realm export. This is a known transitional state and should be documented clearly to avoid confusion.

Findings & Actions
- Must-Fix
  - [SEC] Restrict `webOrigins` for `gustav-web` client
    - Finding:
      - `keycloak/realm-gustav.json` uses `"webOrigins": ["*"]` for the client.
    - Risk:
      - Overly permissive origin configuration widens the attack surface and can encourage insecure copy-paste setups in other schools.
    - Action:
      - Replace `"*"` with explicit origins, e.g.:
        - `https://gustav-lernplattform.de`
        - `https://localhost/*` and/or `https://app.localhost/*` for local = prod.
      - Document this in `docs/references/user_management.md` as the recommended pattern for Keycloak clients.
- Should-Fix
  - [CONSISTENCY] Align reset-password documentation with new realm configuration
    - Finding:
      - `docs/references/user_management.md` still documents `resetPasswordAllowed=false` and a primarily admin-driven reset flow, while the realm export now sets `resetPasswordAllowed=true`.
    - Risk:
      - Readers may assume self-service resets are disabled, leading to incorrect support expectations or misconfigured school deployments.
    - Action:
      - Update the password-reset section to describe the intended self-service vs. admin-reset split with `resetPasswordAllowed=true`, or explicitly mark the current setting as a transitional configuration.
  - [SEC] Document brute-force / rate-limiting assumptions for login and reset flows
    - Finding:
      - Self-service reset and remember-me are enabled IdP-seitig, but there is no explicit reference to Keycloak’s brute-force / rate-limiting configuration in `docs/references/user_management.md`.
    - Risk:
      - Future operators might enable the features without also enabling appropriate protection against credential stuffing or password-guessing attacks.
    - Action:
      - Add a short subsection that references Keycloak’s brute-force protection (z. B. `KC_SPI_BRUTE_FORCE_*`), the expected defaults für GUSTAV, und wie das mit Self-Service-Reset und Remember-me zusammenspielt.
  - [TEST] Assert remember-me checkbox is not pre-checked
    - Finding:
      - Docs state that the checkbox is not preselected by default, but no test enforces this.
    - Risk:
      - A future theme change could accidentally add `checked` and violate the safe default on shared devices.
    - Action:
      - Extend `test_login_has_conditional_remember_me_checkbox` (or add a dedicated test) to assert that:
        - The rendered checkbox snippet does not contain `checked`.
  - [TEST] Strengthen CSS hook coverage for update-password templates
    - Finding:
      - Tests assert presence of the update-password templates but not their CSS hooks.
    - Risk:
      - Layout regressions on the reset page might go unnoticed.
    - Action:
      - Add tests that read `update-password.ftl` / `login-update-password.ftl` and assert presence of the key CSS classes used by the login page (`kc-card`, `kc-title`, `kc-form`, `kc-label`, `kc-input`, `kc-submit`, `kc-message`).
  - [CONSISTENCY] Align verifyEmail docstring with current realm behavior
    - Finding:
      - `test_realm_requires_email_verification_and_email_theme` docstring still describes `verifyEmail=true` as behavior, but the assertion enforces `verifyEmail=false`.
    - Risk:
      - Future maintainers may misinterpret whether email verification is required or intentionally disabled.
    - Action:
      - Either:
        - Update the docstring to explicitly describe the current transitional configuration (verifyEmail disabled, IdP responsible, GUSTAV does not enforce).
      - Or:
        - Change the realm export and assertion if/when the project decides to require email verification by default (and update docs accordingly).
  - [TEST] Specify a minimal functional contract for the update-password templates
    - Finding:
      - Tests currently only check the existence of the update-password templates and (via CSS hooks) their styling, but not the semantic structure.
    - Risk:
      - A regression could remove or rename one of the password fields or the submit button without failing tests.
    - Action:
      - Extend tests to assert that the update-password templates contain:
        - A title referencing `updatePasswordTitle` / `doResetPassword`,
        - Two password fields (password + confirmation),
        - A submit button and a link back to the login page.
- Nice-to-Have
  - [DOC] Update status in the Keycloak login theme plan & tickets
    - Finding:
      - The plan and tickets still mark the reset/remember-me theme work as “open”, although a first implementation is in place.
    - Risk:
      - Confusion in issue tracking and planning; reviewers may duplicate investigations.
    - Action:
      - Update `docs/plan/2025-11-30-keycloak-login-theme-reset-and-remember-me.md` status to reflect that RED + initial GREEN are done, with remaining TODOs (tests, security tweaks).
      - Adjust ticket statuses in:
        - `docs/tickets/keycloak-password-reset-page-not-themed.md`
        - `docs/tickets/keycloak-remember-me-login-theme.md`
      - Link this PR-fix plan from those tickets for traceability.

  - [CONSISTENCY] Avoid silent drift between `update-password.ftl` and `login-update-password.ftl`
    - Finding:
      - Both templates are currently identical copies with no explicit guardrail to keep them in sync.
    - Risk:
      - Future edits may accidentally update only one file, causing inconsistent UX depending on which template Keycloak uses.
    - Action:
      - Add a prominent comment at the top of both files indicating that they must stay semantically identical, or refactor to a single source (e.g. include mechanism or documented symlink) if feasible.
  - [DOC] Make remember-me semantics more accessible for non-developers
    - Finding:
      - The remember-me section is text-heavy and may be hard to parse for non-technical stakeholders.
    - Risk:
      - Misunderstandings about the difference between IdP-session TTL and app-session TTL could lead to incorrect support expectations.
    - Action:
      - Add a small visual element (e.g. a simple flow diagram or timeline) to illustrate IdP session vs. app session and where remember-me has an effect.

Next Steps / Checklist
- [ ] Restrict `webOrigins` in `keycloak/realm-gustav.json` to explicit origins and document the pattern.
- [ ] Add or extend tests:
  - [ ] Ensure remember-me checkbox is rendered without `checked` by default.
  - [ ] Verify update-password templates contain the same CSS hooks as `login.ftl`.
  - [ ] Define and test a minimal semantic contract for the update-password templates (titles, two password fields, submit button, login link).
- [ ] Clarify `verifyEmail` semantics:
  - [ ] Align docstring in `test_realm_requires_email_verification_and_email_theme` with the chosen realm configuration and user-management docs.
- [ ] Synchronise documentation:
  - [ ] Update status sections in `docs/plan/2025-11-30-keycloak-login-theme-reset-and-remember-me.md`.
  - [ ] Adjust Keycloak theme tickets to reference this plan and the implemented changes.
  - [ ] Align the password-reset documentation in `docs/references/user_management.md` with the current realm configuration around `resetPasswordAllowed` and describe the intended self-service vs. admin-reset split.
  - [ ] Add a short subsection on Keycloak’s brute-force / rate-limiting configuration and its expected defaults for GUSTAV, especially in the context of self-service reset and remember-me.
  - [ ] Add comments or a small structural guardrail to keep `update-password.ftl` and `login-update-password.ftl` semantically in sync.
  - [ ] Consider adding a simple diagram or visual element to the remember-me section to make IdP-session vs. app-session semantics easier to grasp for non-developers.
