# PR-Fix: Contract- und Konsistenznotizen (Teaching Detail / Lern-History)

**Datum:** 2025-12-04  
**Autor:** Codex (Review)  
**Kontext:** Review-Findings zu aktuellem PR (Teaching Live Detail Tabs, Feedback/Auswertung UI)

## Hauptbefund (API-Contract)
- `analysis_json` wird in der Teaching-Latest-Detail-API aktuell als freies Dict mit `summary` ausgeliefert.
- Der OpenAPI-Contract fordert `oneOf: AnalysisJsonCriteriaV1 | AnalysisJsonCriteriaV2` (jeweils `schema` + `criteria_results`).
- Risiko: Client-Parser, die auf `schema`/Kriterien vertrauen, brechen; Spezifikationsverletzung.
- Fix-Optionen:
  1) Server transformiert/validiert `analysis_json` auf criteria.v1/v2 (inkl. `schema`-Feld) bevor es in die Payload gelangt.
  2) Alternativ: Contract erweitern (neues Schema mit `summary`), Tests/Spec synchron halten. (Bevorzugt Option 1 für Konsistenz.)

## Entscheidung: `analysis_json`-Contract (Option 1)
- Entscheidung: Wir halten den bestehenden OpenAPI-Contract bei, d.h. `TeachingLatestSubmission.analysis_json` bleibt strikt `oneOf: AnalysisJsonCriteriaV1 | AnalysisJsonCriteriaV2` mit `schema` + `criteria_results`.
- Server-Verhalten:
  - Die Backend-Schicht (Use-Case + Web-Adapter) transformiert/validiert jedes vorhandene Analyseformat vor dem Response in eines der Kriterien-Schemata (criteria.v1/v2).
  - Freiform- oder `summary`-Varianten werden als interne Repräsentation behandelt und vor Auslieferung in strukturierte Kriterien überführt; sie tauchen nicht mehr „roh“ im API-Contract auf.
- Begründung (aspektreich):
  - API-Design: Der Contract bleibt schlank und stark typisiert – „Auswertung = Kriterien-JSON“. Clients können sich überall auf `schema` + `criteria_results` verlassen.
  - Domain/Glossary: Passt zur Fachsprache („Auswertung“ = Kriterien-Auswertung). Narrative Elemente oder Zusammenfassungen werden aus den Kriterien abgeleitet, nicht als eigener Contract-Typ etabliert.
  - Clients/SSR: UI und Analytics können generisch über Kriterien iterieren (z.B. Karten pro Kriterium), ohne Sonderpfade für „summary-only“-Fälle. Evtl. bestehende `summary`-Darstellungen werden künftig aus `criteria_results` abgeleitet.
  - Governance/Lehrbarkeit: Stützt die Prinzipien „Contract-first“ und „Clean Architecture“ – gute Lernvorlage, weil Domain-Modell und API-Vertrag konsistent bleiben.
- Umsetzungshinweise:
  - Kurzfristig: Transformations-/Validierungs-Layer definieren, der aus alt/alternativ gespeicherten Analyseformen ein gültiges `AnalysisJsonCriteriaV1|V2` erzeugt; dazu gezielte TDD-Tests (Input-Format → erwartete Kriterien-Struktur).
  - Mittelfristig: Persistierte Alt-Daten (falls nur `summary`) per Migration/Script in ein Kriterien-Schema überführen, sodass die DB-Daten langfristig bereits criteria.v1/v2-konform sind.
  - Langfristig: Neue Analysepipelines (Ollama + DSPy) sollen direkt criteria.v1/v2 erzeugen, damit kein zusätzlicher Mapping-Schritt mehr nötig ist.

## Sekundäre Befunde
- `files[].size` wird als `None` serialisiert, obwohl OpenAPI `integer` verlangt. → Immer Integer liefern oder Spec anpassen.
- UI-Dopplung: SSR zeigt Tabs („Auswertung“) und zusätzlich ein Accordion innerhalb des Feedback-Tabs. Laut Plan sollte Auswertung wahlweise als Tab (Lehrkraft) oder als Accordion im Feedback-Block (Schüler) erscheinen – nicht beides parallel. → Struktur glätten.
- Fallback-Pfad der Teaching-Detail-API (defensiver DB-Fallback) liefert aktuell nur Kernfelder + `files`, aber kein `feedback_md`/`analysis_json`, obwohl der Contract diese Felder vorsieht. → Verhalten explizit entscheiden und dokumentieren.
- Plan `2025-12-03-teaching-live-detail-tab.md` beschreibt einen Fallback `text_body ← analysis_json.text`, der im aktuellen Code nicht umgesetzt ist. → Plan oder Implementierung harmonisieren.
- Glossary-Terminologie „Auswertung“ (criteria-JSON) vs. „Rückmeldung“ (feedback_md) ist korrekt, wird in Code-Kommentaren aber noch nicht explizit referenziert. → Kurzkommentar/Doc-Verweise ergänzen.

## Entscheidung: `files[].size`
- Entscheidung: Der OpenAPI-Contract bleibt strikt – `TeachingLatestSubmission.files[].size` ist ein nicht-null `integer` und wird **nicht** auf `nullable` erweitert.
- Server-Verhalten:
  - Beim Bauen der `files[]`-Struktur wird für jede Datei die tatsächliche Byte-Größe aus dem Storage/Metadata ermittelt und als Integer gesetzt.
  - Falls für eine Datei keine verlässliche Größe bestimmt werden kann, wird diese Datei im API-Response nicht in `files[]` aufgenommen (oder der gesamte Request wird als Fehler behandelt – genaue Strategie wird im Implementierungsplan konkretisiert, aber `size = null` ist kein zulässiger Zustand).
- Begründung:
  - API-Design: Clients dürfen sich darauf verlassen, dass jede ausgelieferte Datei eine valide Größe besitzt; der Datentyp bleibt einfach und klar.
  - Domain/UX: Für Lehrkräfte/Schüler ist „Datei mit bekannter Größe“ ein intuitiver Zustand; „Größe unbekannt“ stiftet eher Verwirrung und bringt keinen Mehrwert in der UI.
  - Governance/Lehrbarkeit: Stützt das Prinzip „Implementierung erfüllt den Vertrag“ statt „Vertrag wird an Implementierung angepasst“ – gutes Lernbeispiel für typisierte API-Designs.
- Umsetzungshinweise:
  - Kurzfristig: Codepfade identifizieren, in denen `files[].size` als `None` landet, und diese so korrigieren, dass entweder die Größe korrekt nachgeladen oder die Datei gar nicht erst in `files[]` aufgenommen wird.
  - Mittelfristig: Tests ergänzen (API und ggf. SSR), die sicherstellen, dass `files[].size` immer ein Integer ≥ 0 ist und niemals `null` serialisiert wird.
  - Langfristig: Bei neuen Storage-/Bucket-Funktionen konsequent darauf achten, dass Dateigrößen Teil der domänenseitig verfügbaren Metadaten sind, sodass spätere Features auf denselben Vertrag aufbauen können.

## Entscheidung: UI „Auswertung“-Tab vs. Accordion
- Entscheidung: Es gibt keine gleichzeitige Darstellung eines „Auswertung“-Tabs **und** eines Auswertungs-Accordions im Feedback-Tab. Die Darstellung hängt klar von der Rolle ab:
  - Lehrkraft-Ansicht (Teaching-Detail/SSR): „Auswertung“ erscheint als eigener Tab neben z.B. „Datei“ und „Rückmeldung“. Innerhalb dieses Tabs gibt es **kein** zusätzliches Accordion für Auswertung.
  - Schüler-Ansicht: „Auswertung“ wird als Accordion/Klappbereich **innerhalb** des Feedback-Blocks („Rückmeldung“) dargestellt; es existiert **kein** separater „Auswertung“-Tab.
- Begründung:
  - UX/Klarheit: Vermeidet doppelte und widersprüchliche Darstellungen der gleichen Information. Lehrkräfte bekommen eine klar getrennte Sicht auf Lösung, Rückmeldung und Auswertung; Schüler sehen Auswertung im Kontext der Rückmeldung.
  - Glossary-Konsistenz: „Auswertung“ (criteria-JSON) und „Rückmeldung“ (`feedback_md`) werden in der UI klar auseinandergehalten – Tabs/Accordion spiegeln diese Trennung wider, ohne sie zu duplizieren.
  - Lehrbarkeit/Tests: Die Rollentrennung (Lehrkraft vs. Schüler) ist explizit und lässt sich in SSR-Tests gut ausdrücken („…wie lehrkraft“ / „…wie schueler“), was das Verhalten für Lernende nachvollziehbar macht.
- Umsetzungshinweise:
  - SSR-Routing/Context muss eindeutig bestimmen, ob es sich um eine Lehrkraft- oder Schüler-Ansicht handelt, und entsprechend genau eine der beiden Darstellungsvarianten aktivieren.
  - Bestehende Tests und UI-Komponenten sind so anzupassen, dass sie keine Kombination aus Tab + Accordion mehr erwarten, sondern jeweils nur die passende Variante pro Rolle.
  - Negativfall: Wenn keine Kriterien (`analysis_json.criteria_results`) vorhanden sind, bleibt der Tab/Accordion sichtbar, zeigt aber einen klaren Platzhalter („Noch keine Auswertung verfügbar“), keine leeren Karten.

## Entscheidung: Fallback-Verhalten Teaching-Detail-API
- Entscheidung: Der defensive Fallback-Pfad der Teaching-Detail-API liefert weiterhin ein möglichst vollständiges Domain-Objekt. Insbesondere werden `feedback_md` und `analysis_json` auch im Fallback aus der DB geladen und im `TeachingLatestSubmission`-Response ausgeliefert. Der Fallback degradiert nur die Dateiseite (`files[]`), nicht die fachliche Information.
- Server-Verhalten:
  - Normalpfad: Verwendet `get_latest_submission_for_owner` inkl. `feedback_md`/`analysis_json` und ergänzt `files[]` via Storage/Bucket + Presigns.
  - Fallbackpfad: Nutzt denselben DB-Row-Typ (`get_latest_submission_for_owner`) und denselben Mapping-Pfad für `feedback_md`/`analysis_json`, lässt aber `files[]` leer oder reduziert (z.B. ohne Presigns), wenn Storage/Adapter nicht verfügbar ist.
- Begründung:
  - Contract-Stabilität: `TeachingLatestSubmission` bleibt als Domain-Typ konsistent – Feedback und Auswertung sind vorhanden, sobald die DB erreichbar ist und fachlich Daten vorliegen, unabhängig vom Zustand des Storages.
  - Domain-/UX-Gedanke: Feedback/Auswertung gehören zur Submission, nicht zum Storage. Lehrkräfte sollen Rückmeldung und Kriterien-Auswertung auch dann sehen können, wenn Dateianhänge temporär nicht geladen werden können.
  - Lehrbarkeit/Governance: Gutes Beispiel für „graceful degradation“ der Infrastruktur (Storage) bei stabiler Domain-Schicht – illustriert Clean-Architecture-Denken für Lernende.
- Umsetzungshinweise:
  - Fallback-Implementierung so anpassen, dass sie die gleiche Mapping-Funktion von DB-Row → `TeachingLatestSubmission` nutzt wie der Normalpfad, lediglich mit abweichender/fehlender `files[]`-Befüllung.
  - Im OpenAPI-Contract und in der Routen-Dokumentation explizit erwähnen, dass im Fallback nur `files[]` degradiert werden kann (z.B. leer), `feedback_md`/`analysis_json` aber nach Möglichkeit unverändert geliefert werden.
  - Tests ergänzen, die beide Pfade abdecken: Normalpfad mit vollständigen Dateien und Fallbackpfad ohne/mit reduzierten Dateien, aber identischem `feedback_md`/`analysis_json` für dieselbe Submission.

## Klarstellung: Kein Fallback `text_body ← analysis_json.text`
- Hintergrund: Im Plan `2025-12-03-teaching-live-detail-tab.md` wurde ein Fallback „leeres `text_body` → nutze `analysis_json.text`“ skizziert. Im aktuellen Verständnis des Systems ist dieser Punkt obsolet.
- Invariante:
  - `analysis_json` entsteht fachlich aus der ursprünglichen Schülerlösung (`text_body` bzw. der aus der Einreichung extrahierten Textrepräsentation).
  - Daraus folgt: Wenn `analysis_json` vorliegt, muss auch ein passendes `text_body` vorhanden sein. Ein Zustand „`analysis_json` vorhanden, `text_body` leer“ gilt als Bug in Pipeline/Persistenz, nicht als regulärer Fall.
- Konsequenz:
  - Es wird **kein** API-Fallback `text_body ← analysis_json.text` im Teaching-Detail-Endpunkt implementiert.

## Umsetzungsscope und betroffene Dateien
Zur vollständigen Umsetzung der obigen Entscheidungen werden voraussichtlich folgende Dateien angepasst (inkl. grober Umfangsschätzung):

- API-Contract und Referenzen
  - `api/openapi.yml` (Schema `TeachingLatestSubmission`, `AnalysisJsonCriteriaV1/V2`) — **klein**  
    - Review/Feinschliff der Beschreibungen; sicherstellen, dass `analysis_json`-Beschreibung die Kriterien-Schemata und die neue Fallback-Semantik (nur `files[]` degradiert) korrekt widerspiegelt.
  - `docs/references/teaching_live.md` — **klein**  
    - Referenztext zur Teaching-Live-Detail-Route an die finale Contract-Semantik anpassen (Auswertung = criteria-JSON, Rückmeldung = `feedback_md`, Fallback nur bei Dateien).

- Backend-API (Teaching-Detail-Endpoint)
  - `backend/web/routes/teaching.py` (Funktion `get_latest_submission_detail`) — **mittel bis groß**  
    - Einführung eines Mapping-/Helperpfads von DB-Row → `TeachingLatestSubmission`-Payload:
      - `analysis_json`: Transformation/Validierung auf `AnalysisJsonCriteriaV1|V2` (insb. Alt-Formate wie `{"summary": ...}` → criteria.v1/v2 oder klarer Fehler).
      - `files[]`: `size` immer als Integer befüllen (und Dateien mit fehlender Größe ggf. ausfiltern).
    - Normalpfad und Fallbackpfad auf diesen gemeinsamen Mapper umstellen, sodass `feedback_md`/`analysis_json` sowohl im Normal- als auch im Fallbackpfad konsistent geliefert werden und nur `files[]` degradiert.

- SSR-Ansicht für Lehrkräfte (Tabs/Feedback/Auswertung)
  - `backend/web/main.py` (Funktion `teaching_unit_live_detail_partial` + Render-Helper) — **mittel**  
    - Tabs so anpassen, dass die Lehrkraft-Ansicht die beschlossene Struktur nutzt:
      - Eigene Tabs für „Text“, „Datei“ (bei Datei-Submission), „Auswertung“, „Rückmeldung“.
      - Kein zusätzliches „Auswertung anzeigen“-Accordion im Feedback-Tab der Lehrkraft (Auswertung wird im Auswertungs-Tab gerendert).
    - Anzeige der Dateigröße robust machen (`file_size` als Integer, sinnvolle Darstellung nur bei vorhandener Größe).
  - `backend/tests/test_teaching_live_detail_ssr.py` — **mittel**  
    - Erwartungen in den SSR-Tests an die neue Tab- und Inhaltstruktur anpassen:
      - `test_detail_partial_file_submission_shows_text_and_file_tab` ggf. um Assertions zur Dateigröße ergänzen.
      - `test_detail_partial_shows_rueckmeldung_und_auswertung_wie_schueler` so anpassen, dass es die getrennten Tabs (ohne Accordion im Lehrkraft-View) prüft.

- Teaching-Detail-API-Tests
  - `backend/tests/test_teaching_live_detail_api.py` — **mittel**  
    - `files[]`-Assertions erweitern (z. B. sicherstellen, dass `size` immer ein Integer ist).  
    - `test_latest_detail_includes_feedback_and_analysis` so umbauen, dass:
      - Entweder bereits criteria.v1/v2-konformes `analysis_json` inseriert wird und die API dieses unverändert durchreicht, oder
      - gezielt ein Altformat (z. B. mit `summary`) inseriert wird und der Test die Transformation auf criteria.v1/v2 prüft (inkl. `schema` + `criteria_results`).
  - `backend/tests/test_openapi_teaching_live_detail_contract.py` — **klein**  
    - Voraussichtlich nur Review/Kommentar; die Schema-Referenz auf `TeachingLatestSubmission` bleibt bestehen.

- Learning-/Worker-Seite und Migrationen (optional / mittelfristig)
  - `backend/learning/adapters/dspy/feedback_program.py` u. ä. — **klein bis mittel (Review)**  
    - Sicherstellen, dass alle Feedback-/Kriterien-Pfade bereits criteria.v2-konformes `analysis_json` erzeugen (kein neues Summary-Format). Anpassungen nur, falls Altpfade entdeckt werden.
  - `supabase/migrations/*` (neue Migration) — **klein bis mittel (optional)**  
    - Nur falls historisch summary-basierte `analysis_json`-Daten in der DB vorhanden sind und in einem eigenen Schritt nach criteria.v1/v2 migriert werden sollen.

- Schüler-UI (Verifikation)
  - `backend/tests/test_learning_ui_student_submissions.py` — **klein (voraussichtlich nur Verifikation)**  
    - Sicherstellen, dass die bestehende Schüleransicht (Feedback-Block mit „Auswertung anzeigen“-Accordion) unverändert funktioniert; Änderungen nur nötig, falls zentrale Bezeichner/Markup angepasst werden.

- Dokumentation / Glossar / ältere Pläne
  - `docs/ARCHITECTURE.md`, `docs/bounded_contexts.md`, `docs/glossary.md` — **klein**  
    - Kurze Ergänzungen, die das Mapping Domain-Begriff → API-Feld festhalten:
      - „Auswertung“ → `analysis_json` (criteria.v1/v2),  
      - „Rückmeldung“ → `feedback_md`,  
      - Teaching-Live-Detail-Ansicht als UI, die strikt auf dem `TeachingLatestSubmission`-Contract aufsetzt.
  - `docs/plan/2025-12-03-teaching-live-detail-tab.md` — **klein**  
    - Markieren, dass der dort skizzierte Fallback `text_body ← analysis_json.text` obsolet ist (Verweis auf dieses PR-Fix-Dokument), sodass Plan und aktuelle Entscheidung konsistent bleiben.

## Nächste Schritte (empfohlen)
1) API: Schema-konformes `analysis_json` liefern (criteria.v1/v2) und Tests ergänzen, die `schema` erzwingen.
2) Dateien: Codepfade korrigieren, die `files[].size = None` produzieren, so dass `files[].size` immer ein Integer ist; Regressionstest hinzufügen.
3) SSR/UI: Erwartetes Layout festlegen (Tab vs. Accordion) und Tests entsprechend anpassen.
4) Fallback-Verhalten: Fallback-Implementierung auf das beschlossene Verhalten umbauen (vollständiges Domain-Objekt mit `feedback_md`/`analysis_json`, nur `files[]` ggf. degradiert) und API-Contract/Routendokumentation entsprechend schärfen.
5) Tests erweitern: 
   - Teaching-Detail-API: `files[]`-Struktur (nicht nur Existenz, sondern auch `mime`, nicht-null `size`, URI-förmige `url`) prüfen.
   - UI/SSR: Negativfall „keine Kriterien → Auswertung-Tab/-Bereich zeigt nur Platzhaltertext, keine Karten“ abdecken.
6) Dokumentation: Plan-Dokumente (`2025-12-03-teaching-live-detail-tab.md`, UI-Leitfaden) und Glossary explizit mit der implementierten Semantik verknüpfen (Auswertung = criteria-json, Rückmeldung = feedback_md).

## Zusätzlicher Kontext
- Migration `20251203120000_teaching_latest_submission_owner_extend_feedback.sql` erweitert `get_latest_submission_for_owner` um `feedback_md`/`analysis_json`. Alle Call-Sites müssen den neuen Row-Typ konsumieren (keine alten Signaturen mehr).
- OpenAPI-Änderung: `TeachingLatestSubmission` beschreibt `analysis_json` explizit als criteria.v1/v2; außerdem Beschreibung für `text_body`/`files` präzisiert. Client-Updates prüfen.
- Tests hinzugekommen: 
  - API: `test_latest_detail_includes_text_and_files_for_pdf_submission`, `test_latest_detail_includes_feedback_and_analysis` (fordern `feedback_md`/`analysis_json`).
  - SSR: Tabs für Datei/Feedback/Auswertung (`test_detail_partial_file_submission_shows_text_and_file_tab`, `test_detail_partial_shows_rueckmeldung_und_auswertung_wie_schueler`).
  - Lern-UI: History-Accordion (`test_ui_history_feedback_wraps_collapsible_analysis_toggle` u.a.). Diese Tests müssen nach Contract-Fix weitergrün bleiben.
- Storage: Teaching-Detail nutzt Submissions-Bucket via `get_submissions_bucket()` + Presign. Falls Adapter fehlt/fällt, fällt der API-Code auf minimalen Pfad ohne Feedback/Analysis zurück (siehe defensive Fallback). Konsistenz der Presigns/TLL berücksichtigen und klar dokumentieren, welche Felder im Fallback garantiert sind (Kernfelder + optional `files`, aber kein Feedback/Analysis) – oder Fallback mittelfristig an den Contract angleichen.

## Referenzen
- api/openapi.yml: Komponenten `TeachingLatestSubmission.analysis_json`, `files[].size`.
- backend/web/routes/teaching.py: Payload-Building für latest detail (feedback/analysis/files).
- backend/web/main.py: SSR-History/Detail Rendering mit Accordion/Tab-Logik.
