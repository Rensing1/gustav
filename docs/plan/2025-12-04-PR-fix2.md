# PR-Fix 2: Review-Notizen zum aktuellen Teaching-Live-Detail-PR

**Datum:** 2025-12-04  
**Autor:** Codex (Review)  
**Kontext:** Zweite Review-Runde zum PR „Teaching Live Detail Tabs, Feedback/Auswertung UI & Contract-Fix“ auf Basis des Diffs `700f88a5f9e5dede961579f3c887ac18ab7e2764...32384c753a899d361ba98ed8cc25d148f34bee81`.

Ziel dieses Plans ist es, die zusätzlichen Review-Befunde kompakt, aber nachvollziehbar zu dokumentieren, die über `docs/plan/2025-12-04-PR-fix.md` hinausgehen – insbesondere zu Fallback-Verhalten, UI-Fallback und Dokumentationskonsistenz.

---

## 1. Kurzer Überblick über die Änderungen im PR

Relevant sind u.a. folgende Dateien:

- `api/openapi.yml`
  - Schema `TeachingLatestSubmission` präzisiert:
    - `text_body`: jetzt explizit als Best-Effort-Textrepräsentation auch für Datei-/Bild-/PDF-Abgaben beschrieben.
    - `files[]`: klarer Contract für `mime`, **integer** `size`, `url`; Beschreibung für signierte, kurzlebige URLs.
    - `feedback_md` / `analysis_json`: explizit als Rückmeldung (Markdown) und strukturierte Kriterien-Auswertung (criteria.v1/v2) beschrieben.

- `backend/web/routes/teaching.py`
  - Neue Hilfsfunktionen:
    - `_normalise_analysis_json(...)`: vereinheitlicht `analysis_json` auf criteria.v1/v2 (inkl. Mapping von Legacy-Formaten mit `summary`/`criteria` zu `criteria.v2`).
    - `_build_latest_submission_payload(...)`: bündelt die Übersetzung eines DB-Rows in das `TeachingLatestSubmission`-Payload inkl.:
      - Normalisierung von `kind` (`file` + PDF → `pdf`),
      - Kürzung von `text_body`,
      - Anhängen von `feedback_md` und normalisiertem `analysis_json`,
      - optionalem Aufbau von `files[]` mit integer `size` und signierten URLs aus dem Submissions-Bucket (`get_submissions_bucket()`).
  - Route `get_latest_submission_detail(...)` (Teaching-Detail-API) nutzt oben genannte Hilfsfunktionen und:
    - prüft Ownership + Kurs/Unit/Task-Relation,
    - greift primär auf den SECURITY-DEFINER-Helper `get_latest_submission_for_owner(...)` zu (erweiterter Rückgabetyp mit `feedback_md`/`analysis_json`),
    - besitzt einen defensiven Fallback direkt auf `public.learning_submissions` mit gleicher Payload-Form, aber `include_files=False`.

- `supabase/migrations/20251203120000_teaching_latest_submission_owner_extend_feedback.sql`
  - Erweitert `get_latest_submission_for_owner(...)` um `feedback_md` und `analysis_json` in der Row-Signatur, so dass Teaching-Detail alle für die Tabs benötigten Daten aus einem Helper erhält.

- `backend/web/main.py`
  - Lern-UI (History):
    - `_build_history_entry_from_record(...)` rendert jetzt:
      - „Deine Antwort“ (Text oder extrahierter Text),
      - einen Rückmeldungsblock mit Überschrift „Rückmeldung“,
      - **ein `<details>`/`<summary>`-Accordion „Auswertung anzeigen“**, das bei vorhandenen Kriterien die bereits etablierten Kriterienkarten (`_render_analysis_criteria_section`) einbettet.
    - Falls zwar Kriterien, aber kein `feedback_md` existieren, wird nur ein Accordion mit „Auswertung anzeigen“ gerendert (kein Rückmeldungsblock).
  - Teaching-Live-Detail (SSR):
    - `teaching_unit_live_detail_partial(...)` baut jetzt eine Karte mit **Tabs**:
      - Tab „Text“ (immer vorhanden, zeigt `text_body` in einem eingerahmten Block `submission-body`),
      - Tab „Datei“ (für `kind != "text"`, zeigt Bild-/PDF-Vorschau oder Download-Link plus Bytes-Anzeige),
      - Tab „Auswertung“ (bei vorhandenen Kriterien, zeigt Kriterien-Karten via `_render_analysis_criteria_section`),
      - Tab „Rückmeldung“ (bei vorhandenem `feedback_md`, ohne Accordion – die Auswertung ist hier ein eigener Tab).

- `backend/web/static/css/gustav.css`
  - Ergänzte Styles:
    - `.analysis-feedback__*` für das Accordion in der Lern-Ansicht.
    - `.tab-header`, `.tab-btn`, `.tab-panels`, `.tab-panel[hidden]`, `.submission-body`, `.submission-preview` für die Teacher-Tabs im Live-Detail.

- Tests
  - `backend/tests/test_learning_ui_student_submissions.py`:
    - Neue Tests für das Verhalten des Accordions:
      - `test_ui_history_feedback_wraps_collapsible_analysis_toggle`
      - `test_ui_history_hides_analysis_toggle_when_no_criteria`
      - `test_ui_history_shows_collapsible_analysis_even_without_feedback`
  - `backend/tests/test_teaching_live_detail_api.py`:
    - `test_latest_detail_includes_text_and_files_for_pdf_submission`
    - `test_latest_detail_includes_feedback_and_analysis`
    - `test_latest_detail_includes_integer_file_size_for_pdf_submission`
    - `test_latest_detail_omits_files_when_size_unknown`
  - `backend/tests/test_teaching_live_detail_ssr.py`:
    - `test_detail_partial_file_submission_shows_text_and_file_tab`
    - `test_detail_partial_shows_rueckmeldung_und_auswertung_wie_schueler`

---

## 2. Review-Befunde (ergänzend zu PR-fix.md)

Die folgenden Punkte sind Ergänzungen zur ersten Fix-Analyse (`2025-12-04-PR-fix.md`) und fokussieren auf Konsistenz (Contract, Doku, Fallback), Robustheit und UI-Fallback.

### 2.1 API-Contract & Fallback-Verhalten

**Befund A – Doku vs. Implementierung (DB-Fallback im Teaching-Detail)**  

- Doku (`docs/references/teaching_live.md:54-71`):
  - Beschreibt den Teaching-Detail-Endpunkt mit Fokus auf die SECURITY-DEFINER-Helper (`get_unit_latest_submissions_for_owner`, `get_latest_submission_for_owner`).
  - Formuliert u.a.: „Kein direkter Tabellen-Fallback.“ (im Abschnitt „DB & RLS“).
- Implementierung (`backend/web/routes/teaching.py:4156-4332`):
  - Primärpfad: Nutzung des Helpers `get_latest_submission_for_owner(...)` mit Owner-/Relation-Checks.
  - Defensiver Fallback:
    - Bei Fehlern im Helper-Pfad (z.B. während Migration) wird direkt auf `public.learning_submissions` zugegriffen,
    - liefert aber **das gleiche Payload-Format** (inkl. normalisiertem `analysis_json` und `feedback_md`), lediglich ohne `files[]` (`include_files=False`).

**Einschätzung (Konsistenz & Sicherheit):**

- Der Fallback ist vertretbar, weil:
  - Er erfolgt nur nach erfolgreicher Owner-/Relation-Prüfung,
  - `set_config('app.current_sub', ...)` wird weiterhin gesetzt, d.h. RLS bleibt aktiv.
- Der Satz „Kein direkter Tabellen-Fallback“ ist in dieser Form nicht mehr korrekt und könnte Leser:innen verwirren.

**Empfohlener Fix (Doku):**

- `docs/references/teaching_live.md` präzisieren:
  - Klarstellen, dass:
    - im Normalfall ausschließlich die Helper benutzt werden,
    - in seltenen Fehlerszenarien ein **defensiver Fallback** existiert, der aber:
      - unverändert Owner-/Relation-Checks respektiert,
      - RLS über `app.current_sub` beibehält,
      - die Domain-Felder (`text_body`, `feedback_md`, `analysis_json`) vollständig liefert,
      - nur `files[]` degradieren kann (leer/fehlend).

---

**Befund B – `files[]`-Semantik bei fehlender Größe**

- Contract (`api/openapi.yml:985ff.`):
  - `TeachingLatestSubmission.files[]` mit `mime: string`, `size: integer` (nicht nullable), `url: uri`.
- Implementierung (`backend/web/routes/teaching.py:4082-4118`):
  - `files` wird nur gesetzt, wenn:
    - `include_files=True`,
    - `kind ∈ {"file","pdf","image"}`,
    - `storage_key` vorhanden,
    - presigned URL erfolgreich und `size_bytes` sinnvoll in Integer konvertierbar ist.
  - Sonst:
    - kein Eintrag oder `files` ganz weggelassen.
- Tests:
  - `test_latest_detail_includes_integer_file_size_for_pdf_submission`
  - `test_latest_detail_omits_files_when_size_unknown`

**Einschätzung (Konsistenz):**

- Das Verhalten ist konsistent mit dem Contract:
  - Wenn `files[]` existiert, ist `size` immer ein Integer.
  - Wenn die Größe nicht bestimmt werden kann (`size_bytes` NULL oder nicht parsebar), wird kein invalides Objekt mit `size = null` erzeugt.
- Kleinere Inkonsistenz:
  - Im „Happy Path“ wird `files` gesetzt (z.B. `[ {...} ]`),
  - im Fehlerfall fehlt `files` in der Payload komplett (statt `files: []`).

**Empfohlener Fix (optional, Konsistenz):**

- `_build_latest_submission_payload(...)` so anpassen, dass:
  - Bei `include_files=True`, aber ohne gültige Datei, explizit `files: []` gesetzt wird,
  - Clients dadurch nicht unterscheiden müssen zwischen „keine Dateien“ und „Feld fehlt“.
- Doku (`docs/references/teaching_live.md`) beschreibt bereits:
  - „`files[]`: Enthält Original-Uploads …; wenn die Größe nicht zuverlässig ermittelt werden kann, wird die Datei nicht in `files[]` aufgenommen.“
  - Diese Formulierung ist kompatibel mit `files: []` und sollte beibehalten werden.

---

### 2.2 Lern-UI-History: Fallback-TaskCards & offene Attempts

**Befund C – History-Fallback für Lerneinheiten (SSR)**  

- Kontext: `backend/web/main.py` – Route für die Lerneinheiten-Detailseite:
  - Normalfall:
    - Sections/Tasks kommen aus der Learning-API und enthalten pro Aufgabe einen History-Placeholder mit:
      - `id="task-history-{task_id}"`,
      - `class="task-panel__history"`,
      - `data-open-attempt-id="..."`,
      - `hx-vals='{"open_attempt_id": "..."}'`,
      - `hx-on="toggle: window.gustav && window.gustav.handleHistoryToggle(event, this)"`.
    - JS (`gustav.js`) aktualisiert `data-open-attempt-id` und `hx-vals`, um beim Polling den aktuell geöffneten Versuch stabil zu halten.
  - Fallback:
    - Wenn die Learning-API gar keine Sections/Tasks liefern konnte (`parts` leer), werden Tasks aus dem Teaching-Repo rekonstruiert:
      - TaskCards mit demselben Formular-Contract (`_build_task_submit_form_html`),
      - ein History-Placeholder pro Task, der lazy nachlädt.

- Implementierungsdetail im Fallback (`backend/web/main.py:1500-1506`):
  - Der Placeholder nutzt aktuell:
    - `data-open_attempt_id="{...}"` (Unterstrich),
    - kein `hx-on="toggle: window.gustav && window.gustav.handleHistoryToggle(...)"`.

**Einschätzung (Robustheit & Konsistenz):**

- Funktional:
  - Der Fallback stellt sicher, dass auch ohne Learning-API eine TaskCard + History-Loader existiert – gut für Dev/Test.
- Konsistenzproblem:
  - Attributname unterscheidet sich (`data-open_attempt-id` vs. `data-open_attempt_id`),
  - `handleHistoryToggle(...)` wird nicht gebunden, d.h. der „offene Versuch“ wird im Fallback nicht persistiert.

**Empfohlene Fixes:**

1. Attributname vereinheitlichen:
   - Im Fallback ebenfalls `data-open-attempt-id="..."` verwenden.
2. `hx-on`-Handler ergänzen:
   - Auch im Fallback:
     - `hx-on="toggle: window.gustav && window.gustav.handleHistoryToggle(event, this)"` setzen.
3. Ggf. einen kleinen zusätzliche Testfall ergänzen:
   - Der aber vermutlich schwierig nachzustellen ist, weil er ein gezielt „kaputtes“ Learning-API-Setup voraussetzt.
   - Alternativ: Kommentar im Code, der den Fallback als „best-effort for Dev/Test“ kennzeichnet.

---

### 2.3 Doku-Synchronisation & Begriffe

**Befund D – Teaching-Live-Doku vs. implementierte Fallback-Strategie**

- `docs/references/teaching_live.md` wurde bereits erweitert:
  - Semantik-Sektion beschreibt:
    - `text_body`, `feedback_md`, `analysis_json`, `files[]`,
    - Fallback-Hinweis: „Bei Infrastrukturproblemen (Storage/Helper) … Domain-Objekt liefern; nur `files[]` kann temporär leer sein.“
- Diese Doku ist weitgehend konsistent mit der implementierten Strategie, muss aber die direkte Tabellen-Fallback-Option (siehe Befund A) erwähnen, um keine falsche Sicherheit zu suggerieren („Helper-only“).

**Empfohlener Doku-Abgleich:**

- Kurze Ergänzung im Abschnitt „DB & RLS“:
  - Klarstellen, dass Helper der primäre Weg sind,
  - der defensive Fallback formal existiert, aber:
    - dieselben Ownership-/Relation-Checks respektiert,
    - nur zur Erhöhung der Robustheit während Migrationen gedacht ist.

---

 ## 3. Konkrete Follow-up-Aufgaben (aus Sicht dieses Plans)

Die folgenden Tasks ergeben sich direkt aus dieser zweiten Review-Runde und bauen auf `2025-12-04-PR-fix.md` auf.

1. **Doku Teaching-Live-Detail anpassen**
   - Datei: `docs/references/teaching_live.md`
   - Inhalt:
     - klarer Hinweis auf defensiven Tabellen-Fallback unter Beibehaltung von RLS/Ownership,
     - explizite Nennung, dass im Fallback `text_body`/`feedback_md`/`analysis_json` weiter geliefert werden, `files[]` aber entfallen kann,
     - kurzer Zusatz bei `text_body`, dass der Wert als Best-Effort-Extrakt ggf. gekürzt wird (z.B. auf 1000 Zeichen).

2. **`files[]`-Konvention vereinheitlichen**
   - Datei: `backend/web/routes/teaching.py` (`_build_latest_submission_payload`)
   - Ziel:
     - Im Fall `include_files=True`, aber ohne gültige Datei, explizit `files: []` setzen.
   - Tests:
     - `test_latest_detail_omits_files_when_size_unknown` sollte danach weiterhin grün sein (ggf. Assertion von „Feld fehlt“ auf „Feld leer“ anpassen).

3. **History-Fallback-Placeholder korrigieren**
   - Datei: `backend/web/main.py` (Fallback-Block für Tasks, ca. Zeilen 1485ff. im Stand `32384c7`)
   - Anpassungen:
     - `data-open_attempt_id` → `data-open-attempt-id`,
     - `hx-on="toggle: window.gustav && window.gustav.handleHistoryToggle(event, this)"` ergänzen.
   - Minimaler Test:
     - Evtl. ein HTML-Snapshot-Test, der sicherstellt, dass beide Varianten (Normalpfad und Fallback) dieselben Attributnamen verwenden.

4. **Doku-Referenz auf diesen Plan**
   - `docs/plan/2025-12-04-PR-fix.md` und/oder `docs/references/teaching_live.md` kann optional einen Verweis auf dieses Dokument (`2025-12-04-PR-fix2.md`) aufnehmen, um Reviewer:innen eine „Historie der Contract-Fixes“ zu geben.

5. **Fallback-Tests für Teaching-Detail ergänzen**
   - Datei: `backend/tests/test_teaching_live_detail_api.py`
   - Ziel:
     - Einen Testfall ergänzen, der `get_latest_submission_for_owner` gezielt scheitern lässt (z.B. via Monkeypatch/Fake-Schema) und prüft, dass der defensive Fallback auf `public.learning_submissions` weiterhin ein vollständiges Domain-Objekt liefert (`text_body`, `feedback_md`, normalisiertes `analysis_json`), aber keine `files[]`-Einträge.
     - Einen zweiten Testfall ergänzen, der den äußersten Fallback-Pfad triggert (z.B. durch einen fehlerhaften DSN oder eine simulierte Verbindungsstörung) und sicherstellt, dass in diesem Fall ein `204` mit privaten Cache-Headern (`Cache-Control: private, no-store`, `Vary: Origin`) zurückgegeben wird.

6. **Doku & Kommentare zu Legacy-Analyseformaten ergänzen**
   - Dateien: `backend/web/routes/teaching.py` (`_normalise_analysis_json`), `docs/references/teaching_live.md`
   - Ziel:
     - Im Docstring/Kommentar von `_normalise_analysis_json` kurz und lehrbar erläutern, welche Legacy-Formate unterstützt werden (z.B. freies `summary`/`criteria`-Dict, `criteria_results` ohne `schema`) und wie diese in criteria.v2 überführt werden.
     - In `docs/references/teaching_live.md` optional einen Satz ergänzen, der auf diese Normalisierung hinweist (z.B. „Ältere Analyseformate werden intern in ein criteria.v1/v2-Objekt überführt.“), ohne zusätzliche Komplexität für API-Clients zu erzeugen.

---

## 4. Meta: Abgleich mit Projektleitlinien

Einordnung der Befunde entlang der GUSTAV-Prinzipien:

- **Komplexität (KISS):**
  - `_normalise_analysis_json` und `_build_latest_submission_payload` bündeln Mehrfachlogik gut; vorgeschlagene Anpassungen (z.B. `files: []`) bleiben klein.
- **Wartbarkeit:**
  - Klarere Doku zum Fallback-Verhalten verhindert künftige Missverständnisse.
  - Vereinheitlichte Attributnamen in der History-UI reduzieren versteckte Spezialpfade.
- **Robustheit:**
  - Der defensive DB-Fallback ist sinnvoll, sollte aber bewusst dokumentiert werden.
  - Die strenge Behandlung von `files[].size` als Integer wird bereits gut durch Tests abgesichert.
- **Sicherheit:**
  - Owner-/Relation-Checks + `app.current_sub` bleiben korrekt; hier gibt es keinen erkennbaren SEC-Bruch.
- **Dokumentation/Konsistenz:**
  - Der vorgeschlagene Doku-Fix bringt Code, OpenAPI-Vertrag und Referenzdokument in Einklang und stützt das „Contract-First“-Versprechen der Plattform.
