# Supabase Storage CORS — Runbook

Status: Draft

## Purpose
Configure and audit the Cross-Origin Resource Sharing (CORS) policy for the `learning-uploads` storage bucket so that browsers can upload files directly to Supabase Storage via presigned URLs without exposing the bucket or allowing untrusted origins.

## Audience
- Teachers/Operators who deploy GUSTAV to production (must have Supabase project admin rights).
- Developers who need to test the upload intent workflow end-to-end.

## Preconditions
- Supabase CLI installed (`supabase --version`).
- Project ref and service-role key available from the secure secret store (never hard-code in repo).
- You are signed in with a Supabase account that has permission to edit Storage settings.
- Networking: Ensure you run commands from a trusted network; avoid public Wi-Fi unless behind VPN.

## Bucket Overview
- Name: `learning-uploads`
- Visibility: `private`
- Expected clients: Browser-based uploads initiated from `app.gustav.school` (prod) and `app.dev.gustav.school` (staging).
- Methods: `PUT` for binary uploads (default), optional `POST` for future multipart flows.

## Check Current Policy
```bash
supabase secrets get --project-ref "$SUPABASE_REF"            # Verify access (should list secrets)
supabase storage list-buckets --project-ref "$SUPABASE_REF"
supabase storage list-policies learning-uploads --project-ref "$SUPABASE_REF"
```
- Confirm there is a policy named `cors-learning-uploads`.
- Ensure no wildcard origin or method is present.

## Update CORS Policy (CLI)
```bash
supabase storage set-cors \
  --project-ref "$SUPABASE_REF" \
  --bucket-id learning-uploads \
  --allowed-origins "https://app.gustav.school,https://app.dev.gustav.school" \
  --allowed-methods "PUT" \
  --allowed-headers "Content-Type,X-Amz-Date,Authorization,X-Requested-With" \
  --exposed-headers "ETag" \
  --max-age 300
```
- For local development, append `http://localhost:5173` when working on the frontend preview. Remove before deploying to production.
- Keep `allowed-headers` in sync with browser requests generated by the upload intent (check via DevTools → Network).
- `max-age` keeps the preflight response cached for 5 minutes; tweak if browsers spam OPTIONS.

## Validate
1. Run `curl -i -X OPTIONS` against the presigned URL with the intended origin header. Expect `204` with the headers set above.
2. In browser DevTools (prod/staging), trigger an upload and verify:
   - Preflight (OPTIONS) returns 204.
   - Actual PUT returns 200/204.
   - Response header `Access-Control-Allow-Origin` matches the requesting origin.
3. Supabase Dashboard → Storage → Policies: verify the UI reflects the CLI configuration to catch drift.

## Security Notes
- Never add `*` (wildcard) origins or methods; this would allow third-party sites to upload arbitrary files via your presigned URLs.
- Keep the bucket private. Only presigned URLs should grant temporary access; revoke via Supabase Dashboard if leakage is suspected.
- Monitor Supabase audit logs for changes to Storage policies; unexpected edits should trigger an incident.
- Rotate service-role keys if you suspect the CLI credentials leaked.

## Troubleshooting
- **403 on PUT**: Check that the presigned headers match the CORS configuration (`Content-Type` mismatch is common).
- **Preflight blocked**: Browser console shows `CORS error` → verify OPTIONS response has `Access-Control-Allow-Methods: PUT`.
- **Policy not updating**: Ensure Supabase CLI is ≥ v1.173 (older versions ignore multi-origin input). Upgrade via `npm install -g supabase`.
- **Local dev origin denied**: Re-run `set-cors` with localhost origin before testing, then revert to prod-only configuration.

## Change Log
- 2025-11-04: Initial draft (Felix & GUSTAV Team).
