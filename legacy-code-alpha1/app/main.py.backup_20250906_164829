import streamlit as st
import time
# KEIN 'from streamlit.navigation import Page' mehr n√∂tig

from auth import sign_up, sign_in, sign_out, get_user, get_user_role

# --- Seitenkonfiguration (MUSS ZUERST) ---
st.set_page_config(
    page_title="GUSTAV-Lernplattform",
    page_icon="assets/GUSTAV-Logo.png",
    layout="wide"
)

# Importiere Auth-Funktionen (Duplikat entfernen)
from utils.session_client import invalidate_user_client, get_anon_supabase_client, get_user_supabase_client

# --- Initialisierung des Session State --- (Bleibt gleich)
if 'user' not in st.session_state:
    st.session_state.user = None
if 'session' not in st.session_state:
    st.session_state.session = None
if 'role' not in st.session_state:
    st.session_state.role = None
if 'active_tab' not in st.session_state:
    st.session_state.active_tab = 0  # 0 = Login, 1 = Registrieren
if 'show_registration_success' not in st.session_state:
    st.session_state.show_registration_success = False



# --- E-Mail Best√§tigungs-Handler ---

# Pr√ºfe verschiedene Best√§tigungs-Parameter
confirmation_params = [
    st.query_params.get("type") == "signup",
    st.query_params.get("type") == "email_change", 
    "token" in st.query_params,
    "confirmation_token" in st.query_params,
    "access_token" in st.query_params and not st.session_state.user
]

if any(confirmation_params):
    # Pr√ºfe auf Fehler
    if st.query_params.get("error"):
        st.error(f"‚ùå Fehler: {st.query_params.get('error_description', st.query_params.get('error'))}")
        # Clear query params nur bei Fehler
        st.query_params.clear()
    else:
        st.success("‚úÖ E-Mail-Adresse erfolgreich best√§tigt!")
        st.info("Sie k√∂nnen sich jetzt mit Ihren Zugangsdaten anmelden.")
        # Setze active_tab auf Login
        st.session_state.active_tab = 0
        # Clear query params bei success
        st.query_params.clear()

# --- Hauptlogik ---

if st.session_state.user is None:
    # --- Nicht angemeldeter Zustand: Zeige Login/Registrierung direkt in main.py ---
    st.title("Willkommen bei GUSTAV üìö")
    st.markdown("### Die KI-gest√ºtzte Lernplattform")
    st.sidebar.info("Bitte melden Sie sich an oder registrieren Sie sich.")

    # Tab-Container mit manueller Kontrolle
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("Login", key="tab_login", type="primary" if st.session_state.active_tab == 0 else "secondary", use_container_width=True):
            st.session_state.active_tab = 0
            st.session_state.show_registration_success = False
            st.rerun()
    
    with col2:
        if st.button("Registrieren", key="tab_signup", type="primary" if st.session_state.active_tab == 1 else "secondary", use_container_width=True):
            st.session_state.active_tab = 1
            st.rerun()
    
    st.divider()
    
    # --- Login Form ---
    if st.session_state.active_tab == 0:
        st.subheader("Anmelden")
        
        # Login-Form direkt anzeigen
        with st.form("login_form", clear_on_submit=False):
            login_email = st.text_input("E-Mail")
            login_password = st.text_input("Passwort", type="password")
            login_submit = st.form_submit_button("Anmelden")

            if login_submit:
                if not login_email or not login_password:
                    st.warning("Bitte E-Mail und Passwort eingeben.")
                else:
                    res = sign_in(login_email, login_password)
                    if res.get("error"):
                         st.error(f"Anmeldefehler: {res['error']['message']}")
                    elif res.get("user") and res.get("session"):
                        # Pr√ºfe ob E-Mail best√§tigt wurde
                        if res["user"].email_confirmed_at is None:
                            st.error("‚ùå Bitte best√§tigen Sie zuerst Ihre E-Mail-Adresse.")
                            st.info("üìß √úberpr√ºfen Sie Ihr Postfach und klicken Sie auf den Best√§tigungslink.")
                        else:
                            st.session_state.session = res["session"]
                            st.session_state.user = res["user"]
                            st.session_state.role = get_user_role(res["user"].id)
                            st.success("Erfolgreich angemeldet!")
                            print(f"Login erfolgreich: User {res['user'].email}, Rolle {st.session_state.role}")
                            st.rerun() # Wichtig, um Navigation neu aufzubauen
                    else:
                        st.error("Anmeldung fehlgeschlagen. √úberpr√ºfen Sie Ihre Zugangsdaten oder unerwarteter Fehler.")
                        print(f"Unerwartete Antwort von sign_in: {res}")

    # --- Registrierungs Form ---
    elif st.session_state.active_tab == 1:
        st.subheader("Registrieren")
        
        # Zeige Erfolgsmeldung wenn vorhanden
        if st.session_state.show_registration_success:
            st.success("‚úÖ Registrierung erfolgreich!")
            st.info("üì¨ Bitte √ºberpr√ºfen Sie Ihre E-Mail-Adresse und klicken Sie auf den Best√§tigungslink, um Ihr Konto zu aktivieren.")
            st.markdown("---")
            st.markdown("Nach der Best√§tigung k√∂nnen Sie sich anmelden.")
            if st.button("‚Üí Zum Login wechseln", key="after_signup_login"):
                st.session_state.active_tab = 0
                st.session_state.show_registration_success = False
                st.rerun()
        else:
            # Info √ºber erlaubte E-Mail-Domains
            st.info("üìß Die Registrierung ist nur mit einer schulischen E-Mail-Adresse (@gymalf.de) m√∂glich.")
            
            # Formular immer anzeigen (einfachste L√∂sung)
            with st.form("signup_form", clear_on_submit=True):
                signup_email = st.text_input("E-Mail", placeholder="vorname.nachname@gymalf.de")
                signup_password = st.text_input("Passwort", type="password", help="Mindestens 6 Zeichen")
                signup_confirm_password = st.text_input("Passwort best√§tigen", type="password")
                signup_submit = st.form_submit_button("Registrieren")

                if signup_submit:
                    if not signup_email or not signup_password or not signup_confirm_password:
                        st.warning("Bitte alle Felder ausf√ºllen.")
                    elif signup_password != signup_confirm_password:
                        st.error("Die Passw√∂rter stimmen nicht √ºberein.")
                    elif len(signup_password) < 6:
                        st.error("Das Passwort muss mindestens 6 Zeichen lang sein.")
                    elif not signup_email.lower().endswith('@gymalf.de'):
                        st.error("‚ùå Die Registrierung ist nur mit einer @gymalf.de E-Mail-Adresse m√∂glich.")
                    else:
                        res = sign_up(signup_email, signup_password)
                        if res.get("error"):
                            st.error(f"Registrierungsfehler: {res['error']['message']}")
                        elif res.get("user"):
                            # Setze Flag f√ºr Erfolgsmeldung und bleibe im Tab
                            st.session_state.show_registration_success = True
                            st.rerun()
                        else:
                            st.error("Unbekannter Fehler bei der Registrierung.")


else:
    # --- Angemeldeter Zustand: Definiere und zeige Navigation ---
    st.sidebar.success(f"Angemeldet als: {st.session_state.user.email}")
    role_display = "Lehrer" if st.session_state.role == "teacher" else "Sch√ºler" if st.session_state.role == "student" else st.session_state.role
    st.sidebar.write(f"Rolle: **{role_display}**")

    # Definiere die Seitenpfade basierend auf der Rolle
    # Die Dateinamen (z.B. "0_Dashboard.py") bestimmen Titel und Icon,
    # es sei denn, sie werden in der Datei selbst mit st.set_page_config √ºberschrieben.
    pages_for_role = []
    if st.session_state.role == 'teacher':
        pages_for_role = [
            "pages/0_Startseite.py",
            "pages/1_Kurse.py",
            "pages/2_Lerneinheiten.py",
            "pages/5_Schueler.py",
            "pages/6_Live-Unterricht.py",
            "pages/9_Feedback_einsehen.py"
        ]
    elif st.session_state.role == 'student':
        pages_for_role = [
            "pages/0_Startseite.py",
            "pages/3_Meine_Aufgaben.py",
            "pages/7_Wissensfestiger.py",
            "pages/8_Feedback_geben.py"
        ]
    else:
        st.sidebar.warning("Unbekannte Rolle.")
        # Fallback: Nur Dashboard anzeigen, wenn Rolle unbekannt aber User eingeloggt
        pages_for_role = ["pages/0_Startseite.py"]

    # Rufe st.navigation mit der Liste der Pfade auf
    if pages_for_role:
        pg = st.navigation(pages_for_role)

        # Logout Button in der Sidebar (nur wenn eingeloggt)
        if st.sidebar.button("Logout"):
            if sign_out():
                 # Client invalidieren
                 invalidate_user_client()
                 st.session_state.user = None
                 st.session_state.session = None
                 st.session_state.role = None
                 st.session_state.active_tab = 0
                 st.session_state.show_registration_success = False
                 st.success("Erfolgreich abgemeldet.")
                 st.rerun()

        # F√ºhre den Code der ausgew√§hlten Seite aus
        pg.run()

    else:
         # Zeige eine Meldung, wenn keine Seiten f√ºr die Rolle definiert sind
         st.error("F√ºr Ihre Rolle sind keine Seiten konfiguriert.")
         if st.sidebar.button("Logout"): # Logout auch hier anbieten
            if sign_out():
                 # Client invalidieren
                 invalidate_user_client()
                 st.session_state.user = None
                 st.session_state.session = None
                 st.session_state.role = None
                 st.session_state.active_tab = 0
                 st.session_state.show_registration_success = False
                 st.success("Erfolgreich abgemeldet.")
                 st.rerun()